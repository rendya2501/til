# 自宅のVSCodeがマーケットプレイスにつながらない問題について

[VSCodeの拡張機能を使うには？](https://gbw-portal.appspot.com/pages/ja/pageview.html?page=vscode%2Fp005%2Ehtml)

なんかjsonの設定を書き換えればいけるとか書いてある。  
`C:\Program Files\Microsoft VS Code\product.json`  

職場のproduct.json  

```json:
    "extensionAllowedProposedApi": [
        "GitHub.codespaces",
        "GitHub.vscode-pull-request-github-insiders",
        "GitHub.vscode-pull-request-github",
        "Microsoft.vscode-nmake-tools",
        "ms-ai-tools.notebook-renderers",
        "ms-dotnettools.dotnet-interactive-vscode",
        "ms-python.gather",
        "ms-python.python",
        "ms-toolsai.vscode-ai",
        "ms-vscode-remote.remote-containers-nightly",
        "ms-vscode-remote.remote-containers",
        "ms-vscode-remote.remote-ssh-edit-nightly",
        "ms-vscode-remote.remote-ssh-edit",
        "ms-vscode-remote.remote-ssh-nightly",
        "ms-vscode-remote.remote-ssh",
        "ms-vscode-remote.remote-wsl-nightly",
        "ms-vscode-remote.remote-wsl",
        "ms-vscode-remote.vscode-remote-extensionpack-nightly",
        "ms-vscode-remote.vscode-remote-extensionpack",
        "ms-vscode.azure-account",
        "ms-vscode.azure-sphere-tools-ui",
        "ms-vscode.azure-sphere-tools",
        "ms-vscode.github-browser",
        "ms-vscode.github-richnav",
        "ms-vscode.js-debug-nightly",
        "ms-vscode.js-debug",
        "ms-vscode.lsif-browser",
        "ms-vscode.references-view",
        "ms-vscode.vscode-js-profile-flame",
        "ms-vscode.vscode-js-profile-table",
        "ms-vsliveshare.cloudenv-explorer",
        "ms-vsliveshare.cloudenv",
        "ms-vsliveshare.vsliveshare",
        "ms-vsonline.vsonline"
    ],
    "extensionsGallery": {
        "serviceUrl": "https://marketplace.visualstudio.com/_apis/public/gallery",
        "cacheUrl": "https://vscode.blob.core.windows.net/gallery/index",
        "itemUrl": "https://marketplace.visualstudio.com/items",
        "controlUrl": "https://az764295.vo.msecnd.net/extensions/marketplace.json",
        "recommendationsUrl": "https://az764295.vo.msecnd.net/extensions/workspaceRecommendations.json.gz"
    },
```

---

## 特定のポートを解放することで何とかならないかやってみた

結果はダメだった。  
参考にしたURLだけ貼っておく。  

[Windows10で特定のポートを開放する](https://support.borndigital.co.jp/hc/ja/articles/360002711593-Windows10%E3%81%A7%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E9%96%8B%E6%94%BE%E3%81%99%E3%82%8B)

---

## 2021/01/04 Mon 解決

### 閃き

現状の環境でVSCodeの拡張利用がうまくいかないなら、Dockerで適当にサーバーを立ち上げて、  
そこでVSCodeの拡張を確認してみたらどうなるか？という案。  
この検証をすることによって、ホスト側の環境が悪いのか、そもそもネットワークが悪いのかを確認することができる。  
それでもだめならパソコンが悪いとしか言いようがない。  

### 作業経緯

- Docker for windowsをダウンロード。
チュートリアルを実行するもこの地点でコケる。  
- とにかく適当なLinuxサーバーを構築できればよかったので、
  色々調べたら、windows subsystem for linux ver.2(wsl2)なる物があるらしいので、Dockerではなくそちらに切り替えた。  
- OSはCentからUbuntuにすることにした。
  なぜならリモートデスクトップ接続してGUIでVSCodeを確認することが目的だったので、Ubuntuのほうがやりやすいだろうと判断したから。  
- クローム使うとタブの使い分けが面倒なのでEgdeで作業してたら、
  Edgeのアップデートもうまく行かなくて、そちらの原因を探ることにも時間を費やしてしまった。  
- 結果的に、Egdeの件はWindowsUpdateをすることで解決した。  
- wsl2+ubuntuで調べて、ubuntuをストアからダウンロードしたはいいが、起動できなかった。
  これもWindowsUpdateをすることによって解決できた。  
- 適当な動画を見てRDP接続するところまではできたが、GUIが表示されない。正確にはすぐに落ちてしまう。  
- 改めてwsl2+ubuntu+rdpを解説している動画があったので、徹頭徹尾同じくしたら起動できた。  
- VSCodeもダウンロードして起動して拡張を確認したらオススメが表示されることを確認  
  一人で感動した。  
- 仮想環境で使っているアダプターと比較して違いを探してみたが、確認する項目が多すぎてこれだけでは問題解決に至らないと判断。  
- なんとなくネットワークの診断をしたら、ホスト側で使っているアダプターはDNSによる名前解決が機能していないことが判明。  
- とりあえずグーグルのDNSである。`8.8.8.8` `8.8.4.4`を設定。  
  これだけではうまくいかなかった。  
- それから仮想側のVSCodeのプロキシの設定とホスト側のプロキシの設定を比較して、仮想側に合わせたらうまく行った。  
- どこかのタイミングでホスト側のネットワーク設定のプロキシの項目も設定したはず。  
  それも関係あるかも？  

※ちなみにEdgeやChromeのアップデートがうまくいかないのも今回の問題が原因だった。  

wsl2+ubuntu+rdpの設定が一番色々あったので、備忘録として設定の流れとコマンドをまとめたいところ。  
sudo /etc/init.d/xrdp start  

### 原因

原因はIPv4のDNS設定とプロキシの設定だった模様。  

プロキシの設定はVSCodeがプロキシがうんたらかんたらというから適当に設定した値であったが、これがまずかった。完全に余計な対処だった模様。  

DNS設定はルーターのほうで設定しているから完全に眼中になかった。  
なんとなく診断して、初めて注目した問題だったので、運がよかったとしか言えない。  

検証のためDNSだけを元に戻して問題が再現するか確認してみたが、再現しなかった。  
以上からDNSとプロキシの設定が複合して発生した問題だったと推測する。  
全部元に戻してもよかったが、また治らなくなったら嫌なのと、面倒くさかったのと、作業の手順はすべて覚えていたので、それで済ませた。  

### 対処方法まとめ

1. **パソコン側のプロキシ設定**
  Windowsメニューから歯車の設定を選択  
  →ネットワークとインターネット  
  →プロキシ  
  →設定を自動的に検出する  
  →オフに変更  

2. **DNSサーバーの設定**
  コンパネ  
  →ネットワークと共有センター  
  →左側タブの「アダプターの詳細設定」を選択  
  →対応アダプターを右クリックして「プロパティ」を選択  
  →「インターネット プロトコル バージョン4」を選択して「プロパティ」ボタンを押下  
  →「次のDNSサーバーのアドレスを使う」を選択して以下を設定  
    - 優先DNSサーバー : 8.8.8.8  
    - 代替DNSサーバー : 8.8.4.4  

3. **VSCodeのプロキシ設定**
  VSCodeを開く  
  →左下の歯車から設定を選択  
  →proxyで検索  
  →すべてデフォルトの状態にする  

### 参考サイト

[このサイトの動画の通りにやったらうまくいった](https://www.briteccomputers.co.uk/posts/ubuntu-on-windows-10-with-wsl2-and-gui-setup-via-remote-desktop-2/)

<https://www.karelie.net/ubuntu-debian-command-install-vscode/>
<https://yoshimemo.com/post-723/>
<https://astherier.com/blog/2020/08/install-ubuntu-desktop-on-wsl2/>
