# 分子分母を出力するサンプル

Window関数を初めて知ってから組み上げた実践サンプル。  

1つの予約が複数の時間に跨っている様を分母分子で表示するサンプル  
1つの時間に複数の予約がある場合は「+」を表示させる。  

---

## データ準備

``` sql
DROP TABLE IF EXISTS TestReservation
CREATE TABLE TestReservation
(
    [Id] INT NOT NULL IDENTITY(1,1) PRIMARY KEY,  
    [ReservationTime] TIME,  
    [ReservationNo] nvarchar(255)
);
INSERT INTO TestReservation
VALUES
     ('07:00:00.0000000','RES202204160001')
    ,('07:07:00.0000000','RES202204160001')
    ,('07:14:00.0000000','RES202204160001')
    ,('07:21:00.0000000','RES202204160001')
    ,('07:28:00.0000000','RES202204160002')
    ,('07:35:00.0000000','RES202204160002')
    ,('07:42:00.0000000','RES202204160003')
    ,('07:42:00.0000000','RES202204160004')
    ,('07:49:00.0000000','RES202204160003')
    ,('07:56:00.0000000','RES202204160005')
```

---

## 実装

``` sql
SELECT
    [ReservationTime],
    [ReservationNo],
    -- その予約の時間の順番(分子:Numerator)
    ROW_NUMBER() OVER(PARTITION BY [ReservationNo] ORDER BY [ReservationTime]) AS [Numerator],
    -- その予約の合計(分母:Denominator)
    COUNT(1) OVER(PARTITION BY [ReservationNo]) AS [Denominator],
    -- 分数表示。その時間に複数の予約がある場合は+を表示する
    CONVERT(nvarchar,ROW_NUMBER() OVER(PARTITION BY [ReservationNo] ORDER BY [ReservationTime]))
    + '/' 
    + CONVERT(nvarchar,COUNT(1) OVER(PARTITION BY [ReservationNo]))
    + CASE WHEN COUNT(*) OVER (PARTITION BY [ReservationTime]) > 1 THEN '+' ELSE '' END
    AS [Result]
FROM [TestReservation]
GROUP BY [ReservationTime],[ReservationNo]

-- ReservationTime   ReservationNo    Numerator  Denominator  Result
-- 07:00:00.0000000  RES202204160001      1          4        1/4   
-- 07:07:00.0000000  RES202204160001      2          4        2/4   
-- 07:14:00.0000000  RES202204160001      3          4        3/4   
-- 07:21:00.0000000  RES202204160001      4          4        4/4   
-- 07:28:00.0000000  RES202204160002      1          2        1/2   
-- 07:35:00.0000000  RES202204160002      2          2        2/2   
-- 07:42:00.0000000  RES202204160003      1          2        1/2+  
-- 07:42:00.0000000  RES202204160004      1          1        1/1+  
-- 07:49:00.0000000  RES202204160003      2          2        2/2   
-- 07:56:00.0000000  RES202204160005      1          1        1/1   
```

---

## 超愚直にやった場合

Window関数がよくわからなかったときに組んだ事例も備忘録として残しておく。  

``` sql
SELECT
    [A].[ReservationTime],
    [A].[ReservationNo],
    CONVERT(nvarchar,[A].[Numerator]) AS [Numerator],
    CONVERT(nvarchar,[B].[Denominator]) AS [Denominator],
    CASE WHEN COUNT(*) OVER (PARTITION BY [ReservationTime]) > 1 THEN '+' ELSE '' END AS [Emphasis],
    CONVERT(nvarchar,[A].[Numerator])
    + '/'
    + CONVERT(nvarchar,[B].[Denominator])
    + CASE WHEN COUNT(*) OVER (PARTITION BY [ReservationTime]) > 1 THEN '+' ELSE '' END AS [Result]
FROM (
    -- その予約の時間の順番(分子:Numerator)
    SELECT
        [ReservationTime],
        [ReservationNo],
        ROW_NUMBER() OVER(PARTITION BY [ReservationNo] ORDER BY [ReservationTime]) AS [Numerator]
    FROM 
        [TestReservation]
    GROUP BY
        [ReservationTime],[ReservationNo]
    ) AS [A]
JOIN (
    -- その予約の合計(分母:Denominator)
    SELECT
        [ReservationNo],
        COUNT(DISTINCT [ReservationTime]) AS [Denominator]
    FROM 
        [TestReservation]
    GROUP BY 
        [ReservationNo]
) AS [B]
ON [A].[ReservationNo] = [B].[ReservationNo]

-- ReservationTime   ReservationNo    Numerator  Denominator  Emphasis  Result
-- 07:00:00.0000000  RES202204160001    1             4                 1/4
-- 07:07:00.0000000  RES202204160001    2             4                 2/4
-- 07:14:00.0000000  RES202204160001    3             4                 3/4
-- 07:21:00.0000000  RES202204160001    4             4                 4/4
-- 07:28:00.0000000  RES202204160002    1             2                 1/2
-- 07:35:00.0000000  RES202204160002    2             2                 2/2
-- 07:42:00.0000000  RES202204160003    1             2          +      1/2+
-- 07:42:00.0000000  RES202204160004    1             1          +      1/1+
-- 07:49:00.0000000  RES202204160003    2             2                 2/2
-- 07:56:00.0000000  RES202204160005    1             1                 1/1
```
