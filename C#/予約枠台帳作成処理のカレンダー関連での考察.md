
# 予約枠台帳作成処理のカレンダー関連での考察

予約枠台帳作成処理において、カレンダーに適切な値をバインドしたくて四苦八苦した時の経験を備忘録として残す。  

---

## 1.カレンダーの曜日表示をボタンにして、ボタンを押したら、その曜日の日付を全て選択したい

1. 曜日分のボタンを生成すること。  
2. 1つ1つボタンにCommandを設定すること。  
3. どのボタンを押下したのかわからないので引数を受け取ることはできないか？  

### ① 曜日分のボタンを生成すること

正直どういう理論で7つも生成されるのか知らないが、取り合えず、テキスト部分をボタンに置き換えたらちゃんと出来た。  
出来ればXAMLにおける繰り返し処理もまとめたい。  

### ② 1つ1つボタンにCommandを設定すること

Styleで定義した状態では、親の情報しか参照しないので、単純に`Command = {Bingind HogeCommand}`としただけではバインドエラーになる。  
そこで昔にやったFindAncestorとDataContextを使うことで、見事、親を超えてViewModelのCommandをバインドさせることに成功した。  
`Command="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type metro:MetroWindow}}, Path=DataContext.SelectDayOfWeekCommand, Mode=OneWay}"`  

### ③ どのボタンを押下したのかわからないので引数を受け取ることはできないか？

ずばりな記事がありました。  
→[MVVMで引数があるCommandを実装する](https://yoshinorin.net/2016/05/21/MVVM-command-hasArgument/)  

CommandParameterを使うことで実現できました。  
ちゃんとDelegateCommandも第一引き数にDayOfWeek Enumが来るように修正することで、  
見事どのボタンが押されたのかを観測することが出来ました。  

---

## 日付の下に文字を表示したい

[標準のCalendarに1日ごとにアイテムを追加できるようにカスタムする(MultiBindConverter使用)](https://qiita.com/pregum/items/775b24fbf2eb80e43991#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%95%E3%81%9B%E3%81%A6%E9%A0%82%E3%81%84%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88)  
やりたいのはこういう事。

まだ試していないが、MultiBindingを用いればいけそうな感じがする。  
MultiBindingを使えば、Converterのvaluesに複数のデータを投げることができる。  
このコンバーターは専用コンバーターにするとして、型変換してLinqでWhereすればいけると思われる。

``` XML
<ItemsControl.ItemsSource>
    <MultiBinding Converter="{StaticResource MultiBindingSample}" UpdateSourceTrigger="PropertyChanged" Mode="OneWay">
        <Binding Path="Date" UpdateSourceTrigger="PropertyChanged"/>
        <Binding Path="DataContext.TestCollection" ElementName="rootGrid"  />
    </MultiBinding>

    <MultiBinding Converter="{StaticResource AccessLevelToVisibilityConverter}">
        <Binding Path="Tag" RelativeSource="{RelativeSource Mode=FindAncestor,AncestorType=UserControl}"/>
        <Binding Path="Tag" RelativeSource="{RelativeSource Mode=Self}"/>
    </MultiBinding>
</ItemsControl.ItemsSource>
```

``` C#
public sealed class LengthConverter : IMultiValueConverter
{
    public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
    {
        // 1. BusinessDate
        // 2. TestClass
        TestClass testClass = null;
        foreach (item in values)
        {
            if (item is TestClass) {
                testClass = item;
                break;
            }
        }
        testClass.Where(w => w.businessDate == values[0].BusinessDate);
    }

    public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture)
    {
        throw new NotSupportedException();
    }
}

class TestClass
{
    public DateTime BusinessDate { get; set; }
    public int Bunsi {get; set;}
    public int Bunbo {get; set;}
}

```
