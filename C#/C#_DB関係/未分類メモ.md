# C# DB関係 未分類メモ

## SqlClient 待ち操作がタイムアウトになりました

DbUpの移行中に発生。  
Create Index等、重めの処理に差し掛かったあたりで発生した。  
`IDbCommand`の`CommandTimeout`を99999秒にしてみたが解決しなかった。  
SQLServerへの接続文字列に`Connection Timeout=99999`を指定したら解決した。  
`Connection Timeout`が99999秒の状態で`IDbCommand`の`CommandTimeout`を設定しないようにしたら、再発したので、どちらも指定する必要がある模様。  

タイムアウト関連のエラーが発生した場合、接続設定と`IDbCommand`の設定を確認すべし。  

以下、発生したタイムアウトエラーのログ。  

``` txt
Upgrade failed due to an unexpected exception:
Microsoft.Data.SqlClient.SqlException (0x80131904): Execution Timeout Expired.  The timeout period elapsed prior to completion of the operation or the server is not responding.
 ---> System.ComponentModel.Win32Exception (258): 待ち操作がタイムアウトになりました。
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParserStateObject.ThrowExceptionAndWarning(Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParserStateObject.ReadSniError(TdsParserStateObject stateObj, UInt32 error)
   at Microsoft.Data.SqlClient.TdsParserStateObject.ReadSniSyncOverAsync()
   at Microsoft.Data.SqlClient.TdsParserStateObject.TryReadNetworkPacket()
   at Microsoft.Data.SqlClient.TdsParserStateObject.TryPrepareBuffer()
   at Microsoft.Data.SqlClient.TdsParserStateObject.TryReadByte(Byte& value)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.TdsParser.Run(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj)
   at Microsoft.Data.SqlClient.TdsParser.TdsExecuteTransactionManagerRequest(Byte[] buffer, TransactionManagerRequestType request, String transactionName, TransactionManagerIsolationLevel isoLevel, Int32 timeout, SqlInternalTransaction transaction, TdsParserStateObject stateObj, Boolean isDelegateControlRequest)
   at Microsoft.Data.SqlClient.SqlInternalConnectionTds.ExecuteTransaction2005(TransactionRequest transactionRequest, String transactionName, IsolationLevel iso, SqlInternalTransaction internalTransaction, Boolean isDelegateControlRequest)
   at Microsoft.Data.SqlClient.SqlInternalConnectionTds.ExecuteTransaction(TransactionRequest transactionRequest, String name, IsolationLevel iso, SqlInternalTransaction internalTransaction, Boolean isDelegateControlRequest)
   at Microsoft.Data.SqlClient.SqlInternalTransaction.Rollback()
   at Microsoft.Data.SqlClient.SqlTransaction.Rollback()
   at DbUp.Engine.Transactions.SingleTransactionAlwaysRollbackStrategy.Dispose() in /_/src/dbup-core/Engine/Transactions/SingleTransactionAlwaysRollbackStrategy.cs:line 81
   at DbUp.Engine.Transactions.DatabaseConnectionManager.<OperationStarting>b__7_0() in /_/src/dbup-core/Engine/Transactions/DatabaseConnectionManager.cs:line 57
   at DbUp.Engine.DelegateDisposable.Dispose() in /_/src/dbup-core/Engine/DelegateDisposable.cs:line 14
   at DbUp.Engine.UpgradeEngine.PerformUpgrade() in /_/src/dbup-core/Engine/UpgradeEngine.cs:line 81
ClientConnectionId:edb0ce37-ad6c-4959-b777-68f4beaae05b
Error Number:-2,State:0,Class:11
```

- 参考  
  - [SqlConnection.ConnectionTimeout プロパティ (System.Data.SqlClient) | Microsoft Learn](https://learn.microsoft.com/ja-jp/dotnet/api/system.data.sqlclient.sqlconnection.connectiontimeout?view=dotnet-plat-ext-7.0)  
  - [SQL Server / SQL Database パフォーマンスチューニング & トラブルシューティング シリーズ : SQL Server へのクエリ実行時の「コマンド タイムアウト」の挙動について at SE の雑記](https://blog.engineer-memo.com/2020/06/30/sql-server-sql-database-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0-%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7/)  
  - [SQL Serverに.NETで接続しようとすると1.2秒でタイムアウトする場合がある - give IT a try](https://blog.jnito.com/entry/20120219/1329633868)  
  - [SQL Serverで断続的に発生するクエリタイムアウトの原因を調査した話 - ZOZO TECH BLOG](https://techblog.zozo.com/entry/sqlserver-query-timeout)  
