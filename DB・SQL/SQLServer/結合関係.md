# 結合関係まとめ

---

## SQLの結合条件のON句の順番について

<https://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q11166323581>  

SQLのLEFT JOIN とかのONの順番は関係無いらしい。  
地味に知らなかったので、メモ。  

---

## CROSS JOIN+WHERE と INNER JOIN

<https://qiita.com/zaburo/items/548b3c40fee68cd1e3b7>  
<https://stackoverflow.com/questions/17759687/cross-join-vs-inner-join-in-sql>  

CROSS JOIN して WHERE で絞る方法(等価結合)とINNER JOINの結果は同じらしい。(厳密には内部処理的には違うらしいが)  
まぁ、CROSS JOINしてWHEREで絞るくらいなら素直にINNER JOIN使えって話。  

``` SQL
-- どちらも結果は同じになる

-- CROSS JOIN + WHERE
SELECT depts.dept_name,employees.name
FROM depts,employees
WHERE depts.dept_id = employees.dept_id;

-- INNER JOIN
SELECT depts.dept_name,employees.name
FROM depts INNER JOIN employees
WHERE depts.dept_id = employees.dept_id;
```

---

## テーブル結合にLIKE演算子を使えるか

普通に行ける。  
[テーブル結合 LIKE演算子](https://teratail.com/questions/65949)  

``` sql
SELECT
    テーブル1.X 
FROM
    テーブル1
    LEFT JOIN テーブル2 
    ON テーブル2.Y LIKE テーブル1.X + '%' 
    (AND / OR テーブル2でさらに絞りたい条件式)
WHERE
    テーブル2.Y IS NULL 
    AND ~~
```

---

## JOIN条件にBETWEEN使える

JOIN ID BETWEEN FROM AND TO

``` sql
SELECT
    CASE
        WHEN [TableB].[PrimaryKey] IS NOT NULL THEN 2
        WHEN [nanka].[nanka] IS NOT NULL THEN 1
        ELSE 0
    END
FROM [TableA]
LEFT JOIN [TableB]
ON [TableA].[Number] BETWEEN [TableB].[NumberFrom] AND [TableB].[NumberTo]
```

---

## 文字列結合した結果でJOIN

[【SQL】JOIN(結合)でLIKEを使ってSELECTをしてみる](https://buralog.jp/sql-join-like-operator/)  

普通に実現可能。
CONCAT関数。  

``` sql
SELECT *
FROM
    [Table1]
    JOIN [Table2]
    ON CONCAT([Table1].[ID],FORMAT([Table1].[DetailNo],'000000')) = [Table2].[TestID]
```

---

## LIKE結合とEXCEPT

全データがあるテーブルから存在しないレコードだけを抜き出したいという案件を受けた。  
それだけなら差集合でいいけど、微妙に文字列が追加されていて、単純な結合ができない。  

SQLServerで正規表現が使えればよかったが、SQLServerでは使えない模様。  
LIKE句を使った結合はできたが、その先が分からなかった。  
そんな時にドンピシャな記事があったのでまとめる。  

[テーブル結合　LIKE演算子](https://teratail.com/questions/65949)
[SQL EXCEPTのサンプル(差分を抽出する)](https://itsakura.com/sql-except)  

>下記の状況で最適なSQLを作成したいのです。  
>
>【情報】  
>テーブル1 カラム名：項目X  
>テーブル2 カラム名：項目Y(※レコード内容は項目Xに文字列を付与したものが入っています)  
>
>手順1.ある条件を元にして、テーブル1の項目XのSELECTします。(結果は複数行返ってきます)  
>手順2.手順1のSELECT結果をWHERE条件にLIKE演算子の前方一致でテーブル2の項目YをSELECTします。  
>
>最終的には、手順2で前方一致でぶつからなかった項目Xの値を知りたいと思っています。  
>これをSQLにて効率的に実行するには、どのようなやり方が望ましいのでしょうか。  
>テーブル1とテーブル2を結合する際の条件にLIKE演算子を用いるとかですかね、、、？  

``` sql
-- 全データ
SELECT `項目X` FROM `テーブル1`
EXCEPT
-- 抽出したデータ
SELECT
    [Table2].`項目X`
FROM
    `テーブル2` AS [Table1]
INNER JOIN
    (SELECT `項目X` FROM `テーブル1` WHERE "ある条件") AS [Table2]
ON
    [Table1].`項目Y` LIKE [Table2].`項目X` + '%'
```

``` sql : こっちでもいけた
SELECT
    テーブル1.X 
FROM
    テーブル1
    LEFT JOIN テーブル2 
    ON テーブル2.Y 
    LIKE テーブル1.X + '%' （AND / OR テーブル2でさらに絞りたい条件式）
WHERE
    テーブル2.Y IS NULL AND
```
