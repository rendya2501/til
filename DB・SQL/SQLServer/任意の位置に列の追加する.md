# SQLServer 任意の位置に列を追加する構文

[浦下.com](https://urashita.com/archives/13652)  

SQLServerManagementStudio でならデザイナで任意の場所に列を追加することが可能。  

T-SQL(Transact-SQL)でやる場合、そのようなコマンドは存在しないので以下のような手順を踏んでフィールドを追加する必要あり。  
そもそも、MySQL以外のデータベースではカラム追加時の位置指定が軒並み不可能な模様。  

---

## 手順

1. テーブルをバックアップ  
2. テーブルを削除  
3. テーブルを再作成  
4. 再作成したテーブルにバックアップからリストア  

---

## クエリ

TRY CATCH構文と組み合わせて実装している。  

``` SQL
BEGIN TRAN
BEGIN TRY
    -- ①対象テーブルのデータをテンポラリテーブルにバックアップ
    SELECT * INTO #Temp FROM TBL_USER

    -- ②対象テーブルを削除
    DROP TABLE TBL_USER

    -- ③カラムを追加して対象テーブルを再作成
    CREATE TABLE TBL_USER
    (
        UserNo int NOT NULL DEFAULT (0),
        Name nvarchar(255) NOT NULL DEFAULT (),
        Age int NOT NULL DEFAULT (0),
        Addr nvarchar(255) NOT NULL DEFAULT (),
        Tel nvarchar(255) NOT NULL DEFAULT (),
        CONSTRAINT TBL_USER_PK PRIMARY KEY CLUSTERED (UserNo)
    )

    -- ④テンポラリテーブルからバックアップデータを復元
    INSERT INTO TBL_USER
    SELECT
        Tmp.UserNo,
        Tmp.Name,
        0,
        Tmp.Addr,
        Tmp.Tel
    FROM #Temp Tmp

    -- ⑤テンポラリテーブルを削除
    DROP TABLE #Temp

    COMMIT TRAN
END TRY
BEGIN CATCH
    ROLLBACK TRAN
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage
END CATCH
```

---

## 一番最後に列を追加するクエリ

一番最後に列を追加するのは当たり前なので割愛するが、コマンドはこんな感じ。

``` sql : TBK_USERに年齢カラムを追加するクエリ
ALTER TABLE TBL_USER ADD Age int DEFAULT 0
```
