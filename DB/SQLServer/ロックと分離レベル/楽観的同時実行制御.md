# 楽観的(オプティミスティック)同時実行制御

## 概要

読み取り時のロックをすぐに解放し、更新するときに、更新されたかどうかをチェックするような形態を楽観的同時実行制御(Optimistic Concurrency Control)と呼ばれる。  
これは「誰も更新する人はいないだろう、いたとしても後からチェックしよう」と楽観的に考えていることからこのように呼ばれる。  

これに対し、「更新ロック」(UPDLOCK)を利用して、読み取ったデータを保護する形態は、悲観的同時実行制御(Pessimistic Concurrency Control)と呼ばれる。  
「誰かが更新するかもしれないから、念のためにブロックしておく」と悲観的に考えているからこのように呼ばれている。  

---

## 楽観的同時実行制御の実装方法

1. 読み取り時のデータを更新条件に含める  
2. 更新されたかどうかをチェックする列をテーブルに追加する  

### 1. 読み取り時のデータを更新条件に含める

``` txt
|座席|予約者名|
|----+--------|
| 1  | NULL   |
| 2  | sato_t |
| 3  | NULL   |
| 4  | NULL   |
```

``` sql
-- トランザクションX
UPDATE 予約
SET 予約者="X"
WHERE 座席=3
AND 予約者 IS NULL
-- ↑読み取った時のデータを更新条件に含める

-- トランザクションY
UPDATE 予約
SET 予約者="Y"
WHERE 座席=3
AND 予約者 IS NULL
-- ↑読み取った時のデータを更新条件に含める
```

読み取った時のデータを更新時(UPDATEステートメント実行時)のWHEREの条件として含めるようにすれば、他のユーザーによる同時更新を検出できるようになる。  

### 2. 更新されたかどうかをチェックする列をテーブルに追加する

更新時の時刻や一意なバージョン番号等、同時更新をチェックする列をテーブルへ追加する。  

``` txt
|座席|予約者名|更新時刻               |
|----+--------|-----------------------|
| 1  | NULL   | :                     |
| 2  | sato_t | :                     |
| 3  | NULL   | 2016/6/5 04:30:12.467 |
| 4  | NULL   | NULL                  |
```

``` sql
-- トランザクションX
UPDATE 予約
SET 予約者="X",更新時刻=GETDATE()
WHERE 座席=3
AND 更新時刻='2016/6/5 04:30:12.467'
-- ↑読み取った時の更新時刻を更新条件に含める

-- トランザクションY
UPDATE 予約
SET 予約者="Y",更新時刻=GETDATE()
WHERE 座席=3
AND 更新時刻='2016/6/5 04:30:12.467'
-- ↑読み取った時の更新時刻を更新条件に含める
```

データ更新時には、更新時刻を必ず更新するようにし、読み取った時点での更新時刻をUPDATE実行時のWHERE句を含めることで、他のユーザーに寄る同時更新を検出できるようになる。  

---

## ASP.NETでの楽観的同時実行制御の自動実装

ASP.NETでは、楽観的同時実行制御を自動実装してくれる「データソースの構成ウィザード」が提供されている。  
これを利用すると、読み取り時のデータを更新条件に含めるUPDATEステートメントを自動実装してくれる。  

---

## ADO.NETでは0.333秒に注意

ADO.NETでは、datetimeデータ型のデータを取得する際に、300分の1秒(0.333ミリ秒)の部分が切り捨てられてしまう点に注意する。  
例えば、データが「2016/6/5 04/30/12.467」であれば、「467」の部分が切り捨てられてしまう。  
このままでは、更新条件のWHERE句を正しく記述出来なくなり、他のユーザーの同時更新をチェックできなくなってしまう。  

300分の1秒を切り捨てないようにするには、`CONVERT関数`を利用して文字列として更新時刻を取得するようにする。  

``` sql
SELECT a,b,
    CONVERT(char(11),更新時刻,111) + CONVERT(char(12),更新時刻,114) AS 更新時刻
FROM T1
-- 111 : yy/mm/dd
-- 114 : hh:mi:ss:mmm
```

SQLServer2012以降であれば`FORMAT関数`を利用して取得可能。  

``` sql
FORMAT(更新時刻,'yyyy/MM/dd hh:mm:ss.fff')
```
