# SQLServer関係メモ

[SQL Serverチートシート](https://qiita.com/esflat/items/7885e53737163eb955fe)  

---

## DISTINCTとワイルドカードの併用

DISTINCTとワイルドカード `*` を併用したら.NETFrameworkでは実行速度が遅くなるらしい  

---

## パフォーマンス改善

パフォーマンスによる影響  
・クエリの応答速度低下→コマンドタイムアウトの発生  
・CPU負荷の情報  

---

## 統計情報

これまで普通に使えていた SQL Server が急に遅くなった、夜間の更新処理に異常に時間がかかるようになった。  
といったとき、統計情報が古くなっていて実行プランが正しく選択されていないことががあります。  

統計情報を最新にすることで正しい実行プランが選択されるようになり、パフォーマンスが改善されることがあります。  

[SQL Serverで統計情報を更新する。UPDATE STATISTICSの使い方](https://www.fenet.jp/dotnet/column/database/sql/5389/)  
[統計情報を更新してクエリのパフォーマンスを改善する](https://www.projectgroup.info/tips/SQLServer/MSSQL_00000027.htm)  

---

## sp_updatestats

データベース単位で統計情報を更新するストアドプロシージャ。  

そのデータベースに存在する全てのインデックス、列 の統計情報を更新する。  
全部実行するので時間はかかる。  

・何を実行しても遅い場合  
・定期的に全部キレイにしたい場合  
・特定のクエリではなく全体的にクエリ パフォーマンスが低下している場合  
・どのテーブルのインデックス、列 の統計情報を更新すべきか明確に特定できていない場合  

等の場合において使用するとよい。  

``` sql
EXEC sp_updatestats
GO
```

[【保存版】クエリ パフォーマンスが著しく低下した場合の一時的な対処方法 (SQL Server/Azure SQL Database)](https://www.nobtak.com/entry/sqlp01)  
[統計情報を更新してクエリのパフォーマンスを改善する](https://www.projectgroup.info/tips/SQLServer/MSSQL_00000027.htm)  

---

## CONSTRAINT PRIMARY KEY CLUSTERED

CONSTRAINT句でPRIMARY KEYを設定する時、今までCLUSTERED句を書いて来なかったのだが、databaseProjectから自動生成されるクエリにはCLUSTERD句が書いてあった。  
CLUSTERD句がなくても動くことは知っていたのだが、この場合の動作はどのようになるのか調べた。  

公式でも、大抵の文献でも、CLUSTERED句はセットで記述されており、デフォルトの動作がどうなのかどこにも書いていなかったのだが、ようやくそれについて言及している記事を見つけた。  
書かなくても自動的にクラスター化インデックスになる模様。  
まぁ、書いておいて損はないだろう。  

>主キーは自動的にクラスタ化インデックスになるので、例示のCLUSTEREDはなくても動きます。  
>
>[SQL Serverチートシート](https://qiita.com/esflat/items/7885e53737163eb955fe)  

---

## SQLを止める方法

GOTOするかTHROWする。  
RETURNはストアドでしか使えない。  

検索文字列 : sqlserver t-sql 途中終了  

[T-SQL STOP or ABORT command in SQL Server](https://stackoverflow.com/questions/2028072/t-sql-stop-or-abort-command-in-sql-server)  

---

## クラスター化インデックスと非クラスター化インデックス

[SQL Server/SQL Database再入門 第2回 Index SeekとIndex Scan](https://qiita.com/yyukawa/items/4cc1cd5e447b5a5d1b48)  

[【SQL】ゼロ知識から実行計画を読み解きパフォーマンス改善](https://qiita.com/yoshinori_hisakawa/items/5ef0cf4fd8eb6dd3037f)  
[【SQL】ゼロ知識からSQLのパフォーマンスを考えられるようになるまで](https://qiita.com/yoshinori_hisakawa/items/f5d608d302ede8f9883d)  

実行計画の見方  
[use-the-index-luke](https://use-the-index-luke.com/ja/sql/explain-plan/sql-server/operations)  

>主キー列(PRIMARY KEY 制約を設定した列)には、デフォルトで「クラスター化インデックス」という種類のインデックスが作成されます。  
>Clustered Index Scan はテーブルスキャンと同等の内部動作  

Table Scan : テーブル全体の検索  
Clustered Index Scan : テーブルスキャンと同等の内部動作  
Clustered Index Seek : クラスター化インデックスでの一意検索(ピンポイント検索)や部分的なスキャンを意味する。  

---

## 制約名を変更する方法

`EXEC sp_rename N'Tamp_Table_PKC', N'Table_PKC', N'OBJECT';`  

■以下、昔の書き込み  

削除して追加する。  
制約名を更新する命令はない模様。  

``` sql : 主キー制約の変更
-- 制約削除
ALTER TABLE [テーブル名] DROP CONSTRAINT [削除する制約名]

-- 制約の追加
ALTER TABLE [テーブル名] ADD CONSTRAINT [追加する制約名]
PRIMARY KEY ([フィールド1],[フィールド2],...)
```

外部キー制約を確認するクエリ  

``` sql
select * from sys.key_constraints
```

[【SQL Server】外部キー制約の一覧を確認する](https://sqlserver.work/2021/01/06/%E3%80%90sys-foreign_keys-%E3%80%91%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E5%88%B6%E7%B4%84%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B/)  

---

[SQLServer: int型のID値を持つテーブルをできる限り短時間でbigint型に変更する - Qiita](https://qiita.com/maaaaaaaa/items/cdab2d91127ec8169ff1)  

---

## ON PRIMARY句

CREATE TABLE するときの`ON [PRIMARY]`句が何を指しているのか分からなかったので調査。  

``` sql
CREATE TABLE [dbo].[TableName](
    [columnA] [int] NULL,
    [columnB] [nvarchar](50) NULL,
    ・・・
) ON [PRIMARY]
```

[SQL ServerのON [PRIMARY]句って何を意味してるの？ファイルグループの概念も解説 | 煎茶](https://www.simpletraveler.jp/2022/04/09/sql-server%E3%81%AEon-primary%E5%8F%A5%E3%81%A3%E3%81%A6%E4%BD%95%E3%82%92%E6%84%8F%E5%91%B3%E3%81%97%E3%81%A6%E3%82%8B%E3%81%AE%EF%BC%9F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B0%E3%83%AB/)  
