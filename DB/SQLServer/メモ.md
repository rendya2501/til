# SQLServer関係メモ

[SQL Serverチートシート](https://qiita.com/esflat/items/7885e53737163eb955fe)  

---

## 変更の保存が許可されていません

null許可のフィールドを追加した時に発生。  

- 対処法  
  1. [ツール] メニューの [オプション] をクリック。  
  2. [オプション] ウィンドウのナビゲーション ウィンドウ で 、[デザイナー] をクリック。  
  3. [テーブルの再作成を必要とする変更の保存を防止する] チェックボックスをオンまたはオフにし 、[OK] をクリック。  

SQLServer2008から「NULL/NOT NULLの設定を変更」、「列の順序を変更」、「データ型を変更」、「既存の列の前に新しい列の追加」を行った場合にこのエラーが発生するようになった。(2005以前は発生しない)  

例えば、「社員番号」列が「NULL」へ設定されている場合に、PRIMARY KEY制約を設定しようとすると、PRIMARY KEY制約は暗黙的にNOT NULLへ設定変更を行うため、このエラーが発生する。  

他にも、「発生原因としてはテーブルの監視履歴が削除されてしまうから」とか。  

[SQL Server カラム定義を変更すると「変更の保存が許可されていません」が表示された場合の対処法](https://nasunoblog.blogspot.com/2013/10/sql-server-column-edit-error.html)  
[変更の保存は、エラー メッセージで許可SSMS](https://docs.microsoft.com/ja-jp/troubleshoot/sql/ssms/error-when-you-save-table)  

---

## テーブルデザイナーにコメント列を追加する方法

あると便利といわれたのでまとめ。  
レジストリをいじらないと駄目です。  

[SSMS のテーブルデザイナの列をカスタマイズした](https://qiita.com/d01tsumath/items/906043d69f86a6a53cef)  
[SQL Server Management Studio のテーブルデザイナの列をカスタマイズする](https://blog.xin9le.net/entry/2018/06/17/165526)  

---

## DISTINCTとワイルドカードの併用

DISTINCTとワイルドカード `*` を併用したら.NETFrameworkでは実行速度が遅くなるらしい  

---

## 移行におけるあれこれ

Aデータベースの動作が不安定なのでBデータベースを新しく立てて、そちらにデータを移動させることになった。  
デタッチしてmdfファイルを直接移動させて、アタッチする方式を取ろうとしたが、エラーが発生してうまく行かなかった。  
エラーの内容は以下の通り。  

``` txt
TITLEMicrosoft SQL Server Management Studio
------------------------------

データベース 'sample_database' の復元に失敗しました。 (Microsoft.SqlServer.Management.RelationalEngineTasks)

------------------------------
ADDITIONAL INFORMATION:

Transact-SQL ステートメントまたはバッチの実行中に例外が発生しました。 (Microsoft.SqlServer.SmoExtended)

------------------------------

データベース 'sample_database' は、オブジェクト 'sample_tabel' の一部または全体でデータ圧縮または vardecimal ストレージ形式が有効になっているため、このエディションの SQL Server では開けません。データ圧縮および vardecimal ストレージ形式がサポートされているのは、SQL Server Enterprise Edition だけです。
データベース 'sample_database' は、このエディションの SQL Server では起動できません。このデータベースには、パーティション関数 'sample_func' が含まれています。パーティション分割は SQL Server Enterprise Edition でしかサポートされません。
SQL Server の現在のエディションではデータベース機能の一部が使用できないため、データベース 'sample_database' を開くことができません。 (Microsoft SQL Server、エラー: 909)

ヘルプを表示するには https://docs.microsoft.com/sql/relational-databases/errors-events/mssqlserver-909-database-engine-error をクリック
```

[sqlserver error 909]  
このエラー自体は上位エディション(Enterprise Edition)から下位エディション()に移行した時に発生する現象な模様。  
しかし、`SELECT SERVERPROPERTY('Edition');`このクエリで確認してみると、AもBもStandard Editionであった。  

色々調べた結果、テーブルに圧縮の設定がされている場合に発生してしまう模様。  
調査クエリで確認したり、圧縮の設定を解除するクエリを流したり、直接テーブルの設定を変えたらうまく行った。  

DB単位で Enterprise Edition のどの機能を使用しているかを確認するクエリ

``` sql
select * from sys.dm_db_persisted_sku_features
```

データ圧縮されているオブジェクトのリストを表示するクエリ

``` sql
SELECT
    SCHEMA_NAME(sys.objects.schema_id) AS SchemaName
    ,OBJECT_NAME(sys.objects.object_id) AS ObjectName
    -- VarDecimalStorage 形式の圧縮があるかどうかを確認する
    ,OBJECTPROPERTY ( OBJECT_ID ( OBJECT_NAME(sys.objects.object_id) ), 'TableHasVarDecimalStorageFormat' )
    ,[rows]
    ,[data_compression_desc]
FROM sys.partitions
INNER JOIN sys.objects ON sys.partitions.object_id = sys.objects.object_id
WHERE data_compression > 0 AND SCHEMA_NAME(sys.objects.schema_id) != 'SYS'
ORDER BY SchemaName, ObjectName
```

データ圧縮オプションを「なし」にしてインデックスを再構築し、圧縮を無効にするクエリ。  

``` sql
ALTER INDEX ALL ON sample_table REBUILD WITH ( DATA_COMPRESSION = None );
```

上記クエリは1行ずつしか実行できないのでカーソル処理としたもの。  

``` sql
--カーソルの値を取得する変数宣言
DECLARE @ObjectName varchar(255)

--カーソル定義
DECLARE CUR_AAA CURSOR FOR
    SELECT OBJECT_NAME(sys.objects.object_id) AS ObjectName
    FROM sys.partitions
    INNER JOIN sys.objects ON sys.partitions.object_id = sys.objects.object_id
    WHERE data_compression > 0 AND SCHEMA_NAME(sys.objects.schema_id) != 'SYS'
    ORDER BY ObjectName

--カーソルオープン
OPEN CUR_AAA;

--最初の1行目を取得して変数へ値をセット
FETCH NEXT FROM CUR_AAA
INTO @ObjectName;

--データの行数分ループ処理を実行する
WHILE @@FETCH_STATUS = 0
BEGIN

    -- ========= ループ内の実際の処理 ここから===
    EXEC('ALTER INDEX ALL ON ' + @ObjectName + ' REBUILD WITH ( DATA_COMPRESSION = None );')
    -- ========= ループ内の実際の処理 ここまで===

    --次の行のデータを取得して変数へ値をセット
    FETCH NEXT FROM CUR_AAA
    INTO @ObjectName;
END

--カーソルを閉じる
CLOSE CUR_AAA;
DEALLOCATE CUR_AAA;
```

なんかのついでに拾ったクエリ。  
一応参考程度に残しておく。  

``` sql
SELECT s.[name]+'.'+o.[name] AS [object], i.[type_desc] COLLATE database_default+ISNULL(' '+i.[name], '') AS index_name,
       (CASE WHEN COUNT(DISTINCT p.partition_number)>1 THEN 'Is partitioned' ELSE '' END) AS [partitioned?],
       ISNULL(MIN(NULLIF(p.data_compression_desc, 'NONE'))+' compression', '') AS [compressed?],
       (CASE WHEN ISNULL(OBJECTPROPERTY(p.[object_id], 'TableHasVarDecimalStorageFormat'), 0)=0 THEN '' ELSE 'vardecimal' END) AS [vardecimal?]
FROM sys.partitions AS p
INNER JOIN sys.indexes AS i ON p.[object_id]=i.[object_id] AND p.index_id=i.index_id
INNER JOIN sys.objects AS o ON i.[object_id]=o.[object_id]
INNER JOIN sys.schemas AS s ON o.[schema_id]=s.[schema_id]
GROUP BY p.[object_id], s.[name], o.[name], i.index_id, i.[type_desc], i.[name]
ORDER BY s.[name], o.[name], i.index_id
```

[Microsoft SQL Server: エラー: 909 データベースを SQL Server 2008 の SQL Server Enterprise Edition から任意の下位エディションに移行中に発生する](http://www.thesqlpost.com/2012/06/microsoft-sql-server-error-909-while.html)  
[SQL Server 2008 R2 で新しい (ContosoRetailDW) を作成するときのエラー 909。エラー 909 を受け取り、](https://social.msdn.microsoft.com/Forums/en-US/0057feb1-2034-448c-a9ea-c66484b048ba/error-909-when-creating-new-contosoretaildw-on-sql-server-2008-r2-receiving-error-909?forum=sqlgetstarted)  
[Enterprise Edition の DB バックアップを Standard Edition にリストア](https://blog.engineer-memo.com/2014/12/24/enterprise-edition-%E3%81%AE-db-%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%82%92-standard-edition-%E3%81%AB%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2/)  

---

## SQLServerのバージョンを確認する

単純に出力するクエリ

``` sql
PRINT @@VERSION;

-- 出力結果
-- Microsoft SQL Server 2016 (RTM) - 13.0.1601.5 (X64) 
--    Apr 29 2016 23:23:58 
--    Copyright (c) Microsoft Corporation
--    Standard Edition (64-bit) on Windows Server 2016 Standard 6.3 <X64> (Build 14393: ) (Hypervisor)
```

``` sql
SELECT
    CASE 
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '8%' THEN 'SQL2000'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '9%' THEN 'SQL2005'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '10.0%' THEN 'SQL2008'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '10.5%' THEN 'SQL2008 R2'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '11%' THEN 'SQL2012'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '12%' THEN 'SQL2014'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '13%' THEN 'SQL2016'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '14%' THEN 'SQL2017' 
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '15%' THEN 'SQL2019' 
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '16%' THEN 'SQL2022' 
        ELSE 'unknown'
    END AS MajorVersion,
    SERVERPROPERTY('ProductLevel') AS ProductLevel,
    SERVERPROPERTY('Edition') AS Edition,
    SERVERPROPERTY('ProductVersion') AS ProductVersion


IF SERVERPROPERTY('ProductVersion') >= 11
    BEGIN
        PRINT 11;
    END
ELSE
    BEGIN
        PRINT 10;
    END
```

[How to tell what SQL Server versions you are running](https://www.mssqltips.com/sqlservertip/1140/how-to-tell-what-sql-server-version-you-are-running/)

---

## パフォーマンス改善

パフォーマンスによる影響  
・クエリの応答速度低下→コマンドタイムアウトの発生  
・CPU負荷の情報  

---

## 統計情報

これまで普通に使えていた SQL Server が急に遅くなった、夜間の更新処理に異常に時間がかかるようになった。  
といったとき、統計情報が古くなっていて実行プランが正しく選択されていないことががあります。  

統計情報を最新にすることで正しい実行プランが選択されるようになり、パフォーマンスが改善されることがあります。  

[SQL Serverで統計情報を更新する。UPDATE STATISTICSの使い方](https://www.fenet.jp/dotnet/column/database/sql/5389/)  
[統計情報を更新してクエリのパフォーマンスを改善する](https://www.projectgroup.info/tips/SQLServer/MSSQL_00000027.htm)  

---

## sp_updatestats

データベース単位で統計情報を更新するストアドプロシージャ。  

そのデータベースに存在する全てのインデックス、列 の統計情報を更新する。  
全部実行するので時間はかかる。  

・何を実行しても遅い場合  
・定期的に全部キレイにしたい場合  
・特定のクエリではなく全体的にクエリ パフォーマンスが低下している場合  
・どのテーブルのインデックス、列 の統計情報を更新すべきか明確に特定できていない場合  

等の場合において使用するとよい。  

``` sql
EXEC sp_updatestats
GO
```

[【保存版】クエリ パフォーマンスが著しく低下した場合の一時的な対処方法 (SQL Server/Azure SQL Database)](https://www.nobtak.com/entry/sqlp01)  
[統計情報を更新してクエリのパフォーマンスを改善する](https://www.projectgroup.info/tips/SQLServer/MSSQL_00000027.htm)  

---

## CONSTRAINT PRIMARY KEY CLUSTERED

CONSTRAINT句でPRIMARY KEYを設定する時、今までCLUSTERED句を書いて来なかったのだが、databaseProjectから自動生成されるクエリにはCLUSTERD句が書いてあった。  
CLUSTERD句がなくても動くことは知っていたのだが、この場合の動作はどのようになるのか調べた。  

公式でも、大抵の文献でも、CLUSTERED句はセットで記述されており、デフォルトの動作がどうなのかどこにも書いていなかったのだが、ようやくそれについて言及している記事を見つけた。  
書かなくても自動的にクラスター化インデックスになる模様。  
まぁ、書いておいて損はないだろう。  

>主キーは自動的にクラスタ化インデックスになるので、例示のCLUSTEREDはなくても動きます。  
>
>[SQL Serverチートシート](https://qiita.com/esflat/items/7885e53737163eb955fe)  

---

## SQLを止める方法

GOTOするかTHROWする。  
RETURNはストアドでしか使えない。  

検索文字列 : sqlserver t-sql 途中終了  

[T-SQL STOP or ABORT command in SQL Server](https://stackoverflow.com/questions/2028072/t-sql-stop-or-abort-command-in-sql-server)  

---

## クラスター化インデックスと非クラスター化インデックス

[SQL Server/SQL Database再入門 第2回 Index SeekとIndex Scan](https://qiita.com/yyukawa/items/4cc1cd5e447b5a5d1b48)  

[【SQL】ゼロ知識から実行計画を読み解きパフォーマンス改善](https://qiita.com/yoshinori_hisakawa/items/5ef0cf4fd8eb6dd3037f)  
[【SQL】ゼロ知識からSQLのパフォーマンスを考えられるようになるまで](https://qiita.com/yoshinori_hisakawa/items/f5d608d302ede8f9883d)  

実行計画の見方  
[use-the-index-luke](https://use-the-index-luke.com/ja/sql/explain-plan/sql-server/operations)  

>主キー列(PRIMARY KEY 制約を設定した列)には、デフォルトで「クラスター化インデックス」という種類のインデックスが作成されます。  
>Clustered Index Scan はテーブルスキャンと同等の内部動作  

Table Scan : テーブル全体の検索  
Clustered Index Scan : テーブルスキャンと同等の内部動作  
Clustered Index Seek : クラスター化インデックスでの一意検索(ピンポイント検索)や部分的なスキャンを意味する。  

---

## 制約名を変更する方法

`EXEC sp_rename N'Tamp_Table_PKC', N'Table_PKC', N'OBJECT';`  

■以下、昔の書き込み  

削除して追加する。  
制約名を更新する命令はない模様。  

``` sql : 主キー制約の変更
-- 制約削除
ALTER TABLE [テーブル名] DROP CONSTRAINT [削除する制約名]

-- 制約の追加
ALTER TABLE [テーブル名] ADD CONSTRAINT [追加する制約名]
PRIMARY KEY ([フィールド1],[フィールド2],...)
```

外部キー制約を確認するクエリ  

``` sql
select * from sys.key_constraints
```

[【SQL Server】外部キー制約の一覧を確認する](https://sqlserver.work/2021/01/06/%E3%80%90sys-foreign_keys-%E3%80%91%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E5%88%B6%E7%B4%84%E3%81%AE%E4%B8%80%E8%A6%A7%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B/)  

---

## SQL Serverのバージョンが異なるため復元に失敗する

探しても文献が出てこない。  
大抵の場合は、CREATEスクリプトを生成してデータを移行しろという事しか書いていない。  

[SQL Serverのバージョンが異なるため復元に失敗する - Qiita](https://qiita.com/miltood/items/b2c79a62c7e5604f216d)  

---

[SQLServer: int型のID値を持つテーブルをできる限り短時間でbigint型に変更する - Qiita](https://qiita.com/maaaaaaaa/items/cdab2d91127ec8169ff1)  

---

## ローカルサーバーでSQLServer認証する

ローカルサーバーはWindows認証一択だが、あえてSQLServer認証するならどのような設定をするのか気になったのでまとめ。  

まずSQL ServerでMixed Mode認証が有効になっていることを確認する。  
Mixed Mode認証は、Windows認証とSQL Server認証の両方をサポートする。  

**SQL ServerでMixed Mode認証を有効にする方法:**

1. SQL Server Management Studio (SSMS) を開きます。  
2. オブジェクト エクスプローラで、対象のSQL Serverインスタンスに接続します。  
3. サーバー名を右クリックし、[プロパティ] を選択します。  
4. [セキュリティ]ページを開きます。  
5. [サーバー認証] セクションで、[SQL ServerおよびWindows認証モード] を選択します。  
6. [OK] をクリックして変更を適用します。  
7. SQL Server サービスを再起動して変更を反映させます。  
8. オブジェクト エクスプローラで、対象のSQL Serverインスタンスに接続します。  
9. サーバー名を展開し、[セキュリティ] フォルダを展開します。  
10. [セキュリティ] フォルダの下にある [ログイン] フォルダを右クリックし、[新しいログイン] を選択します。  
11. [ログイン - 新規] ウィンドウが開きます。  
12. [ログイン名] フィールドに、新しいユーザー名（ID）を入力します。  
13. [認証] セクションで、[SQL Server認証] を選択します。  
14. [パスワード] と [パスワードの確認] フィールドに、新しいパスワードを入力します。  
15. [パスワードポリシーを適用] のチェックボックスがオンになっている場合、パスワードポリシーを適用します。適用しない場合は、チェックボックスをオフにします。  
16. 左側のペインで [サーバー ロール] を選択し、必要に応じてユーザーにロールを割り当てます。例えば、ユーザーに管理者権限を付与する場合は、[sysadmin] チェックボックスをオンにします。  
17. 左側のペインで [ユーザー マッピング] を選択し、ユーザーがアクセスできるデータベースを選択し、必要に応じてデータベースロールを割り当てます。  
18. 必要に応じて他の設定を行い、[OK] をクリックして新しいログインを作成します。  

新しいログインが作成されたら、先ほど作成したIDとパスワードを使用してSQL Serverに接続できます。
