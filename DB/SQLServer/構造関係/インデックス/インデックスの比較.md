# インデックスの比較

2つのデータベースを比較して、インデックスで差分があるものを抜き出したい。

---

## データベースのインデックス一覧を取得する

[このサイト](https://sql55.com/query/sql-server-list-all-indexes.php)で紹介されている例。  
実行したデータベースのインデックス情報を出力するクエリとなる。  

``` sql
SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    sys.indexes AS I
       INNER JOIN sys.objects AS O
          ON I.object_id = O.object_id
       INNER JOIN sys.schemas AS S
          ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
ORDER BY 
    S.name,
    O.name,
    I.name;
```

## 少し拡張

``` sql
SELECT
    [O].[name] AS [ObjectName],
    [I].[name] AS [IndexName],
    [I].[type_desc] AS [IndexTypeDesc],
    [I].[is_primary_key] AS [IsPrimaryKey],
    [I].[is_unique] AS [IsUnique],
    [I].[is_disabled] AS [IsDisabled],
    [IndexKeys] = STUFF((
        SELECT
            CONCAT(
                ', ',
                [AC].[name],
                CASE
                    WHEN [is_descending_key] = 1 THEN ' - DESC'
                    ELSE ''
                END
            )
        FROM
            [Database].[sys].[index_columns] AS [IC]
            JOIN [Database].[sys].[all_columns] AS [AC]
            ON  [IC].[object_id] = [AC].[object_id]
            AND [IC].[column_id] = [AC].[column_id]
        WHERE
            [IC].[object_id] = [I].[object_id]
            AND [IC].[index_id] = [I].[index_id]
            AND [is_included_column] = 0 
            FOR XML PATH(''), TYPE
    ).value('.', 'VARCHAR(MAX)'), 1, 2, '')
FROM
    [Database].[sys].[indexes] AS [I]
    INNER JOIN [Database].[sys].[objects] AS [O]
    ON [I].[object_id] = [O].[object_id]
WHERE
    [I].[index_id] > 0
    AND [O].[is_ms_shipped] = 0
ORDER BY 
    [O].[name]
```

---

## Diff方式

単純に差分を取得しただけ

``` sql
-- src
SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    src.sys.indexes AS I
       INNER JOIN src.sys.objects AS O
          ON I.object_id = O.object_id
       INNER JOIN src.sys.schemas AS S
          ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
EXCEPT
SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    dst.sys.indexes AS I
       INNER JOIN dst.sys.objects AS O
          ON I.object_id = O.object_id
       INNER JOIN dst.sys.schemas AS S
          ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
ORDER BY
    S.name,
    O.name,
    I.name


SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    dst.sys.indexes AS I
       INNER JOIN dst.sys.objects AS O
          ON I.object_id = O.object_id
       INNER JOIN dst.sys.schemas AS S
          ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
EXCEPT
SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    src.sys.indexes AS I
       INNER JOIN src.sys.objects AS O
          ON I.object_id = O.object_id
       INNER JOIN src.sys.schemas AS S
          ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
ORDER BY
    S.name,
    O.name,
    I.name
```

``` sql
DECLARE @Sourcedb sysname  = 'master';

EXEC ('
SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    ' + @Sourcedb + '.sys.indexes AS I
       INNER JOIN ' + @Sourcedb + '.sys.objects AS O
          ON I.object_id = O.object_id
       INNER JOIN ' + @Sourcedb + '.sys.schemas AS S
          ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
')
```

---

## FULL OUTER JOIN 方式

``` sql
SELECT
    *
FROM
    (
        SELECT
            S.name AS SchemaName,
            O.name AS ObjectName,
            I.name AS IndexName,
            I.type_desc AS IndexTypeDesc,
            I.is_primary_key AS IsPrimaryKey,
            I.is_unique AS IsUnique,
            I.is_disabled AS IsDisabled
        FROM
            src.sys.indexes AS I
               INNER JOIN src.sys.objects AS O
                  ON I.object_id = O.object_id
               INNER JOIN src.sys.schemas AS S
                  ON O.schema_id = S.schema_id
        WHERE
            I.index_id > 0
            AND O.is_ms_shipped = 0
    ) AS [SrcTable]
    FULL JOIN
        (
        SELECT
            S.name AS SchemaName,
            O.name AS ObjectName,
            I.name AS IndexName,
            I.type_desc AS IndexTypeDesc,
            I.is_primary_key AS IsPrimaryKey,
            I.is_unique AS IsUnique,
            I.is_disabled AS IsDisabled
        FROM
            dst.sys.indexes AS I
               INNER JOIN dst.sys.objects AS O
                  ON I.object_id = O.object_id
               INNER JOIN dst.sys.schemas AS S
                  ON O.schema_id = S.schema_id
        WHERE
            I.index_id > 0
            AND O.is_ms_shipped = 0
    ) AS [DstTable]
        ON
        [SrcTable].SchemaName = [DstTable].SchemaName
        AND [SrcTable].ObjectName = [DstTable].ObjectName
        AND [SrcTable].IndexName = [DstTable].IndexName
        AND [SrcTable].IndexTypeDesc = [DstTable].IndexTypeDesc
WHERE
    [SrcTable].[SchemaName] IS NULL
    OR [DstTable].[SchemaName] IS NULL
```

``` sql

EXEC('
SELECT
    *
FROM
    (
        SELECT
            S.name AS SchemaName,
            O.name AS ObjectName,
            I.name AS IndexName,
            I.type_desc AS IndexTypeDesc,
            I.is_primary_key AS IsPrimaryKey,
            I.is_unique AS IsUnique,
            I.is_disabled AS IsDisabled
        FROM
            ' + @SourceDataBaseName + '.sys.indexes AS I
               INNER JOIN ' + @SourceDataBaseName + '.sys.objects AS O
                  ON I.object_id = O.object_id
               INNER JOIN ' + @SourceDataBaseName + '.sys.schemas AS S
                  ON O.schema_id = S.schema_id
        WHERE
            I.index_id > 0
            AND O.is_ms_shipped = 0
    ) AS [SrcTable]
    FULL JOIN
        (
        SELECT
            S.name AS SchemaName,
            O.name AS ObjectName,
            I.name AS IndexName,
            I.type_desc AS IndexTypeDesc,
            I.is_primary_key AS IsPrimaryKey,
            I.is_unique AS IsUnique,
            I.is_disabled AS IsDisabled
        FROM
            ' + @TargetDataBaseName + '.sys.indexes AS I
               INNER JOIN ' + @TargetDataBaseName + '.sys.objects AS O
                  ON I.object_id = O.object_id
               INNER JOIN ' + @TargetDataBaseName + '.sys.schemas AS S
                  ON O.schema_id = S.schema_id
        WHERE
            I.index_id > 0
            AND O.is_ms_shipped = 0
    ) AS [DstTable]
        ON
        [SrcTable].SchemaName = [DstTable].SchemaName
        AND [SrcTable].ObjectName = [DstTable].ObjectName
        AND [SrcTable].IndexName = [DstTable].IndexName
        AND [SrcTable].IndexTypeDesc = [DstTable].IndexTypeDesc
WHERE
    [SrcTable].[SchemaName] IS NULL
    OR [DstTable].[SchemaName] IS NULL
')
```

---

## 実験

``` sql
DECLARE @Sourcedb sysname  = 'src' 
DECLARE @Destdb sysname = 'dst' 
DECLARE @SQL varchar(max) 


SELECT @SQL = ' SELECT ISNULL(SoSource.name,SoDestination.name) ''Object Name'' 
                     , CASE  
                       WHEN SoSource.object_id IS NULL      THEN SoDestination.type_desc +  '' missing in the source -- '  
                                                                                         + @Sourcedb + ''' COLLATE database_default 
                       WHEN SoDestination.object_id IS NULL THEN SoSource.type_desc      +  '' missing in the Destination -- ' + @Destdb  
                                                                                         + ''' COLLATE database_default 
                       ELSE SoDestination.type_desc + '' available in both Source and Destination'' COLLATE database_default 
                       END ''Status'' 
                 FROM (SELECT * FROM ' + @Sourcedb + '.SYS.objects  
                        WHERE Type_desc not in (''INTERNAL_TABLE'',''SYSTEM_TABLE'',''SERVICE_QUEUE'')) SoSource  
      FULL OUTER JOIN (SELECT * FROM ' + @Destdb + '.SYS.objects  
                        WHERE Type_desc not in (''INTERNAL_TABLE'',''SYSTEM_TABLE'',''SERVICE_QUEUE'')) SoDestination 
                   ON SoSource.name = SoDestination.name COLLATE database_default 
                  AND SoSource.type = SoDestination.type COLLATE database_default 
                  ORDER BY isnull(SoSource.type,SoDestination.type)' 

EXEC (@Sql)
```

``` sql
SELECT
    ISNULL(SoSource.name,SoDestination.name) 'Object Name',
    CASE  
        WHEN SoSource.object_id IS NULL THEN SoDestination.type_desc + ' missing in the source --  Src' COLLATE database_default 
        WHEN SoDestination.object_id IS NULL THEN SoSource.type_desc + ' missing in the Destination -- Dst' COLLATE database_default 
        ELSE SoDestination.type_desc + ' available in both Source and Destination' COLLATE database_default 
    END 'Status'
FROM
    (
        SELECT * 
        FROM Src.SYS.objects  
        WHERE Type_desc not in ('INTERNAL_TABLE','SYSTEM_TABLE','SERVICE_QUEUE')
    ) SoSource  
    FULL OUTER JOIN 
        (
            SELECT * 
            FROM Dst.SYS.objects  
            WHERE Type_desc not in ('INTERNAL_TABLE','SYSTEM_TABLE','SERVICE_QUEUE')
        ) SoDestination 
        ON SoSource.name = SoDestination.name COLLATE database_default 
        AND SoSource.type = SoDestination.type COLLATE database_default 
ORDER BY 
    isnull(SoSource.type,SoDestination.type)
```

``` sql
SELECT
    *,
    STUFF((
            SELECT
                ', ' + sys.all_columns.name + CASE
                    WHEN is_descending_key = 1 THEN ' - DESC'
                    ELSE ''
                END
            FROM
                sys.index_columns
                JOIN
                    sys.all_columns
                ON  sys.index_columns.object_id = sys.all_columns.object_id
                AND sys.index_columns.column_id = sys.all_columns.column_id
            WHERE
                sys.index_columns.object_id = sys.indexes.object_id
            AND sys.index_columns.index_id = sys.indexes.index_id
            AND is_included_column = 0 FOR XML PATH(''),
                TYPE
        ).value('.', 'VARCHAR(MAX)'), 1, 2, '') AS IndexKeys,
    STUFF((
            SELECT
                ', ' + sys.all_columns.name + CASE
                    WHEN is_descending_key = 1 THEN ' - DESC'
                    ELSE ''
                END
            FROM
                sys.index_columns
                JOIN
                    sys.all_columns
                ON  sys.index_columns.object_id = sys.all_columns.object_id
                AND sys.index_columns.column_id = sys.all_columns.column_id
            WHERE
                sys.index_columns.object_id = sys.indexes.object_id
            AND sys.index_columns.index_id = sys.indexes.index_id
            AND is_included_column = 1 FOR XML PATH(''),
                TYPE
        ).value('.', 'VARCHAR(MAX)'), 1, 2, '') AS IncludedColumns
FROM
    sys.indexes
    INNER JOIN sys.objects AS O
        ON sys.indexes.object_id = O.object_id
WHERE
    index_id > 0
    AND is_ms_shipped = 0


SELECT
    S.name AS SchemaName,
    O.name AS ObjectName,
    I.name AS IndexName,
    I.type_desc AS IndexTypeDesc,
    I.is_primary_key AS IsPrimaryKey,
    I.is_unique AS IsUnique,
    I.is_disabled AS IsDisabled
FROM
    sys.indexes AS I
        INNER JOIN sys.objects AS O
            ON I.object_id = O.object_id
        INNER JOIN sys.schemas AS S
            ON O.schema_id = S.schema_id
WHERE
    I.index_id > 0
    AND O.is_ms_shipped = 0
```

[index - Compare Indexes/Constraints between two SQL Server databases - Database Administrators Stack Exchange](https://dba.stackexchange.com/questions/76997/compare-indexes-constraints-between-two-sql-server-databases)  

---

[SQL Server: データベース内の全てのインデックス (index) を取得する - 便利なT-SQL＆クエリー集 - SQL Server 入門](https://sql55.com/query/sql-server-list-all-indexes.php)  

compare indexes between 2 databases sql server

[sys.indexes (Transact-SQL) - SQL Server | Microsoft Learn](https://learn.microsoft.com/ja-jp/sql/relational-databases/system-catalog-views/sys-indexes-transact-sql?view=sql-server-ver16)  
