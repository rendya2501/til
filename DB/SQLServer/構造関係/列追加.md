# SQLServer 任意の位置に列を追加する構文

---

## 概要

ManagementStudio ではデザイナで任意の場所に列を追加することが可能。  

T-SQL(Transact-SQL)の場合、そのようなコマンドは存在しないので以下のような手順を踏んでフィールドを追加する必要あり。  
そもそも、MySQL以外のデータベースではカラム追加時の位置指定が軒並み不可能な模様。  

[浦下.com](https://urashita.com/archives/13652)  

---

## 手順

1. 新テーブルの作成  
2. 新テーブルへデータ投入  
3. 元テーブルの削除  
4. 新テーブルのリネーム  
5. キー名のリネーム  
6. コメントの作成  

---

## フォーマット

``` sql
BEGIN TRY
    BEGIN TRAN
    -- ①新テーブルの作成
    CREATE TABLE [Tamp_Table] (
        filed1,
        filed2,
        new_column,
        CONSTRAINT [Tamp_Table_PKC] PRIMARY KEY CLUSTERED (MainKey)
    )

    -- ②新テーブルへデータ投入
    INSERT INTO [Tamp_Table]
    SELECT [filed1],[filed2]... FROM [Table]

    -- ③元テーブルの削除
    DROP TABLE [Table]

    -- ④新テーブルのリネーム
    EXEC sp_rename N'Tamp_Table', N'Table';
    -- ⑤キー名のリネーム
    EXEC sp_rename N'Tamp_Table_PKC', N'Table_PKC', N'OBJECT';

    -- ⑥コメントの作成
    EXECUTE sp_addextendedproperty N'MS_Description', N'テーブル論理名', N'SCHEMA', N'dbo', N'TABLE', N'TestTable', NULL, NULL;
    EXECUTE sp_addextendedproperty N'MS_Description', N'カラム論理名', N'SCHEMA', N'dbo', N'TABLE', N'Table', N'COLUMN', N'カラム物理名';

    COMMIT TRAN
END TRY
BEGIN CATCH
    ROLLBACK TRAN
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage
END CATCH
```

この構文の場合、テーブルを作った地点で主キーを設定した場合何か弊害があるのだろうか？
できるなら作ってしまったほうが手間が省けてよさそうに見えるが？  
後、コメントもテーブル作ったタイミングでできないか？  
テーブル名を変更した時、コメントも影響受けるのだろうか？  
そこもしっかり把握していくか。  

テーブルを生成した地点で主キーを設定しても問題ない。  
テーブル名を変更しても問題なく主キーが有効であった。  
コメントはテーブル名を指定しないといけないので、元のテーブルが新しくなった後にやらないと駄目なので、テーブル生成と同じタイミングでやるならテーブル名を全部書き換えないといけない。  
それをやっていいなら生成と同時にできるけど、そうじゃないなら最後にやるべし。  

CONSTRAINT名はユニークである必要がある。  
`[TestTable],[TestTable_PKC]`と`[TestTable2],[TestTable_PKC]`だとエラーになる。  
なので主キーもTempで置き換えないと重複してエラーとなる。  
なので、テーブルを作成した地点で元のテーブルで使っていた主キー名を入れると、CREATE TABLEの地点でエラーとなる。  

``` txt
メッセージ 2714、レベル 16、状態 5、行 1
データベースに 'TestTable_PKC' という名前のオブジェクトが既に存在します。
メッセージ 1750、レベル 16、状態 1、行 1
制約またはインデックスを作成できませんでした。以前のエラーを調べてください。
```

---

## ボツフォーマット

備忘録として残しておく。  
なぜだめかというと`SELECT * INTO FROM`方式ではインデックスの情報などはコピーしないため。  
データの移行自体は問題なくできるが、完全にテーブルの情報をコピーするわけではないので、お勧めしない。  

1. テーブルをバックアップ  
2. テーブルを削除  
3. テーブルを再作成  
4. 再作成したテーブルにバックアップからリストア  

``` SQL
BEGIN TRY
    BEGIN TRAN
    -- ①対象テーブルのデータをテンポラリテーブルにバックアップ
    SELECT * INTO #Temp FROM TBL_USER

    -- ②対象テーブルを削除
    DROP TABLE TBL_USER

    -- ③カラムを追加して対象テーブルを再作成
    CREATE TABLE TBL_USER
    (
        UserNo int NOT NULL DEFAULT (0),
        Name nvarchar(255) NOT NULL DEFAULT (),
        Age int NOT NULL DEFAULT (0),
        Addr nvarchar(255) NOT NULL DEFAULT (),
        Tel nvarchar(255) NOT NULL DEFAULT (),
        CONSTRAINT TBL_USER_PK PRIMARY KEY CLUSTERED (UserNo)
    )

    -- コメントも必要に応じて入れる
    EXECUTE sp_addextendedproperty N'MS_Description', N'コード', N'SCHEMA', N'dbo', N'TABLE', N'Src_Table', N'COLUMN', N'Code'

    -- ④テンポラリテーブルからバックアップデータを復元
    INSERT INTO TBL_USER
    SELECT
        UserNo,
        [Name],
        0,
        Addr,
        Tel
    FROM #Temp

    -- ⑤テンポラリテーブルを削除
    DROP TABLE #Temp

    COMMIT TRAN
END TRY
BEGIN CATCH
    ROLLBACK TRAN
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage
END CATCH
```

---

## 一番最後に列を追加する

一番最後に列を追加するのは当たり前なので割愛するが、コマンドはこんな感じ。

``` sql : TBK_USERに年齢カラムを追加するクエリ
ALTER TABLE TBL_USER ADD Age int DEFAULT 0
```
