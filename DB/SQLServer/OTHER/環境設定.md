# 環境設定

## 変更の保存が許可されていません

null許可のフィールドを追加した時に発生。  

- 対処法  
  1. [ツール] メニューの [オプション] をクリック。  
  2. [オプション] ウィンドウのナビゲーション ウィンドウ で 、[デザイナー] をクリック。  
  3. [テーブルの再作成を必要とする変更の保存を防止する] チェックボックスをオンまたはオフにし 、[OK] をクリック。  

SQLServer2008から「NULL/NOT NULLの設定を変更」、「列の順序を変更」、「データ型を変更」、「既存の列の前に新しい列の追加」を行った場合にこのエラーが発生するようになった。(2005以前は発生しない)  

例えば、「社員番号」列が「NULL」へ設定されている場合に、PRIMARY KEY制約を設定しようとすると、PRIMARY KEY制約は暗黙的にNOT NULLへ設定変更を行うため、このエラーが発生する。  

他にも、「発生原因としてはテーブルの監視履歴が削除されてしまうから」とか。  

[SQL Server カラム定義を変更すると「変更の保存が許可されていません」が表示された場合の対処法](https://nasunoblog.blogspot.com/2013/10/sql-server-column-edit-error.html)  
[変更の保存は、エラー メッセージで許可SSMS](https://docs.microsoft.com/ja-jp/troubleshoot/sql/ssms/error-when-you-save-table)  

---

## テーブルデザイナーにコメント列を追加する方法

あると便利といわれたのでまとめ。  
レジストリをいじらないと駄目です。  

[SSMS のテーブルデザイナの列をカスタマイズした](https://qiita.com/d01tsumath/items/906043d69f86a6a53cef)  
[SQL Server Management Studio のテーブルデザイナの列をカスタマイズする](https://blog.xin9le.net/entry/2018/06/17/165526)  

---

## SQLServerのバージョンを確認する

単純に出力するクエリ

``` sql
PRINT @@VERSION;

-- 出力結果
-- Microsoft SQL Server 2016 (RTM) - 13.0.1601.5 (X64) 
--    Apr 29 2016 23:23:58 
--    Copyright (c) Microsoft Corporation
--    Standard Edition (64-bit) on Windows Server 2016 Standard 6.3 <X64> (Build 14393: ) (Hypervisor)
```

``` sql
SELECT
    CASE 
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '8%' THEN 'SQL2000'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '9%' THEN 'SQL2005'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '10.0%' THEN 'SQL2008'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '10.5%' THEN 'SQL2008 R2'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '11%' THEN 'SQL2012'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '12%' THEN 'SQL2014'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '13%' THEN 'SQL2016'
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '14%' THEN 'SQL2017' 
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '15%' THEN 'SQL2019' 
        WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '16%' THEN 'SQL2022' 
        ELSE 'unknown'
    END AS MajorVersion,
    SERVERPROPERTY('ProductLevel') AS ProductLevel,
    SERVERPROPERTY('Edition') AS Edition,
    SERVERPROPERTY('ProductVersion') AS ProductVersion


IF SERVERPROPERTY('ProductVersion') >= 11
    BEGIN
        PRINT 11;
    END
ELSE
    BEGIN
        PRINT 10;
    END
```

[How to tell what SQL Server versions you are running](https://www.mssqltips.com/sqlservertip/1140/how-to-tell-what-sql-server-version-you-are-running/)

---

## ローカルサーバーでSQLServer認証する

ローカルサーバーはWindows認証一択だが、あえてSQLServer認証するならどのような設定をするのか気になったのでまとめ。  

まずSQL ServerでMixed Mode認証が有効になっていることを確認する。  
Mixed Mode認証は、Windows認証とSQL Server認証の両方をサポートする。  

**SQL ServerでMixed Mode認証を有効にする方法:**

1. SQL Server Management Studio (SSMS) を開きます。  
2. オブジェクト エクスプローラで、対象のSQL Serverインスタンスに接続します。  
3. サーバー名を右クリックし、[プロパティ] を選択します。  
4. [セキュリティ]ページを開きます。  
5. [サーバー認証] セクションで、[SQL ServerおよびWindows認証モード] を選択します。  
6. [OK] をクリックして変更を適用します。  
7. SQL Server サービスを再起動して変更を反映させます。  
8. オブジェクト エクスプローラで、対象のSQL Serverインスタンスに接続します。  
9. サーバー名を展開し、[セキュリティ] フォルダを展開します。  
10. [セキュリティ] フォルダの下にある [ログイン] フォルダを右クリックし、[新しいログイン] を選択します。  
11. [ログイン - 新規] ウィンドウが開きます。  
12. [ログイン名] フィールドに、新しいユーザー名（ID）を入力します。  
13. [認証] セクションで、[SQL Server認証] を選択します。  
14. [パスワード] と [パスワードの確認] フィールドに、新しいパスワードを入力します。  
15. [パスワードポリシーを適用] のチェックボックスがオンになっている場合、パスワードポリシーを適用します。適用しない場合は、チェックボックスをオフにします。  
16. 左側のペインで [サーバー ロール] を選択し、必要に応じてユーザーにロールを割り当てます。例えば、ユーザーに管理者権限を付与する場合は、[sysadmin] チェックボックスをオンにします。  
17. 左側のペインで [ユーザー マッピング] を選択し、ユーザーがアクセスできるデータベースを選択し、必要に応じてデータベースロールを割り当てます。  
18. 必要に応じて他の設定を行い、[OK] をクリックして新しいログインを作成します。  

新しいログインが作成されたら、先ほど作成したIDとパスワードを使用してSQL Serverに接続できます。
