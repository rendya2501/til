# SQLServer ネットワークの設定

---

## ネットワークを介したSQLServerへの接続

ネットワーク接続の有効化(Developer/Expressエディションのみ)とファイアウォールでのポート開放(既定のインスタンスの場合はTCP 1433)が必要になる。  

---

## ネットワーク接続の有効化(Developer/Expressエディションのみ)

SQLServer2016のDeveloperおよびExpressエディションでは、規定でネットワーク接続が無効(TCP/IPプロトコルが無効)に設定され、ローカル利用(同じマシン内での利用)に制限されている。  
これは、悪意のある攻撃者がネットワークを介してSQLServerへ簡単に侵入できないようにするための処置。  

ネットワーク接続を有効化(TCP/IPプロトコルを有効化)するには、「SQLServer構成マネージャー」ツールを利用する。  
「`SQLServerネットワークの構成`」を展開。  
「`MSSQLSERVERのプロトコル`」をクリックする(名前付きインスタンスとしてインストールしている場合は[<インスタンス名>のプロトコル]をクリックする)。  
一覧されるSQLServerのプロトコルの中から[TCP/IP]を右クリックして、[有効化]をクリックする。  
これにより、「変更の反映には、サービスの再起動が必要」という主旨のダイアログが表示されるので「OK」をクリックする。  
後は、SQLServerサービスを再起動すれば、ネットワーク接続の有効化は完了する。  

---

## ファイアウォールの解放 (TCP1433)

ネットワークを介してSQLServerへアクセスさせるには、ファイアウォールでのポート開放(受信の規則/例外の追加)も必要になる。  
規定ではファイアウォールが有効化されていて、SQLServerへ接続するためのポートが封鎖されているため。  

ファイアウォールでポートを解放するためには、[コントロールパネル]の[システムとセキュリティ]から[Windowsファイアウォール]をクリックする。  
[詳細設定]をクリックして、[セキュリティが強化されたWindowsファイアウォール]ウィンドウを起動する。  
[受信の規則]を右クリックして、[新しい規則]をクリックする。  
[規則の種類]ページで[ポート]を選択し、[プロトコルおよびポート]ページで[TCP]を選択して[特定のローカルポート]へ[1433]を入力する。  

次の[操作]ページでは、[接続を許可する]を選択し、[プロファイル]ページでは任意の適用場所を選択する。  

ドメイン内でのみ接続を許可したい場合は[ドメイン]のみをチェックする。  
ドメイン外など、異なるネットワークからの接続も許可したい場合には、[パブリック]もチェックする。  

次の[名前]ページで任意の規則名(TCP 1433など)を設定すれば、ポートの解放は完了。  

---

## ホスト名解決やOSレベルでの認証も必要

ネットワーク接続を有効化して、TCP 1433ポートを解放すれば、IPアドレスレベルでの接続ができるようになる。  
Management Studio やアプリケーションの接続文字列には、IPアドレスを指定することが可能。  

SQL Server の名前(ホスト名)で接続したい場合には、ホスト名解決(DNSサーバーやhostsファイルなどを利用したホスト名からIPアドレスへの変換)も必要。  

また、Windows認証での接続の場合には、WindowsOSレベルでの認証も必要になるため、ドメインユーザーを利用したり、異なるドメイン/ワークグループの場合には、同じユーザー名/パスワードのアカウントが必要になる。  

---

## 名前付きインスタンス (動的ポート,UDP 1434)

SQLServerを名前付きインスタンスとしてインストールしている場合には、TCP 1433ポートが利用されない。  

使用するポート番号は動的ポートとして設定され、これを確認するには[`SQLServer構成マネージャー`]ツールで[`SQLServerネットワークの構成`]の[`<インスタンス名>のプロトコル`]から[`TCP/IP`]プロトコルをダブルクリックする。  
[`TCP/IPのプロパティ`]ダイアログが表示されたら、[`IPアドレス`]タブを開き、一番下に表示される[`IP ALL`] セクションの[`TCP DynamicPorts`]\(動的ポート)を確認する。  
これが名前付きインスタンスが使用するポート番号となるため、Windowsファイアウォールの「`受信の規則`」でこのポート番号を追加していく必要がある。  

SQLServerへの接続時には、「`IPアドレス,動的ポート番号`」のようにカンマで区切ってポート番号を記述すれば名前付きインスタンスへ接続できるようになる(ホスト名解決ができる場合はIPアドレスの代わりにホスト名でも可)。  

「`マシン名￥インスタンス名`」形式で接続したい場合には、「`受信の規則`」で「`UDP 1434`」ポートも追加しておく必要がある。  
また、SQLServerBrowserサービスを開始しておく必要もある(SQLServerBrowserサービスは、名前付きインスタンスが利用している動的ポート番号の問い合わせに利用されている)。  

その他のSQLServer関連の機能(Reporting Service や Analysis Services など)が利用するポート番号については、オンラインブック以下の項目が参考になる。  
