# 日付リストとループ

---

## While方式

ただループして処理するだけならWhileループが一番お手軽。  

``` sql
DECLARE @StartDate DATE = '2020-01-01';
DECLARE @EndDate   DATE = '2020-01-15';

WHILE @StartDate <= @EndDate
BEGIN
    PRINT @StartDate;
    SET @StartDate = DATEADD(dd, 1, @StartDate);
END
```

- 参考  
  - [T-SQL - WHILE の使い方 - T-SQL 入門 - SQL Server 入門](https://sql55.com/t-sql/t-sql-while.php)  

---

## CTE方式

テーブルとして抽出したければ共通テーブル式(CTE)で再帰で生成すれば良い。  

### 案1

``` sql
DECLARE @StartDate DATE = '2020-01-01';
DECLARE @EndDate   DATE = '2020-01-20';

WITH [CTE_DAYS] AS
(
    SELECT @StartDate AS [YMD]
    UNION ALL
    SELECT DATEADD(DAY, 1, [YMD])
    FROM [CTE_DAYS]
    WHERE [CTE_DAYS].[YMD] < DATEADD(DAY, 0, @EndDate)
)
SELECT [YMD]
FROM [CTE_DAYS]
OPTION (MAXRECURSION 2000)
```

- 参考
  - [SQLで指定期間内の日付リストを取得する(連続値の生成) - Qiita](https://qiita.com/yaju/items/4bd4185aa9c1d14b23ca)  

### 案2

参考サイトの例をそのまま解析のために使わせてもらったが、別に案1でも同じようにできるので、こちらを採用する必要はないかも。  

``` sql
DECLARE @StartDate date = '2020-01-01';
DECLARE @EndDate   DATE = '2020-01-15';

WITH seq(n) AS
(
    SELECT 0
    UNION ALL
    SELECT n + 1
    FROM seq
    WHERE n < DATEDIFF(DAY, @StartDate, @EndDate)
),
d(d, youbi) AS
(
    SELECT DATEADD(DAY, n, @StartDate),DATENAME(WEEKDAY, DATEADD(DAY, n, @StartDate))
    FROM seq
)
SELECT d, youbi
FROM d
ORDER BY d
OPTION (MAXRECURSION 2000)
```

- 参考
  - [再帰SQLでの最大再帰数（SQL Server） | DB & SQL 技術ブログ](https://www.dbsheetclient.jp/blog/?p=2253)  

---

## カーソル処理

全くお勧めはしないけど、日付リストをカーソルで回すならこのようになる。  
長い。そしてパフォーマンスが悪い。  

``` sql
DECLARE @StartDate DATE = '2020-01-01';
DECLARE @EndDate   DATE = '2020-01-20';
DECLARE @businessDate DATE;

DECLARE CUR_AAA CURSOR FOR
    WITH [CTE_DAYS] AS
    (
        SELECT @StartDate AS [YMD]
        UNION ALL
        SELECT DATEADD(DAY, 1, [YMD])
        FROM [CTE_DAYS]
        WHERE [CTE_DAYS].[YMD] < DATEADD(DAY, 0, @EndDate)
    )
    SELECT [YMD]
    FROM [CTE_DAYS]
    OPTION (MAXRECURSION 2000)
-- CURSOR オープン
OPEN CUR_AAA;

-- CURSOR 最初の1行目を取得して変数へ値をセット
FETCH NEXT FROM CUR_AAA INTO @businessDate;

-- CURSOR ループ
WHILE @@FETCH_STATUS = 0
BEGIN
    -- ========= ループ内の実際の処理 ここから===
    PRINT @businessDate;
    -- ========= ループ内の実際の処理 ここまで===

    -- CURSOR 次の行のデータを取得して変数へ値をセット
    FETCH NEXT FROM CUR_AAA INTO @businessDate
END

-- CURSOR カーソルを閉じて、リソースを開放する
CLOSE CUR_AAA;
DEALLOCATE CUR_AAA;
```

---

## 参考

[T-SQL - WHILE の使い方 - T-SQL 入門 - SQL Server 入門](https://sql55.com/t-sql/t-sql-while.php)  
[SQLで指定期間内の日付リストを取得する(連続値の生成) - Qiita](https://qiita.com/yaju/items/4bd4185aa9c1d14b23ca)  
[再帰SQLでの最大再帰数（SQL Server） | DB & SQL 技術ブログ](https://www.dbsheetclient.jp/blog/?p=2253)  
