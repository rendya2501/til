# ストアドプロシージャ(Stored Procedure)

## ストアドプロシージャとは

まとめて処理したいデータベース操作を1つのオブジェクトとしてデータベースサーバー上に保存したもの。  
Storeは「保存する」「蓄える」、Procedureは「手続き」「手順」という意味。  
ストアドプロシージャの作成には、`Transact-SQL(T-SQL)`ステートメントを使用する。  

因みにOracleでストアドプロシージャを作成する場合は、`PL/SQL`、PostgreSQLでは`PL/pgSQL`を利用する。  

---

## ストアドプロシージャのメリット

主に3つ存在する。  

### テーブル構造の隠蔽とセキュリティの強化

テーブルに対する捜査権限を取り消し(REVOKE)、ストアドプロシージャ経由のみでテーブル操作を行えるようにすることで、一般ユーザーからテーブルを直接操作されることを防ぐことができる。  

### アプリケーションロジックの共有化

ストアドプロシージャは任意のアプリケーションから呼び出すことができるため、同じような処理を行うアプリケーションを複数作成する場合には、その部分を共有化できる。  

### パフォーマンスの向上

ストアドプロシージャを利用すると、プロシージャキャッシュへコンパイル済みの実行プランを格納できるため、SQLステートメントを解釈するオーバーヘッドを軽減できる。  
また、ネットワーク上を流れるSQLステートメントも少なくすることができる。  

---

## ストアドプロシージャの作成

ストアドプロシージャは、`CREATE PROCEDURE`ステートメントを利用して作成することができる。  
構文は次の通り。  

``` sql
CREATE PROCEDURE ストアドプロシージャ名
AS
    任意のT-SQLステートメント
```

`AS`以下に実行したいT-SQLステートメントを記述する。  

`PROCEDURE`は`PROC`と省略可能。  
「CREATE PROC」と記述もできる。  

`CREATE ORICEDURE`ステートメントはバッチの先頭に記述する必要がある。  
バッチの先頭で記述しないとエラーとなる。  

例 : proc1という商品テーブルを検索するストアドプロシージャを作成する  

``` sql
CREATE PROCEDURE proc1
AS
    SELECT * FROM 商品 WHERE 区分コード = 8
```

---

## ストアドプロシージャの変更

ストラテジーパターンを変更するには、「ALTER PROCEDURE」ステートメントを使用する。  

``` sql
ALTER PROCEDURE proc1
@param1 int
AS
    SELECT * FROM 商品 WHERE 区分コード = @param1
```

パラメーターの名前には「@param1」、データ型には「int」を指定し、これをWHERE句の条件式で「区分コード=@param1」として利用している。  
引数の設定に関しては別で解説する。  

---

## ストアドプロシージャの削除

ストアドプロシージャを削除する場合は、「DROP PROCEDURE」ステートメントを使用する。  

``` sql
DROP PROCEDURE ストアドプロシージャ名
```

---

## ストアドプロシージャの実行

- ストアドプロシージャ名を指定して実行する。  

``` sql
proc1
```

- EXECUTEステートメントを利用して実行する。  

``` sql
EXEC proc1
```

ストアドプロシージャの名前だけを指定して実行できるのは、バッチの先頭にある場合だけ。  
エラーを回避するためには「GO」を間に入れてバッチを区切るかEXECUTEステートメントを使用する。  

EXECUTE(EXEC)ステートメントを利用した場合は、バッチ内の任意の場所からストアドプロシージャを実行することができる。  

---

## 引数付きのストアドプロシージャの実行

``` sql
proc1 6
```

``` sql
proc1 @param1 = 6
```

---

## 入力パラメーターの利用

ストアドプロシージャは**入力パラメーター(引数)**を利用することで、汎用性を持たせることができる。  

``` sql
CREATE PROCEDURE ストアドプロシージャ名
@パラメータ名1 データ型 [= 初期値],
@パラメータ名2 データ型 [= 初期値], …
AS
    任意のT-SQLステートメント
```

ストアドプロシージャ名とASの間に入力パラメーターを宣言し、パラメーターの名前には先頭に「@」を付ける必要がある。  
それぞれのパラメーターには、データ型を指定し、データ型の隣に「=」を記述した場合は、初期値も設定することができる。  

---

## パラメーターの入力チェック

パラメーターが省略された場合には、エラーを返すように入力チェックを行うことも可能。  
パラメーターの初期値を「NULL」に設定して、NULLかどうかをチェックするIF文を記述することで実現できる。  

``` sql
ALTER PROCEDURE proc1
@param1 int = NULL
AS
    IF @param1 IS NULL
    BEGIN
        RAISERROR('パラメーターが未入力です!',16,1)
        RETURN
    END
    SELECT * FROM 商品 WHERE 区分コード = @param1
```

RAISERRORの第1引数は「エラーメッセージ」、第2引数に「エラーの重大度レベル」、第3引数に「状態」を指定する。  
`RETURN`ステートメントは「ストアドプロシージャの強制終了」を明示する。  
RETURNの記述がない場合は、その下のステートメントが実行されてしまう。  

---

## バッチの先頭に記述する必要があるステートメント

- CREATE PROCEDURE  
- CREATE VIEW  
- CREATE FUNCTION  
- CREATE TRIGGER  

---

## ビューとの違い

ビューの場合は、AS以下に記述できるのはSELECTステートメントのみで、UPDATEやDELETEなどの更新系ステートメントを記述することができない。  
また、変数や流れ制御、トランザクションといったT-SQLの要素や、パラメーター化を行うこともできない。  
ストアドプロシージャであれば、これらを利用することができる。  

ビューは、"仮想表"とも呼ばれるように、あくまでも表に見せかけたものであるのに対して、ストアドプロシージャは何かしらの処理を行う手順(Procedure)を記述したプログラムとなる。  
