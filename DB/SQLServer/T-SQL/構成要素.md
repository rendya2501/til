# Transact-SQLの構成要素

標準規格のSQLでは、データベースサーバーを操作する上では足りない部分があるので、各データベース製品はそれらを補うために独自の拡張を行っている。  
SQLServerの場合は「Transact-SQL」(T-SQL)、Oracleでは「PL/SQL」(Procedural Language Extensions to SQL)、PostgreSQLでは「PL/pgSQL」(PL/SQLのPostgreSQL版)といった具合。  
こうした拡張SQLは、変数宣言や流れ制御といった、プログラミング言語的な要素やバックアップや定期メンテナンスなど、運用管理系の操作などが実装されている。  
これら、拡張SQLの実装方法はデータベース製品によって異なるため、互換性がない。  
これはSQLの「方言」(ダイアレクト : Dialect)とも呼ばれている。  

---

## DECLARE ローカル変数の利用

T-SQLでは、他のプログラミング言語と同じように変数を利用することができる。  
変数はローカル変数(Local Variable)と呼ばれ、「`DECLARE`」ステートメントで宣言し、`SELECT`または`SET`ステートメントで値を代入する。  

■**DECLAREステートメントの構文**

``` sql
DECLARE @変数名1 データ型[=初期値],@変数名2 データ型 [=初期値]
```

■**値の代入**  

T-SQLでは、変数名の先頭に「`@`」をつける必要がある。  
データ型の隣には、`=`を付けて初期値を指定することも可能。(変数宣言時に初期値を代入できるようになったのは2008以降)  

``` sql
SELECT @変数名1 = 代入したい値,@変数名2 = 代入したい値

-- または

SET @変数名1 = 代入したい値
SET @変数名2 = 代入したい値
```

変数@xと@yをint型で宣言し、SELECTステートメントで値を代入。  
変数@zは宣言時に値を代入。  

``` sql
DECLARE @x int, @y int, @z varchar(20) = 'YYY'
SELECT @x = 77,xu = 88
SELECT @x,@y,@z
```

SETステートメントでは、複数の変数を一度に扱うことができない。  
以下のようにするとエラーとなる。  
SETステートメントを利用して変数を代入する場合は、1行ずつ(1つの変数ごとに)行う必要がある。  

``` sql
DECLARE @x int, @y int
SET @x = 77,xu = 88

-- メッセージ 102、レベル 15、状態 1、行 2
-- ',' 付近に不適切な構文があります。
```

## SELECTステートメントの結果をローカル変数へ代入

ローカル変数には、SELECTステートメントで取得した値を代入することもできる。  

``` sql
DECLARE @shimei varchar(50), @hiredate datetime
SELECT @shimei = 氏名, @hiredate = 入社日 FROM 社員 WHERE 社員番号 = 1
SELECT @shimei, @hiredate
```

SELECTステートメントで取得した結果をローカル変数へ代入する場合は、SELECTステートメントの結果が1件になるようにWHERE句の条件式を指定する必要がある。  
ローカル変数へは、1つの値しか格納できないため。  
もし、複数の結果が返却される場合は、最後に取得した値が変数へ格納されるが、SELECTステートメントでは、ORDER BY句を指定しない限り順序に保証はないため、そのような利用方法はお勧めできない。  

---

## GO

GOコマンドはSQLServerにおける処理の区切りを表す。  

SQLServerに対してまとめて処理させたいステートメントの"塊"を**バッチ**と呼ぶ。  
クエリエディターで選択した範囲がバッチとなる。  
選択していない場合はクエリエディター内へ記述した全てのステートメントが1つのバッチとして扱われる。  
そのバッチを区切るためのコマンドが**goコマンド**。(goコマンドがバッチ終了の合図)  

従って、次のようにDECLAREによる変数宣言の後にgoを記述した場合、「変数宣言がされていない」という主旨のエラーが発生する。  

``` sql
DECLARE @x int;
go

-- スカラー変数 "@x" を宣言してください。
SELECT @x = 77;
SELECT @x;
```

### GOコマンドで気を付けること

GOの最後にコロンをつけてはいけない。  
エラーになる。  

```sql
DECLARE @test varchar(10) = 'hogehoge';
SELECT @test;
GO;
-- メッセージ 102、レベル 15、状態 1、行 7
-- 'GO' 付近に不適切な構文があります。
```

[SQL ServerのGOコマンドとは？](https://sql-oracle.com/sqlserver/?p=708)  
[GOとセミコロンってなんだろうか](https://sotoattanito.hatenablog.com/entry/2015/10/08/230340)  

---

## 文末 (セミコロンと半角スペース)

T-SQLでは、セミコロン「`;`」または「半角スペース」があると、文末(ステートメントの末尾・区切り)とみなされる。  

``` sql
DECLARE @x int;SET @x=77;SELECT @x;
```

「DECLAREによる変数宣言」と「SETによる変数への値の代入」、「変数の参照」を1行で記述している。  
それぞれの間にセミコロンを記述することで、文末として扱うことができるので、このような記述が可能。  
半角スペースでも可能だが、分かりにくいのでなるべくセミコロンを利用すべし。  

## 半角スペースでの文末はT-SQL独特

半角スペースが文末を意味するのは、T-SQLならではの特徴。  
多くのデータベース製品では、セミコロンのみが文末を意味するので、半角スペースでの文末はなるべく利用しないようにすべし。  

---

## コメント (`--` と `/* */`)

T-SQLでは、「`-`」(ハイフン2つ)と、「`/*`」と「`*/`」で囲んだ範囲をコメントとして扱うことができる。  
「`-`」は1行、「`/*`」と「`*/`」は複数行をコメント化したい場合に利用する。  

---

## PRINTステートメント

PRINTステートメントはクエリエディターの[結果]ウィンドウへメッセージを出力したい場合に利用する。  

``` sql
PRINT `出力したい文字列` またはローカル変数
```

このステートメントはアプリケーションを作成する上ではほとんど利用しないが、クエリエディターで変数の値や関数の処理結果を確認したい場合や、運用管理系のSQLを実行したい場合は非常に便利なステートメント。  

---

## GOTO

任意の場所(指定したラベル)へジャンプすることができる。  
基本的にあまり利用しない。  

``` sql
GOTO ラベル

ラベル:
    -- 実行したいステートメント
```

``` sql
GOTO test
SELECT * FROM 社員
test:
PRINT 'aaaa'

-- SELECT文は実行されない。
```

---

## WAITFOR DELAY

`WAITFOR DELAY`ステートメントは処理を数秒間待機したい場合に利用する。  
動作検証等wお行う場合に役立つステートメント。  

``` sql
WAITFOR DELAY '待機したい時間'
```

3秒待機した後にSELECT文を実行する場合。  

``` sql
WAITFOR DELAY `00:00:03`
SELECT * FROM 社員
```
