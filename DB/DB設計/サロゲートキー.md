# サロゲートキー(代理キー)

## サロゲートキーとは？

業務上発生するデータ(「商品コード」など)とは異なる、連番やUUIDなど人工的に生成された一意な値をもつキーのことをサロゲートキー(代理キー)と呼ぶ。  
複合主キーを避ける目的等で使用される。  
あくまでユニークになる連番であるため、業務的には意味は持たない。  

商品テーブル  
|||
|---|---|
|PK|**内部ID**|
||会社コード</br>商品コード</br>商品名</br>価格</br>...|

[DB データのサロゲートキー | knooto](https://knooto.info/software-design-surrogate-key/)  

---

## メリット

- 簡単にデータの一意性が確保できる  

- 業務データが変更になっても主キーや外部キーに影響がない  
  - 業務上のコードが主キーの場合、コード体系が変更になったら主キー含め、別テーブルの外部キーにも影響が出る。  

- クエリ操作が楽  
  - CRUDでの指定が基本的に単独主キーで行える。  

- アプリケーション側の処理を統一させやすい。  
  - 全テーブルが常に同じ形式の主キーを保持しているため。  

[DB データのサロゲートキー | knooto](https://knooto.info/software-design-surrogate-key/)  

---

## 連番の留意点

- DBが分散されているなどで連番の一意性が保証できない構成になる場合、サロゲートキーに連番を使用できない。  
  - UUIDなどで一意性を保証する必要がある。  

- 挿入と削除を繰り返す処理が必要な場合、連番が急激に進む。  
  - サロゲートキーの型がもしint32の場合、「2,417,483,647」で連番が枯渇するので、最低限bitingにする。  

- アプリケーション上で連番がユーザーに見える場合、下記のような状況が発生することがある。  
  - URLに連番がパラメーターとして付与されている場合、ユーザーに番号の推測がされやすくなる。  
    - 見えているパラメーターが1000の場合、1001に書き換えてアクセスされるなど、試行されやすい。  
  - 連番自体が自然キー化する場合がある。  
    - 連番をゼロ埋めして見積もり番号などに使ってしまっている場合等。  
    - 「同じ番号 + 枝番の見積書を作りたい」という要件が後から発生したら破綻する。  

[DB データのサロゲートキー | knooto](https://knooto.info/software-design-surrogate-key/)  

---

## サロゲートキーの特徴

- **テーブル間の依存関係が希薄**  
   サロゲートキーの場合、業務の変更により、主キーの体系が変化した場合などの影響が少ない。  
   ナチュラルキーの場合、参照する様々なエンティティに影響が生じるため、影響が大きい。  

- **画面間引継ぎの情報や実装などを統一できる**  
   全てのテーブルでサロゲートキーとしてIDを持った場合、削除や更新などすべての処理でその行に対する処理をIDで行うことが可能となる。  
   ナチュラルキーの場合、特定のキーが必要となるが、異なるテーブルでは、一意と特定するために必要なキーが異なる。  
   全てのテーブルでサロゲートキーとしてIDを持つなどすると、必要なキーは統一され、画面間で引き継ぐ情報や実装を統一することが可能となるが、一概に良いとは言えない。  
   コードを自動生成するツールを作る場合など、実装を容易にするという面では良いかもしれない。  

- **複合主キーのテーブルに比べSQLの条件が簡潔に実装できる**  
   ナチュラルキーを複合主キーとして使った場合、主キーに対するあらゆる操作が複雑になる。  
   サロゲートキーの場合、1項目でレコードを一意に特定することができるという点でSQLを簡潔に記載することができる。  

- **業務上は意味のないキーであるため、容量を余分に使ったりする**  
   サロゲートキーは業務上必要なものでは無いため、DBの容量などを考えると余分な容量を使うことになる。  
   DBに容量によるコストやパフォーマンスなどを考慮するとデメリットとなる。  

ナチュラルキーは業務上必要な項目であるため、必ずテーブルに持つことになり、データの解析性などを勘定するとメリットも大きい。  
サロゲートキーのように業務上必要ではない項目とはいえ、システム設計を行う上で考慮することも出てくるはず。  

[DB設計 サロゲートキーとナチュラルキー - Qiita](https://qiita.com/masapiko/items/05c393379c2eb42c86f5)  
