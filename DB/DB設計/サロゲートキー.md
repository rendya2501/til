# サロゲートキー(代理キー)

システム的にユニークな値になるようにDB設定等においてオートインクリメントで連番を設定しているテーブルのPKのことをサロゲートキー(代理キー)と呼ぶ。  
あくまでユニークになる連番であるため、業務的には意味は持たない。  

---

## サロゲートキーの特徴

1. **テーブル間の依存関係が希薄**  
   サロゲートキーの場合、業務の変更により、主キーの体系が変化した場合などの影響が少ない。  
   ナチュラルキーの場合、参照する様々なエンティティに影響が生じるため、影響が大きい。  

2. **画面間引継ぎの情報や実装などを統一できる**  
   全てのテーブルでサロゲートキーとしてIDを持った場合、削除や更新などすべての処理でその行に対する処理をIDで行うことが可能となる。  
   ナチュラルキーの場合、特定のキーが必要となるが、異なるテーブルでは、一意と特定するために必要なキーが異なる。  
   全てのテーブルでサロゲートキーとしてIDを持つなどすると、必要なキーは統一され、画面間で引き継ぐ情報や実装を統一することが可能となるが、一概に良いとは言えない。  
   コードを自動生成するツールを作る場合など、実装を容易にするという面では良いかもしれない。  

3. **複合主キーのテーブルに比べSQLの条件が簡潔に実装できる**  
   ナチュラルキーを複合主キーとして使った場合、主キーに対するあらゆる操作が複雑になる。  
   サロゲートキーの場合、1項目でレコードを位置に特定することができるという点でSQLを完結に記載することができる。  

4. **業務上は意味のないキーであるため、容量を余分に使ったりする**  
   サロゲートキーは業務上必要なものでは無いため、DBの容量などを考えると余分な容量を使うことになる。  
   DBに容量によるコストやパフォーマンスなどを考慮するとデメリットとなる。  

ナチュラルキーは業務上必要な項目であるため、必ずテーブルに持つことになり、データの解析性などを勘定するとメリットも大きい。  
サロゲートキーのように業務上必要ではない項目とはいえ、システム設計を行う上で考慮することも出てくるはず。  

[DB設計 サロゲートキーとナチュラルキー - Qiita](https://qiita.com/masapiko/items/05c393379c2eb42c86f5)  

---

## ナチュラルキー(自然キー)

業務的にそのテーブルをユニークにし、キーそのものに意味が含まれているものをナチュラルキーと呼ぶ。  
社員テーブルにおける、社員コード(PK)のように、業務的に意味のあるキーがPKとなっている場合、ナチュラルキーとなる。  

---

## サロゲートキーとナチュラルキー 1

[DB データのサロゲートキー | knooto](https://knooto.info/software-design-surrogate-key/)  

---

## サロゲートキーとナチュラルキー 2

### どちらを使うべきか？

ナチュラルキーとサロゲートキーはどちらが優れているというものでは無い。  
サロゲートキーは、システム開発においての１つの思考であり、業務的に必ず必要というわけではない。  
しかし、ナチュラルキーだけではシステム開発をする上で、どうしても難しく解決が困難なことが多々あると思われる。  
それぞれのメリット・デメリットを理解し、適切なDB設計をすることが大事となる。  

### ピヨピヨの使い分け  

得に制約がなければ、ナチュラルキーを使う。  
フレームワーク等の制約がある場合や、後々がっつりと変更が入りそうな場合のみ、しぶしぶサロゲートキーを使う。  

主キーに設定した項目は個別にインデックスを設定しなくてよい。  
主キーに設定した項目は個別に制約をかけなくてよい。  
パッと見てデータ構造が把握しやすい。  

の理由から、ナチュラルキーを好む模様。  
特に3の理由が大きいらしい。  

「拡張性を考えるとサロゲートキーの方が使い勝手が良い」という理屈もわかるが、論理的に入ってくるはずのデータは物理的にも入らないようにしておく方が好みだとか。  

[「ナチュラルキー」と「サロゲートキー」の違い｜「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典](https://wa3.i-3-i.info/diff100key.html)  

---

## データベーススペシャリスト 複合キーと代理キー

Q. 関係データベース上に実装するエンティティの主キーが複合キーであり，複合キーを構成している属性数が多すぎるので，少なくして扱いやすくしたい。この場合の対応として，適切なものはどれか。  

A. 複合キーを連番などの代理のキー(surrogate key)に置き換え、複合キーを構成している属性を代理キー(alternate key)にする。  

**複合主キー**は、複数の属性の組み合わせを主キーとして使用するものです。  
複合主キーには本来持ち合わせている属性だけを使用してテーブルの構成することができるというメリットもあるのですが、主キーの属性数が多すぎると「**1.SQLの結合演算記述が煩雑になる**」「**2.テーブル間の依存度が高くなる**」「**3.コードの仕様変更の影響を受けやすい**」などの弊害が問題になってくる。  
このような時はデータをシンプルに扱うために、単一でレコードを特定可能な属性をテーブルに追加し、複合キーの代わりにそれを主キーとする手法が用いられる。  
この追加されて主キーとなる属性を**代理キー**(サロゲートキー)といい、通常は連番コードなどのように値の固有性を容易に確保しやすいものを設定する。  
値事態に業務上の意味がない注文Noや会社IDなどがこれに該当する。  

主キーでなくなった複合キーは、主キーの要件を満たしているが、主キーに指定されていないため、代理キー(alternate key)という扱いになる。  

[平成22年春期問4 複合キーと代理キー｜データベーススペシャリスト.com](https://www.db-siken.com/kakomon/22_haru/am2_4.html)  

---

## 複合主キー(自然キー) vs. 人工キー

実際の開発では、3つ以上の項目から構成される複合主キーが存在することは珍しくない。  
しかし、主キーを構成する項目が多くなると、SQLステートメントやプログラム記述が複雑になる。  
これを回避するために、人工的な主キー(識別子)を追加することもある。  

人工的な主キーは、「人工キー」「人為キー」「サロゲートキー(代理キー)」とも呼ばれる。  
元々の主キーは「自然キー」(Natural Key)と呼ばれることもある。(人工に対して自然な主キーという意味)。  
全ての状況において、人工キーの追加を進めるわけではないが、人工キーを追加したほうが開発/保守しやすい場合は、追加すべし。  

[SQLServer 2016の教科書より]  

---

[DB設計 サロゲートキーとナチュラルキー - Qiita](https://qiita.com/masapiko/items/05c393379c2eb42c86f5)  
[「ナチュラルキー」と「サロゲートキー」の違い｜「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典](https://wa3.i-3-i.info/diff100key.html)  

[DB データのサロゲートキー | knooto](https://knooto.info/software-design-surrogate-key/)  
[システム開発の本質とは～単独主キー主義 VS 複合主キー許容派～ | TALON](https://talon.jp/info/345/)  
[データモデリングの先生 | TALON](https://talon.jp/info/324/)  
[SQLアンチパターン勉強会　第三回：IDリクワイアド - Qiita](https://qiita.com/ayayo/items/ba38853bca0c2cc2acb7)  
[サロゲートキーについて - 今日も元気に真人間](https://glory-hm.hatenablog.com/entry/2018/05/12/130000)  
