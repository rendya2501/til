# 8.論理設計のグレーノウハウ

データベースの論理設計には、明確にバッドノウハウとは言えないものの、きわどいライン上に位置するグレーゾーンが存在する。  
グレーゾーンは、利点と欠点のバランスが拮抗しており、使用の際は慎重な判断が求められる。  

- バッドノウハウ以外にも、違法スレスレの「グレーゾーン」の設計、グレーノウハウがある。  
- グレーノウハウは節度ある利用に留める限り、有効に作用する「良薬」になりえるが、利点と欠点のバランスを慎重に考える必要がある。  
- 代理キー、列持ちテーブル、アドホックな集計キー、多段ビューがある。  

---

## 8.2 代理キー ～主キーが役に立たない時

リレーショナルデータベースのテーブルにおいては、原則主キーが必ず必要であるが、その主キーを決めるのが容易ではないケースがある。  

### 主キーが決められない、または主キーとして不十分なケース  

- パターン1 : そもそも入力データに主キーにできるような一意キーが存在しない。  
- パターン2 : 一意キーはあるが、サイクリックに使いまわされる。  
- パターン3 : 一意キーはあるが、途中で指す対象が変化する。  

#### パターン1 : そもそも入力データに主キーにできるような一意キーが存在しない

最も単純だが、同時に言語道断なケースである。  
一意キーが存在しないのでは、主キーが決められない。  

信じがたいかもしれないが、業務システムによっては、実際にこういうデータを許容しているケースがある。  
例えば、入力インターフェースではレコードの2重登録を許容していて、後でレコードの重複を排除する処理が行われるような場合などがある。  

こういうケースでは、原理原則を言えば、そもそもそんなデータをテーブルに投入するべきではない。  
前段ヵ委のアプリケーションできちんとレコードを一意にして、「きれいな」状態にしてからデータベースへ投入するべきである。  
このように、そのままではデータベースに登録できない状態のデータを「きれいに」する処理を、その名もずばり「**データクレンジング(データの掃除)**」と呼ぶ。  
具体例は8.6にて取り上げるのでそちらを参照されたし。  

#### パターン2 : 一意キーはあるが、サイクリックに使いまわされる  

これは、主キーの値が全て使われてしまった場合に、既存の値が使われるケースで発生する。  
例えば、市町村の情報を管理するテーブルを考える。  
このテーブルの主キーとして「市町村コード」という「A + 3桁の数字」からなるコードを使うとする。  
すると、A000~A999までの1000個の市町村を登録してしまうと、そのままでは次に1001個目の市町村を登録することができない。  

この時、「市町村コードの桁数を拡張する」という選択を採ることができれば問題はないのだが、こうしたコードは業務ルール(=ビジネスロジック)によってシステムとは無関係に体系が決まっていることがある。  
これでは、市町村コードを使った履歴管理を行うことができず、主キーの役割を果たさない。  
同じ「A001」という市町村コードが、ある年度では「B市」を意味していたのが、その年を境に「Q市」になってしまう、ということが発生する。  
常に最新のコードしか使用しないのならこの運用でも問題はないが、時系列で過去のデータを取得した場合などには、履歴情報を残さなければ対応できない。  

#### パターン3 : 一意キーはあるが、途中で指す対象が変化する

このケースは、主キーの指す対象が途中で変わってしまうという点で、パターン2とよく似ている。  
ただ、その理由が値の枯渇ではないだけである。  

例えば、C町とD村が合併することになったとする。  
実質的にはD村がC町に吸収される形をとり、合併後の名前は引き続き「C町」が使われることになったとする。  

この場合、「A002」というコードは、表向きは継続的に「C町」を指している。  
しかし、その内実は合併を境に大きく変わっている。  
その証拠に、合併後の人口は合併前のC町(3万人)どD村(1万人)を合計した4万人になっているからである。  
本来であれば、やはりこの場合も合併前と合併後の情報は分けて履歴管理することが望ましいが、このコード体系ではそれができない。  

### 代理キーによる解決

パターン1~3のような問題を解決する手段として利用されるのが、**代理キー**(surrogate key)である。  
「サロゲートキー」とも呼ぶ。  

これは、名前の通り、入力データに最初から存在しているキーの「代理」として新たに追加するキーとなる。  
試しに、先ほどの市町村テーブルに、代理キーとして「市町村管理コード」という整数柄の代理キーを追加してみよう。  

---

## コラム 主キーはなぜ必要か？

リレーショナルデータベースにおいて、テーブルが主キーを持つことは必須である。  
言い換えれば、重複レコードの存在を認めない。  
これは、レコードを一意に特定することが一般的な業務システムでは要求されるから、というのが最大の理由ではあるが、では仮に、業務的にレコードの一意性が求められなかった場合、テーブルに主キーを設定しないことは許されるだろうか？  

実際、たまにあるのだが、何らかの記録を補完するだけの機能(「ジャーナルファイル」と呼ばれたりする)が求められる場合、レコードの一意性がなくても良い、という業務要件も存在する。  
こういう場合、リレーショナルデータベースのテーブルは、主キーを作らなくても良いのだろうか？  

その答えは、やはり「No」である。  
たとえ業務要件上、主キーが不要であったとしても、リレーショナルデータベースのテーブルには主キーが必要である。  
ここでは重要な1つの理由を説明する。  

まず、実際に「主キーがない」テーブルを許すとどのようなことが起きるかを考えてみよう。  

問題1 : 結果の重複を排除するためにDISTINCTを付ける必要がある。  
問題2 : 結合において多数のレコードを対象にする必要がある。  

どちらもパフォーマンスに悪影響を与える要因となる。  
問題1は結果に含まれるレコード数が少ない場合には大きな問題とはならないが、問題2が与える影響は甚大である。  
結合はSQLの行う処理の中でもコストが高く、結合レコード数を極力減らすことがSQLチューニングの基本となる。  
冗長なレコードを結合対象にすることは、その基本に真っ向から反対する行為なのだ。  

これはほんの一例に過ぎない。  
重複レコードを許すことによるパフォーマンスへの悪影響は他にもある。  
こうした理由からも、テーブルに主キーを付けることはリレーショナルデータベースにとって非常に重要な意味を持っているということが分かるだろう。  
