# 主キー

---

## 主キーはなくても動く

主キーを設定することがあまりにも当たり前すぎて、主キーなしという状態が許可されるのか分からなかったので確かめた。  
普通にいけた。  
もちろん重複したデータをいれることができる。  

``` sql
CREATE TABLE [IDENTITY_INSERT_TEST_TBL]  
(
    [Id] INT NOT NULL,  
    [Code] INT NOT NULL,
    [Name] nvarchar(255)
);

-- 重複レコードが余裕で入る
INSERT INTO [IDENTITY_INSERT_TEST_TBL] ([id],[Code],[Name]) 
VALUES(1,1,'A'),(1,2,'B'),(1,3,'C'),(1,1,'A'),(1,2,'B'),(1,3,'C');
```

---

## 主キーはアップデート可能か？

**可能**<!--  -->  

>プライマリキーは更新可能  
>データベースにおいて、プライマリキーを更新してもよいのでしょうか？  
>設計上は違和感がありますが、ほとんどのデータベースシステム (DBMS) では問題なく更新可能です。  
>プライマリキーを更新するかどうかは設計側の判断にゆだねられます。  
>[データベースでprimary keyを更新できるか？](https://urashita.com/archives/33098)  

<!--  -->
>更新は可能だが、1レコードを特定するための情報が変更されてしまうし、更新した値が他の値と被った場合エラーになるので、運用が難しくなる。  
>後、そうしなきゃいけない地点で設計が悪い。  
>マスターの主キーが更新された場合には関連するテーブルの全てを更新しなければいけなくなる可能性も存在する。  
><https://atmarkit.itmedia.co.jp/bbs/phpBB/viewtopic.php?topic=45369&forum=26>  

---

## 複合主キーの一部を複合インデックスの一部に含めることは可能か？

**可能**<!--  -->  

どういう時に必要なのかわからないので都度まとめることにする。  
因みに複合インデックスの一部をさらに別の複合インデックスの一部とすることも、もちろんできる。  

``` sql
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[TestTable](
    [SeqNo] [bigint] IDENTITY(1,1) NOT NULL,
    [OfficeCD] [nvarchar](3) NOT NULL,
    [TemplateName] [nvarchar](50) NULL,
    [TemplateString] [nvarchar](max) NULL,
    [AnalysisType] [tinyint] NULL,
    [Sort] [int] NULL,
    [ValidFlag] [bit] NULL
 CONSTRAINT [TestTable_PKC] PRIMARY KEY CLUSTERED 
(
    [SeqNo] ASC,
    [OfficeCD] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

-- 複合主キーの一部である[OfficeCD]と複合インデックスの一部とすることができる。
create index [IX1]
  on TestTable([OfficeCD],[Sort]);

-- また、複合インデックスの一部である[Sort]を別の複合インデックスの一部とすることもできる。
create index [IX2]
  on TestTable([Sort],[AnalysisType]);
```

---

## 複合主キーのインデックス

4つで複合主キーとしているところで3つしか検索条件としない場合、インデックスは効くのか？  
試してみた感じ、全てを含めたほうが、コストが低いことは観測出来た。  

複合主キー 全部指定しないと効かない?  
[複合主キーを避けるべき理由](https://torazuka.hatenablog.com/entry/20110713/pk)  
[システム開発の本質とは～単独主キー主義 VS 複合主キー許容派～](https://talon.jp/info/345/)  

Q. 複合主キーを設定した場合、自動的に複合インデックスとなるのか？
A. なるっぽい。  

主キーに対して自動的にインデックスは作成される。  
複合主キーでも同様で、自動的に複合インデックスを作成する。  

>データベースは、プライマリキーに対して自動的にインデックスを作成しますが、キーが複数の列からなる時は、さらに手動で調整をする 余地があります。  
>この場合、データベースはプライマリキーの全ての列にいわゆる 連結インデックス(あるいはマルチカラム インデックス、複合インデックス)を作成します。  
>複合インデックスの列の順番は、インデックスの使い勝手に大きな影響を及ぼすので、注意して決定する必要があります。  
[use-the-index-luke](https://use-the-index-luke.com/ja/sql/where-clause/the-equals-operator/concatenated-keys)  
