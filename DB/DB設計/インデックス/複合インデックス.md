# 複合インデックス

## 複合インデックスとは？

テーブルの複数のカラムを組み合わせて1つのインデックスとしたもの。  

---

## 複合インデックスのメリット

インデックスはキーと、そのキーを持つデータがテーブルのどの行に存在するかを特定する行IDから成り立っている。  

![Alt text](Asset/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-03-06%20221738.png)

上記のように、「姓」だけでインデックスを作成した場合を考える。  
姓が「佐藤」で名が「太郎」という条件で検索を実行すると、インデックスで3件のレコードがヒットする。  
次にそのヒットした3件のレコードのテーブルデータを1つずつ調べて、「名」が一致するかどうかを検査する。  

検索速度の観点からすると、「インデックスでの検索時間 + テーブルデータを調べる処理時間」 ということになるので、インデックスの検索だけで行を決定できる場合と比べて時間がかかる事になる。  

そこで今度は「姓」と「名」で複合インデックスとした場合を考える。  

![Alt text](Asset/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-03-06%20221717.png)

上記画像のように、複合インデックスとして検索した場合、姓が「佐藤」で名が「太郎」という条件での検索は、インデックスの検索だけで、行ID:0105が目的のデータであることを特定することができる。  

これが複合インデックスを作成するメリットである。  

[データベース／複合インデックスの落とし穴](https://www.gatc.jp/gat/it/it02dbindex.html)  

---

「顧客マスタ」のように何百万レコードもあるような場合は、同姓同名が相当な数存在することになる。  
なので、「生年月日」も複合インデックスに追加したくなる。  
次に「都道府県」次にまた何か、といった具合に何でもかんでも複合インデックスに含めたくなる事象が発生する。  

これも対処法がある模様。

[データベース／複合インデックスの落とし穴](https://www.gatc.jp/gat/it/it02dbindex.html)  

---

## 複合インデックスとした場合に、逆に速度が遅くなってしまう場合

[データベース／複合インデックスの落とし穴](https://www.gatc.jp/gat/it/it02dbindex.html)  

---

## 一部のキーを指定した場合、インデックスは効くのか？

Q.あるテーブルのカラム(C1, C2, C3) に対して複合インデックスを貼り、その一部のフィールドだけをwhereの条件とした場合、インデックスは効くのか？  

A.キーの先頭(今回の例でいえばC1)を含めれば効く。  
後はデータベースによる。  
[このサイト(複合インデックスは、構成列のどの列を指定すれば選択候補に挙がるのか。 - sgyatto's blog)](https://sgyatto.hatenablog.com/entry/2018/11/24/225938)では、データベース毎の仕様を紹介してくれている。  

>ここで問題になるのは複合インデクスの特徴の１つである、「キーとして構成されているカラムの全てが検索条件に指定されていなくても、キーの先頭から途中までのカラムが指定されていれば、インデクスが使われる」という点です。  
>[データベース／複合インデックスの落とし穴](https://www.gatc.jp/gat/it/it02dbindex.html)  

<!--  -->
>Q1. 複合インデックスを作っている場合、where句で1つだけを指定してもインデックスが効きますか？  
>A1. そのインデックスの先頭の項目が条件であれば、適用されます。  
>
>Q2. 複合インデックスがあるところに対して更に1つだけのインデックスを作る必要はありますか？  
>A2. 複合インデックスの先頭を含まない条件の場合は、その条件項目から始まるインデックスが必要です。  
>
>※where条件の記述順序は関係ありません。  
>[複合インデックスは1つのwhereでも効果がありますか？](https://teratail.com/questions/284051)  

<!--  -->
>複合インデックスについて、「構成列の一部が指定された場合でも効く」というのはなんとなく知っていたのですが、(略  
>
>あくまで「複合インデックスが選択される可能性がある」というだけです。  
>先頭列を抽出条件に含まなかったり、偏った部分集合を抽出条件とした場合などは、別のスキャン方法が選択される可能性が高いです。  
>[複合インデックスは、構成列のどの列を指定すれば選択候補に挙がるのか。 - sgyatto's blog](https://sgyatto.hatenablog.com/entry/2018/11/24/225938)  

---

## 参考

複合インデックスについて一番わかりやすいサイトではなかろうか。  
[複合インデックスの落とし穴 | がっとな日々 | ガットコンピューター](https://www.gatc.jp/gat/it/it02dbindex.html)  

複合インデックスの一部を指定した場合の、各データベースの挙動を紹介してくれているサイト。  
[複合インデックスは、構成列のどの列を指定すれば選択候補に挙がるのか。 - sgyatto's blog](https://sgyatto.hatenablog.com/entry/2018/11/24/225938)  

B+木の仕組みを理解していれば複合インデックスとした場合、何故先頭を含める必要があるのかわかる。  
以下のリンクの解説のが1番わかりやすい。  
[SQLアンチパターンとBtreeインデックスの関連性]
(https://devblog.thebase.in/entry/2018/12/09/110000)  
