# 17. 設計技術の理解の深め方

## 17.1 さらにステップアップするための設計技術書

- 現場で役立つシステム設計の原則～変更を楽で安全にするおオブジェクト指向の実戦技法  
- リーダブルコード - より良いコードを書くためのシンプルで実戦的なテクニック  
- リファクタリング 既存のコードを安全に改善する(第2版)  
- CleanCode アジャイルソフトウェア達人の技  
- レガシーコード改善ガイド  
- レガシーソフトウェア改善ガイド  
- レガシーコードからの脱却 - ソフトウェアの寿命を伸ばし価値を高める9つのプラクティス  
- エンジニアリング組織論への招待 ～ 不確実性に向き合う指向と組織のリファクタリング  
- プリンシパル オブ プログラミング 3年目までに身に着けたい一生役立つ101の原理原則  
- Clean Architecture 達人に学ぶソフトウェアの構造と設計  
- エリック・エヴァンスのドメイン駆動設計  
- セキュア・バイ・デザイン 安全なソフトウェア設計  
- ドメイン駆動設計入門 ボトムアップでわかる!ドメイン駆動設計の基本  
- ドメイン駆動設計 モデリング/実践ガイド  
- ドメイン駆動設計 サンプルコード&FAQ  
- テスト駆動開発  

---
---

## 17.2 設計スキルを高める学び方

実戦的な設計スキルを高めるための効率的な学び方を紹介する。  

---

### 17.2.1 学習のための指針

- インプットは2、アウトプットは8  
- 設計効果を必ず意識すること  

#### インプットは2、アウトプットは8

1つ目の指針は、インプットよりアウトプットを重視する事。  
インプットを2としたら、8ぐらいの割合でアウトプットする。  
これは設計に限らず、学習に関して広く言える。  

例えば自転車の乗り方を一生懸命本で勉強しても乗れません。  
実際に乗って練習し、バランスの取り方等を体で覚える必要があります。  
サービス開発可能な実戦的なプログラミングスキルを身につけるには、プログラミング言語の入門書を読んだだけでは困難。  
実際に機能要件を自分でかみ砕き、要件を満たすロジックを考えて組んでいく経験が必要。  

同様に、設計も本を読むだけでは中々理解が進まない。  
実際に手を動かして試行錯誤する経験を得て、初めて大幅なスキルアップを望める。  

1つ新しい事を学んだら、すぐにコードを書いて自分なりに色々考え試行錯誤すべし。  

#### 設計効果を意識する

2つ目の指針は、設計の前後で必ず効果(設計効果)を確認すること。  

例えば、ストラテジーパターンは条件分岐の重複コードを削減んする効果がある。  
ストラテジーパターンを使うなら、適用するコードが抱える課題とストラテジーパターンの効果が一致するかを確認する。  

設計適用後、本当に効果が得られたかどうかを確認する。  
思った効果がいまいち得られていないのであれば、何が問題なのか、どう工夫すれば良いか考える。  
さらに改善を積み重ねられ、設計の理解が深まる。  

一番よくないのは、設計効果を対して意識せず、構造だけをまねて満足してしまうこと。  
問題解決にならないばかりか、逆に構造を複雑にしてしまって、問題が深刻化する場合すらあり得る。  
聞きかじった程度の設計パターンを意味もなく適用して複雑化しているケースが結構多く見られる。  

以上、2つの指針に基づき、次に示す方法で学びを深める。  

---

### 17.2.2 悪魔の構造を見破る練習

より良い設計に使用とするモチベーション、危機感を高めるには、どこに悪魔が潜んでいるのか見破る目を養うことが第一歩。  
内容と照らし合わせながら、普段開発に携わっているプロダクションコードを眺めてみよう。  
構造的に良くない箇所はどこか、なぜよくないのか分析する練習を積もう。  
先に紹介した書籍「リファクタリング」や「CleanCode」を読めば、「悪魔の正体を見破る目」をさらに増やす事ができる。  

---

### 17.2.3 リファクタリングで大幅スキルアップ

設計スキルを大幅に高める方法はリファクタリング。  
リファクタリングの練習題材にするのは、普段仕事で使っているプロダクションコード。  
プロダクションコードは泥臭い複雑さを抱えている。  
だからこそ、実戦レベルで使える設計力を養える。  

リポジトリからローカルにプロダクションコードをチェックアウトし、練習用にブランチを切る。  
このブランチでリファクタリングの練習をする。  
練習用なので、製品ブランチにマージしてはいけない。  

次にリファクタリングの対象を選ぶ。  
行数の多いメソッドやpublicメソッドは難易度が高いので避ける。  
大抵は他の様々なクラスやメソッドに依存している度合いが高いため。  
行数の少ないprivateメソッドやstaticメソッドが、ちょうど良い練習題材になる。  
publicメソッドと違い、他との依存が小さいため。  

例えば、早期リターンやファーストクラスコレクションを用いてネストを解消するなど、色々試してみるべし。  
何かの計算をしてローカル変数に格納しているロジックがあれば、そのローカル変数の値をインスタンス変数とする値オブジェクトを設計してみるべし。  
そして、値オブジェクトに計算ロジックを移動してみるべし。  

繰り返しになるが、アウトプットが重要となる。  
とにかく数をこなすことが大事。  
また、意図した効果が得られているかを必ず確認する。  

構造変更の練習だけ出来れば良いため、テストコードを書く必要は特にない。  
テストコードを使った本番差ながらのリファクタリングを練習れすれば、さらにスキルアップが望める。  

---

### コラム C#と長き旅、そして設計への道

著者はC#でのWindowsアプリ開発の経験が最も長い。  
大学の研究室での経験年数も含めると数十年ある模様。  
C#での開発経験を通じて、設計スキルが最も向上した模様。  

著者は最初から設計に興味や知識があったわけではない。  
C#を使った、とある開発プロジェクトに従事した際、ひどいレガシーコードに苦しめられたことがあった。  
バグが頻発してプロジェクトは炎上し、残業続きの毎日となった。  
次第に疲れ果て、「なぜこれほどバグが多いのだろう…。いったい何がまずいのだろう…。」と悩む日が続いた。  

そんなある日、何か良い技術本はないかなと、職場の本棚をなんの気なしに漁って偶然手にした本があった。  
それが『リファクタリング』という本であった。  
「コードが理解しやすくなる」「バグが少なくなる」の記述を目にしたとき、「これだ!」と著者は衝撃を覚えた模様。  

コード変更時にバグを埋め込みにくくする設計がある…、著者がソフトウェア設計にはじめて触れた日であり、大げさではなく著者の運命を本当に変えた本だった模様。  

読んですぐ、学んだ内容を試したくなった。  
プロダクションコードのリポジトリから練習用のブランチを切り、プロダクションコードを題材にリファクタリングの練習や試行錯誤を毎日積み重ねた。  
この時期に設計スキルが最も伸びだ模様。  

複雑で混乱したロジックがきれいに整頓されていく有様があまりに面白かったので、ますます設計への興味が高まって、『レガシーコード改善ガイド』や『ドメイン駆動設計』など、様々な設計技術書を買い漁った模様。  

著者が現在リファクタしているRailsアプリに比べ、C#ははるかにリファクタリングしやすい。  
C#は静的型付け言語であり、静的解析によりクラスやメソッドの呼び出し個所を正確に追跡できる。  
IDEのVisualStudioは大変高機能である。  
テストコードをすぐに書けるし、コード分析して品質を数値化できる。  
書いたコードをクラス図として可視化もできる。  

しかし、こうした恵まれた環境であっても、設計に理解がなければ、著者が経験してきたようにバグが頻発し、プロジェクトは炎上する。  
設計品質向上の手段が初めから豊富に用意されているのに、宝の持ち腐れだ。  
それどころか、残念なことに、IDEの便利機能があだとなり、品質低下の手助けになっていたケースがあった。  

例えば、regionディレクティブというプリプロセッサ記述がある。  
これは`#region`でくくった範囲の行を折りたたんで隠せる機能となる。  
数百行に及ぶ長大なメソッドを折りたたんで隠す用途に、regionディレクティブが頻繁に使われていた。  
好んで使っていた方々は「読みやすくなって便利」と口にしていたが、本来であれば長大なメソッドは小さく分割すべきである。  
設計改善の必要性を覆い隠し、見て見ぬふりを助長していた。  

また、「if文の終わり括弧を探す機能があるんですよ。これがあればif文のブロックに何千行書いても大丈夫ですよ。すごいと思いませんか!」と大喜びで語っていた人もいた。  
長大で粗悪なコードを改善するのに、括弧を正確に探す機能は助けになる。  
しかし、逆に粗悪なコードを書く手助けになっていたことがとても残念であった。  

言語の特性や開発環境を生かすも殺すも、設計スキル次第である。  
設計をよく学び、品質を正しく高めていこう。  

---

### 17.2.4 動くコードを書いたら、設計しなおしてからコミット

開発時に設計スキルを高め、かつ品質の高いコードをコミットする方法となります。  

コードを書く前にある程度設計してもいいが、まずは動くコードを早く書く事をお勧めする。  
時間を書けて慎重に設計しても、いざコードに落とし込んでみると、動作に不可欠な要素を見落としているケースが多々あるためである。  

動作するコードを実装出来たら、そのままコミットしてはいけない。  
そこからあるべき構造を設計しなおす。  
動作に必要な値、計算ロジック、分岐ロジックが動くコードから得られる。  
それら動作に必要な要素をメモ帳などにメモしておく。  
メモしておいた要素を用い、今度は変更容易性を考慮したクラスとして設計する。  
そして、最初に雑に書いたコードの代わりに、新たに作ったクラスを組み込む。  
動作に問題がなければコミットする。  

このようにすることで、品質の高いコードをコミットできるし、実戦レベルの設計スキルも向上する。  

---

### 17.2.5 設計技術書でさらなる高みを目指そう

設計がうまくいくと楽しくなってくるもの。  
その時こそ、成長のチャンスとなる。  
先に上げた技術書を入手し、学びを深めるべし。  

書籍「リファクタリング」や「レガシーコード改善ガイド」は、ケースに応じた対応方法がカタログ的に記述されている。  
そのため、通読しなくても、使いたい手法をお手軽に拾い読みしてすぐに試すことができる。  
繰り返しになるが、アウトプットを重視し、読んだらすぐに手を動かして試行錯誤すべし。  
そして設計の効果を確認すべし。  

書籍「ドメイン駆動設計」は、ソフトウェアを長期的に成長させる、価値の高い設計知見にあふれている。  
難解ではあるが、関連する入門書が色々出版されており、サポートが豊富。  
ドメイン駆動設計も、手を動かし、様々な試行錯誤を得て理解が深まる。  

設計力を高め、悪魔に苦しめられず、快適に楽しく開発していける世界を目指していこう。  
