# 11.ネットワークの基礎

``` txt : ネットワーク関係早見表
## TCP/IPの基礎
・IPv4、IPv6  
・ユニキャスト、エニーキャスト、マルチキャスト  
・ウェルノウンポート  
・サブネット、ネットワークアドレス、ブロードキャストアドレス、プライベートアドレス  
・CIDR(Classless Inter-Domain Rounting)  
・TCP(Transmission Control Protocol)  
・IP(Internet Protocol)  
・UDP(User Datagram Protocol)  
・ICMP(Internet Control Message Protocol)  
・ARP(Address Resolution Protocol)

## ネットワークの設定
・/etc/services           :: ポート番号とサービスの対応が記述されたファイル。複数形であることに注意。
・/etc/sysconfig/network  :: ホスト名を設定(Red Hat系)。ネットワーク機能の有効/無効やデフォルトゲートウェイ等も設定可能。  
・/etc/hosts              :: IPアドレスとホスト名の対応付け。
・/etc/hostname           :: ホスト名のみを設定(Debian系)
・/etc/network/interfaces :: Debian系でネットワークインターフェースの設定を記述するファイル。  
・/etc/sysconfig/network-scriptsディレクトリ  
・NetworkManager :: 動的にネットワークを管理する仕組みです。
・nmcli          :: NetworkManagerを管理するためのコマンドラインインタフェース（CLI)  
・hostnamectl    :: systemdが動作するシステムにおける、ホスト名や関連する情報の表示、ホスト名の設定を行うコマンド。  

## ネットワークのトラブルシューティング
・ping        :: 宛先アドレスに到達可能か確認。
・ping6       :: ipv6版
・traceroute  :: 宛先アドレスまでの経路を確認。
・traceroute6 :: ipv6版。
・tracepath   :: 宛先アドレスまでの経路と経路上の最大転送単位(PathMTU)を確認。
・tracepath6  :: ipv6版
・hostname    :: ホスト名を一時的に変更するコマンド。
・hostnamectl :: systemd用ホスト名を設定するコマンド。
・netstat     :: ネットワーク関連の情報を表示するコマンド。
・ss          :: netstatの後継。ネットワークのソケットの情報を表示するコマンド。
・nc          :: テキストストリームにおけるcatコマンドと同様の働きをネットワーク上で行うコマンド。
・route       :: ルーティングテーブルの表示や操作を行うコマンド。  
・ip          :: IPアドレスやルーティングを設定するコマンド。  
・ifconfig    :: インターフェースの情報の表示や設定を行うコマンド。
・ifup        :: 指定したインタフェースを有効にするコマンド。
・ifdown      :: 指定したインタフェースを無効にするコマンド。

## DNS
・/etc/resolv.conf           :: 名前解決に利用するDNSサーバの指定や、ドメインの指定をするファイル。
・/etc/nsswitch.conf         :: GNU Cライブラリが名前解決やサービス名解決の際の問い合わせ順序を指定するファイル。
・/etc/systemd/resolved.conf :: systemd-resolvedの設定ファイル。
・host     :: DNSサーバーを使ってホストやドメインに関する情報を表示する。最も基本となるコマンド。最小出力。
・dig      :: DNSサーバへ直接問い合わせて、指定した名前に関するDNSサーバからの応答を表示します。
・getent   :: 名前解決の順序を設定する「/etc/nsswitch.conf」に従って検索を行うコマンド。
・whois    :: 調べたいドメイン名を指定して、whoisデータベースに問い合わせるコマンド。
・nslookup :: WindowsにおいてDNSサーバに名前解決を問い合わせるWindowsのコマンド。
```

## TCP/IPの基礎

### IPv4

IPv4ヘッダの説明  
・「ヘッダ長」や「オプション」フィールドなど、いくつかのフィールドはIPv6ヘッダには存在しない  
・TTLはルータを1つ通過するごとに1ずつ減算される  
※TTL（Time to Live - パケットの生存期間）はルータを1つ通過するごとに1ずつ減算され、0になるとパケットが破棄されてルーティングのループを防ぎます  

### IPアドレスのクラス

``` txt : IPアドレスのクラス
クラス         範囲                   サブネットマスク
A   ::   0.0.0.0 - 127.255.255.255 :: 255.0.0.0
B   :: 128.0.0.0 - 191.255.255.255 :: 255.255.0.0
C   :: 192.0.0.0 - 223.255.255.255 :: 255.255.255.0
D   :: 224.0.0.0 - 239.255.255.255
E   :: 240.0.0.0 - 255.255.255.255
```

クラスDはマルチキャスト（特定の複数宛ての送信に使用される）用のアドレスです。  

``` txt : プライベートアドレスの範囲
A :: 10.0.0.0 – 10.255.255.255
0000 1010 . 0000 0000 . 0000 0000 . 0000 0000
0000 1010 . 1111 1111 . 1111 1111 . 1111 1111

B :: 172.16.0.0 - 172.31.255.255
1010 1100 . 0001 0000 . 0000 0000 . 0000 0000
1010 1100 . 0001 1111 . 1111 1111 . 1111 1111

C :: 192.168.0.0 – 192.168.255.255
1100 0000 . 1010 1000 . 0000 0000 . 0000 0000
1100 0000 . 1010 1000 . 1111 1111 . 1111 1111
```

IPアドレスのうち、ローカルネットワークでのみ使用が許可されているアドレスを「プライベートアドレス」と言い、クラスごとに範囲が定められています。  
プライベートアドレスはIANA（アイアナ：Internet Assigned Numbers Authority）によって予約されています。  

### IPv6

IPv6(Internet Protocol version 6)は、現在主流のIPv4に変わる次世代版のインターネットプロトコル(IP:Internet Protocol)です。  
近年、インターネットの急速な普及や、接続機器の増加に伴い、IPアドレスの枯渇が問題となりました。  
そこで、IPv4では32ビットの長さで表していたIPアドレスをIPv6では128ビットで表すことで、使用できるIPアドレスが約340澗（かん）個（事実上無限）にまで増大しました。  

※正確には340澗（かん）2823溝（こう）6692穣（じょう）938秄（じょ）4634垓（がい）6337京（けい）4607兆4317億6821万1456個。  
2の32乗（32ビット）で表すことのできる約43億という数の、さらに4乗（2の32乗×2の32乗×2の32乗×2の32乗）という膨大な数です。  

- アドレス長が128bit  
- 16進数表記(0-9,A-F)  
- ユニキャスト、エニーキャスト、マルチキャストをサポート。  
- ブロードキャストが廃止され、一斉送信は全てマルチキャスト（特定グループ宛通信）で行われる  
- アドレス表記法  
  ①各ブロックの先頭の「0」は省略できる  
  ②連続した「0000」のブロックは1回に限り「::」に省略可能  
  ③「0000」は「0」に省略可能  
  例）  
  0001:5000:0001:0000:0000:0002:000A:0001 → 1:5000:1::2:A:1  
  2001:5000:0001:0000:0000:DA02:0000:1001 → 2001:5000:1::DA02:0:1001  
  2001:5000:0001:0000:0000:0000:0000:0000 → 2001:5000:1::  
- プロトコル番号,ポート機能はIPv4と同じ。  
- IPsec（暗号化通信）を標準で実装  
- IPアドレスの自動割り当て機能を標準で実装している。(IPv4はDHCPで実装)  
- IPv4との互換性は無い（但し、機器にIPv4とIPv6の両方のアドレスを割り当てるデュアルスタックなどの仕組みで相互運用は可能）  
- IPv4アドレスと直接通信出来ない。変換が必要。  
  IPv4とIPv6ではパケットフォーマットが異なる為、直接通信をする事はできません（互換性はありません）が、  
  デュアルスタックなどの相互運用の仕組みを利用してIPv4とIPv6が混在したネットワークを構築することが可能です。  
- IPv6アドレスは非常に広大なアドレス空間のため、IPv4での「クラス」の概念はなくなりました。  
  その代わりに、ユニキャスト（1対1通信）のアドレス割当時にはサブネットを表す前半64ビットと、ホストを表す後半64ビットでアドレス割り当てすることが推奨されています。  
  前半64ビットを「サブネットプレフィックス」、後半64ビットを「インタフェース識別子（Interface-ID）」とよびます。  
- IPv4のネットワーク部に相当する部分が**サブネットプレフィックス**、ホスト部に相当する部分が**インタフェース識別子（Interface-ID）**  
- ホップリミットはIPv4のTTLと同じ役割を持つ  
- プレフィックス、インターフェースIDともに64ビット  
- IPv6のポート番号の表記法 → `[IPアドレス]:ポート番号`  
  例:[fe80:20c:29ff:fe55:94ef]:80  

※プロトコル番号  
上位層のプロトコルを識別するための番号。
IPヘッダに8ビット情報で存在する。  
各プロトコルにはポート番号だけではなく、各々に番号がある模様。  

``` txt
 1 :: ICPM
 4 :: IP
 6 :: TCP
17 :: UDP
etc...
```

・ユニキャスト : 1つのネットワークインターフェースを識別するアドレス  
・エニーキャスト : 複数のホストの集合に割り当てられるアドレス  
・マルチキャスト : IPv4のブロードキャストに相当するもの  

ローカルループバックアドレス , ::1/128  
グローバルユニキャストアドレス , 2000::/3  
リンクローカルユニキャストアドレス , fe80::/10  
マルチキャストアドレス , ff00::/8  

IPv6パケット内の制御情報であるIPv6ヘッダは、IPv6ヘッダ（固定長）＋オプションの拡張ヘッダ（可変長）で構成されます。  

``` txt : IPv6ヘッダー
バージョン（4ビット）        :: IPのバージョン番号。IPv6では"6"が入る  
トラフィッククラス（8ビット）:: パケットの優先度をつける  
フローラベル（20ビット）     :: アプリケーションフローの識別  
ペイロード長（16ビット）     :: IPv6ヘッダを除くパケットのデータ部の長さ  
ネクストヘッダ（8ビット）    :: IPv6ヘッダの次にくるヘッダのタイプを示す  
ホップリミット（8ビット）    :: 通過できるルータの数（IPv4のTTLと同じ）  
送信元アドレス（128ビット）  :: 送信元のIPv6アドレス  
宛先アドレス（128ビット）    :: 宛先のIPv6アドレス  
```

IPv4ヘッダの基本サイズは20バイト、IPv6ヘッダは40バイトなので 2倍のサイズになっていますが、  
IPv6ではチェックサムフィールドなどいくつかのフィールドを削除して構造を簡単にしています。  
さらにIPv6ヘッダでは、可変長となるフィールドをオプションにして、転送に必要になる基本ヘッダを固定長にすることで処理効率を上げています。  

### CIDR(Classless Inter Domain Routing)  

IPアドレスのクラスの概念を使わずに、任意の長さのサブネットマスクを利用する事。

アドレスクラスの概念を気にしないで、IPアドレスの割り当てや経路選択などの自由度を上げる仕組み。  
サブネットマスクを調整することで任意の大きさのネットワークを作るあれのこと。  
192.168.0.***/24の「/24」の部分がCIDR表記。  

クラスの概念に基づいてネットワークを設定すると、使わないIPアドレスが発生してしまう。  
なので、クラスの概念をとっぱらって、サブネットマスクでもって、設定できるようにしたほうが無駄が少なくてよくね？って考え方がこれ。  

読み方はサイダー  

### ウェルノウンポート  

ポート番号は0～65535番まであります。  
その中でも、主要なサービスのポート番号はウェルノウンポート(0～1023番）として予約されています。  
ポートは0から始まる事に注意。  

``` txt : ポート
Well Known Ports :: 0~1023      :: システムやroot権限を持つプロセスに割り当てられたポート
System Ports                       (WebサーバーやWindowsファイル共有サービスなど)

Registered Ports :: 1024~49151  :: よく使われるプログラムに割り当てられたポート番号
User Ports                         (OracleやMicrosoft SQL Serverなど)
                                   一般ユーザーが使えるのは1024番から。

Dynamic Ports    :: 49152~65535 :: 自由に使用可能なポート
Ephemeral Ports(エフェメラル)
Private Ports
```

``` txt : ウェルノウンポート
 20 :: FTP    :: ファイル転送(データ用)
 21 :: FTP    :: ファイル転送(制御用)
 22 :: SSH    :: リモートホストの遠隔操作(暗号化あり)
 23 :: Telnet :: リモートホストの遠隔操作(暗号化なし)
 25 :: SMTP   :: 電子メール  
 53 :: DNS    :: TCP/UDP,名前解決
 80 :: HTTP  
110 :: POP3   :: 電子メール受信(受信メールをサーバーからダウンロードしてサーバーから消す方式)(Post Office Protocol version 3)
143 :: IMAP   :: 電子メール受信(受信メールをサーバ上で管理し、メールソフトに表示させる受信方式)(Internet Message Access Protocol)  
161 :: SNMP   :: ネットワークの監視  
162 :: SNMP Trap :: ネットワークの監視(警告通知等)  
443 :: HTTPS  
465 :: SMTPS  
636 :: LDAP over SSL/TLS  
993 :: IMAPS  
995 :: POP3S  

どうでもいいプロトコル
 63 :: whois++プロトコル
123 :: NTP  
361 :: Semantixサービス
389 :: LDAP :: ディレクトリサービス  
529 :: IRC(Internet Relay Chat)
514 :: Syslog :: ロギングサービス  
631 :: CUPSの設定ポート  
```

### IP(Internet Protocol)

「IP（Internet Protocol）」はネットワークに接続された機器（サーバ、ルータ、クライアントPCなど）へのアドレス付与によって機器やネットワークを識別したり、  
パケットの分割や統合を行い目的地までパケットを届ける、インターネット通信の中核をなすプロトコルです。  

### TCP(Transmission Control Protocol)

OSI参照モデルの第4層に属し、TCP/IPの中核となるTCP（Transmission Control Protocol）は、信頼性の高いコネクション型のプロトコルです。  
コネクション型とは、通信する相手と事前にコネクション（接続）を確立し、取り決めた通信手順に従ってデータを送受信する通信方式です。  

TCPはコネクション型の通信プロトコルですので、データを送受信する時の制御機能を持ち、パケットを順番通りに並べたり、到達したかどうか確認したり、  
途中で消失したパケットを再送したりすることができます。  

### UDP（User Datagram Protocol）

UDP（User Datagram Protocol）はコネクションレス型のプロトコルです。  
コネクションレス型とは、相手とのコネクション（接続）を事前に行わず、送りたいデータを一方的に送りつける通信方式です。  
到達確認や再送などの複雑な制御機能を持たない代わりに、いつでもデータを送信でき、処理も簡単なので高速に動作します。  
この特性から、主に動画や音声などのマルチメディア通信に使われます。  

### ARP(Address Resolution Protocol)

IPアドレスからMAC（Media Access Control）アドレスを求めるプロトコル。  

MACアドレスは、ネットワークに接続するNIC（Network Interface Card）などの物理的な接続に割り当てられたアドレスで、基本的に変更することができません。  
ネットワークに接続された機器は、自分のMACアドレス宛のデータのみを受信するようになっています。  
IP（Internet Protocol）アドレスはOSなどのソフトウェアが管理するアドレスであり、割り当てられた範囲内で自由に設定できます。  
そのため、故障による機器交換などでIPアドレスとMACアドレスの組み合わせは簡単に変わってしまいます。  

宛先IPアドレスを持つ機器のMACアドレスが変わっていると、送信したデータの宛先MACアドレスが一致しないため、宛先IPアドレスを設定した機器にもかかわらず、受信せずに破棄されてしまいます。
これを解決するため、「このIPアドレスを持つ機器は、MACアドレスを回答してほしい」という要求を全機器宛てに送信し、  
その応答を元に正しい宛先MACアドレスを設定して送信します。これがARPの仕組みです。  

ARPによって入手したIPアドレスとMACアドレスの対応表は、MACアドレステーブル、ARPキャッシュと呼ばれ、各アドレスごとに一定時間保持されます。  
一定時間経過後には、再度ARPによって最新のIPアドレスとMACアドレスの対応が作成されます。  

### ICMP(Internet Control Message Protocol)

IPを使った通信では、宛先までパケットが到達しなかった場合でも、IP自身にはそれを知らせる術がありません。  
IPで発生した、宛先到達不能などの通信エラー情報や、経路変更要求（リダイレクト）などの制御メッセージの通知にはICMP（Internet Control Message Protocol）が使われます。  
pingやtracerouteコマンドはICMPを利用してネットワークを診断します。  

### その他色々

IPアドレスのホスト部に相当するbitをすべて0にしたものは、ネットワークそのものを表すネットワークアドレスです。  
また、ネットワーク上にあるすべての端末に対して、データを送り出すことをブロードキャストといいます。  
ブロードキャストアドレスは、IPアドレスのホスト部に相当するbitをすべて1にしたものです。  

IPアドレス「192.168.18.1」とサブネットマスク「255.255.255.0」を2進数で表記すると以下のようになります。  

11000000 10101000 00010010 00000001　　 :: IPアドレス  
11111111 11111111 11111111 00000000　　 :: サブネットマスク  

これは後半の8ビット(サブネットマスクが0の部分）がホスト部である事をあらわしています。  
そこを全て0にするとネットワークアドレス、全て1にするとブロードキャストアドレスとなります。  

11000000 10101000 00010010 00000000　　 :: ネットワークアドレス  
11000000 10101000 00010010 11111111　　 :: ブロードキャストアドレス  

これを10進数に直すと、ネットワークアドレスが「192.168.18.0」、ブロードキャストアドレスが「192.168.18.255」となります。  

---

## ネットワークの設定

### /etc/services  

ポート番号とサービスの対応が記述されたファイル  
複数形であることに注意。  

``` txt : 表示例
#cat /etc/services
telnet 23/tcp
```

### /etc/hostname

ホスト名のみが記述されているファイル。  
ホスト名を記述するファイルはディストリビューションによって異なります。  
・Debian系では従来から「/etc/hostname」を使用しています。  
・Red Hat系ディストリビューションでは「/etc/sysconfig/network」にホスト名や、ネットワーク機能の有効/無効、デフォルトゲートウェイの設定などを記述していましたが、  
Red Hat Enterprise Linux（RHEL）7からは、ホスト名の設定はDebian系同様「/etc/hostname」を使用するようになりました。  

なお、「hostname」コマンドでもホスト名の変更は可能ですが、マシンの再起動で元に戻ってしまいますので、恒久的な変更には「/etc」以下のファイルに設定します。  
ホスト名はwww.hoge.comのwwwの部分。hoge.comに属するwwwというPC名(ホスト名)。  

``` txt : 表示例
# car /etc/hostname
Debian
```

``` conf : 例
centos7.example.com
```

### /etc/sysconfig/network

ホスト名を設定(Red Hat系)  
ネットワーク機能の有効/無効やデフォルトゲートウェイ等も設定可能。  
Red Hat Enterprise Linux（RHEL）7からは、ホスト名の設定はDebian系同様「/etc/hostname」を使用するようになりました。  
GATEWAYの設定項目があるのは/etc/sysconfig/networkファイルだけ。  

``` txt : 表示例
# cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=CentOS
GATEWAY=192.168.1.1
```

### /etc/hosts

IPアドレスとホスト名の対応付け

名前解決に用いられるシンプルなテキストファイルで、1行に1つのIPアドレスがあり、そのIPアドレスと続くホスト名とを関連づけています。  
IPアドレスはIPv4、IPv6どちらでも指定できます。  
現在では名前解決にDNSが広く用いられている為、「/etc/hosts」ファイルは補助的な役割を果たしています。  

ホスト名とIPアドレスの対応を記述するファイル。  
小規模ならこれで十分。これ以上になればDNSが必要。  
変更の反映は全てのホストに配布する必要がある。  

``` txt : 書式
IPアドレス ホスト名 ホストの別名

スペースで区切って記述する。  
1対1なので、改行する。

例)
127.0.0.1 localhost.localdomain localhost
192.168.0.1 windsor.example.com windsor
fc00:192:168:1::100 FileServer
```

``` txt : 表示例
# cat /etc/hosts
112.78.124.10 pint-t.com
192.168.1.100 FileServer
```

### /etc/resolv.conf

ドメイン名やDNSサーバーの指定

``` txt : 表示例
# cat /etc/resolv.conf
domain pint-t.com
nameserver 192.168.1.1
```

### /etc/network/interfaces  

Debian系でネットワークインターフェースの設定を記述するファイル。  
Debian系はUbuntuとかか。  

設定項目は多数あるので、問題で出たら都度まとめる。  
IPアドレスとかネットマスクとかDNSのIPアドレスとかデフォルトゲートウェイとか、そういう基本的な設定をするのがこのファイルってわけ。  

### /etc/sysconfig/network-scriptsディレクトリ  

RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  
ネットワークインターフェース名が「eth0」の場合、設定ファイル名は「ifcfg-eth0」となる。  
IPアドレスを固定で割り当てたい場合などにこのファイルを編集する。  

### NetworkManager  

NetworkManagerはRed Hat Enterprise LinuxやCentOSで導入されている、動的にネットワークを管理する仕組みです。  
様々なディストリビューションで採用されており、Red Hat Enterprise Linux 6では、  
従来のinitスクリプトによるネットワーク設定に代わり標準のネットワーク設定として導入されています。  
システムで検出されたネットワークデバイスは自動でNetworkManagerによって管理され、DHCPサーバが有効な環境であればDHCPによって動的なIPアドレスが割り当てられます。  
また、特定のインタフェースをNetworkManagerで管理しないように設定することもできます。  
ノートPCなど移動式のデバイスでは、ネットワーク環境を切り替えるのに便利な機能です。  
ただし、サーバのように設定を固定した方がよい環境では動的に設定が変更されて問題が発生するのを防ぐため、NetworkManagerを無効化することもあります。  
NetworkManagerでは、設定内容をまとめた「接続（connection）」とネットワークデバイスを示す「デバイス（インタフェース）」を別々に定義し、それらを関連付けて管理します。  
既存の接続に新しいデバイスを関連付けることによって、構成変更にも動的に対応できます。  

Ethernet,Wi-Fi,ブリッジといったネットワークデバイスと、デバイスによるネットワーク接続およびデフォルトルート、DNS名前解決を自動的に管理します。  
I/F設定ファイルに特別な記述がない限り、DHCPを利用するので、ネットワークI/Fとデフォルトルートは自動設定される。  
もちろん手動設定も可能。(らしい)  

``` txt
systemdの場合
systemctl status NetworkManager  :: 利用確認
systemctl start NetworkManager   :: 起動
systemctl stop NetworkManager    :: 停止
systemctl enable NetworkManager  :: 有効
systemctl disable NetworkManager :: 無効

SysVinitの場合
/etc/init.d/NetworkManager start :: 起動
/etc/init.d/NetworkMagager stop  :: 停止
chkconfig NetworkManager on      :: 有効
chkconfig NetworkManager off     :: 無効
```

・デフォルトでは固定のIPアドレスが設定される  
DHCPサーバが有効な環境であればDHCPによって動的なIPアドレスが設定されますが、固定IPアドレスは設定されません。よって誤りです。  

・NetworkManagerが管理していないインタフェースも動的に設定する  
NetworkManagerが管理していないインタフェースは管理下にないため、NetworkManagerによる動的な設定は行われませんので、誤りです。  

・無効にするとネットワークに接続できなくなる  
NetworkManagerは無効化できますが、接続設定は維持されネットワークに接続できなくなることはありません。  
従来のinitスクリプトによるネットワーク設定も行えます。よって誤りです。  

### nmtuiコマンド

NetworkManagerによるネットワーク管理を行える、cursesベースのインタフェースを起動するコマンド。  
nmtuiはcurses（カーシス: UNIX向け端末制御ライブラリ）ベースのテキストユーザインタフェース（TUI）です。  
コマンドラインからnmtuiコマンドで起動します。  

### nmcliコマンド  

NetworkManagerにおいて、ネットワークの設定、接続の管理、状態の確認を行うコマンド。  
Network Manager Command Line Interfaceの略見たい。  

``` txt
nmcli オブジェクト [コマンド]

オブジェクト  コマンド
general     :: status                          :: NetworkManagerの状態を表示
            :: hostname[ホスト名]              :: ホスト名を表示・指定したホスト名に変更
networking  :: {on|off}                        :: ネットワークの有効化|無効化
            :: connectivity                    :: ネットワークの接続状態を表示
radio       :: wifi                            :: Wi-Fiの状態を表示
            :: wifi {on|off}                   :: Wi-Fi接続の有効化|無効化
connection  :: show                            :: 接続状況を表示
            :: modify ID パラメータ            :: 指定した接続IDの設定ファイル(/etc/sysconfig/network-scripts/ifcfg-<接続名>)の指定したﾊﾟﾗﾒｰﾀを書き換える。
                                                  ﾊﾟﾗﾒｰﾀの反映には接続のconnection up操作が必要。
            :: {up|down} ID                    :: 接続の有効化|無効化
device      :: status                          :: デバイスの状態を表示
            :: show ｲﾝﾀｰﾌｪｰｽ名                 :: 指定したデバイスの詳細情報を表示
            :: {connect|disconnect} ｲﾝﾀｰﾌｪｰｽ名 :: 指定したデバイスを接続|切断
            :: modify ｲﾝﾀｰﾌｪｰｽ名               :: 指定したｲﾝﾀｰﾌｪｰｽのﾊﾟﾗﾒｰﾀを即時変更する。設定ファイルの書き換えは行われない。
            :: monitor ｲﾝﾀｰﾌｪｰｽ名              :: 指定したデバイスの監視
            :: delete ｲﾝﾀｰﾌｪｰｽ名               :: ｿﾌﾄｳｪｱﾃﾞﾊﾞｲｽ(ﾌﾞﾘｯｼﾞなど)の削除。※ﾌﾞﾘｯｼﾞとは異なるﾈｯﾄﾜｰｸ同士を接続して同一のｾｸﾞﾒﾝﾄとしてまとめる手法
            :: wifi list                       :: Wi-Fiアクセスポイントの表示
            :: wifi connect SSID               :: Wi-Fiに接続するデバイスを作成、有効化
            :: wifi rescan                     :: wi-fiアクセスポイントの再検索
agent
monitor
help
```

NetworkManagerで管理できるネットワークデバイスのタイプ  
wifi,ethernet,bridge  
`nmcli connection show`(接続状況を表示)で確認できる。  

``` txt : nmcli networking connectivityで表示されるネットワークの接続状態
full    :: インターネットにアクセス可能なネットワークに接続している。
portal  :: インターネットにアクセスする前のcaptive portalの状態である。
           ※captive portal(キャプティブポータル)
           Wi-Fiホットスポットやホテルなどでインターネット利用前に強制的に認証や課金のWebページを参照させる技術。
           ログインが完了しないとインターネットにアクセスできない。
limited :: ネットワークに接続しているが、インターネットにアクセスできない。
none    :: どのネットワークにも接続していない。
unknown :: 接続状態が見つからない。
```

ホスト名をcentos.localdomainに設定  
`nmcli general hostname centos.localdomain`  

ホスト名の表示  
`nmcli general hostname`  

デバイスの状態を表示する  
`nmcli device status`  

ネットワークの状態を表示する  
`nmcli networking connectivity`  

My-WiFiに接続する
`nmcli device wifi connect My-Wifi`

### hostnamectlコマンド  

ホスト名を設定するコマンド  
systemdが動作するシステムでは、hostnamectlコマンドでもホスト名や関連する情報の表示、ホスト名の設定を行えます。

``` txt
hostnamectl [サブコマンド]

サブコマンド
status                :: ホスト名と関連情報を表示する(でふぉ)
set-hostname ホスト名 :: ホスト名を設定する  
```

 ホスト名をvm2に変更  
`hostnamectl set-hostname vm2`  

/etc/hostnameファイルでもホスト名を変更できるなら、hostnamectlコマンドでホスト名を変更した情報はどこに保存されるのか？  
hostnamectlコマンドで/etc/hostnameファイルが変更される？  
[hostnameコマンドより便利なhostnamectlコマンド](https://linuc.spa-miz.com/2020/12/23/hostnamectl-command-more-useful-than-the-hostname-command/)  
→
hostnamectlコマンドで/etc/hostnameファイルが変更されるらしい。  
結局、保存先であるファイルが全て何だな。  

### systemd-networkd

systemdの動作するシステムでネットワーク設定を管理するデーモンです。  
systemd-networkdの設定は「/etc/systemd/network」配下の拡張子.networkのファイルで行います。  

---

## ネットワークのトラブルシューティング

### pingコマンド  

pingコマンドは、エラーメッセージや制御メッセージを通知する「ICMP」というプロトコルを使って、ネットワークの疎通確認を行います。  
送信元デバイスでpingコマンドを実行すると、ICMPエコー要求パケットが宛先へと送信されます。  
宛先デバイスでエコー要求パケットを正常に受信すると、正常に受信したことを知らせるためのICMPエコー応答パケットが送り返されてきます。  
通信に問題がある場合は、エラーの原因として時間超過や宛先到達不能などのメッセージが返されます。  

指定されたホスト(ホスト名もしくはIPアドレス)にICMPパケットを送り、その反応を表示するコマンド  
何もオプションを指定しない場合、Ctrl + Cを押すまで送信し続ける。  

ipv6の場合はping6コマンドを使う。内容は全く同じ。  
IPv6アドレスが割り当てられていない宛先へはIPv6アドレスの解決ができないため、ping6コマンドはエラーになります。  
同様に、IPv6ルーティングが無効で、宛先までの経路が存在しない場合もエラーになります。  

``` txt
ping [オプション] ホスト名orIPアドレス

-c 回数 :: 指定した回数だけICMPパケットを送信する。(count)
-i 間隔 :: 指定した間隔(秒)ごとにICPMパケットを送信する(デフォは1秒)(interval)
-n      :: 結果表示時の形式をホスト名ではなくアドレスで表示(numeric)

※IPv6のリンクローカルアドレス（fe80::/10）宛にping6を実行する場合は、-I（大文字i）で出力インターフェースを指定する必要がある。
※Windowsのpingコマンドでは-nが送信するパケットの回数を指定するオプションです。

・応答がない場合
サーバーがダウンしている場合に発生するエラー。
停止しているサーバに対してpingを実行した場合、Ctrl+Cで強制終了するまで応答がない。

・ネットワークに届かないというエラーが返ってくる
コマンドを実行するマシンのインタフェースがdownしている時のエラーです。

・ホストに届かないというエラーが返ってくる
存在しないIPアドレスに対して実行した場合のエラーです。
```

### tracerouteコマンド  

tracerouteコマンドは、リモートホストまでの通信経路を表示します。  
宛先ホストに対して、デフォルトではUDPパケットのTTLを1から1つずつ増やして送信を繰り返します。  
※Time to Live: パケットの生存期間を表し、ルータを経過する度に1つ減る  
TTLが0になった時点の機器はICMP Time Exceeded（時間切れ通知）を送信元に返すので、この情報を元にパケットが通過した経路が組み立てられ、  
経路上のどこに問題があるのかを確認することもできます。  

指定されたホスト(ホスト名もしくはIPアドレス)までパケットが伝わる経路を表示するコマンド  
宛先までのルータやホストが順に表示される。  
ネットワーク経路上に障害があった場合は、その位置を特定できる可能性がある。  
ipv6はtraceroute6コマンドを使う。内容は全く同じ。  

- パケット送信に使用するデフォルトのプロトコルはUDP。  
- UDPポートのデフォルトは33434番で、送信するたびにインクリメントする。  
- routepathはtracerouteよりも機能が少なく、特権を必要とするRAWパケットを生成するオプションもない。  

``` txt
traceroute [オプション] ホスト名orIPアドレス  

オプション
-l            :: ICMP ECHOパケットを送信。デフォルトはUDPパケット。
-f TTL 初期値 :: TTL(Time To Live)の初期値を設定。デフォルトは1。
-n            :: 結果表示の形式をホスト名ではなくアドレスで表示(numeric)
```

### tracepathコマンド  

宛先アドレスまでの経路と経路上の最大転送単位(PathMTU)表示するコマンド。  
ip6はtracepath6コマンドを使う。内容は全く同じ。  

``` txt
tracepath [オプション] ホスト名orIPアドレス[/ポート番号]  

-n :: 結果表示の形式をホスト名ではなくアドレスで表示(numeric)
```

### 疎通コマンド早見表

``` txt
ping       :: 宛先アドレスに到達可能かを確認。
traceroute :: 宛先アドレスまでの経路を確認。
tracepath  :: 宛先アドレスまでの経路と経路上の最大転送単位(PathMTU)を確認。

※IPv4対応コマンドでも、最近は「-6」オプションを使用する事でIPv6対応できる。

※MTU(Maximum Transmission Unit)  
通信用に細切れにしたデータの大きさ制限で『これくらいの大きさの細切れデータなら通れるよ（送れるよ）』な最大値  
```

### hostnameコマンド

ホスト名を一時的に変更するコマンド。  
ホスト名の表示も可能。  
マシンの再起動で設定は元に戻る。  
恒久的な変更には「/etc」以下のファイルに設定します。  
ホスト名を変更できるのはrootユーザーのみ。  

ホスト名変更色々まとめ。  
[CentOS 7 の Hostname を変更する](https://qiita.com/notakaos/items/d18ab37bce2b25b2d5b0)  

``` txt
hostname [ホスト名]  

ホスト名を指定しない場合 :: 現在のホスト名を表示する。  
ホスト名を指定した場合   :: ホスト名を変更する。  
```

### netstatコマンド  

ネットワーク機能に関する様々な情報を表示するコマンド  
開いているポートの検索によく利用する模様。  
「netstat」コマンドはネットワーク情報の表示は出来ますが、設定は一切出来ません。  

``` txt
netstat [オプション]  

-a :: すべてのソケット情報を表示する。全てのプロトコル(TCP,UDP,UNIXソケット)を表示  
-l :: 接続待ち(LISTEN)のソケットを表示。  
-c :: 状況を1秒ごとにリアルタイムで表示する。  
-i :: ネットワークインターフェースの状態を表示する。  
-n :: アドレスやポートを数値で表示する。(つまり名前解決しない)  
-p :: pidとプロセス名も表示する。  
-s :: 統計情報を表示
-r :: ルーティングテーブルを表示する。  
-t :: TCPポートのみ表示する。  
-u :: UDPポートのみ表示する。  
-x :: UNIXソケットを表示  
      ※ソケット :: プログラムがデータを交換する窓口  

オプション無し :: 有効なネットワーク接続や開いているソケットの情報等を表示。

■表示される項目
Active Internet connections
Proto , Recv-Q , Send-Q , LocalAddress , ForeignAddress , State , 
Active UNIX domain sockets
Proto , RefCnt , Flags , Type , State , I-Node , Path
```

netstatコマンドを打ったが、結果がなかなか表示されない。  
原因と考えられるものは何か。  
→  
DNSによる名前解決ができない。  
→  
-nオプションを指定する。  
→  
「netstat」コマンドはオプション無しで実行すると、有効なネットワーク接続や開いているソケットの情報等を表示します。  
その際にはアドレスやポート番号の名前解決を自動で行って表示します。  
この時にDNSサーバに障害などがあると、名前解決が出来ずに、結果が表示がされない場合があります。  

### ssコマンド

ssコマンドはnetstatの後継となるコマンドで、ネットワークのソケットの情報を表示します。  
ifconfig、route、arp、netstatコマンドなど旧来のネットワーク関連ユーティリティであるnet-toolsの代替として開発されたiproute2ユーティリティに含まれています。  

``` txt
ss [オプション]

オプション
-a :: 全てのソケットを表示
-n :: サービス名の名前解決をしない
-t :: TCPソケットを表示
-u :: UDPソケットを表示

※ソケット :: プログラムがデータを交換する窓口  

■表示項目
Netid,State,Recv-Q,Send-Q,LocalAddress:Port,Peer Address:Port
```

### ncコマンド  

netcatコマンド。  
catコマンドのネットワーク版。  
テキストストリームにおけるcatコマンドと同様の働きをネットワーク上で行うコマンド。  

NetcatはTCP/UDPを使った通信を手軽に行うことのできる便利なツールです。  
・標準入出力を使用してのデータ授受  
・TCP/UDPでのデータ送受信  
・簡易的なサーバになれる  

※catコマンド  
conCATenate(繋ぐ、連結する)。  
ファイルを連結するためのコマンド  

``` txt
nc [オプション] [接続先アドレス or ホスト] [宛先ポート番号]  

オプション
-l          :: 指定したアドレス、ポート番号で接続の待ち受けをする。(listen)
               指定したポートをリッスンする。  
               ※簡易サーバ構築に用いられる模様。
-p ポート   :: ポート番号を指定する。  
-u          :: UDPを利用する。(デフォはTCP)  
-o ファイル :: 指定したファイルに出力する。  

※宛先ポート番号が未指定の場合、デフォルトで31337番ポートが指定されたものとして動作する。
```

12345番ポートで待ち受け氏、受け取ったデータをlisten.logファイルに出力する。  
`nc -l -p 12345 -o listen.log`  

上記例を実行したホストの12345番ポートに対し、data.txtファイルの内容を出力する。  
`nc centos7.example.com 12345 < data.txt`  

ファイアウォール機能のテスト用に、Netcatを使って簡易サーバを用意したい。  
serverの8000/tcpで待ち受けし、clientから接続されるとresponse.txtを返す実行例。  
`nc -l 8000 < response.txt`  

ファイアウォール機能のテストのため、Netcatで送信元ポート番号を50000に指定して接続したい。  
`np -p 50000 test-sv`  

ローカルホスト（127.0.0.1）のSSHサーバ（ポート番号：22）にclientのポート番号50000から接続した例  
`nc -p 50000 127.0.0.1 22 &`  

### routeコマンド  

ルーティングテーブルの表示や操作を行うコマンド  
routeコマンドを引数なしで実行すると、ルーティングテーブルが表示される。  
`route` = `netstat -r`  

``` txt
■ルーティングテーブルの表示を行う書式
route [オプション]

オプション
-F :: カーネルのルーティングテーブルを表示(オプション指定無しと同じ)
-C :: カーネルのルーティングキャッシュを表示
-n :: 名前解決をせずルーティングテーブルを表示

■ルーティングテーブルの主な項目
Destination :: 宛先ネットワークアドレス(defaultはデフォルトルート)
Gateway     :: 宛先ネットワークへのゲートウェイ。(*は未設定)
Genmask     :: 宛先ネットワークのサブネットマスク(デフォルトルートは0.0.0.0)
Flags       :: 状態フラグ
Iface       :: 宛先ネットワークへの送信に使用するインターフェース

■状態フラグの項目
U :: 経路が有効
H :: 対象をホストとして設定
G :: ゲートウェイを使用


■ルーティングテーブルに新しい経路を追加する書式
route add [オプション]

-p :: add時に指定すると、次回以降のOS起動後も有効になる。

■ルーティングテーブルから経路情報を削除する書式
route del [オプション]

追加・削除オプション
-host      :: 対象をホストのアドレスとみなす
-net       :: 対象をネットワークアドレスとみなす
netmask    :: サブネットマスクを指定
gw         :: ゲートウェイを指定
default gw :: デフォルトゲートウェイを指定
```

192.168.0.0/24のネットワークあてのパケットは、ゲートウェイ172.30.0.254に送られるようにする設定を追加するコマンド例  
`route add -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイを172.30.0.1に設定する  
`route add default gw 172.30.0.1`  

設定した経路情報を削除する。  
`route del -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイ172.17.255.254を削除する。
`route del default gw 172.17.255.254`  
`route del default`  

デフォルトゲートウェイを削除するには、デフォルトゲートウェイのIPアドレスを指定して削除する方法としないで削除する方法があります。  
IPアドレスを指定する場合は、「route del」の後に「default gw」というオプションの後でIPアドレスを指定します。  
例えば「route del default gw 192.168.1.254」のようになります。  
IPアドレスを指定しない場合は、「route del default」のみでデフォルトゲートウェイの削除は可能です。  
その場合「gw」は付けてはいけません。  

### ipコマンド  

ネットワークインターフェースやルーティングテーブル、ARPテーブル等を管理するコマンド。  
ipコマンドはifconfigコマンドに変わる新しいコマンド。  

ifconfig、route、arp、netstatなどの旧来のネットワーク関連コマンドを置き換えるために、iproute2 ネットワークユーティリティが開発されました。  
iproute2を使うことで、※ポリシーベースルーティングやトラフィック制御といった高度なネットワーク設定が可能になります。  
iproute2ユーティリティでは、ipコマンドでアドレス設定、ルーティング設定などを行います。  
Red Hat Enterprise Linux 7からは旧来のネットワーク関連コマンドは非推奨となっており、今後はiproute2の使用が推奨されます。  
なお、現在でも旧来のネットワーク関連コマンドは提供されており、iproute2と併用することが可能です。  

※ポリシーベースルーティング（PBR）：  
通常のルーティングは宛先アドレスを元にパケットの送信先を決定しますが、  
PBRはそれ以外の情報（送信元アドレス、UDP/TCPのプロトコル、ポート番号など）を組み合わせてより詳細にパケットの送信先を決定するルーティング方式です。  

ipコマンドは、オブジェクト（機能）に対して、コマンド（処理）を指定する形式で実行します。  
オブジェクトやコマンドは短縮して指定することも可能です。  
なお、各オブジェクトごとに指定可能なコマンドは異なります。  

``` txt
ip [オプション] オブジェクト [サブコマンド] [デバイス]

オプション
-s :: 統計情報を表示する

オブジェクト
link      :: データリンク層、ネットワークデバイス、インターフェース
addr      :: IPv4,IPv6アドレス(短縮版は「a」)
route     :: ルーティングテーブル
neighbour :: IPv4のARPキャッシュ、IPv6のNDキャッシュ(アメリカ英語である「neighbor」でも動作する。「neighbour」はイギリス英語)

サブコマンド
show :: 現在の状態の表示(省略したときのデフォルト)(短縮版は「sh」)
add  :: 値の追加
del  :: 値の削除

※IPv6ではARPの代わりにND（Neighbor Discovery）を使って宛先MACアドレスを入手します。
入手したMACアドレスはNDキャッシュに格納されます。
NDキャッシュのみを確認する場合はIPv6を指定する「-6」または「-f inet6」オプションを指定します。

●routeオブジェクトに対する操作では、値としてデフォルトルートを意味する「default」を指定することもできます。

●経路情報を追加するには、routeオブジェクトにaddコマンドを発行します。その際、値を以下の書式で指定します。
ip route add 宛先ネットワークアドレス/サブネットマスク長 via ゲートウェイアドレス [ dev 出力インタフェース ]

例)
宛先ネットワークアドレス：192.168.3.0
サブネットマスク：255.255.255.0
ゲートウェイ：192.168.1.1

ip route add 192.168.3.0/24 via 192.168.1.1


●経路情報を削除するには、routeオブジェクトにdelコマンドを発行します。その際、値を以下の書式で指定します。
ip route del 宛先ネットワークアドレス/サブネットマスク長 [via ゲートウェイアドレス [ dev 出力インタフェース ]]

※デフォルトルートを対象とする場合は「宛先ネットワークアドレス/サブネットマスク長」を「default」と指定します。

例)
ip route del 192.168.3.0/26 via 192.168.2.101 dev eth1

例)コマンドで、デフォルトルートを削除する  
ip route del default
ip route del default via 192.168.122.1


●インタフェースにアドレスを追加するには、addrオブジェクトにaddコマンドを発行します。その際、値を以下の書式で指定します。
ip addr add 宛先ネットワークアドレス/サブネットマスク長 dev インタフェース

例)ip コマンドを使って、lo インタフェースに以下のアドレスを追加したい。
アドレス：127.0.0.100
サブネットマスク：255.255.0.0

ip addr add 127.0.0.100/16 dev lo


●インタフェースを有効化・無効化するには、linkオブジェクトにsetコマンドを発行します。
ip link set { up | down } dev インタフェース
ip link set インタフェース up|down

up   :: インターフェースの有効化
down :: インターフェースの無効化


●IPアドレスの設定状況を確認したい。(短縮バージョン)
ip addr showの短縮バージョン
ip a sh
```

ネットワークインターフェースのデータリンク層の情報を表示する  
`ip link show`  

ネットワークインターフェースeth0の詳細情報を表示する
`ip -s link show dev eth0`

ルーティングテーブルの表示  
`ip route show`  

eth0インターフェースの状態やIPアドレスの表示  
`ip addr show eth0`  

eth0のipアドレスを192.168.11.12/24に設定する  
`ip addr add 192.168.11.12/23 dev eth0`  

デフォルトゲートウェイを192.168.11.1に設定
`id addp add default via 192.168.11.1`  

### 経路表示コマンド早見表

・ip route show  
・route  
・netstat -r  

ipコマンドでルーティングテーブルを表示した場合、viaやdevという表示がある。  

routeとnetstat -rの表示は全く同じ。viaという文言はない。  
Destination,Gateway,Genmask,Flags,Metric,Ref,Use,Iface  

### ifconfigコマンド  

ネットワークインターフェースの情報の表示や設定を行うコマンド。  
ipアドレスの確認によく利用する模様。  
ifconfigは古いので非推奨。ifconfigに代わって利用が推奨されるipコマンドを使うべし。  

``` txt
ifconfig [インターフェース名] [オプション]

オプション
IPアドレス        :: ipアドレスを設定する
netmask ｻﾌﾞﾈｯﾄﾏｽｸ :: サブネットマスクを設定する
up                :: ネットワークインターフェースを有効化する
down              :: ネットワークインターフェースを無効化する


インターフェース名やオプションを指定せずに「ifconfig」コマンドのみを実行すると、有効化されている全てのインターフェースの情報が表示されます。
オプションを指定せずインターフェース名を指定すれば、そのインターフェースの情報のみが表示されます。

表示内容
・インターフェースのMACアドレスやIPアドレス
・ブロードキャストアドレス
・サブネットマスク
・送受信バイト数
・MTU（最大転送単位）
等

※ネットワークインターフェース名はデバイスに基づいた命名規則によって生成されるのが一般的らしい  


ifconfigコマンド使用時の影響範囲について述べた記述で、正しいものを二つ選べ。  
→  
・インターフェースのアップ・ダウン状態が変更される  
・ifconfigコマンドを実行しても、何も影響がない場合もある  

・ルーティングテーブルが変わることはない  
インターフェースを停止すると、接続するネットワークの情報がルーティングテーブルから削除されるため、通信できなくなります。  

・ IPアドレスやサブネットマスクは起動スクリプトで設定されるため、ifconfigでは変更できない  
インターフェース名の後にオプションを指定することで、IPアドレスやサブネットマスクの設定が可能です。  

・ルーティングテーブルに影響なくIPアドレスやサブネットマスクを変えられる  
サブネットマスクを変更すると所属するネットワークが変わるため、ルーティングに影響が出ることに注意してください。  


インターフェースを停止すると、接続するネットワークと通信できなくなります。また、接続するネットワークの情報がルーティングテーブルからも削除されます。
サブネットマスクを変更すると所属するネットワークが変わるため、ルーティングに影響が出ることに注意してください。
この場合、インターフェイスはアップ・ダウンしていませんが、ルーティングテーブルは変更されています。
```

ネットワークインターフェースの情報を表示する  
`ifconfig`  

ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`

ネットワークインターフェースeth0のサブネットマスクを255.255.255.0に設定する。  
`ifconfig eth0 netmask 255.255.255.0`  

### ifup

ifupは指定したインタフェースを有効にするコマンドです。  
ディストリビューションによって書式が異なります。  

``` txt
Red Hat系の書式：
ifup インタフェース名

Debian系の書式：
ifup [オプション] インタフェース名

-a :: 「/etc/network/interfaces」でautoフラグが設定されたNICを対象とする
```

### ifdown

ifdownは指定したインタフェースを無効にするコマンドです。  
ディストリビューションによって書式が異なります。  

``` txt
Red Hat系の書式：
ifdown インタフェース名

Debian系の書式：
ifdown [オプション] インタフェース名

-a :: 「/etc/network/interfaces」でautoフラグが設定されたNICを対象とする
```

### デフォルトルート

・他に宛先がない場合に参照されるルートである  
・Linuxのルーティングテーブルでは「default」と表示される  

宛先ネットワークがルーティングテーブルの「Destination」に存在しない場合は、デフォルトルートの存在を確認し、  
存在する場合はデフォルトルートの「Gateway」（デフォルトゲートウェイ）へ送信します。  
デフォルトルートとは、ルーティングテーブルの「Destination」が「default」と表示されている情報です。  
「route -n」コマンドで名前解決をせずにルーティングテーブルを表示した場合は「0.0.0.0」と表示されます。  

---

## DNSの設定

### DNS（Domain Name System）

DNS（Domain Name System）はドメイン名/ホスト名などの名前とIPアドレスを対応させるシステムです。  
DNSサーバが名前とIPアドレスの対応情報（リソースレコード）を管理し、DNSクライアントからの問い合わせに対して名前解決のための情報を提供します。  

DNSサーバにはDNSキャッシュサーバと権威DNSサーバがあり、インターネット上の多数のDNSサーバでドメイン情報を分散して管理しています。  
・DNSキャッシュサーバ  
権威DNSサーバに問い合わせを行い、得た情報をキャッシュに保持します。  
保持している情報に該当する問い合わせがきた場合は権威DNSサーバに問い合わせずに応答することで、DNSクライアントへの応答速度を上げるとともに、  
権威DNSサーバの負荷も減らします。  

・権威DNSサーバ（ネームサーバ）  
特定のドメインの情報を管理する正当な権限を持つDNSサーバです。  
「xxx.com」を管理する権威DNSサーバや、「xxx.jp」を管理する権威DNSサーバのように、ドメインごとに分散管理しています。名前に関する情報（コンテンツ）を保持するため、  
コンテンツサーバともよばれます。  

DNSサーバが管理している情報をリソースレコードと呼び、主に以下のリソースタイプ（種類）があります。

``` txt
a   :: IPアドレス
mx  :: メールサーバーの情報
ns  :: ネームサーバーの情報
soa :: ゾーン(ドメインの範囲)の情報
txt :: テキスト情報
```

ホスト名とIPアドレスの相互変換→名前解決  
ホスト名からIPアドレスを求める→正引き  
IPアドレスカラホスト名を求める→逆引き  

www.example.com
www : ホスト名  
example.com : ドメイン名  

ネットワークの区画(ドメイン)に所属しているPC名(ホスト名)  

### /etc/resolv.confファイル

名前解決に使用するDNSサーバや、DNSの名前解決問い合わせに関するオプションを設定するファイル。  
ファイル名はresolveではなく**resolv**なので注意。  

今思ったらdns domain,nameserver,serachでdnsの頭文字になってる。  
これならそれっぽく覚えられるな。  

domainとsearchはどちらか片方を指定する。  
両方指定した場合はsearchのほうが有効になる。  

``` txt : 記述例
domain infraeye.com
search infraeye.com infraeye.net infraeye.edu
nameserver 192.168.231.2
```

- domain :  
  このホストが所属するドメイン名を記述する。  
  ドメイン名を含まないホスト名を検索する場合、このドメイン内を検索する。  
  複数のドメイン名を指定することはできない。  
  自ドメインを指定する際はdomainにドメイン名を記述する。  
  例)自ドメインが(pint-t.com)だった場合  
  `domain pint-t.com`  
- serach :  
  ドメイン名の省略時に補完するドメイン名を記述。  
  複数指定可能。スペースで区切る。左から右へ検索していく。  
  **searchの指定を行った場合、ドットがないホスト名についてはsearchで指定したドメインを検索する。**  
- nameserver :  
  DNSサーバーのIPアドレスを記述。  
  nameserverの指定は3台まで。  
  応答が無ければ次の行を参照する。  

「nameserver」の後にDNSサーバのIPアドレスを、「search」の後にドメイン名検索リストを指定します。  

``` txt
# cat /etc/resolv.conf
search test1.domain test2.domain test3.domain
nameserver 192.168.1.1
nameserver 192.168.1.2
nameserver 192.168.1.3
```

設問の設定では、以下のように名前解決しようとします。  
■問い合わせ順序  
・DNSサーバ 192.168.1.1に最初に問い合わせる  
・192.168.1.1から応答がなければ、192.168.1.2に問い合わせる  
・192.168.1.2から応答がなければ、192.168.1.3に問い合わせる  

■名前解決の対象がホスト名のみ（＝ドットを含まない）の場合  
・リストの1番目（test1.domain）をホスト名につけて名前解決  
・リストの1番目のドメインを追加して名前解決に失敗した場合、リストの2番目（test2.domain）を追加して名前解決  
・リストの2番目のドメインを追加して名前解決に失敗した場合、リストの3番目（test3.domain）を追加して名前解決  
・search行のドメイン名リストすべてで失敗した場合、ホスト名のみで名前解決  
・ホスト名のみでも失敗した場合、名前解決に失敗とする  

■名前解決の対象がドメイン名付き（と思われる＝ドットを含む）の場合  
・そのままで名前解決  
・失敗した場合、リストの1番目（test1.domain）を追加して名前解決  
・リストの1番目のドメインを追加して名前解決に失敗した場合、リストの2番目（test2.domain）を追加して名前解決  
・リストの2番目のドメインを追加して名前解決に失敗した場合、リストの3番目（test3.domain）を追加して名前解決  
・search行のメイン名リストすべてで失敗した場合、名前解決に失敗とする  

したがって正解は  
・192.168.1.1から応答が無ければ、192.168.1.2に問い合わせる  
・ホスト名にtest1.domain、test2.domain、test3.domainの順にドメインを追加して名前解決を試みる  

「問い合わせて解決できなければ」ではなく、「応答がなければ」であることに注意。  

### ドメイン

<https://t-tel.net/domain/092/>  

`https://www.example.com`  
ホスト名 : www  
ドメイン名 : example.com  
FQDN : www.example.com  

ホスト名 + ドメイン名 = FQDN  
Fully Qualified Domain Name  

### /etc/nsswitch.conf  

「nsswitch.conf」は、GNU Cライブラリが名前解決やサービス名解決の際の問い合わせ順序を指定するファイルです。  
ユーザー情報、パスワード情報の取得、ホスト名からIPアドレスを取得する際の情報検索先など設定内容は多岐にわたります。  

名前解決の仕方にも色々あるので、どういう順番でどういう手段を使うのかを設定するファイル  

主な名前解決の方法  
・etc/hostsファイルでの問い合わせ→files  
・LDAPサーバーへの問い合わせ→ladp  
・DNSサーバーへの問い合わせ→dns  

以下の記述例の場合、ホスト名の名前解決のために最初に/etc/hostsファイルを参照し、次にLDAPサーバーに問い合わせ、最後にDNSサーバーに問い合わせるように定義している。  

``` txt : /etc/nsswitch.confファイルの設定例
hosts: files ldap dns
```

「passwd」の行でパスワードの情報源の順番を指定します。  
「files」が「/etc/passwd」ファイルを表します。  
「hosts」の行で名前解決の順番を指定します。  
「files」が「/etc/hosts」ファイルを、「dns」がDNSサーバを表します。  
「/etc/hosts」を先に参照し、そこで名前解決が出来なければDNSサーバに問い合わせを行うように指定しています。  

「/etc/nsswitch.conf」ファイルでは、「hosts」の行で名前解決の順番を指定します。  
「files」が「/etc/hosts」ファイルを、「dns」がDNSサーバを表します。  
表示例では「/etc/hosts」を先に参照し、そこで名前解決が出来なければDNSサーバに問い合わせを行うように指定しています。  

「hosts:」に続けて優先順位の高い方から名前解決方法を記述します。  
最初の「files」で「/etc/hosts」ファイルを参照して名前解決をするように指定し、それができなければ続く「dns」でDNSサーバに問い合わせを行うように指定しています。  

``` txt
cat /etc/nsswitch.conf
passwd: files
hosts: files dns
```

### etc/systemd/resolved.conf

systemdを採用したディストリビューションでは、名前解決にsystemd-resolvedサービスが使われる。  
その設定ファイル。  

``` txt : /etc/systemd/resolved.conf
[Resolve]
DNS=192.168.11.1 8.8.8.8
Domains=example.com
```

systemd-resolvedサービスを有効にするコマンド  
`systemctl restart systemd-resolved.service`  

### systemd-resolved

systemd-resolvedは、systemdの動作するシステムで名前解決を管理するデーモンです。  
systemd-resolvedの設定は「/etc/systemd/resolved.conf」ファイルや「/etc/systemd/resolved.conf.d/」配下の拡張子.confのファイルで行います。  

``` txt : resolved.confからの抜粋
[Resolve]
DNS=192.168.0.1
```

### hostコマンド  

DNSサーバーを使ってホストやドメインに関する情報を表示する。  

``` txt
host [オプション] ホスト名orIPアドレス [DNSサーバー]

オプション
-t :: 問い合わせる情報の指定(type)
      digと同じく、a,mx,ns,any等が指定できる。
-v :: 詳細な情報表示(verbose)
```

www.lpi.jpのIPアドレスを問い合わせる→正引き  
`host www.lpi.jp`  

192.168.0.6のホスト名を問い合わせる→逆引き  
`host 192.168.0.6`  

### digコマンド  

DNSサーバへ直接問い合わせて、指定した名前に関するDNSサーバからの応答を表示します。  
また、表示する情報のタイプ（リソースタイプ）を指定する事もでき、詳細な情報を確認できるため、DNSに関するデバッギングツールとしても使用できます。  

・指定したホスト名に対するDNSサーバーへの登録情報を表示する。  
・DNSサーバーからデバッグのための詳細な情報を取得できる。  
・nslookupコマンドはDNSサーバーからの応用を加工して表示するが、digでは応答を加工せずに表示する。  

``` txt
dig [オプション] [@DNSサーバー名] ホスト名orドメイン名 [検索タイプ]

オプション
-x :: IPアドレスからホスト名を検索する(逆引き)

「@DNSサーバ」には問い合わせるDNSサーバを指定します。  
省略した場合は、そのホストに設定されているDNSサーバに問い合わせます。  
-tオプションの後に検索タイプを指定しても情報を絞り込めます。  

検索タイプ
a      :: ipアドレス(Address)(デフォルト)
aaaa   :: ipv6アドレス
any    :: 全ての情報
mx     :: メールサーバーの情報(Mail Exchanger)
ns     :: ネームサーバーの情報(Name Server)
txt    :: ゾーン(ドメインの範囲)の情報
+short :: 詳細情報を省く
```

TXTレコードは任意の文字列を記すためのものですが、メールの送信元を記載することで正しい送信元を確認するためのSPFレコードとして利用したり、  
Google指定の情報を記載することでGoogleのサービス利用時に所有者であることを証明したりすることができます。  

lpi.jpのメールサーバー情報を問い合わせる  
`dig lpi.jp mx`  

69.90.69.237のホスト名を問い合わせる(詳細情報を省く)  
`dig -x 69.90.69.237 +short`

### whoisコマンド  

whoisサーバのデータベースに問い合わせを行い、ドメインの登録者や管理者、所属団体等の情報を得ることができます。  

ドメインの管理者や所有者情報を表示。  
調べたいドメイン名を指定して、whoisデータベースに問い合わせるコマンド。  

### getentコマンド

名前解決の順序を設定する「/etc/nsswitch.conf」に従って検索を行うコマンド。

ホスト名の名前解決順序は「hosts」項目で設定します。  
設問の図のように「files dns」の設定であれば、/etc/hostsから検索し、見つからなければ次にDNSサーバに問い合わせを行います。  
データベース名に nsswitch.conf で指定できるサービス名、検索したい情報をキーに指定することで、名前解決順序設定に従って検索した結果を得られます。  

``` txt
getent データベース名 [ キー ... ]

データベース名
hosts :: nsswitch.conf で指定できるサービス名を指定する。(passwd,hosts)
```

testsvの名前解決  
`getent hosts testsv`  

### 早見表

``` txt
host     :: DNSサーバーを使ってホストやドメインに関する情報を表示する。最も基本となるコマンド。
dig      :: DNSサーバへ直接問い合わせて、指定した名前に関するDNSサーバからの応答を表示します。
getent   :: 名前解決の順序を設定する「/etc/nsswitch.conf」に従って検索を行うコマンド。
nslookup :: DNSサーバに名前解決を問い合わせるコマンド。Windowsのコマンド。
netstat  :: さまざまな項目を指定して、ローカルホストのネットワーク関連の情報を表示するコマンド。
hostname :: 自ホストのホスト名やドメインを参照したり、ホスト名を一時的に変更するコマンド。
```

DNSを利用し、ホスト名をIPアドレスに変換することができるコマンド  
host、nslookup、getent、dig  

IPアドレスとホスト名の変換を行うコマンド  
nslookup、host、dig  

DNSサーバに問い合わせて名前解決を行うコマンドには、nslookup、dig、hostがありますが、出力する情報が最も少ないのはhostコマンドです。  

ドメイン情報の表示  
dig  

---

## 小豆本問題

### 1

エラーメッセージや制御メッセージを伝送するコネクションレス型のプロトコルで、pingやtracerouteコマンド等で利用されているものを選択してください。  

pingという地点でネットワーク層。
プロトコルなので、internet protcol management protocol

---

### 2

以下のIPアドレスの中から、プライベートアドレスとして利用できるものを全て選択してください。

10.0.0.0~10.255.255.255
172.16.0.0~172.31.255.255
192.168.0.0~192.168.255.255

A,E

---

### 3

ネットワークサービスの名称とそのサービスが標準的に利用するポート番号の対応が記述されているファイルを絶対パスで記述してください。  

→  
やったはずなんだが。
思いっきりやってたわ。
サービスってあるから、それで回答すればよろしかった。

`/etc/services`  

---

### 4

デフォルトで53番ポートを利用するサービスを選択してください。

80と25と443しか知らない。

FTP?
UDPでした。

---

### 5

example.com ドメインのメールサーバー情報を問い合わせたい場合、下線部に当てはまる適切なパラメータを記述してください。  
`dig___`

× dig -mx example.com
○ dig example.com mx

---

### 6

離れたネットワークにあるホストAとの通信が出来なくなりました。
ホストAまでは複数のルータを経由しており、ローカルネットワーク内では通信に問題はないことから、ホストAとローカルネットワークの間に障害が発生していると考えられます。  
障害の発生している場所を特定するために最も役立つと考えられるコマンドを選択してください。

→
複数のルーターを跨ぐ。どこ地点で死んでいるか調べるためにはルートを検索すべき。
なので、tracerouteでは無かろうか？
合ってた。
ラジオボタンでの選択式で、tracerouteがあったからそれしかないが、他にも`tracepath`もいけるはず。

---

### 7

NetworkManagerでネットワークを管理しています。以下のコマンドを実行してネットワークの接続情報を表示しました。
`$____conn show`

×nclim  
○nmcli  
network manager command line interfaceの略か？

---

### 8

ネットワークインターフェースeth0に、IPアドレス[10.10.0.5]、サブネットマスク[255.255.255.0]を設定したい場合、実行すべきコマンドを選択してください。  

ipコマンドでネットワークの設定はどうやるんだったか。  
正直、ネットワークインターフェースを設定するコマンドだけで2つ以上はあった気がする。  
addr がipアドレスを対象とするって意味だった気がする。
add が追加と思いきや設定で、サブネットはサイダーで決定できるんだっけか。  
となれば、選択肢はCしかなさそうだが？
合ってた。  

`ip addr add 10.10.0.5/24 dev eth`  

他のやつ
ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`

/etc/sysconfig/network-scriptsディレクトリ  
RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  

---

### 9

以下のIPv6アドレスの省略された表記として適切なものを全て選択してください。
`2001:0db8:0000:0000:0023:0000:0000:0045`

→
①先頭の0は省略できる。  
②0が連続しているところは1か所だけ省略することができる。  

2001:db8::23:0:0:45  
2001:db8:0:0:23::45  
