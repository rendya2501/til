# 11.ネットワークの基礎

## TCP/IPの基礎

・TCP(Transmission Control Protocol)  
・IP(Internet Protocol)  
・IPv6  
・UDP(User Datagram Protocol)  
・ICMP(Internet Control Message Protocol)  
・サブネット、ネットワークアドレス、ブロードキャストアドレス、プライベートアドレス  
・CIDR(Classless Inter-Domain Rounting)  
・ユニキャスト、エニーキャスト、マルチキャスト  
・ウェルノウンポート  
・/etc/servicesファイル  

●IPv6

- アドレス長が128bit  
- ユニキャスト、エニーキャスト、マルチキャストをサポート。  
ブロードキャストはサポートしていない。  
ブロードキャストはマルチキャストで行う。  
- アドレス表記法  
①各ブロックの先頭の「0」は省略できる  
②「0」が連続するブロックは省略して[::]と表記できる。(1か所だけ)  
- プロトコル番号はIPv4と同じ。  
- ポート機能はIPv4と同じ。  
- IPv4アドレスと直接通信出来ない。変換が必要。  
- IPv4のネットワーク部に相当する部分を**プレフィックス**、ホスト部に相当する部分を**インターフェースID**という  
- プレフィックス、インターフェースIDともに64ビット  

※プロトコル番号  
上位争のプロトコルを識別するための番号。
IPヘッダに8ビット情報で存在する。  
各プロトコルにはポート番号だけではなく、各々に番号がある模様。  

``` txt
1 : ICPM
4 : IP
6 : TCP
17 : UDP
etc...
```

・ユニキャスト : 1つのネットワークインターフェースを識別するアドレス  
・エニーキャスト : 複数のホストの集合に割り当てられるアドレス  
・マルチキャスト : IPv4のブロードキャストに相当するもの  

ローカルループバックアドレス , ::1/128  
グローバルユニキャストアドレス , 2000::/3  
リンクローカルユニキャストアドレス , fe80::/10  
マルチキャストアドレス , ff00::/8  

●CIDR  
サイダー  
アドレスクラスの概念を気にしないで、IPアドレスの割り当てや経路選択などの自由度を上げる仕組み  
サブネットマスクを調整することで任意の大きさのネットワークを作るあれのこと。  
192.168.0.***/24の「/24」の部分がCIDR表記。  

クラスの概念に基づいてネットワークを設定すると、使わないIPアドレスが発生してしまう。  
なので、クラスの概念をとっぱらって、サブネットマスクでもって、設定できるようにしたほうが無駄が少なくてよくね？って考え方がこれ。  

●ウェルノウンポート  
都度メモ  

●/etc/servicesファイル  
ポート番号とサービスの対応が記述されたファイル  

---

## ネットワークの設定

・/etc/hostnameファイル  
・/etc/hostsファイル  
・/etc/network/interfacesファイル  
・/etc/sysconfig/network-scriptsディレクトリ  
・NetworkManager  
・nmcliコマンド  
・hostnamectrlコマンド  

●/etc/hostnameファイル  
ホスト名が記述されているファイル。  

``` conf : 例
centos7.example.com
```

●/etc/hostsファイル  
ホスト名とIPアドレスの対応を記述するファイル。  
小規模ならこれで十分。これ以上になればDNSになるはず。  
変更の反映は全てのホストに配布する必要がある。  
IPアドレス、ホスト名、ホストの別名をスペースで区切って記述する。  

``` conf : 例
127.0.0.1 localhost.localdomain localhost
192.168.0.1 windsor.example.com windsor
```

●/etc/network/interfacesファイル  
Debian系でネットワークインターフェースの設定を記述するファイル。  
Debian系はUbuntuとかか。  

設定項目は多数あるので、問題で出たら都度まとめる。  
IPアドレスとかネットマスクとかDNSのIPアドレスとかデフォルトゲートウェイとか、そういう基本的な設定をするのがこのファイルってわけ。  

●/etc/sysconfig/network-scriptsディレクトリ  
RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  
ネットワークインターフェース名が「eth0」の場合、設定ファイル名は「ifcfg-eth0」となる。  
IPアドレスを固定で割り当てたい場合などにこのファイルを編集する。  

●NetworkManager  
ネットワークを管理するサブシステムらしい。  
CentやRHELで導入されている。  

利用確認コマンド  
`systemctl status NetworkManager`  

●nmcliコマンド  
NetworkManagerにおいて、ネットワークの設定、接続の管理、状態の確認を行うコマンド。  
Network Manager Command Line Interfaceの略見たい。  

`nmcli オブジェクト [コマンド]`  
膨大なので都度。  

●hostnamectlコマンド  
ホスト名を設定するコマンド  

`hostnamectl [サブコマンド]`
status : ホスト名と関連情報を表示する(でふぉ)
set-hostname ホスト名 : ホスト名を設定する  

hostnamectl set-hostname vm2 : ホスト名をvm2に変更

/etc/hostnameファイルでもホスト名を変更できるなら、hostnamectlコマンドでホスト名を変更した情報はどこに保存されるのか？  
hostnamectlコマンドで/etc/hostnameファイルが変更される？  
[hostnameコマンドより便利なhostnamectlコマンド](https://linuc.spa-miz.com/2020/12/23/hostnamectl-command-more-useful-than-the-hostname-command/)  
→
hostnamectlコマンドで/etc/hostnameファイルが変更されるらしい。  
結局、保存先であるファイルが全て何だな。  

---

## ネットワークのトラブルシューティング

・pingコマンド  
・ping6コマンド  
・tracerouteコマンド  
・traceroute6コマンド  
・tracepathコマンド  
・tracepath6コマンド  
・hostnameコマンド  
・netstatコマンド  
・ncコマンド  
・routeコマンド  
・ipコマンド  
・ifconfigコマンド  
・ifupコマンド  
・ifdownコマンド  

●pingコマンド  
指定されたホスト(ホスト名もしくはIPアドレス)にICMPパケットを送り、その反応を表示するコマンド  
何もオプションを指定しない場合、Ctrl + Cを押すまで送信し続ける。  

ping [オプション] ホスト名orIPアドレス  
-c 回数 : 指定した回数だけICMPパケットを送信する。  
-i 間隔 : 指定した間隔(秒)ごとにICPMパケットを送信する(デフォは1秒)  

●ping6コマンド  
ipv6の場合はこちらを使う。  
使い方は普通のpingと同じ。  

●tracerouteコマンド  
指定されたホスト(ホスト名もしくはIPアドレス)までパケットが伝わる経路を表示するコマンド  
宛先までのルータやホストが順に表示される。  
ネットワーク経路上に障害があった場合は、その位置を特定できる可能性がある。  

traceroute ホスト名orIPアドレス  

●traceroute6コマンド  
ip6版。  

●tracepathコマンド  
tracerouteコマンドと同様に、指定されたホストまでのパケットが伝わる経路を表示するコマンド。  

tracepath ホスト名orIPアドレス[/ポート番号]  

●tracepath6コマンド  
ry  

●tracerouteとtracepathの違い  
traceroute : 宛先アドレスまでの経路を確認できる。  
tracepath : 宛先アドレスまでの経路と経路上のPathMTUを確認できる。  

MTUは「通信用に細切れにしたデータの大きさ制限で『これくらいの大きさの細切れデータなら通れるよ（送れるよ）』な最大値」
Maximum Transmission Unit  

次から次へと新しいことが出てくるな。  
まぁ、それが勉強ってもんだよな。  

●hostnameコマンド
ホスト名を表示したり変更したりするコマンド。  

hostname [ホスト名]  

ホスト名を指定しない場合、現在のホスト名を表示する。  
ホスト名を指定した場合、ホスト名を変更する。  
ホスト名を変更できるのはrootユーザーのみ。  

ホスト名変更色々まとめ。  
[CentOS 7 の Hostname を変更する](https://qiita.com/notakaos/items/d18ab37bce2b25b2d5b0)  

●netstatコマンド  
ネットワーク機能に関する様々な情報を表示するコマンド  
開いているポートの検索によく利用する模様。  

``` txt
netstat [オプション]  

-a : すべてのソケット情報を表示する。全てのプロトコル(TCP,UDP,UNIXソケット)を表示  
-l : 接続待ち(LISTEN)のソケットを表示。  
-c : 状況を1秒ごとにリアルタイムで表示する。  
-i : ネットワークインターフェースの状態を表示する。  
-n : アドレスやポートを数値で表示する。(つまり名前解決の必要がない)  
-p : pidとプロセス名も表示する。  
-s : 統計情報を表示
-r : ルーティングテーブルを表示する。  
-t : TCPポートのみ表示する。  
-u : UDPポートのみ表示する。  
-x : UNIXソケットを表示  
```

※ソケット  
プログラムがデータを交換する窓口  

●ncコマンド  
netcatコマンド。  
catコマンドのネットワーク版。  
テキストストリームにおけるcatコマンドと同様の働きをネットワーク上で行うコマンド。  

※catコマンド
conCATenate(繋ぐ、連結する)。
ファイルを連結するためのコマンド  

``` txt
nc [オプション] [ホスト] [ポート番号]  

-l : 指定したポートをリッスンする。  
-p ポート : ポート番号を指定する。  
-u : UDPを利用する。(デフォはTCP)  
-o ファイル : 指定したファイルに出力する。  
```

12345番ポートで待ち受け氏、受け取ったデータをlisten.logファイルに出力する。  
nc -l -p 12345 -o listen.log  

上記例を実行したホストの12345番ポートに対し、data.txtファイルの内容を出力する。  
nc centos7.example.com 12345 < data.txt  

●routeコマンド  
ルーティングテーブルの表示や操作を行うコマンド  
routeコマンドを引数なしで実行すると、ルーティングテーブルが表示される。
`route` = `netstat -r`  

``` txt
ルーティングテーブルの表示を行う書式
route [オプション]

ルーティングテーブルに新しい経路を追加する書式
route add [パラメータ]

ルーティングテーブルから経路情報を削除する書式
route del [パラメータ]

-F : カーネルのルーティングテーブルを表示する
-C : カーネルのルーティングキャッシュを表示する
```

ルーティングテーブルの項目にも色々あるが、だるいので都度  

192.168.0.0/24のネットワークあてのパケットは、ゲートウェイ172.30.0.254に送られるようにする設定を追加するコマンド例  
`route add -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイを172.30.0.1に設定する  
`route add default gw 172.30.0.1`  

設定した経路情報を削除する。  
`route del -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

●ipコマンド  
ネットワークインターフェースやルーティングテーブル、ARPテーブル等を管理するコマンド。  

``` txt
ip 操作対象 [サブコマンド] [デバイス]

操作対称
link : データリンク層
addr : ipアドレス
route : ルーティングテーブル

サブコマンド
show : 表示する ←省略したときのデフォ
add : 設定する
```

ネットワークインターフェースのデータリンク層の情報を表示する  
`ip link show`  

ルーティングテーブルの表示  
`ip route show`  

eth0インターフェースの状態やIPアドレスの表示  
`ip addr show eth0`  

eth0のipアドレスを192.168.11.12/24に設定する  
`ip addr add 192.168.11.12/23 dev eth0`  

デフォルトゲートウェイを192.168.11.1に設定
`id addp add default via 192.168.11.1`  

●ifconfigコマンド  
ネットワークインターフェースの状態を表示したり、設定を行ったりするコマンド。  
ipアドレスの確認によく利用する模様。  

``` txt
ifconfig [ネットワークインターフェース名] [パラメータ]

パラメータ
IPアドレス : ipアドレスを設定する  
netmask サブネットマスク : サブネットマスクを設定する  
up : ネットワークインターフェースを有効化する
down : ネットワークインターフェースを無効化する
```

※ネットワークインターフェース名はあデバイスに基づいた命名規則によって生成されるのが一般的らしい  

ネットワークインターフェースの情報を表示する  
`ifconfig`  

ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`

●ifup,ifdown
指定したネットワークインターフェースの有効無効にするコマンド。
ifconfigのup downだけをコマンドで抜き出したものと思われる。  

``` txt
ifup [ネットワークインターフェース名]
ifdown [ネットワークインターフェース名]
```

---

## DNSの設定

・/etc/resolv.confファイル  
・/etc/nsswitch.confファイル  
・/etc/systemd/resolved.confファイル  
・hostコマンド  
・digコマンド  
・whoisコマンド  

### 概要

ホスト名とIPアドレスの相互変換→名前解決  
ホスト名からIPアドレスを求める→正引き  
IPアドレスカラホスト名を求める→逆引き  

www.example.com
www : ホスト名  
example.com : ドメイン名  

ネットワークの区画(ドメイン)に所属しているPC名(ホスト名)  

### DNSの設定ファイル

●/etc/resolv.confファイル
どこにあるDNSサーバーを参照するかを設定するファイル  

``` txt
domain infraeye.com
search infraeye.com
nameserver 192.168.231.2
```

domain行 : このホストが所属するドメイン名を記述する。  
serach行 : ドメイン名の省略時に補完するドメイン名を記述。  
nameserver行 : DNSサーバーのIPアドレスを記述。複数行を記述可能。応答が無ければ次の行を参照する。  

●/etc/nsswitch.confファイル  
名前解決の仕方にも色々あるので、どういう順番でどういう手段を使うのかを設定するファイル  

主な名前解決の方法  
・etc/hostsファイルでの問い合わせ→files  
・LDAPサーバーへの問い合わせ→ladp  
・DNSサーバーへの問い合わせ→dns  

以下の記述例の場合、ホスト名の名前解決のために最初に/etc/hostsファイルを参照し、次にLDAPサーバーに問い合わせ、最後にDNSサーバーに問い合わせるように定義している。  

``` conf : /etc/nsswitch.confファイルの設定例
hosts: files ldap dns
```

●etc/systemd/resolved.confファイル
systemdを採用したディストリビューションでは、名前解決にsystemd-resolvedサービスが使われる。  
その設定ファイル。  

``` conf : /etc/systemd\resolved.conf
[Resolve]
DNS=192.168.11.1 8.8.8.8
Domains=example.com
```

systemd-resolvedサービスを有効にするコマンド  
`systemctl restart systemd-resolved.service`  

### DNS管理コマンド  

●hostコマンド  
DNSサーバーを使ってホストやドメインに関する情報を表示する。  

``` txt
host [オプション] ホスト名orIPアドレス [DNSサーバー]

オプション
-v : 詳細な情報表示
```

www.lpi.jpのIPアドレスを問い合わせる→正引き  
`host www.lpi.jp`  

192.168.0.6のホスト名を問い合わせる→逆引き  
`host 192.168.0.6`  

●digコマンド  
DNSサーバーに対して問い合わせを行い、その応答結果を表示するコマンド。  
nslookupコマンドはDNSサーバーからの応用を加工して表示するが、digでは応答を加工せずに表示する。  

``` txt
dig [オプション] [@DNSサーバー名] ホスト名orドメイン名 [検索タイプ]

オプション
-x : IPアドレスからホスト名を検索する

検索タイプ
a : ipアドレス
aaaa : ipv6アドレス
any : 全ての情報
mx : メールサーバーの情報
ns : ネームサーバーの情報
```

lpi.jpのメールサーバー情報を問い合わせる  
`dig lpi.jp mx`  

●whoisコマンド  
調べたいドメイン名を指定して、whoisデータベースに問い合わせるコマンド。  

---

## 小豆本問題

1.エラーメッセージや制御メッセージを伝送するコネクションレス型のプロトコルで、pingやtracerouteコマンド等で利用されているものを選択してください。  

pingという地点でネットワーク層。
プロトコルなので、internet protcol management protocol



2.以下のIPアドレスの中から、プライベートアドレスとして利用できるものを全て選択してください。

10.0.0.0~10.255.255.255
172.16.0.0~172.31.255.255
192.168.0.0~192.168.255.255

A,E



3.ネットワークサービスの名称とそのサービスが標準的に利用するポート番号の対応が記述されているファイルを絶対パスで記述してください。  
→  
やったはずなんだが。
思いっきりやってたわ。
サービスってあるから、それで回答すればよろしかった。

`/etc/services`  



4.デフォルトで53番ポートを利用するサービスを選択してください。
80と25と443しか知らない。

FTP?
UDPでした。



5.example.com ドメインのメールサーバー情報を問い合わせたい場合、下線部に当てはまる適切なパラメータを記述してください。  
`dig___`

× dig -mx example.com
○ dig example.com mx



6.離れたネットワークにあるホストAとの通信が出来なくなりました。
ホストAまでは複数のルータを経由しており、ローカルネットワーク内では通信に問題はないことから、ホストAとローカルネットワークの間に障害が発生していると考えられます。  
障害の発生している場所を特定するために最も役立つと考えられるコマンドを選択してください。
→
複数のルーターを跨ぐ。どこ地点で死んでいるか調べるためにはルートを検索すべき。
なので、tracerouteでは無かろうか？
合ってた。
ラジオボタンでの選択式で、tracerouteがあったからそれしかないが、他にも`tracepath`もいけるはず。


7.NetworkManagerでネットワークを管理しています。以下のコマンドを実行してネットワークの接続情報を表示しました。
`$____conn show`

×nclim  
○nmcli  
network manager command line interfaceの略か？


8.ネットワークインターフェースeth0に、IPアドレス[10.10.0.5]、サブネットマスク[255.255.255.0]を設定したい場合、実行すべきコマンドを選択してください。  

ipコマンドでネットワークの設定はどうやるんだったか。  
正直、ネットワークインターフェースを設定するコマンドだけで2つ以上はあった気がする。  
addr がipアドレスを対象とするって意味だった気がする。
add が追加と思いきや設定で、サブネットはサイダーで決定できるんだっけか。  
となれば、選択肢はCしかなさそうだが？
合ってた。  

`ip addr add 10.10.0.5/24 dev eth`  

他のやつ
ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`

/etc/sysconfig/network-scriptsディレクトリ  
RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  


9.以下のIPv6アドレスの省略された表記として適切なものを全て選択してください。
`2001:0db8:0000:0000:0023:0000:0000:0045`

①先頭の0は省略できる。  
②0が連続しているところは1か所だけ省略することができる。  

2001:db8::23:0:0:45  
2001:db8:0:0:23::45  
