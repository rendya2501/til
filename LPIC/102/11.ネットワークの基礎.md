# 11.ネットワークの基礎

## TCP/IPの基礎

・TCP(Transmission Control Protocol)  
・IP(Internet Protocol)  
・IPv6  
・UDP(User Datagram Protocol)  
・ICMP(Internet Control Message Protocol)  
・サブネット、ネットワークアドレス、ブロードキャストアドレス、プライベートアドレス  
・CIDR(Classless Inter-Domain Rounting)  
・ユニキャスト、エニーキャスト、マルチキャスト  
・ウェルノウンポート  
・/etc/servicesファイル  

### IPv4

IPv4ヘッダの説明  
・「ヘッダ長」や「オプション」フィールドなど、いくつかのフィールドはIPv6ヘッダには存在しない  
・TTLはルータを1つ通過するごとに1ずつ減算される  
※TTL（Time to Live - パケットの生存期間）はルータを1つ通過するごとに1ずつ減算され、0になるとパケットが破棄されてルーティングのループを防ぎます  

### IPアドレスのクラス

``` txt : IPアドレスのクラス
クラス         範囲                   サブネットマスク
A   ::   0.0.0.0 - 127.255.255.255 :: 255.0.0.0
B   :: 128.0.0.0 - 191.255.255.255 :: 255.255.0.0
C   :: 192.0.0.0 - 223.255.255.255 :: 255.255.255.0
D   :: 224.0.0.0 - 239.255.255.255
E   :: 240.0.0.0 - 255.255.255.255
```

クラスDはマルチキャスト（特定の複数宛ての送信に使用される）用のアドレスです。  

``` txt : プライベートアドレスの範囲
A :: 10.0.0.0 – 10.255.255.255
0000 1010 . 0000 0000 . 0000 0000 . 0000 0000
0000 1010 . 1111 1111 . 1111 1111 . 1111 1111

B :: 172.16.0.0 - 172.31.255.255
1010 1100 . 0001 0000 . 0000 0000 . 0000 0000
1010 1100 . 0001 1111 . 1111 1111 . 1111 1111

C :: 192.168.0.0 – 192.168.255.255
1100 0000 . 1010 1000 . 0000 0000 . 0000 0000
1100 0000 . 1010 1000 . 1111 1111 . 1111 1111
```

IPアドレスのうち、ローカルネットワークでのみ使用が許可されているアドレスを「プライベートアドレス」と言い、クラスごとに範囲が定められています。  
プライベートアドレスはIANA（アイアナ：Internet Assigned Numbers Authority）によって予約されています。  

### IPv6

IPv6(Internet Protocol version 6)は、現在主流のIPv4に変わる次世代版のインターネットプロトコル(IP:Internet Protocol)です。  
近年、インターネットの急速な普及や、接続機器の増加に伴い、IPアドレスの枯渇が問題となりました。  
そこで、IPv4では32ビットの長さで表していたIPアドレスをIPv6では128ビットで表すことで、使用できるIPアドレスが約340澗（かん）個（事実上無限）にまで増大しました。  

※正確には340澗（かん）2823溝（こう）6692穣（じょう）938秄（じょ）4634垓（がい）6337京（けい）4607兆4317億6821万1456個。  
2の32乗（32ビット）で表すことのできる約43億という数の、さらに4乗（2の32乗×2の32乗×2の32乗×2の32乗）という膨大な数です。  

- アドレス長が128bit  
- 16進数表記(0-9,A-F)  
- ユニキャスト、エニーキャスト、マルチキャストをサポート。  
- ブロードキャストが廃止され、一斉送信は全てマルチキャスト（特定グループ宛通信）で行われる  
- アドレス表記法  
  ①各ブロックの先頭の「0」は省略できる  
  ②連続した「0000」のブロックは1回に限り「::」に省略可能  
  ③「0000」は「0」に省略可能  
  例）  
  0001:5000:0001:0000:0000:0002:000A:0001 → 1:5000:1::2:A:1  
  2001:5000:0001:0000:0000:DA02:0000:1001 → 2001:5000:1::DA02:0:1001  
  2001:5000:0001:0000:0000:0000:0000:0000 → 2001:5000:1::  
- プロトコル番号,ポート機能はIPv4と同じ。  
- IPsec（暗号化通信）を標準で実装  
- IPアドレスの自動割り当て機能を標準で実装している。(IPv4はDHCPで実装)  
- IPv4との互換性は無い（但し、機器にIPv4とIPv6の両方のアドレスを割り当てるデュアルスタックなどの仕組みで相互運用は可能）  
- IPv4アドレスと直接通信出来ない。変換が必要。  
  IPv4とIPv6ではパケットフォーマットが異なる為、直接通信をする事はできません（互換性はありません）が、  
  デュアルスタックなどの相互運用の仕組みを利用してIPv4とIPv6が混在したネットワークを構築することが可能です。  
- IPv6アドレスは非常に広大なアドレス空間のため、IPv4での「クラス」の概念はなくなりました。  
  その代わりに、ユニキャスト（1対1通信）のアドレス割当時にはサブネットを表す前半64ビットと、ホストを表す後半64ビットでアドレス割り当てすることが推奨されています。  
  前半64ビットを「サブネットプレフィックス」、後半64ビットを「インタフェース識別子（Interface-ID）」とよびます。  
- IPv4のネットワーク部に相当する部分が**サブネットプレフィックス**、ホスト部に相当する部分が**インタフェース識別子（Interface-ID）**  
- ホップリミットはIPv4のTTLと同じ役割を持つ  
- プレフィックス、インターフェースIDともに64ビット  
- IPv6のポート番号の表記法 → `[IPアドレス]:ポート番号`  
  例:[fe80:20c:29ff:fe55:94ef]:80  

※プロトコル番号  
上位層のプロトコルを識別するための番号。
IPヘッダに8ビット情報で存在する。  
各プロトコルにはポート番号だけではなく、各々に番号がある模様。  

``` txt
 1 :: ICPM
 4 :: IP
 6 :: TCP
17 :: UDP
etc...
```

・ユニキャスト : 1つのネットワークインターフェースを識別するアドレス  
・エニーキャスト : 複数のホストの集合に割り当てられるアドレス  
・マルチキャスト : IPv4のブロードキャストに相当するもの  

ローカルループバックアドレス , ::1/128  
グローバルユニキャストアドレス , 2000::/3  
リンクローカルユニキャストアドレス , fe80::/10  
マルチキャストアドレス , ff00::/8  

IPv6パケット内の制御情報であるIPv6ヘッダは、IPv6ヘッダ（固定長）＋オプションの拡張ヘッダ（可変長）で構成されます。  

``` txt : IPv6ヘッダー
バージョン（4ビット）        :: IPのバージョン番号。IPv6では"6"が入る  
トラフィッククラス（8ビット）:: パケットの優先度をつける  
フローラベル（20ビット）     :: アプリケーションフローの識別  
ペイロード長（16ビット）     :: IPv6ヘッダを除くパケットのデータ部の長さ  
ネクストヘッダ（8ビット）    :: IPv6ヘッダの次にくるヘッダのタイプを示す  
ホップリミット（8ビット）    :: 通過できるルータの数（IPv4のTTLと同じ）  
送信元アドレス（128ビット）  :: 送信元のIPv6アドレス  
宛先アドレス（128ビット）    :: 宛先のIPv6アドレス  
```

IPv4ヘッダの基本サイズは20バイト、IPv6ヘッダは40バイトなので 2倍のサイズになっていますが、  
IPv6ではチェックサムフィールドなどいくつかのフィールドを削除して構造を簡単にしています。  
さらにIPv6ヘッダでは、可変長となるフィールドをオプションにして、転送に必要になる基本ヘッダを固定長にすることで処理効率を上げています。  

### CIDR(Classless Inter Domain Routing)  

IPアドレスのクラスの概念を使わずに、任意の長さのサブネットマスクを利用する事。

アドレスクラスの概念を気にしないで、IPアドレスの割り当てや経路選択などの自由度を上げる仕組み。  
サブネットマスクを調整することで任意の大きさのネットワークを作るあれのこと。  
192.168.0.***/24の「/24」の部分がCIDR表記。  

クラスの概念に基づいてネットワークを設定すると、使わないIPアドレスが発生してしまう。  
なので、クラスの概念をとっぱらって、サブネットマスクでもって、設定できるようにしたほうが無駄が少なくてよくね？って考え方がこれ。  

読み方はサイダー  

### ウェルノウンポート  

ポート番号は0～65535番まであります。  
その中でも、主要なサービスのポート番号はウェルノウンポート(0～1023番）として予約されています。  
ポートは0から始まる事に注意。  

``` txt : ポート
Well Known Ports :: 0~1023      :: システムやroot権限を持つプロセスに割り当てられたポート
System Ports                       (WebサーバーやWindowsファイル共有サービスなど)

Registered Ports :: 1024~49151  :: よく使われるプログラムに割り当てられたポート番号
User Ports                         (OracleやMicrosoft SQL Serverなど)
                                   一般ユーザーが使えるのは1024番から。

Dynamic Ports    :: 49152~65535 :: 自由に使用可能なポート
Ephemeral Ports(エフェメラル)
Private Ports
```

``` txt : ウェルノウンポート
 20 :: FTP    :: ファイル転送(データ用)
 21 :: FTP    :: ファイル転送(制御用)
 22 :: SSH    :: リモートホストの遠隔操作(暗号化あり)
 23 :: Telnet :: リモートホストの遠隔操作(暗号化なし)
 25 :: SMTP   :: 電子メール  
 53 :: DNS    :: TCP/UDP,名前解決
 80 :: HTTP  
110 :: POP3   :: 電子メール受信(受信メールをサーバーからダウンロードしてサーバーから消す方式)(Post Office Protocol version 3)
143 :: IMAP   :: 電子メール受信(受信メールをサーバ上で管理し、メールソフトに表示させる受信方式)(Internet Message Access Protocol)  
161 :: SNMP   :: ネットワークの監視  
162 :: SNMP Trap :: ネットワークの監視(警告通知等)  
443 :: HTTPS  
465 :: SMTPS  
636 :: LDAP over SSL/TLS  
993 :: IMAPS  
995 :: POP3S  

どうでもいいプロトコル
 63 :: whois++プロトコル
123 :: NTP  
361 :: Semantixサービス
389 :: LDAP :: ディレクトリサービス  
529 :: IRC(Internet Relay Chat)
514 :: Syslog :: ロギングサービス  
631 :: CUPSの設定ポート  
```

### ネットワーク関連の設定ファイル

#### /etc/services  

ポート番号とサービスの対応が記述されたファイル  
複数形であることに注意。  

``` txt : 表示例
#cat /etc/services
telnet 23/tcp
```

#### /etc/hostname

ホスト名を設定(Debian系)  

``` txt : 表示例
# car /etc/hostname
Debian
```

#### /etc/sysconfig/network

ホスト名を設定(Red Hat系)  
ネットワーク機能の有効/無効やデフォルトゲートウェイ等も設定可能  

``` txt : 表示例
# cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=CentOS
GATEWAY=192.168.1.1
```

#### /etc/hosts

IPアドレスとホスト名の対応付け

``` txt : 表示例
# cat /etc/hosts
112.78.124.10 pint-t.com
192.168.1.100 FileServer
```

#### /etc/resolv.conf

ドメイン名やDNSサーバーの指定

``` txt : 表示例
# cat /etc/resolv.conf
domain pint-t.com
nameserver 192.168.1.1
```

### IP(Internet Protocol)

「IP（Internet Protocol）」はネットワークに接続された機器（サーバ、ルータ、クライアントPCなど）へのアドレス付与によって機器やネットワークを識別したり、  
パケットの分割や統合を行い目的地までパケットを届ける、インターネット通信の中核をなすプロトコルです。  

### TCP(Transmission Control Protocol)

OSI参照モデルの第4層に属し、TCP/IPの中核となるTCP（Transmission Control Protocol）は、信頼性の高いコネクション型のプロトコルです。  
コネクション型とは、通信する相手と事前にコネクション（接続）を確立し、取り決めた通信手順に従ってデータを送受信する通信方式です。  

TCPはコネクション型の通信プロトコルですので、データを送受信する時の制御機能を持ち、パケットを順番通りに並べたり、到達したかどうか確認したり、  
途中で消失したパケットを再送したりすることができます。  

### UDP（User Datagram Protocol）

UDP（User Datagram Protocol）はコネクションレス型のプロトコルです。  
コネクションレス型とは、相手とのコネクション（接続）を事前に行わず、送りたいデータを一方的に送りつける通信方式です。  
到達確認や再送などの複雑な制御機能を持たない代わりに、いつでもデータを送信でき、処理も簡単なので高速に動作します。  
この特性から、主に動画や音声などのマルチメディア通信に使われます。  

### ARP(Address Resolution Protocol)

IPアドレスからMAC（Media Access Control）アドレスを求めるプロトコル。  

MACアドレスは、ネットワークに接続するNIC（Network Interface Card）などの物理的な接続に割り当てられたアドレスで、基本的に変更することができません。  
ネットワークに接続された機器は、自分のMACアドレス宛のデータのみを受信するようになっています。  
IP（Internet Protocol）アドレスはOSなどのソフトウェアが管理するアドレスであり、割り当てられた範囲内で自由に設定できます。  
そのため、故障による機器交換などでIPアドレスとMACアドレスの組み合わせは簡単に変わってしまいます。  

宛先IPアドレスを持つ機器のMACアドレスが変わっていると、送信したデータの宛先MACアドレスが一致しないため、宛先IPアドレスを設定した機器にもかかわらず、受信せずに破棄されてしまいます。
これを解決するため、「このIPアドレスを持つ機器は、MACアドレスを回答してほしい」という要求を全機器宛てに送信し、  
その応答を元に正しい宛先MACアドレスを設定して送信します。これがARPの仕組みです。  

ARPによって入手したIPアドレスとMACアドレスの対応表は、MACアドレステーブル、ARPキャッシュと呼ばれ、各アドレスごとに一定時間保持されます。  
一定時間経過後には、再度ARPによって最新のIPアドレスとMACアドレスの対応が作成されます。  

### ICMP(Internet Control Message Protocol)

IPを使った通信では、宛先までパケットが到達しなかった場合でも、IP自身にはそれを知らせる術がありません。  
IPで発生した、宛先到達不能などの通信エラー情報や、経路変更要求（リダイレクト）などの制御メッセージの通知にはICMP（Internet Control Message Protocol）が使われます。  
pingやtracerouteコマンドはICMPを利用してネットワークを診断します。  

### その他色々

IPアドレスのホスト部に相当するbitをすべて0にしたものは、ネットワークそのものを表すネットワークアドレスです。  
また、ネットワーク上にあるすべての端末に対して、データを送り出すことをブロードキャストといいます。  
ブロードキャストアドレスは、IPアドレスのホスト部に相当するbitをすべて1にしたものです。  

IPアドレス「192.168.18.1」とサブネットマスク「255.255.255.0」を2進数で表記すると以下のようになります。  

11000000 10101000 00010010 00000001　　 :: IPアドレス  
11111111 11111111 11111111 00000000　　 :: サブネットマスク  

これは後半の8ビット(サブネットマスクが0の部分）がホスト部である事をあらわしています。  
そこを全て0にするとネットワークアドレス、全て1にするとブロードキャストアドレスとなります。  

11000000 10101000 00010010 00000000　　 :: ネットワークアドレス  
11000000 10101000 00010010 11111111　　 :: ブロードキャストアドレス  

これを10進数に直すと、ネットワークアドレスが「192.168.18.0」、ブロードキャストアドレスが「192.168.18.255」となります。  

---

## ネットワークの設定

・/etc/hostnameファイル  
・/etc/hostsファイル  
・/etc/network/interfacesファイル  
・/etc/sysconfig/network-scriptsディレクトリ  
・NetworkManager  
・nmcliコマンド  
・hostnamectrlコマンド  

### /etc/hostnameファイル  

ホスト名が記述されているファイル。  

``` conf : 例
centos7.example.com
```

### /etc/hostsファイル  

ホスト名とIPアドレスの対応を記述するファイル。  
小規模ならこれで十分。これ以上になればDNSになるはず。  
変更の反映は全てのホストに配布する必要がある。  
**IPアドレス、ホスト名、ホストの別名**をスペースで区切って記述する。  

``` conf : 例
127.0.0.1 localhost.localdomain localhost
192.168.0.1 windsor.example.com windsor
```

### /etc/network/interfacesファイル  

Debian系でネットワークインターフェースの設定を記述するファイル。  
Debian系はUbuntuとかか。  

設定項目は多数あるので、問題で出たら都度まとめる。  
IPアドレスとかネットマスクとかDNSのIPアドレスとかデフォルトゲートウェイとか、そういう基本的な設定をするのがこのファイルってわけ。  

### /etc/sysconfig/network-scriptsディレクトリ  

RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  
ネットワークインターフェース名が「eth0」の場合、設定ファイル名は「ifcfg-eth0」となる。  
IPアドレスを固定で割り当てたい場合などにこのファイルを編集する。  

### NetworkManager  

ネットワークを管理するサブシステムらしい。  
CentやRHELで導入されている。  

Ethernet,Wi-Fi,ブリッジといったネットワークデバイスと、デバイスによるネットワーク接続およびデフォルトルート、DNS名前解決を自動的に管理します。  
つまりネットワーク管理システムって事だ。  
I/F設定ファイルに特別な記述がない限り、DHCPを利用するので、ネットワークI/Fとデフォルトルートは自動設定される。  
もちろん手動設定も可能。(らしい)  

``` txt
systemdの場合の色々
systemctl status NetworkManager : 利用確認
systemctl start NetworkManager : 起動
systemctl stop NetworkManager : 停止
systemctl enable NetworkManager : 有効
systemctl disable NetworkManager : 無効

SysB initの場合の色々
/etc/init.d/NetworkManager start : 起動
/etc/init.d/NetworkMagager stop : 停止
chkconfig NetworkManager on : 有効
chkconfig NetworkManager off : 無効
```

### nmcliコマンド  

NetworkManagerにおいて、ネットワークの設定、接続の管理、状態の確認を行うコマンド。  
Network Manager Command Line Interfaceの略見たい。  

``` txt
nmcli オブジェクト [コマンド]

オブジェクト
general
networking
radio
connection
device
agent
monitor
help

コマンド
それぞれのオブジェクトで使える物が決まっているので、単純なオブジェクトとコマンドの組み合わせというわけにはいかない。
```

全部書くとキリがないので、出題された奴だけまとめる。  

ホスト名をcentos.localdomainに設定  
`nmcli general hostname centos.localdomain`  

ホスト名の表示  
`nmcli general hostname`  

デバイスの状態を表示する  
`nmcli device status`  

ネットワークの状態を表示する  
`nmcli networking connectivity`  

My-WiFiに接続する
`nmcli device wifi connect My-Wifi`

### hostnamectlコマンド  

ホスト名を設定するコマンド  

``` txt
hostnamectl [サブコマンド]

サブコマンド
status : ホスト名と関連情報を表示する(でふぉ)
set-hostname ホスト名 : ホスト名を設定する  
```

 ホスト名をvm2に変更  
`hostnamectl set-hostname vm2`  

/etc/hostnameファイルでもホスト名を変更できるなら、hostnamectlコマンドでホスト名を変更した情報はどこに保存されるのか？  
hostnamectlコマンドで/etc/hostnameファイルが変更される？  
[hostnameコマンドより便利なhostnamectlコマンド](https://linuc.spa-miz.com/2020/12/23/hostnamectl-command-more-useful-than-the-hostname-command/)  
→
hostnamectlコマンドで/etc/hostnameファイルが変更されるらしい。  
結局、保存先であるファイルが全て何だな。  

---

## ネットワークのトラブルシューティング

・pingコマンド  
・ping6コマンド  
・tracerouteコマンド  
・traceroute6コマンド  
・tracepathコマンド  
・tracepath6コマンド  
・hostnameコマンド  
・netstatコマンド  
・ncコマンド  
・routeコマンド  
・ipコマンド  
・ifconfigコマンド  
・ifupコマンド  
・ifdownコマンド  

### pingコマンド  

指定されたホスト(ホスト名もしくはIPアドレス)にICMPパケットを送り、その反応を表示するコマンド  
何もオプションを指定しない場合、Ctrl + Cを押すまで送信し続ける。  
ipv6の場合はping6コマンドを使う。内容は全く同じ。  

ping [オプション] ホスト名orIPアドレス  
-c 回数 : 指定した回数だけICMPパケットを送信する。  
-i 間隔 : 指定した間隔(秒)ごとにICPMパケットを送信する(デフォは1秒)  

### tracerouteコマンド  

指定されたホスト(ホスト名もしくはIPアドレス)までパケットが伝わる経路を表示するコマンド  
宛先までのルータやホストが順に表示される。  
ネットワーク経路上に障害があった場合は、その位置を特定できる可能性がある。  
ip6はtraceroute6コマンドを使う。内容は全く同じ。  

``` txt
traceroute [オプション] ホスト名orIPアドレス  

オプション
-l : ICMP ECHOパケットを送信。デフォルトはUDPパケット。
-f TTL 初期値 : TTL(Time To Live)の初期値を設定。デフォルトは1。
```

- パケット送信に使用するデフォルトのプロトコルはUDP。  
- UDPポートのデフォルトは33434番で、送信するたびにインクリメントする。  
- [-l]オプションを付けることでICMPパケットを送信できる。  
- routepathはtracerouteよりも機能が少なく、特権を必要とするRAWパケットを生成するオプションもない。  

### tracepathコマンド  

tracerouteコマンドと同様に、指定されたホストまでのパケットが伝わる経路を表示するコマンド。  
ip6はtracepath6コマンドを使う。内容は全く同じ。  

tracepath ホスト名orIPアドレス[/ポート番号]  

### tracerouteとtracepathの違い  

traceroute : 宛先アドレスまでの経路を確認できる。  
tracepath : 宛先アドレスまでの経路と経路上のPathMTUを確認できる。  

MTUは「通信用に細切れにしたデータの大きさ制限で『これくらいの大きさの細切れデータなら通れるよ（送れるよ）』な最大値」
Maximum Transmission Unit  

次から次へと新しいことが出てくるな。  
まぁ、それが勉強ってもんだよな。  

### hostnameコマンド

ホスト名を表示したり変更したりするコマンド。  

hostname [ホスト名]  

ホスト名を指定しない場合、現在のホスト名を表示する。  
ホスト名を指定した場合、ホスト名を変更する。  
ホスト名を変更できるのはrootユーザーのみ。  

ホスト名変更色々まとめ。  
[CentOS 7 の Hostname を変更する](https://qiita.com/notakaos/items/d18ab37bce2b25b2d5b0)  

### netstatコマンド  

ネットワーク機能に関する様々な情報を表示するコマンド  
開いているポートの検索によく利用する模様。  

``` txt
netstat [オプション]  

-a : すべてのソケット情報を表示する。全てのプロトコル(TCP,UDP,UNIXソケット)を表示  
-l : 接続待ち(LISTEN)のソケットを表示。  
-c : 状況を1秒ごとにリアルタイムで表示する。  
-i : ネットワークインターフェースの状態を表示する。  
-n : アドレスやポートを数値で表示する。(つまり名前解決の必要がない)  
-p : pidとプロセス名も表示する。  
-s : 統計情報を表示
-r : ルーティングテーブルを表示する。  
-t : TCPポートのみ表示する。  
-u : UDPポートのみ表示する。  
-x : UNIXソケットを表示  
```

※ソケット  
プログラムがデータを交換する窓口  

### ncコマンド  

netcatコマンド。  
catコマンドのネットワーク版。  
テキストストリームにおけるcatコマンドと同様の働きをネットワーク上で行うコマンド。  

※catコマンド
conCATenate(繋ぐ、連結する)。
ファイルを連結するためのコマンド  

``` txt
nc [オプション] [ホスト] [ポート番号]  

-l : 指定したポートをリッスンする。  
-p ポート : ポート番号を指定する。  
-u : UDPを利用する。(デフォはTCP)  
-o ファイル : 指定したファイルに出力する。  
```

12345番ポートで待ち受け氏、受け取ったデータをlisten.logファイルに出力する。  
nc -l -p 12345 -o listen.log  

上記例を実行したホストの12345番ポートに対し、data.txtファイルの内容を出力する。  
nc centos7.example.com 12345 < data.txt  

### routeコマンド  

ルーティングテーブルの表示や操作を行うコマンド  
routeコマンドを引数なしで実行すると、ルーティングテーブルが表示される。  
`route` = `netstat -r`  

``` txt
ルーティングテーブルの表示を行う書式
route [オプション]

ルーティングテーブルに新しい経路を追加する書式
route add [パラメータ]

ルーティングテーブルから経路情報を削除する書式
route del [パラメータ]

-F : カーネルのルーティングテーブルを表示する。
-C : カーネルのルーティングキャッシュを表示する。
-p : add時に指定すると、次回以降のOS起動後も有効になる。
```

ルーティングテーブルの項目にも色々あるが、だるいので都度  

192.168.0.0/24のネットワークあてのパケットは、ゲートウェイ172.30.0.254に送られるようにする設定を追加するコマンド例  
`route add -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイを172.30.0.1に設定する  
`route add default gw 172.30.0.1`  

設定した経路情報を削除する。  
`route del -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイ172.17.255.254を削除する。
`route del default gw 172.17.255.254`  
`route del default`  

### ipコマンド  

ネットワークインターフェースやルーティングテーブル、ARPテーブル等を管理するコマンド。  
ipコマンドはifconfigコマンドに変わる新しいコマンド。  

``` txt
ip [オプション] 操作対象 [サブコマンド] [デバイス]

オプション
-s : 統計情報を表示する

操作対称
link : データリンク層
addr : ipアドレス
route : ルーティングテーブル

サブコマンド
show : 表示する ←省略したときのデフォ
add : 設定する
del : 削除する
```

ネットワークインターフェースのデータリンク層の情報を表示する  
`ip link show`  

ネットワークインターフェースeth0の詳細情報を表示する
`ip -s link show dev eth0`

ルーティングテーブルの表示  
`ip route show`  

eth0インターフェースの状態やIPアドレスの表示  
`ip addr show eth0`  

eth0のipアドレスを192.168.11.12/24に設定する  
`ip addr add 192.168.11.12/23 dev eth0`  

デフォルトゲートウェイを192.168.11.1に設定
`id addp add default via 192.168.11.1`  

### ifconfigコマンド  

ネットワークインターフェースの状態を表示したり、設定を行ったりするコマンド。  
ipアドレスの確認によく利用する模様。  

``` txt
ifconfig [ネットワークインターフェース名] [パラメータ]

パラメータ
IPアドレス : ipアドレスを設定する  
netmask サブネットマスク : サブネットマスクを設定する  
up : ネットワークインターフェースを有効化する
down : ネットワークインターフェースを無効化する
```

※ネットワークインターフェース名はデバイスに基づいた命名規則によって生成されるのが一般的らしい  

ネットワークインターフェースの情報を表示する  
`ifconfig`  

ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`

### ifup,ifdown

指定したネットワークインターフェースの有効無効にするコマンド。
ifconfigのup downだけをコマンドで抜き出したものと思われる。  

``` txt
ifup [ネットワークインターフェース名]
ifdown [ネットワークインターフェース名]
```

---

## DNSの設定

・/etc/resolv.confファイル  
・/etc/nsswitch.confファイル  
・/etc/systemd/resolved.confファイル  
・hostコマンド  
・digコマンド  
・whoisコマンド  

### DNS（Domain Name System）

DNS（Domain Name System）はドメイン名/ホスト名などの名前とIPアドレスを対応させるシステムです。  
DNSサーバが名前とIPアドレスの対応情報（リソースレコード）を管理し、DNSクライアントからの問い合わせに対して名前解決のための情報を提供します。  

DNSサーバにはDNSキャッシュサーバと権威DNSサーバがあり、インターネット上の多数のDNSサーバでドメイン情報を分散して管理しています。  
・DNSキャッシュサーバ  
権威DNSサーバに問い合わせを行い、得た情報をキャッシュに保持します。  
保持している情報に該当する問い合わせがきた場合は権威DNSサーバに問い合わせずに応答することで、DNSクライアントへの応答速度を上げるとともに、  
権威DNSサーバの負荷も減らします。  

・権威DNSサーバ（ネームサーバ）  
特定のドメインの情報を管理する正当な権限を持つDNSサーバです。  
「xxx.com」を管理する権威DNSサーバや、「xxx.jp」を管理する権威DNSサーバのように、ドメインごとに分散管理しています。名前に関する情報（コンテンツ）を保持するため、  
コンテンツサーバともよばれます。  

DNSサーバが管理している情報をリソースレコードと呼び、主に以下のリソースタイプ（種類）があります。

``` txt
a   :: IPアドレス
mx  :: メールサーバーの情報
ns  :: ネームサーバーの情報
soa :: ゾーン(ドメインの範囲)の情報
txt :: テキスト情報
```

ホスト名とIPアドレスの相互変換→名前解決  
ホスト名からIPアドレスを求める→正引き  
IPアドレスカラホスト名を求める→逆引き  

www.example.com
www : ホスト名  
example.com : ドメイン名  

ネットワークの区画(ドメイン)に所属しているPC名(ホスト名)  

### /etc/resolv.confファイル

どこにあるDNSサーバーを参照するかを設定するファイル  
ファイル名はresolveではなく**resolv**なので注意。  

``` txt
domain infraeye.com
search infraeye.com
nameserver 192.168.231.2
```

- domain :  
このホストが所属するドメイン名を記述する。  
ドメイン名を含まないホスト名を検索する場合、このドメイン内を検索する。  
- serach :  
ドメイン名の省略時に補完するドメイン名を記述。  
複数指定可能。  
左から右へ検索していく。  
**searchの指定を行った場合、ドットがないホスト名についてはsearchで指定したドメインを検索する。**  
- nameserver :  
DNSサーバーのIPアドレスを記述。  
nameserverの指定は3台まで。  
応答が無ければ次の行を参照する。  

domainとsearchはどちらか片方を指定する。  
両方指定した場合は後のほうが有効になる。  

### ドメイン

<https://t-tel.net/domain/092/>  

`https://www.example.com`  
ホスト名 : www  
ドメイン名 : example.com  
FQDN : www.example.com  

ホスト名 + ドメイン名 = FQDN  
Fully Qualified Domain Name  

### /etc/nsswitch.confファイル  

名前解決の仕方にも色々あるので、どういう順番でどういう手段を使うのかを設定するファイル  

主な名前解決の方法  
・etc/hostsファイルでの問い合わせ→files  
・LDAPサーバーへの問い合わせ→ladp  
・DNSサーバーへの問い合わせ→dns  

以下の記述例の場合、ホスト名の名前解決のために最初に/etc/hostsファイルを参照し、次にLDAPサーバーに問い合わせ、最後にDNSサーバーに問い合わせるように定義している。  

``` txt : /etc/nsswitch.confファイルの設定例
hosts: files ldap dns
```

### etc/systemd/resolved.confファイル

systemdを採用したディストリビューションでは、名前解決にsystemd-resolvedサービスが使われる。  
その設定ファイル。  

``` txt : /etc/systemd/resolved.conf
[Resolve]
DNS=192.168.11.1 8.8.8.8
Domains=example.com
```

systemd-resolvedサービスを有効にするコマンド  
`systemctl restart systemd-resolved.service`  

### systemd-resolved

systemd-resolvedは、systemdの動作するシステムで名前解決を管理するデーモンです。  
systemd-resolvedの設定は「/etc/systemd/resolved.conf」ファイルや「/etc/systemd/resolved.conf.d/」配下の拡張子.confのファイルで行います。  

``` txt : resolved.confからの抜粋
[Resolve]
DNS=192.168.0.1
```

### hostコマンド  

DNSサーバーを使ってホストやドメインに関する情報を表示する。  

``` txt
host [オプション] ホスト名orIPアドレス [DNSサーバー]

オプション
-t :: 問い合わせる情報の指定(type)
      digと同じく、a,mx,ns,any等が指定できる。
-v :: 詳細な情報表示(verbose)
```

www.lpi.jpのIPアドレスを問い合わせる→正引き  
`host www.lpi.jp`  

192.168.0.6のホスト名を問い合わせる→逆引き  
`host 192.168.0.6`  

### digコマンド  

DNSサーバへ直接問い合わせて、指定した名前に関するDNSサーバからの応答を表示します。  
また、表示する情報のタイプ（リソースタイプ）を指定する事もでき、詳細な情報を確認できるため、DNSに関するデバッギングツールとしても使用できます。  

・指定したホスト名に対するDNSサーバーへの登録情報を表示する。  
・DNSサーバーからデバッグのための詳細な情報を取得できる。  
・nslookupコマンドはDNSサーバーからの応用を加工して表示するが、digでは応答を加工せずに表示する。  

``` txt
dig [オプション] [@DNSサーバー名] ホスト名orドメイン名 [検索タイプ]

オプション
-x :: IPアドレスからホスト名を検索する(逆引き)

「@DNSサーバ」には問い合わせるDNSサーバを指定します。  
省略した場合は、そのホストに設定されているDNSサーバに問い合わせます。  
-tオプションの後に検索タイプを指定しても情報を絞り込めます。  

検索タイプ
a      :: ipアドレス(Address)(デフォルト)
aaaa   :: ipv6アドレス
any    :: 全ての情報
mx     :: メールサーバーの情報(Mail Exchanger)
ns     :: ネームサーバーの情報(Name Server)
txt    :: ゾーン(ドメインの範囲)の情報
+short :: 詳細情報を省く
```

TXTレコードは任意の文字列を記すためのものですが、メールの送信元を記載することで正しい送信元を確認するためのSPFレコードとして利用したり、  
Google指定の情報を記載することでGoogleのサービス利用時に所有者であることを証明したりすることができます。  

lpi.jpのメールサーバー情報を問い合わせる  
`dig lpi.jp mx`  

69.90.69.237のホスト名を問い合わせる(詳細情報を省く)  
`dig -x 69.90.69.237 +short`

### whoisコマンド  

調べたいドメイン名を指定して、whoisデータベースに問い合わせるコマンド。  

### 早見表

``` txt
host     :: DNSサーバーを使ってホストやドメインに関する情報を表示する。最も基本となるコマンド。
dig      :: DNSサーバへ直接問い合わせて、指定した名前に関するDNSサーバからの応答を表示します。
getent   :: 名前解決の順序を設定する「/etc/nsswitch.conf」に従って検索を行うコマンド。
nslookup :: DNSサーバに名前解決を問い合わせるコマンド。Windowsのコマンド。
netstat  :: さまざまな項目を指定して、ローカルホストのネットワーク関連の情報を表示するコマンド。
hostname :: 自ホストのホスト名やドメインを参照したり、ホスト名を一時的に変更するコマンド。

```

DNSを利用し、ホスト名をIPアドレスに変換することができるコマンド  
host、nslookup、getent、dig  

IPアドレスとホスト名の変換を行うコマンド  
nslookup、host、dig  

DNSサーバに問い合わせて名前解決を行うコマンドには、nslookup、dig、hostがありますが、出力する情報が最も少ないのはhostコマンドです。  

---

## 小豆本問題

### 1

エラーメッセージや制御メッセージを伝送するコネクションレス型のプロトコルで、pingやtracerouteコマンド等で利用されているものを選択してください。  

pingという地点でネットワーク層。
プロトコルなので、internet protcol management protocol

---

### 2

以下のIPアドレスの中から、プライベートアドレスとして利用できるものを全て選択してください。

10.0.0.0~10.255.255.255
172.16.0.0~172.31.255.255
192.168.0.0~192.168.255.255

A,E

---

### 3

ネットワークサービスの名称とそのサービスが標準的に利用するポート番号の対応が記述されているファイルを絶対パスで記述してください。  

→  
やったはずなんだが。
思いっきりやってたわ。
サービスってあるから、それで回答すればよろしかった。

`/etc/services`  

---

### 4

デフォルトで53番ポートを利用するサービスを選択してください。

80と25と443しか知らない。

FTP?
UDPでした。

---

### 5

example.com ドメインのメールサーバー情報を問い合わせたい場合、下線部に当てはまる適切なパラメータを記述してください。  
`dig___`

× dig -mx example.com
○ dig example.com mx

---

### 6

離れたネットワークにあるホストAとの通信が出来なくなりました。
ホストAまでは複数のルータを経由しており、ローカルネットワーク内では通信に問題はないことから、ホストAとローカルネットワークの間に障害が発生していると考えられます。  
障害の発生している場所を特定するために最も役立つと考えられるコマンドを選択してください。

→
複数のルーターを跨ぐ。どこ地点で死んでいるか調べるためにはルートを検索すべき。
なので、tracerouteでは無かろうか？
合ってた。
ラジオボタンでの選択式で、tracerouteがあったからそれしかないが、他にも`tracepath`もいけるはず。

---

### 7

NetworkManagerでネットワークを管理しています。以下のコマンドを実行してネットワークの接続情報を表示しました。
`$____conn show`

×nclim  
○nmcli  
network manager command line interfaceの略か？

---

### 8

ネットワークインターフェースeth0に、IPアドレス[10.10.0.5]、サブネットマスク[255.255.255.0]を設定したい場合、実行すべきコマンドを選択してください。  

ipコマンドでネットワークの設定はどうやるんだったか。  
正直、ネットワークインターフェースを設定するコマンドだけで2つ以上はあった気がする。  
addr がipアドレスを対象とするって意味だった気がする。
add が追加と思いきや設定で、サブネットはサイダーで決定できるんだっけか。  
となれば、選択肢はCしかなさそうだが？
合ってた。  

`ip addr add 10.10.0.5/24 dev eth`  

他のやつ
ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`

/etc/sysconfig/network-scriptsディレクトリ  
RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  

---

### 9

以下のIPv6アドレスの省略された表記として適切なものを全て選択してください。
`2001:0db8:0000:0000:0023:0000:0000:0045`

→
①先頭の0は省略できる。  
②0が連続しているところは1か所だけ省略することができる。  

2001:db8::23:0:0:45  
2001:db8:0:0:23::45  
