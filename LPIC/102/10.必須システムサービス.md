# 10.必須システムサービス

---

## システムクロックの設定

### ハードウェアクロック

PCにハードウェアとして内臓された時計。  
電源がオフの状態でも動作する。(PC内に取り付けられた電池で動作する)  

### システムクロック

Linuxカーネル内に存在する時計。  
Linux起動時にハードウェアクロックを参照して設定されるが、その後は別々に動く。  
そのため、起動してから時間が経過するにつれ、ハードウェアクロックと差が生じる。  

### dateコマンド

システムクロックを表示するコマンド。  
rootユーザーはdateコマンドを使ってシステムクロックを変更できる。  

``` txt
現在の日付を表示する。
date

引数を「+」で始めると、指定した書式で表示する。
%Y :: 年
%m :: 月(01~12)
%d :: 日(01~31)
%H :: 時(00~23)
%M :: 分(00~59)
%a :: 曜日
%b :: 月名


システムクロックを変更する。
date [MMDDhhmm[[CC]YY][.ss]]

MM :: 月
DD :: 日
hh :: 時
mm :: 分
CC :: 西暦の上2桁
YY :: 西暦の下2桁
ss :: 秒
```

システムクロックを2018年12月10日20時に設定する。  
`sudo date 121020002018`  

「年/月/日(曜日)」の書式で表示する。  
`date "+%Y/%m/%d (%a)"`  
2018/12/10 (月)  

※バックアップをする時に``tar czf `date +"+%Y%m%d"`.tar.gz/data``というコマンドが自動的に実行されるようにしておけば、  
「20181210.tar.gz」のように、バックアップを実行した日付入りのアーカイブファイルを作成する事ができる。  

### hwclockコマンド

ハードウェアクロックの参照や設定を行うコマンド  

``` txt
hwclock オプション

-r :: ハードウェアクロックを表示する。
-w(--systohc) :: システムクロックの時刻をハードウェアクロックに設定する。
-s(--hctosys) :: ハードウェアクロックの時刻をシステムクロックに設定する。
```

### timedatectlコマンド

日付と時刻、タイムゾーンを管理するコマンド。  
systemdを採用したディストリビューションで使用可能。  
コマンドのみを実行した場合、現在の日時、タイムゾーン、NTPを利用しているかどうかを表示する。  

``` txt
timedatectl [サブコマンド]

status :: 現在の状態を表示する(デフォルト)
set-time 時刻 :: 時刻を設定する(HH:MM:SS)
set-time 日付 :: 日付を設定する(YYYY-MM-DD)
set-time 日付 時刻 :: 日付と時刻を設定する(YYYY-MM-DD HH:MM:SS)
set-timezone タイムゾーン :: タイムゾーンを設定する
list-timezones :: タイムゾーン一覧を表示する
set-ntp yes|no :: NTPを使うかどうか
```

日時を2019年3月12日12時24分に設定する。  
`timedatectl set-time 2019-03-12 12:24:00`  

タイムゾーンを「Asia/Tokyo」に設定する。  
`timedatectl set-timezone Asia/Tokyo`  

### NTP(Network Time Protocol)

ハードウェアクロックもシステムクロックも残念ながらあまり正確ではない。  
正確な時刻を設定するためには、ネットワーク経由でクロックを同期するプロトコルであるNTPを使い、インターネット上にあるNTPサーバー(タイムサーバー)から正確な時刻を取得する。  

NTPネットワークは階層構造になっている。  
最上位は原子時計やGPSなど、きわめて正確な時刻情報の提供元がある。  
その直下にあるNTPサーバーをStratum1。
その次をStratum2。
数字は階層を下るに従って増えていく。  
NTPサーバーは上位の複数のNTPサーバーから正確な時刻を取得する。  

### ntpdateコマンド

指定したNTPサーバーから現在時刻を取得するコマンド。  

``` txt
ntpdate NTPサーバー名
```

NTPサーバーtime.sercer.lpic.jpから現在時刻を取得する。  
`ntpdate time.server.lpic.jp`  

### ntpサーバー

NTPサーバーは自前で運用することができる。  
組織内にNTPクライアントが多い場合は用意したほうが都合がよい。  

SysVinitを採用したシステムでのNTPサーバーの起動方法  
`/etc/init.d/ntpd start`  

systemdを採用したシステムでのNTPサーバーの起動方法  
`systemctl start ntpd.service`  

NTPサーバーの設定は`/etc/ntp.conf`で行う。  
補正情報(クロックの誤差を予測した数値)は、`/etc/ntp.drift`に保存される。  
ディストリビューションによっては`/var/lib/ntp/drift`や`/var/lib/ntp/ntp.drift`になっていることもある。  

``` txt : /etc/ntp.confファイルの例
server 0.jp.pool.ntp.org ← 1番目のNTPサーバー
server 1.jp.pool.ntp.org ← 2番目のNTPサーバー
server 2.jp.pool.ntp.org ← 3番目のNTPサーバー
server 3.jp.pool.ntp.org ← 4番目のNTPサーバー
driftfile /etc/ntp.drift ← 補正情報ファイルの指定
logfile /var/log/ntp.log ← ログファイルの設定
```

この設定例では、複数のNTPサーバーをまとめて仮想的なNTPサーバーとして運用している。  
0.jo.pool.ntp.orgにDNSで問い合わせすると、いくつかのNTPサーバーの中から1つのIPアドレスがランダムに帰ってくる。  
このようにして特定のNTPサーバーに負荷が集中しないようにしている。  

### ntpqコマンド

NTPサーバーの状態を紹介するコマンド。  

localhostで稼働しているNTPサーバーから問い合わせされているNTPサーバーのリストを表示する。
`ntpq -p localhost`  

### Chrony

ntpd/ntpdate の代替となるNTPサーバー/クライアントソフトウェア。  
デーモンプロセス:`chronyd` と クライアントコマンド:`chronyc` から構成される。  
設定ファイル : `/etc/chrony.conf`  

``` conf : /etc/chrony.confの設定例
# NTPサーバーを指定
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst

# 補正情報ファイルを指定
driftfile /var/lib/chrony/drift

# ハードウェアクロックと同期させる
rtcsync

# ログファイルを指定
logdir /var/log/chrony
```

### chronycコマンド

chronydの管理を行うコマンド  
chronycコマンド単体で実行した場合、対話モードでの操作となる。  

``` txt
chronyc [サブコマンド]

activity :: NTPサーバーのオンライン/オフライン数を表示する。
sources :: 時刻ソースの情報を表示する。
sourcestats :: 時刻ソースの統計情報を表示する。
tracking :: トラッキングを確認する。
quit :: 対話状態を終了する。
```

時刻ソースとなるNTPサーバー毎の情報を表示する。  
`chronyc sources`  

---

## システムログの設定

Linuxでは、**syslog**と呼ばれるプログラムを使用することによってLinuxで発生する各種イベントをログファイルに出力したりコンソールに出力することが可能となります。  
syslogのプログラムは、**syslogd**というデーモンにより実行される。  
syslogは他のプログラムからのメッセージを受信して、出力元や優先度に従って分類を行って、syslogで定義した出力先に送信する。  

### syslog,rsyslog

CentOS6以降のディストリビューションではrsyslogが採用されている場合がある。  
rsyslogは各種機能をプラグインモジュールで拡張できるようになっている。  
ログの出力方式などは/etc/syslog.confファイルの書式とほぼ同じ。  
linucイージスではsyslog,小豆本ではrsyslogを解説しているのでどちらもまとめる。  

syslogの設定  
`/etc/syslog.conf`設定ファイルで行う。  

rsyslogの設定  
`/etc/rsyslog.conf`設定ファイル or `etc/rsyslog.d`設定ディレクトリで行う。  

### /etc/rsyslog.conf

rsyslog.confファイルは「モジュール設定部分」「グルーバル設定部分」「ルール設定部分」が主たる設定項目になる。  
`#`で始まる行はコメント行。  

モジュールプラグインのデフォルトは[imuxsock] [imklog]のみ有効になっている。  

``` txt : rsyslogの主なプラグインモジュール
imuxsock :: UNIXソケットによるローカルロギングサポート(loggerコマンドなど)
imjournal :: systemdのジャーナルサポート
imklog :: カーネルログのサポート
immark :: マークを出力(--MARK--)
imudp :: UDPでメッセージを受信
imtcp :: TCPでメッセージを受信
```

どのようなメッセージをどこに出力するか？といった設定はルール設定部分および、/etc/rsyslog.dディレクトリ以下の～.confファイルで設定する。  

rsyslog.confファイルの書式 :: `ファシリティ.プライオリティ 出力先`  

### ファシリティ

メッセージの生成元を表す。  
具体的にはカーネルや実行中のプロセス。  
[*]を使うとすべてのファシリティを選択できる。  

``` txt : ファシリティ
auth,authpriv :: 認証システム(loginなど)による出力
cron :: cronによる出力
deamon :: 各種デーモンによる出力
kern :: カーネルによる出力
lpr :: 印刷システムによる出力
mail :: メールサービス関連による出力
user :: ユーザーアプリケーションによる出力
syslog :: syslog機能
local0~local7 :: ローカルシステムの設定
```

### プライオリティ

メッセージの重要度を表す。  
低く設定すればするほど、ログとして出力される情報量も多くなる。
[*]を使うとすべてのプライオリティを選択できる。  
noneだけは例外で、指定されたファシリティのログを除外する役割を持つ。  

emergが最も高く、debugが最も低い。  
指定したプライオリティよりもレベルが高いものがすべて記録される。  
critならalertとemergも含まれる。  
特定のプライオリティを指定したい場合、プライオリティの前に[=]を付ける。  

``` txt : プライオリティ
emerg :: 緊急事態
alert :: 早急に対処が必要な事態
crit :: システムの処理は継続できるものの深刻な事態
err :: 一般的なエラー
warning :: 一般的な警告
notice :: 一般的な通知
info :: 一般的な情報
debug :: デバッグ情報
none :: ログを記録しない
```

### 出力先

出力先として、ログファイルやユーザーの端末、他のホスト等を選択できる。  
この部分を「アクションフィールド」と言う。  

``` txt : アクションフィールド
ファイル名 :: ファイルへの出力
ユーザー名 :: ユーザーの端末への出力
@ホスト名 :: リモートホストのsyslogへUDPで出力
@@ホスト名 :: リモートホストのsyslogへTCPで出力
/dev/tty1 :: コンソール(rrt1)に出力
/dev/console :: コンソールへの出力
* :: ログイン中のすべてのユーザーの端末に出力

/var/log/messages :: ログファイルに出力
@sv.example.com :: ホストsv.sxample.comにUDPで出力
@@sv.example.com :: ホストsv.example.comにTCPで出力
violet :: ユーザーvioletの端末に出力
```

※因みにファシリティとプライオリティを合わせて「セレクタフィールド」という。  
セレクタフィールドは「;」区切り文字で複数を列挙できる。  

### 記述例のオンパレード

crit,alert,emergレベルのメール関連のログを/var/log/mailファイルに記録  
`mail.crit /var/log/mail`  

critレベルのメール関連のログを/var/log/mailファイルに記録  
`mail.=crit /var/log/mail`  

errレベル、noticeレベルのメール関連のログを/var/log/mailファイルに記録  
`mail.=err;mail.=notice /var/log/mail`  

crit,alert,emergレベルのメール関連のログを192.168.0.1の端末に転送  
`mail.crit @192.168.0.1`  

メールのログを出力しない  
`mail.none`  

カーネルに関するすべてのメッセージを/var/log/kernelに出力  
`keln.* /var/log/kernel`  

緊急メッセージは全ユーザーが受け取る  
`*.emerg *`  

### loggerコマンド

システムログに記録を追加するコマンド。  
ログメッセージを生成する事ができるので、syslog.confの設定ファイルが正しく設定されたのかを確認する事ができる。  

``` txt
logger [-p ファシリティ.プライオリティ] [-t タグ] メッセージ
```

ファシリティをsyslog,プライオリティをinfoとして「test message」というメッセージを出力  
`logger -p syslog.info -t TEST "test message"`  

### syslogの一元管理

各Linuxマシンでsyslogによりログを管理できるが、複数のLinuxマシンを運用する場合、syslogは1つのLinuxマシンに集中管理させることが一般的。  
その場合は、各Linuxマシンのsyslog.confファイルにて、syslogを管理するサーバーをログの出力先として設定する。  

Webサーバー、Mailサーバー、DNSサーバーがあったとして、それらのsyslog.confを`*.* @192.168.0.100`と設定する。  
syslogサーバーとして192.168.0.100を設定する。外部からのsyslogを受信できるようにUDPポート514番を解放する。  

### systemd-catコマンド

systemdを採用したシステムで使用可能。  
コマンドの実行結果をジャーナルに書き込む事ができるコマンド。  

``` txt
systemd-cat コマンド
```

uptimeコマンドの実行結果をジャーナルに書き込む。  
`systemd-cat uptime`  
`sournalctl -xe`を実行する事で結果を確認できる。  

### logの調査方法色々

---

## メール管理(メールシステム)

### MTA(Mail Transfer Agent)

メールの配送を行うプログラム。  
メールシステムの中心的役割を担う。  
DNSサーバーを使用してメールの送信先となるMTAのホスト名を調べる。  
SMTPプロトコルでメッセージをやり取りするため、SMTPサーバーとも呼ばれる。  

代表的なMTAプログラム  
Exim,Postfix,Sendmailなど  

### MDA (Mail Delivery Agent)

MTAが受け取ったメールをローカルドメインのユーザーに配信する(メールスプールに格納する)プログラム。  

MTAに対するMDAプログラム  

- Sendmail : procmail(デフォルト)  
- PostFix : localデーモン  
- Exim : Exim自身が行う  

### MUA (Mail User Agenet)

ユーザーがメールの送受信に使用するプログラム。  

CUIベース : malix,mutt  
GUIベース : Thunderbird,Evolution  

### メール配送の仕組み

``` txt
クライアント  メールサーバー  ネットワーク  メールサーバー  クライアント
    MUA    →     MTA①          →             MTA②
                                                 ↓
                                                 MDA
                                                 ↓
                                            メールボックス
                                                 ↓
                                              POPサーバー  →    MUA
```

①メールクライアントソフトウェア(MUA)で作成されたメールは、送信用MTA①へ送られる。  
②MTA①は、メールアドレスから配送先メールサーバーを調べ、メールをMTA②に配送する。  
③MTA②がメールを受け取ると、ローカル配送プログラムであるMDAが、メールのさて先となっているユーザーのメールボックスにメールを格納する。  
④受取人側はPOPサーバーやIMAPサーバーを経由して自分のメールボックスからメールを取り出す。  

### Sendmail,Exim,Postfix

Sendmail : 1981  
Exim : 1995  
Postfix : 1998  

Sendmailは標準的なMTAとして長く使われてきたが、最近は使われていない。(さすがに古いし、後継もある)  
主流はEximとPostfix。  
SMTPサーバーとして使われる。  
EximとPostfixはSendmailに互換性がある。  

以下のコマンドとファイルでの設定が有効であるため  
・sendmailコマンド  
・newaliasesコマンド  
・mailqコマンド  
・~/.forwardファイル  

### ローカルユーザー宛のメールが格納されるディレクトリ

Sendmail : /var/spool/mail  
Exim : /var/mail  
Postfix : /var/mail  

### 転送することが出来なかったメールを置くデフォルトのキューディレクトリ

Sendmail : /var/spool/mqueue  
Exim : /var/spool/exim/input  
Postfix : /car/spool/postfix/deferred  

### /etc/aliasesファイル

メールアドレスの別名を設定するファイル。  
例えば、root宛に届いたメールをユーザーadminとlpicでも受け取れるようにするには以下のように設定する。  
adminとlpicはどちらもrootあてのメールを受け取れるようになるが、rootにはメールが届かなくなる。  
設定の反映は`newaliases`コマンドで行う。  

``` txt : /etc/aliasesの記述例
root: admin,lpic
```

### MTAの起動

### mailコマンド

コマンドラインでメールを受信したり、受信メールを確認したりするコマンド。  
mailコマンドでユーザー名のみを指定するとローカルシステムのユーザー宛に送信される。  
-sはタイトル(Subject)を指定するオプション。  
引数なしでコマンドを実行すると、メールボックスに届いているメールを確認できる。  
`番号`でその番号のメールを選択。`q`で終了。

``` txt
mail [-s 題名] [宛先メールアドレス or ユーザー名]
```

ローカルシステム内のユーザーである「admin」にメールを送信する。  

``` txt
mail -s TESTMAIL admin
this is a test e-mail
.
```

### sendmailコマンド

メールを送信するコマンド。  
CUIのMUAであるmalix,muttで利用する。  

``` txt : 実行例
sendmail yuki@mylpic.com < 送信する本文を格納したファイル
```

### newaliasesコマンド

メールアドレスの別名を設定するファイルとして、エイリアスファイル(/etc/aliases)とエイリアスデータベースファイル(/etc/aliases.db)がある。  
このうちの、**エイリアスデータベースファイルを更新するコマンド**。  
エイリアスデータベースファイルは更新してもすぐには反映されないので、newaliasesコマンドを叩いて変更を反映させる必要がある。  
因みにエイリアスファイルはSendmail,Postfixの起動時にのみ、読みこまれる。  

エイリアスデータベースファイルがあれば、そちらを参照し、無ければエイリアスファイルが参照される。  
Eximはエイリアスデータベースファイルを参照しない。  
newaliasesコマンドは使えるが、それはSendmailとの互換性のためだけ。  

Sendmail,Postfix : エイリアスファイル、エイリアスデータベースファイル  
Exim : エイリアスファイル  

``` txt
別名 : 転送アドレス1,転送アドレス2,転送アドレス3
```

### mailqコマンド

MTAが転送できなかったメールのキューを見るためのコマンド。  
送信待ちのメールはメールキュー(/var/spool/mqueue)に蓄えられる。  
全MDA(Sendmail,Postfix,Exim)で使用可能。  

### ~/.forwardファイル

ユーザー受信メールのリダイレクトを行いたい時に設定するファイル。  
自分のホームディレクトリの下に`.forward`ファイルを作成して、転送先メールアドレスを記述する。  
一時的にメールを転送したい場合等に便利。  
ユーザーが各自で設定できるため、管理者が設定する必要はない。  

``` txt : 記述例
mana@example.com
mana@mylpic.com
```

自分宛のメールをmana@example.comとmana@mylpic.comに転送する。  

因みにファイル名やディレクトリが「.(ドット)」から始まるのは隠しファイルや隠しフォルダ。  
`~/`はホームディレクトリを表す。  

### /var/spool/queue

送信待ちメールの格納先  

### /var/spool/mail

受信待ちメールの格納先  

### オープンリレー

外部からのメールを制限することなく他のドメインに中継する事。  
そのままではスパムの踏み台にされるので、以下の制限を設定する。  
①外部からのメールはローカルドメイン宛のメールだけを受け取り、他のドメインへ中継しない。  
②内部ネットワークからのメールだけを他のドメインに中継する。  

因みに「外部からの名前解決リクエストに対して制限することなく答えを返すこと」をオーブンリゾルバという。  

---

## プリンタ管理

### CPUS(Common Unix Printing System)

印刷サブシステムらしい。  

・IPP(Internet Printer Protocol)の採用  
ネットワーク上のプリンタをサポートする印刷プロトコルIPPを採用。  

・PPD(PostScript Printer Description)ファイルのサポート  
AdobeのPPD形式のファイル(テキストファイル)でデバイスドライバの設定ができる。  

・Webベースで設定可能  
Webブラウザから設定できるツールが組み込まれている。  

・プリンタクラスのサポート  
複数のプリンタを1台のプリンタに見せかける機能をサポートしている。  

PPDファイルの格納場所 :: `/etc/cups/ppdディレクトリ以下`  
CUPSの設定ファイル :: `/etc/cups/cupsd.conf`  
→印刷要求をネットワーク経由で受け付ける場合のポート番号や、接続するクライアントのアクセス許可の設定等。  
プリンタに関する情報などの設定 :: `/etc/cups/printers.conf`  
設定ポート :: 631  
→localhost:631でアクセス。  

設定ファイルを直接編集。  
WebブラウザでCUPSの設定ページにアクセスして編集する。  

### CUPSの印刷処理の流れ

1. アプリケーションや印刷コマンドから印刷データを受け取る。  
   プリンタの設定オプションはPPDファイルから提供される。  
2. スプーラーが印刷データを受付、スケジューリングを行う。  
3. プリンタが直接受け付けられないデータを一旦中間形式としてPDFまたはPostScriptにフィルタで変換する。  
4. PPDに定義されたフィルタにより、最終の印刷データに変換する。  
5. 処理した印刷データをCUPSのバックエンドに送る。  
6. バックエンドは印刷データをローカル接続(USBなど)またはネットワークを経由(IPPやLPRなど)してプリンタに渡す。  

### CUPSサービスの起動

SysVinitの場合  
`/etc/init.d/cups start`  

systemdの場合  
`systemctl start cups.service`  

IPPサービス(ポート631/tcp)が開いていれば、CUPSは動作している。  
`netstat -at | grep ipp`  

### lprコマンド

印刷コマンド。  
指定されたファイルや標準入力をプリントキューに送る。  

``` txt
lpr [オプション] [ファイル名]

-# 部数 :: 印刷部数を指定する。
-P プリンタ名 :: 印刷を行うプリンタを指定する。
```

テキストファイル testdata.txtを6部印刷する。  
`lpr -# 6 testdata.txt`  

/etc/passwdファイルを5部印刷する。  
`lpr -# 5 /etc/passwd`  

dmesgコマンドの出力を印刷する。  
`dmesg | lpr`  

### lpqコマンド

プリントキューの内容を表示するコマンド。  
オプションを指定せずにコマンドを実行した場合、デフォルトに設定されているプリンタのキューを表示する。  

``` txt
lpq [オプション] [ユーザー名] [ジョブ番号]

-a :: すべてのプリンタの情報を表示。
-P プリンタ名 :: 指定したプリンタの情報を表示。
```

### lprmコマンド

プリンタキューにある印刷ジョブを削除するコマンド。  
一般ユーザーは自分の発行した印刷要求のみ、スーパーユーザーはすべての印刷要求を削除できる。  

``` txt
lprm [オプション] [ジョブ番号]

-P プリンタ名 :: 指定したプリンタの印刷ジョブを削除
- :: 自分の印刷ジョブをすべて削除
```

自分の印刷ジョブを全て削除(一般)  
`$ lprm -`  

自分の印刷ジョブを全て削除(root)  
`# lprm -`  

---

## 小豆本問題

---

### 1 ○

cronを使って自動的にバックアップを取るようにしている。  
バックアップファイル名にバックアップ日時が使われるにように死体場合、書式として適切なコマンドは？  

→  
D. ``tar czf /backup/date`date "+%Y%m%d"`.tar.gz /home``  

すげー。当たった。  
書式の設定はじめは「+」からだったような？ってのは合ってたみたいだ。  
tarのコマンドは知らん。xは回答だから違うとしとvとfの違いがわからない。  

cfz → create file zip  

---

### 2

---

### 3

---

### 4

---

### 5

---

### 6

---

### 7

---

### 8

---

### 9
