# 10.必須システムサービス

---

## システムクロックの設定

### ハードウェアクロック

PCにハードウェアとして内臓された時計。  
電源がオフの状態でも動作する。(PC内に取り付けられた電池で動作する)  

### システムクロック

Linuxカーネル内に存在する時計。  
Linux起動時にハードウェアクロックを参照して設定されるが、その後は別々に動く。  
そのため、起動してから時間が経過するにつれ、ハードウェアクロックと差が生じる。  

### dateコマンド

システムクロックを表示するコマンド。  
rootユーザーはdateコマンドを使ってシステムクロックを変更できる。  

``` txt
現在の日付を表示する。
date

引数を「+」で始めると、指定した書式で表示する。
%Y :: 年
%m :: 月(01~12)
%d :: 日(01~31)
%H :: 時(00~23)
%M :: 分(00~59)
%a :: 曜日
%b :: 月名


システムクロックを変更する。
date [MMDDhhmm[[CC]YY][.ss]]

MM :: 月
DD :: 日
hh :: 時
mm :: 分
CC :: 西暦の上2桁
YY :: 西暦の下2桁
ss :: 秒
```

システムクロックを2018年12月10日20時に設定する。  
`sudo date 121020002018`  

「年/月/日(曜日)」の書式で表示する。  
`date "+%Y/%m/%d (%a)"`  
2018/12/10 (月)  

※バックアップをする時に``tar czf `date +"+%Y%m%d"`.tar.gz/data``というコマンドが自動的に実行されるようにしておけば、  
「20181210.tar.gz」のように、バックアップを実行した日付入りのアーカイブファイルを作成する事ができる。  

### hwclockコマンド

ハードウェアクロックの参照や設定を行うコマンド  

``` txt
hwclock オプション

-r :: ハードウェアクロックを表示する。
-w(--systohc) :: システムクロックの時刻をハードウェアクロックに設定する。
-s(--hctosys) :: ハードウェアクロックの時刻をシステムクロックに設定する。
```

### timedatectlコマンド

日付と時刻、タイムゾーンを管理するコマンド。  
systemdを採用したディストリビューションで使用可能。  
コマンドのみを実行した場合、現在の日時、タイムゾーン、NTPを利用しているかどうかを表示する。  

``` txt
timedatectl [サブコマンド]

status :: 現在の状態を表示する(デフォルト)
set-time 時刻 :: 時刻を設定する(HH:MM:SS)
set-time 日付 :: 日付を設定する(YYYY-MM-DD)
set-time 日付 時刻 :: 日付と時刻を設定する(YYYY-MM-DD HH:MM:SS)
set-timezone タイムゾーン :: タイムゾーンを設定する
list-timezones :: タイムゾーン一覧を表示する
set-ntp yes|no :: NTPを使うかどうか
```

日時を2019年3月12日12時24分に設定する。  
`timedatectl set-time 2019-03-12 12:24:00`  

タイムゾーンを「Asia/Tokyo」に設定する。  
`timedatectl set-timezone Asia/Tokyo`  

### NTP(Network Time Protocol)

ハードウェアクロックもシステムクロックも残念ながらあまり正確ではない。  
正確な時刻を設定するためには、ネットワーク経由でクロックを同期するプロトコルであるNTPを使い、インターネット上にあるNTPサーバー(タイムサーバー)から正確な時刻を取得する。  

NTPネットワークは階層構造になっている。  
最上位は原子時計やGPSなど、きわめて正確な時刻情報の提供元がある。  
その直下にあるNTPサーバーをStratum1。
その次をStratum2。
数字は階層を下るに従って増えていく。  
NTPサーバーは上位の複数のNTPサーバーから正確な時刻を取得する。  

### ntpdateコマンド

指定したNTPサーバーから現在時刻を取得するコマンド。  

``` txt
ntpdate NTPサーバー名
```

NTPサーバーtime.sercer.lpic.jpから現在時刻を取得する。  
`ntpdate time.server.lpic.jp`  

### ntpサーバー

NTPサーバーは自前で運用することができる。  
組織内にNTPクライアントが多い場合は用意したほうが都合がよい。  

SysVinitを採用したシステムでのNTPサーバーの起動方法  
`/etc/init.d/ntpd start`  

systemdを採用したシステムでのNTPサーバーの起動方法  
`systemctl start ntpd.service`  

NTPサーバーの設定は`/etc/ntp.conf`で行う。  
補正情報(クロックの誤差を予測した数値)は、`/etc/ntp.drift`に保存される。  
ディストリビューションによっては`/var/lib/ntp/drift`や`/var/lib/ntp/ntp.drift`になっていることもある。  

``` txt : /etc/ntp.confファイルの例
server 0.jp.pool.ntp.org ← 1番目のNTPサーバー
server 1.jp.pool.ntp.org ← 2番目のNTPサーバー
server 2.jp.pool.ntp.org ← 3番目のNTPサーバー
server 3.jp.pool.ntp.org ← 4番目のNTPサーバー
driftfile /etc/ntp.drift ← 補正情報ファイルの指定
logfile /var/log/ntp.log ← ログファイルの設定
```

この設定例では、複数のNTPサーバーをまとめて仮想的なNTPサーバーとして運用している。  
0.jo.pool.ntp.orgにDNSで問い合わせすると、いくつかのNTPサーバーの中から1つのIPアドレスがランダムに帰ってくる。  
このようにして特定のNTPサーバーに負荷が集中しないようにしている。  

### ntpqコマンド

NTPサーバーの状態を紹介するコマンド。  

localhostで稼働しているNTPサーバーから問い合わせされているNTPサーバーのリストを表示する。
`ntpq -p localhost`  

### Chrony

ntpd/ntpdate の代替となるNTPサーバー/クライアントソフトウェア。  
デーモンプロセス:`chronyd` と クライアントコマンド:`chronyc` から構成される。  
設定ファイル : `/etc/chrony.conf`  

``` conf : /etc/chrony.confの設定例
# NTPサーバーを指定
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst

# 補正情報ファイルを指定
driftfile /var/lib/chrony/drift

# ハードウェアクロックと同期させる
rtcsync

# ログファイルを指定
logdir /var/log/chrony
```

### chronycコマンド

chronydの管理を行うコマンド  
chronycコマンド単体で実行した場合、対話モードでの操作となる。  

``` txt
chronyc [サブコマンド]

activity :: NTPサーバーのオンライン/オフライン数を表示する。
sources :: 時刻ソースの情報を表示する。
sourcestats :: 時刻ソースの統計情報を表示する。
tracking :: トラッキングを確認する。
quit :: 対話状態を終了する。
```

時刻ソースとなるNTPサーバー毎の情報を表示する。  
`chronyc sources`  

---

## システムログの設定

Linuxでは、**syslog**と呼ばれるプログラムを使用することによってLinuxで発生する各種イベントをログファイルに出力したりコンソールに出力することが可能となります。  
syslogのプログラムは、**syslogd**というデーモンにより実行される。  
syslogは他のプログラムからのメッセージを受信して、出力元や優先度に従って分類を行って、syslogで定義した出力先に送信する。  

### syslog,rsyslog

CentOS6以降のディストリビューションではrsyslogが採用されている場合がある。  
rsyslogは各種機能をプラグインモジュールで拡張できるようになっている。  
ログの出力方式などは/etc/syslog.confファイルの書式とほぼ同じ。  
linucイージスではsyslog,小豆本ではrsyslogを解説しているのでどちらもまとめる。  

syslogの設定  
`/etc/syslog.conf`設定ファイルで行う。  

rsyslogの設定  
`/etc/rsyslog.conf`設定ファイル or `etc/rsyslog.d`設定ディレクトリで行う。  

### /etc/rsyslog.conf

rsyslog.confファイルは「モジュール設定部分」「グルーバル設定部分」「ルール設定部分」が主たる設定項目になる。  
`#`で始まる行はコメント行。  

モジュールプラグインのデフォルトは[imuxsock] [imklog]のみ有効になっている。  

``` txt : rsyslogの主なプラグインモジュール
imuxsock :: UNIXソケットによるローカルロギングサポート(loggerコマンドなど)
imjournal :: systemdのジャーナルサポート
imklog :: カーネルログのサポート
immark :: マークを出力(--MARK--)
imudp :: UDPでメッセージを受信
imtcp :: TCPでメッセージを受信
```

どのようなメッセージをどこに出力するか？といった設定はルール設定部分および、/etc/rsyslog.dディレクトリ以下の～.confファイルで設定する。  

rsyslog.confファイルの書式 :: `ファシリティ.プライオリティ 出力先`  

### ファシリティ

メッセージの生成元を表す。  
具体的にはカーネルや実行中のプロセス。  
[*]を使うとすべてのファシリティを選択できる。  

``` txt : ファシリティ
auth,authpriv :: 認証システム(loginなど)による出力
cron :: cronによる出力
deamon :: 各種デーモンによる出力
kern :: カーネルによる出力
lpr :: 印刷システムによる出力
mail :: メールサービス関連による出力
user :: ユーザーアプリケーションによる出力
syslog :: syslog機能
local0~local7 :: ローカルシステムの設定
```

### プライオリティ

メッセージの重要度を表す。  
低く設定すればするほど、ログとして出力される情報量も多くなる。
[*]を使うとすべてのプライオリティを選択できる。  
noneだけは例外で、指定されたファシリティのログを除外する役割を持つ。  

emergが最も高く、debugが最も低い。  
指定したプライオリティよりもレベルが高いものがすべて記録される。  
critならalertとemergも含まれる。  
特定のプライオリティを指定したい場合、プライオリティの前に[=]を付ける。  

``` txt : プライオリティ
emerg :: 緊急事態
alert :: 早急に対処が必要な事態
crit :: システムの処理は継続できるものの深刻な事態
err :: 一般的なエラー
warning :: 一般的な警告
notice :: 一般的な通知
info :: 一般的な情報
debug :: デバッグ情報
none :: ログを記録しない
```

### 出力先

出力先として、ログファイルやユーザーの端末、他のホスト等を選択できる。  
この部分を「アクションフィールド」と言う。  

``` txt : アクションフィールド
ファイル名 :: ファイルへの出力
ユーザー名 :: ユーザーの端末への出力
@ホスト名 :: リモートホストのsyslogへUDPで出力
@@ホスト名 :: リモートホストのsyslogへTCPで出力
/dev/tty1 :: コンソール(rrt1)に出力
/dev/console :: コンソールへの出力
* :: ログイン中のすべてのユーザーの端末に出力

/var/log/messages :: ログファイルに出力
@sv.example.com :: ホストsv.sxample.comにUDPで出力
@@sv.example.com :: ホストsv.example.comにTCPで出力
violet :: ユーザーvioletの端末に出力
```

※因みにファシリティとプライオリティを合わせて「セレクタフィールド」という。  
セレクタフィールドは「;」区切り文字で複数を列挙できる。  

### 記述例のオンパレード

crit,alert,emergレベルのメール関連のログを/var/log/mailファイルに記録  
`mail.crit /var/log/mail`  

critレベルのメール関連のログを/var/log/mailファイルに記録  
`mail.=crit /var/log/mail`  

errレベル、noticeレベルのメール関連のログを/var/log/mailファイルに記録  
`mail.=err;mail.=notice /var/log/mail`  

crit,alert,emergレベルのメール関連のログを192.168.0.1の端末に転送  
`mail.crit @192.168.0.1`  

メールのログを出力しない  
`mail.none`  

カーネルに関するすべてのメッセージを/var/log/kernelに出力  
`keln.* /var/log/kernel`  

緊急メッセージは全ユーザーが受け取る  
`*.emerg *`  

### loggerコマンド

システムログに記録を追加するコマンド。  
ログメッセージを生成する事ができるので、syslog.confの設定ファイルが正しく設定されたのかを確認する事ができる。  

``` txt
logger [-p ファシリティ.プライオリティ] [-t タグ] メッセージ
```

ファシリティをsyslog,プライオリティをinfoとして「test message」というメッセージを出力  
`logger -p syslog.info -t TEST "test message"`  

### syslogの一元管理

各Linuxマシンでsyslogによりログを管理できるが、複数のLinuxマシンを運用する場合、syslogは1つのLinuxマシンに集中管理させることが一般的。  
その場合は、各Linuxマシンのsyslog.confファイルにて、syslogを管理するサーバーをログの出力先として設定する。  

Webサーバー、Mailサーバー、DNSサーバーがあったとして、それらのsyslog.confを`*.* @192.168.0.100`と設定する。  
syslogサーバーとして192.168.0.100を設定する。外部からのsyslogを受信できるようにUDPポート514番を解放する。  

### systemd-catコマンド

systemdを採用したシステムで使用可能。  
コマンドの実行結果をジャーナルに書き込む事ができるコマンド。  

``` txt
systemd-cat コマンド
```

uptimeコマンドの実行結果をジャーナルに書き込む。  
`systemd-cat uptime`  
`sournalctl -xe`を実行する事で結果を確認できる。  

### logの調査方法色々

---

## メール管理

---

## プリンタ管理

---

## 小豆本問題

---

### 1

---

### 2

---

### 3

---

### 4

---

### 5

---

### 6

---

### 7

---

### 8

---

### 9
