# 12.セキュリティ

## ホストレベルのセキュリティ

・スーパーサーバー  
・/etc/xinetd.confファイル  
・/etc/xinetd.dディレクトリ  

### スーパーサーバー

サーバープログラムを管理するプログラム。  
必要な時だけ個々のサーバープログラムを起動する。  
→メモリなどのシステムリソースを効率的に使うことが出来る。  

即応性が求められるサービスはそのサービス自体で監視すべき(スタンドアロン)  
Webサーバー,メールサーバ,etc...  

FTP,Telnetなど、頻度が高くないものはスーパーサーバー経由での接続に適している。  

代表的なスーパーサーバー  
inted,xinted  

### xinetd

ネットワークからのリクエストを受け付けるデーモン。  
`/etc/xinted.confファイル` : xintedの全体的な設定を行うファイル  
`/etc/xinted.dディレクトリ` : サービスごとの設定ファイルを格納するディレクトリ  

<https://www.express.nec.co.jp/linux/distributions/knowledge/network/xinetd.html>  
xinetd は、単体で inetd + TCP wrapper(tcpd) の機能を持っているだけでなく、よりきめ細かで自由度の高い設定を行なうことができる。  

``` txt
/etc/services
ポート番号→サービス名
23 telnet

/etc/xinetd.conf
サービス名→デーモン名
telnet in.telnetd
```

### /etc/xinetd.confファイル

### /etc/xinted.dディレクトリ

/etc/xinted.d以下の設定ファイルの主なパラメーター  

``` txt
disable : サービスの有効/無効
socket_type : 通信のタイプ(TCP:stream , UDP:dgram)
wait : ウェイトタイム
user : サービスを実行するユーザー
server : サーバープログラム(デーモン)へのフルパス
server_args : サーバープログラム(デーモン)に渡す引数
log_on_failure : 接続を拒否した時にログに記録する内容
nice : 実行優先度
only_from : 接続を許可する接続元
no_acccess : 接続を拒否する接続元
access_time : アクセスを許可する時間帯
```

/etc/xinetd.d/time-streamの例  

``` txt
service time
{
    disable = no
    id = time-stream
    type = INTERNAL
    wait = no
    socket_type = stream
    only_from = 172.16.0.1
```

### TCP Wrapper

システムに常駐する、外部からのTCP/IP接続のアクセス制御を行うプログラム。  
標準の常駐プログラム名(デーモン名)は**tcpd**  
サービス要求を受け取った後、設定に基づいてチェックを行い、接続が許可された場合はそれぞれのサーバープログラムに処理を引き渡す。  

設定ファイル  
/etc/hosts.allow  
/etc/hosts.deny  

### lsofコマンド

プロセスによってオープンされているファイルの一覧を表示するコマンド  
引数にファイル名をした場合、そのファイルをオープンしているプロセスを表示する。  

``` txt
lsof [オプション] [ファイル名]

オプション
-i : オープンしているポートとプロセスを表示する。
-i:ポート番号 : 指定のポートをオープンしているプロセスを表示する。
-i:サービス名 : 指定のサービスをオープンしているプロセスを表示する。
-p プロセスID : 指定したプロセスがオープンしているファイルを表示する。
-P : ポート番号をサービス名に変換せず、数値のままで表示する。
```

### nmapコマンド

ポートスキャンをするコマンド  

``` txt
nmap 対象ホスト
```

使用例  
`nmap www.emxample.com`  

### fuserコマンド

ポートを開いているプロセスを調べるコマンド  

``` txt
fuser -n tcp 8080
```

### SUIDの確認

SUIDが設定されているファイルを把握しておく必要がある。  
定期的にチェックすべき。  

SUIDが設定されているファイルを検索するコマンド  
`find / -perm -u+s -ls`  

---

## ユーザーに対するセキュリティ管理

### changeコマンド

ユーザーのパスワードの有効期限を表示・変更するコマンド。  
引数を設定しないで実行した場合、対話モードになる。  

``` txt
chage [オプション] [ユーザー名]
```

### /etc/nologinファイル

ユーザーのログインを禁止するファイル  
これが存在するだけでルートユーザー以外のログインは出来なくなる。  
中身は空でもいいが、書いた内容は一般ユーザーがログインしようとしたときに表示される。  

### suコマンド

一時的に別のユーザーになるコマンド  
別の実行ユーザーIDと実行グループIDを持つ新たなシェルを起動するコマンド  

``` txt
su [オプション] [-] ユーザー名

-あり : 直接ログインしたときと同様の動作を行う。
カレントディレクトリは新しいユーザーのホームディレクトリとなる。
環境変数が全て初期化される。

-なし : 現在の環境をそのままにしてユーザーだけを切り替える。  
```

### sudoコマンド

別のユーザーの権限でプログラムを実行するためのコマンド  
大抵はrootユーザーとして実行する場合に使われる。  

``` txt
sudo [オプション] [-u ユーザー名] コマンド

オプション
-l : 許可されているコマンドで表示する
-i : 変更先ユーザーでシェルを起動する(ログイン時の処理を行う)
-s : 変更先ユーザーでシェルを起動する

-u ユーザー : rootではなく指定したユーザーでコマンドを実行する
ユーザー名を省略するとrootユーザーで実行する。
```

### visudoコマンド

sudoコマンドの利用設定をするコマンド。  
/etc/sudoersファイルを開く。  
rootユーザーのみ実行可能。  

### /etc/sudoersファイル

sudoコマンドを実行できるユーザーの設定を行うファイル。  
sudoコマンド実行時、sudoコマンドはこのファイルを参照してユーザーが実行権限を持っているかどうか判定を行う。  
エディターで直接、このファイルを開いてはいけないらしい。  

``` txt
書式
ユーザー名 ホスト名=(実行ユーザー名) [NOPASSWD:]コマンド


ユーザー名 : コマンドの実行を許可するユーザー名かグループ名、もしくはALL
ホスト名 : 実行を許可するホスト名か、IPアドレス、もしくはALL
実行ユーザー名 : コマンド実行時のユーザー名(省略時はroot)、もしくはALL
コマンド : 実行を許可するコマンドのパス、もしくはALL
NOPASSWD: : 指定すると、コマンド実行時にパスワードを問われない
```

studentユーザーのみshutdownコマンドが実行できるように設定する  
`student ALL=(ALL) /sbin/shutdown`  

studentユーザーに対し、全てのroot権限が必要なコマンドの実行を許可する。  
`student ALL=(ALL) ALL`  

wheelグループに対し、全てのroot権限が必要なコマンドをパスワードなしで実行できるようにする。  
`%wheel ALL=(ALL) NOPASSWD:ALL`

### ulimitコマンド

ユーザーが利用できるリソースを制御するコマンド

``` txt
ulimit [オプション[リミット]]

-a
-c サイズ
-f サイズ
-n 数
-u プロセス数
-v サイズ

```

---

## OpenSSH

SSHプロトコルを利用するためのソフトウェア。  
SSHサーバーおよびSSHクライアントを含む。  
SSHを利用するために、現在世界で最も使われているSSH実装。  

[インフラエンジニアじゃなくても押さえておきたいSSHの基礎知識](https://qiita.com/tag1216/items/5d06bad7468f731f590e)  

### SSH(Secure Shell)

暗号や認証の技術を利用して、安全にリモートコンピュータと通信するためのプロトコル。  
ポート番号 : 22  

sshd : SSHサーバーの機能を提供するデーモン  

/etc/sshディレクトリは、sshサーバーとsshクライアントがともに使用するディレクトリ。  

### /etc/ssh/sshd_config  

sshdの設定ファイル  

sshtの主なディレクティブ  

- Port : 待機ポート番号  
- Protocol : プロトコルバージョン
- PermitRootLogin : rootログインを許可するかどうか
- PubkeyAuthentication : 公開鍵認証(プロトコルバージョン2)  
- AuthorizedKeysFile : ユーザー認証の公開鍵格納ファイル名  
- PasswordAuthentication : パスワード認証  

``` txt : sshd_configの抜粋
Port 22
Protocol 2
PermitRootLogin yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PasswordAuthentication yes
```

### /etc/ssh/ssh_known_hostsファイル

ローカルシステムの全ユーザーが利用するsshサーバーの公開鍵を格納するファイル。  
そのsshサーバーはローカルシステムの全ユーザーにとって正当と認めるサーバーになる。  

### sshコマンド

SSHを使ってリモートホストにログインするためのコマンド  

``` txt
ssh [[ログインユーザー@] ホスト]

-p ポート番号 : ポート番号を指定する
※ 「-o Port = ポート番号」 or 「-o "Port ポート番号"」 でも指定可能な模様。
-l ユーザー名 : 接続するユーザーを指定する
-i ファイル名 : 秘密鍵ファイルを指定する

ssh ユーザー名@ホスト名 -i 秘密鍵ファイルのパス -p ポート番号
```

sv1.lpic.jpにSSHで接続する。  
`ssh sv1.lpic.jp`  

studentユーザーとしてsv1.lpic.jpにSSHで接続する。  
`ssh student@sv1.lpic.jp`  

ポート番号22番、アイデンティティファイル~/.ssh/id_dsa、プロトコルバージョン2、ログインユーザーyukoでsshサーバーにログインする。  
`ssh -p 22 -i ~/.ssh/id_dsa -2 -l yuko examserver`  

### ホスト認証

クライアントがサーバーの正当性を確認するための認証。  
①クライアントがサーバーにSSH接続する。  
②サーバーがクライアントに公開鍵を送信する。  
③クライアントは送られてきた公開鍵の正当性をチェックする。  

ホスト認証の後、ユーザー認証を行う。  
接続先がなりすましだった場合、警告が出る。  
ユーザーが接続先の正当性を確認するための認証がホスト認証というわけ。  

### 公開鍵認証

- 公開鍵暗号方式は非対称暗号方式とも呼ばれる。  
- 暗号化と復号の鍵が異なる方式。  
- 秘密鍵を乱数で生成し、秘密鍵から大きな2つの素数の積や離散対数により公開鍵を生成する。  
- 秘密鍵と公開鍵は1対1対応。  
- 秘密鍵から公開鍵が計算されるが、その逆の演算は実質不可能(宇宙が出来上がるまでの時間を書ければ出来なくはないが、計算時間に対して割に合わな過ぎる。)  
- データ送信側は受信側から事前に取得してある公開鍵でデータを暗号化して受信側に送り、受信側は自分の秘密鍵でデータを復号する。  
- 公開鍵認証では、被認証側が自分の秘密鍵で認証データを作成して認証側に送り、認証側では被認証側の公開鍵で認証データを検証する。  

### ssh-keygenコマンド

公開鍵と秘密鍵の鍵ペアを作成するコマンド  

``` txt
ssh-keygen [オプション]

-t キータイプ : 
-p : 
-f ファイル名 :
-R ホスト名 : 
-b ビット長 :

キータイプ
rsa1 : 
rsa : デフォ
dsa :
ecdsa : 
ed25519 : 
```

DSAで鍵ペアを作成
`ssh-keygen -t dsa`

パスフレーズ  
秘密鍵を利用する際の認証用文字列。  
秘密鍵を暗号化してファイルに格納するために秘密鍵の作成時に設定する文字列。  
秘密鍵をファイルから取り出すときに同じパスフレーズを入力して復号する。  

### ~/.ssh/内のファイル

#### authorized_keys  

接続を許可する公開鍵を登録しておくサーバー側のファイル。  
①接続先リモートホストのホームディレクトリ内に「.ssh」ディレクトリを作成。  
②その中にauthorized_keysファイルを作成して、そこに公開鍵をコピーして登録する。  

#### config

SSH接続情報を格納したファイル。  
sshコマンドを使うとき、ここに記述した設定が反映されるので、毎回面倒な接続情報書かなくて済むようになったりする。  
接続時に使うので、クライアント側に配置するファイルだと思われる。  

<https://blog-and-destroy.com/20409>  
<https://qiita.com/0084ken/items/2e4e9ae44ec5e01328f1>  
SSH系の記事が豊富過ぎてまとめるのが大変だ。  

主な設定項目

- Host  
  sshコマンド等で指定するホスト名  
  使い方はしたでまとめている。  
- HostName  
  実際の接続ホストのアドレス。IPアドレスや/etc/hostsに指定したホスト名等を指定する。  
  これがあることでホスト名を省略できる。  
- User  
  ユーザー名  
  これがあることでユーザー名を省略できる。  
- Port  
  ポート番号  
  これがあることで `-p ポート番号` って書かなくてよくなる。  
- IdentityFile  
  秘密鍵ファイル  
  これがあることで `-i 秘密鍵ファイルのパス` って書かなくてよくなる。  

``` txt
Host 接続コマンド名（任意の名前）
    HostName ホスト名
    User ユーザー名
    IdentityFile ~/.ssh/秘密鍵のファイル名
    Port ポート番号

ssh 接続コマンド名
を利用した接続が可能になる。  
```

#### id_rsa

ssh-keygenで生成した秘密鍵。  

#### id_rsa.pub

ssh-keygenで生成した公開鍵。  

#### known_hosts

過去に接続したことがあるサーバーの情報。  
クライアント側に保存される。  
内容は**ホスト名、IPアドレス、公開鍵**  

### scpコマンド

SSHの仕組みを使い、ホスト間で安全にファイルをコピーするコマンド  

``` txt
scp 
```

### ssh-agent

### ポート転送

---

## GnuPGによる暗号化

### GnuPG(GNU Privacy Guard)

公開鍵暗号方式を使って、ファイルの暗号化や復号をしたり、電子署名をしたりすることができるオープンソースソフトウェア。  

### gpgコマンド

共通鍵を使ったファイルの暗号化

gpg -c ファイル名

secret.txtファイルを暗号化
`gpg -c secret.txt`

公開鍵を使ったファイルの暗号化

``` txt
gpg -c ファイル名
```

公開鍵のエクスポート

``` txt
gpg -o 出力ファイル名 -a --export 自分のメールアドレス
```

公開鍵のインポート

``` txt
gpg --import pubkey
```

ファイルの暗号化

```txt
gpg -e -a -r 送り先のメールアドレス 暗号化するファイル名
```

ファイルの復号

```txt
gpg important.txt.asc
```

ファイルの署名

```txt
pgp -o sample.sig --sign gpg.log
```

---

## 小豆本問題

---

### 1 ○

TCP Wrapperを使ってアクセス制御している。  
/etc/hosts.allow「sshd : 192.168.2.」  
/etc/hosts.deny「ALL:ALL」  
このことの説明。  

→  
B : 192.168.2.5のホストからSSH接続ができる。  

ホワイトリスト→ブラックリスト  
ホワイトリストに当てはまったら即OK。  
ホワイトリストに無かったらブラックリストを見る。  
ブラックリストにあったら即OUT。  

---

### 2 ×

/etc/nologinファイルを作成するとどうなるか？  

→  
C : /etc/nologinファイルに記述されたユーザーはログインできなくなる。  

A : 全てのユーザーはログイン出来なくなる。  
まじか。覚え間違えだったかな。  
ファイルを作って、その中でユーザーを指定するものだと思っていたのだが、勘違いだったようだ。  

空のファイルで良いが、メッセージを記述すると、ログインしたときのそのメッセージが表示されるらしい。  
なるほどね。  

---

### 3 ○

パスワードの有効期限を表示、設定するコマンドは？

→  
change  

---

### 4 ○

SSHを使って、ホストa.example.netに、ユーザーstudentとしてログインしたい。  
実行するコマンドは？  

→  
`ssh student@a.example.net`  
Eかな。  

正解。  
`ssh ログインユーザー名@ホスト名`  
ユーザー名を省略した場合、ローカルホストでSSHを実行したユーザーのユーザー名が指定されたことになる。  

---

### 5 ×

SSHを使ってリモートホストへ公開鍵認証でログインできるよう設定中。  
①接続先リモートホストのホームディレクトリ内に「.ssh」ディレクトリを作成。  
②その中に___ファイルを作成。そこに公開鍵をコピーして登録した。  
ファイル名は？  

→  
`~/.ssh/authorized_keys`  
なのでファイル名は`authorized_keys`  
登録元は？  

---

### 6 ○

GPGを使って暗号化されたファイルsecret.ascが送られてきた。  
送付元の公開鍵はすでに登録済み。  
復号のコマンドは？  

→  
`gpg secret.asc`  
ということでA  

当たった。  
