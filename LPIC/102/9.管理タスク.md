# 9.管理タスク

- ユーザー/グループの作成、変更、削除  
- ホームディレクトリのひな形の作成  
- cronとsystemdのタイマーUnitを使った定期的なジョブスケジューリング  
- atを使ったジョブの予約と確認、削除  
- cronとatの利用制限  
- ロケールの設定と確認  
- 文字コードの変換  
- タイムゾーンの設定  

---

## ユーザーとグループの管理

### 101の復習

### useraddコマンド

ユーザーアカウントを作成するコマンド  

``` txt
useradd [オプション] ユーザー名

オプション
-c コメント :: コメントフィールドを指定する。
-d パス :: ホームディレクトリを指定する。
-g グループ名 / GID :: プライマリグループを指定する。
-G グループ名 / GID :: プライマリグループ以外に所属するグループを指定する。
-s パス :: デフォルトシェルを指定する。
-D :: デフォルトの設定値を表示もしくは設定する。
-m :: ホームディレクトリを自動的に作成する。
```

コメント、ホームディレクトリ、デフォルトシェルを指定して、新規ユーザーlinuxuserを作成する。  
`useradd -c "Linux User" -d /home/linux -s /bin/bash linuxuser`

### /etc/skelディレクトリ

ホームディレクトリのデフォルトファイルを置くディレクトリ  
ユーザーアカウントを作成したときに、自動的にコピーされるひな形を置いておくディレクトリ  
基本的な設定ファイルなど、どのユーザーにも必要と思われるファイルも同時に配布できると便利。  
ホームディレクトリ作成時に配布したいファイルはひな形として/etc/skelディレクトリに置いておく。  

### usermodコマンド

既存のユーザーアカウントを変更するコマンド。  
/etc/passwdファイルの概要フィールドを書き換えた場合と同じ。  

``` txt
usermod [オプション] ユーザー名

オプション
-c コメント :: コメントフィールドを変更する。
-d パス :: ホームディレクトリを変更する。
-g グループ名 / GID :: プライマリグループを変更する。
-G グループ名 / GID :: 所属するグループを変更する。プライマリグループは変更しない。
-s パス :: デフォルトシェルを変更する。
-L :: パスワードをロックして一時的に無効化する。
-U :: パスワードのロックを解除する。
```

ユーザーlpicがプライマリグループ以外に所属するグループをbprojectに変更する。  
`usermod -G bproject lpic`  

ユーザーlpicのアカウントを無効にする。  
`usermod -L lpic`  

### userdelコマンド

ユーザーアカウントを削除するコマンド。  

``` txt
userdel [オプション] ユーザー名

オプション
-r :: ホームディレクトリも同時に削除する。
```

ユーザーlpicjpをホームディレクトリごと削除する。  
`userdel -r lpicjp`  

### passwdコマンド

パスワードを変更するコマンド。  
スーパーユーザー以外は自分のパスワードだけを変更できる。  

``` txt
1. passwd
2. passwd [オプション] [ユーザー名]

オプション
-l :: パスワードをロックして一時的に無効化する。
-u :: パスワードのロックを解除する。
```

passwdを単独で実行すると自分自身のパスワードを変更できる。  
現在のパスワードを入力したのち、新しいパスワードを確認のため2回入力する。  

### groupaddコマンド

グループを作成するコマンド。  
グループを指定してユーザーを作成するときは、あらかじめグループを作成しておく必要がある。  

``` txt
groupadd グループ名
```

salesグループを作成する。  
`groupadd salse`  

### groupmodコマンド

既存のグループを変更する。  

``` txt
groupmod [オプション] グループ名

オプション
-g GID :: GIDを変更する。
-n グループ名 :: グループ名を変更する。
```

develグループの名称をdevelopに変更する。  
`groupmod -n develop devel`  

groupmod 変更前 -n 変更後 という構造ではないことに注意。  

### groupdelコマンド

グループを削除するコマンド。  
削除対象グループをプライマリグループとするユーザーがいる場合は削除出来ない。  

``` txt
groupdel グループ名
```

salesグループを削除する。  
`groupdel salse`  

### idコマンド

ユーザーが所属しているグループを調べるコマンド。  

``` txt
id [ユーザー名]
```

### getentコマンド

ローカルホストやLDAPサーバーなどにあるユーザー情報、グループ情報などを一括して出力することができる。  

``` txt
getent 対象

対象
ユーザー情報→passwd
グループ情報→group
をそれぞれ指定する。
```

### シャドウパスワード

暗号化されたパスワードは **/etc/shadowファイル** に記録されている。  
rootユーザーしか読み取り出来ない。  
/etc/passwdファイルの読み取りを禁止した場合、様々な不都合が生じるため、このような構造になっている。  

---

## ジョブスケジューリング

### cron

スケジュールを定義したコマンドを定期的に実行するプログラム。  
DAEMONとも呼ばれる。  

定期的にジョブを実行するcronはスケジュールを管理するデーモンである**crond**と、スケジューリングを編集する**crontabコマンド**から構成される。  
crondデーモンは1分ごとにcrontabファイルを調べて実行すべきスケジュールが存在すればそのジョブを実行する。  

### crontabコマンド

コマンドの定時実行のスケジュール管理を行うために用いられるコマンド。  
標準入力からコマンド列を読み取り、crontabと呼ばれるファイルにそれを記録する。  
crontabファイルは直接編集してはいけない。  
crontabコマンドを使用して編集する。  
起動されるエディタは環境変数EDITORに設定されているエディタ。  

``` txt
crontab [オプション]

オプション
-e :: エディタを使ってcrontabファイルを編集する
-l :: crontabファイルの内容を表示する
-r :: crontabファイルを削除する
-i :: crontabファイル削除時に確認する
-u ユーザー名 :: ユーザーを指定してcrontabファイルを編集する。(rootユーザーのみ可)
```

ユーザーのcrontabファイルは`var/spool/cronディレクトリ`以下に置かれる。  

studentユーザーの場合  
`/var/spool/cron/student` or `var/spool/cron/crontabs/student`  

### crontabファイルの構成とフィールド

```txt
書式 :: 分 時 日 月 曜日 コマンド

分 :: 0~59までの整数
時 :: 0~23までの整数
日 :: 1~31までの整数
月 :: 1~12までの整数、もしくはjan~decまでの文字列
曜日 :: 0~7までの整数( 1=月、2=火、3=水、4=木、5=金、6=土、7と0 =日) もしくはSun,Monなどの文字列
コマンド :: 実行すべきコマンド

「#」がある行はコメント
「*」はすべての値にマッチする
複数の値を指定する場合は「,」で区切る。
2分事や2時間毎などの間隔の指定は「*/2」のように記述する。
```

毎日23:15に`usr/local/bin/backup`プログラムを実行する。  

``` txt
# Daily Backup
15 23 * * * /usr/local/bin/backup
```

毎週月曜日の9時と12時に`/usr/local/bin/syscheck`プログラムを実行する。  

```txt
#weekly System Check
0 9,12 * * 1 /usr/local/bin/syscheck
```

2時間ごとに`/usr/local/bin/syscheck`プログラムを実行する。  
`0 */2 * * * /usr/local/bin/syscheck`  

### systemのcrontab

システム用のcrontabファイル(`/etc/crontab`)では、そこから`/etc/cron.*`ディレクトリに置かれたファイルを呼び出すようになっており、  
`/etc/crontab`ファイルには実行するユーザー名を指定するフィールドが加わる。  

書式 :: 分 時 日 月 曜日 ユーザー コマンド  

cronで定期的に実行するジョブを格納するディレクトリ  
/etc/cron.hourly/ :: 毎時定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.daily/ :: 毎日定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.monthly/ :: 毎月定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.weekly/ :: 毎週定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.d/ :: 上記以外のジョブのスクリプトを格納したディレクトリ  

/etc/crontab :: システムのcrontabファイル  
/var/spool/cron/ or /var/spool/cron/crontabs/ :: ユーザーのcrontabファイルを収めたディレクトリ  

### atコマンド

1回限りの実行スケジュールを扱うコマンド。  
atコマンドによるスケジューリングを実施するには、atデーモン(atd)が動作している必要がある。  
atコマンドは対話式でコマンドを指定する。  
日時を指定すると入力モードになる。  
Ctrl + Dでコマンドの入力を終了する。  
あらかじめテキストファイルにコマンドを記述して起き、そのファイルを指定する方法もある。  

``` txt
1. at オプション
2. at [-f ファイル名] 日時

オプション
-dジョブ / -rジョブ :: 予約中のジョブをジョブ番号で指定して削除する(atrmコマンドと同じ)
-l :: 予約中のジョブを表示する(atqコマンドと同じ)
-f :: コマンドを記述したファイルを指定する。
```

明日の6:00に/usr/local/bin/backup.shプログラムを実行  

``` txt
at 6:00 tomorrow
at> /usr/local/bin/backup.sh
at> ^D
```

testjobファイルにあらかじめコマンドを定義した例  

``` txt
at -f testjob 15:00
```

書式例  
午後10時 :: 22:00 or 10pm  
正午 :: noon  
真夜中 :: midnight  
16:00 :: teatime  
今日 :: today  
明日 :: tomorrow  
3日後 :: now + 3 days  
2週間後の22:00 :: 10ps + 2 weeks  

### cronコマンドのアクセス制御

`/etc/cron.allow` :: cronの利用を許可するユーザーを記述する。  
`/etc/cron.deny` :: cronの利用を拒否するユーザーを記述する。  

① /etc/cron.allowファイルがあれば、そこに記述されたユーザーのみがcronを利用できる。/etc/cron.denyファイルは無視される。  
② /etc/cron.allowファイルが無ければ、/etc/cron.denyを参照し、/etc/cron.denyに記述されていないすべてのユーザーがcronを利用できる。  
③ /etc/cron.allowファイル、/etc/cron.denyファイルのどちらもない場合、すべてのユーザーがcronを利用可能。  
※最新バージョンでは、rootユーザーのみが利用可能。  

初期状態では利用制限が行われていないため、すべてのユーザーが実行することができる。  

### atコマンドのアクセス制御

`/etc/at.allow` :: atの利用を許可するユーザーを記述する。  
`/etc/at.deny` :: atの利用を拒否するユーザーを記述する。  

① /etc/at.allowがあれば、そこに記述されたユーザーのみがatを利用できる。/etc/at.denyファイルは無視される。  
② /etc/at.allowが無ければ、/etc/at.denyを参照し、/etc/at.denyに記述されていないすべてのユーザーがatを利用できる。  
③ どちらのファイルも無ければ、rootユーザーだけがatを利用できる。  

初期状態では利用制限が行われていないため、すべてのユーザーが実行することができる。  
デフォルトで空の/etc/at.denyファイルがあり、すべてのユーザーがatコマンドを利用できるようになっている。  

設定例 : 「mike」と「ken」に対してatを利用可能にする設定  

``` bash
#vi /etc/at.allow
mike
ken
```

### で、結局違いは何なの？

どちらのファイルもなかった場合の挙動 :: cronはすべてOK。atはrootだけ。  
atは最初から/etc/at.denyファイルがある。  

### systemdによるスケジューリング

systemdの**タイマーUnit**を使うと、cronの代わりにスケジューリングを設定できる。という話。  

モノトニックタイマー :: 「システム起動後10分後」のようなイベントから一定時間経過した後に発動し、以後定期的に実施される。  
リアルタイムタイマー :: crontabと同様にカレンダーで指定して定期的に実施される。  

システム起動後10分後にlpic.serviceサービスを実行し、以後1週間毎に実施されるタイマー  

### systemd-runコマンド

systemdに置けるスケジューリングを設定するコマンド。  
タイマーUnitによる設定より簡単らしい。  

---

## ローカライゼーションと国際化

### ローカライゼーション(localization)

言語や通過単位、日付の書式等を地域や国に合わせる事  

### 国際化(internationalization : i18n)

ローカライゼーションを国ごとに行うのは大変なので、多くのソフトウェアでは最初から多言語・他地域に対応するように作られている。  

### ロケール

利用者の地域情報  

ロケールの主なカテゴリ  
LC_CTYPE ::  文字の種類やその比較・分類の規定  
LC_COLLATE :: 文字の照合や整列に関する規定  
LC_MESSAGES :: メッセージ表示に使用する言語  
LC_MONETARY :: 通貨に関する規定  
LC_NUMERIC :: 数値の書式に関する規定  
LC_TIME :: 日付や時刻の書式に関する規定  
LC_ALL :: ロケールの環境変数すべて  

環境変数LC_ALLが設定されていれば、全てのカテゴリで必ずその値が使われる。  
環境変数LANGが設定されていれば、全てのカテゴリで必ずその値が使われるが、個々のカテゴリ毎に個別の設定が可能。  

### localeコマンド

現在のロケールの設定を確認するコマンド  

``` txt
構文 :: locale [オプション] ユーザー名

オプション
-a :: 設定できるロケールを全て表示
-m :: 利用できる文字コードを全て表示
```

ロケール名の言語名_国家もしくは地域名.文字コード  

主なロケール名  
C,POSIX :: 英語  
ja_JP.utf8 :: 日本語/Unicode  
ja_JP.eucJP :: 日本語/EUC-JP  
ja_JP.ShiftJIS :: 日本語/シフトJIS
en_US.utf8 :: 英語(米)/Unicode

ロケールの環境変数の全てをja_JP.utf8にする例  
`export LC_ALL=ja_JP.utf8`  

### 文字コード

ASCII :: 7ビットで表される基本的な128種類の文字(英数字+α)  
ISO-8859 :: ASCIIを拡張した8ビットの文字コードで256種類の文字  
UTF-8 :: Unicodeを使った文字コードで、1文字を1バイトから6バイトで表す  
日本語EUC(EUC-JP) :: UNIX環境で標準的に利用されていた日本語の文字コード  
ShiftJIS :: Windowsで利用される日本語の文字コード  
ISO-2022-JP :: 電子メールなどで利用される日本語の文字コード(JISコード)  

### iconvコマンド

文字コードを変換するコマンド  

``` txt
iconv [オプション] [入力ファイル名]

オプション
-f 入力文字コード :: 返還前の文字コードを指定する
-t 出力文字コード :: 変換して出力したい文字コードを指定する 
-l :: 扱える文字コードを表示する  
```

日本語EUC(EUC-JP)で作成されたファイルreport.euc.txtをUTF-8に変換してreport.utf8.txtとして保存する例。  
`iconv -f eucjp -t utf8 report.euc.txt > report./.utf8.txt`  

### タイムゾーン

地域ごとに区分された標準時間帯をタイムゾーンと言う。  

### /usr/share/zeneinfo と /etc/localtime

タイムゾーンの情報は `/usr/share/zeneinfo`ディレクトリ配下のバイナリファイルに格納されている。  
上記ファイルを `/etc/localtime`にコピーするかシンボリックリンクを作成する事でシステムに反映させることができる。  

タイムゾーンを日本に設定するコマンド  
`cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime`  

シンボリックリンクの場合  
`ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime`  

### 環境変数TZ

環境変数`TZ`で設定もできる。  
`export TZ="Asia/Tokyo"`  

環境変数TZを全ユーザーで利用するなら、`/etc/timezone`ファイルに「Asia/Tokyo」と設定する。  

### tzselectコマンド

一覧から表示される情報をもとにタイムゾーンを設定できるコマンド  
対話式でオプション等はなさそう。  

### tzconfigコマンド

このコマンドでもタイムゾーンを設定できる。  
`/etc/localtime`と`/etc/timezone`の値をまとめて変更する。  

最近のディストリビューションでは利用できない。  
利用したいなら`dpkg-reconfigure tzdata`をたたく。  

---

## 小豆本問題

---

### 1

---

### 2

---

### 3

---

### 4

---

### 5

---

### 6

---

### 7

---

### 8

---

### 9
