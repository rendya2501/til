# 9.管理タスク

``` txt : ユーザーとグループの管理
・/etc/passwd :: ユーザーアカウント情報(※ユーザーのプライマリグループの指定も)が格納されているファイル。パーミッションは「644(-rw-r--r--)」。
・/etc/shadow :: 暗号化されているパスワードや、パスワードの有効期限に関する情報が格納されているファイル。  
                 パーミッション「400(r--------)」、「600(rw-------)」、「000(---------)」など、rootユーザのみが読み書き可能。
                 ユーザーパスワードの最終更新日が記録されるのもこのファイル。
・/etc/skel/  :: 新規ユーザー作成時にコピーする雛形（スケルトン）ファイルを配置するディレクトリ。
・/etc/group  :: グループに関する情報が格納されているファイル。グループのメンバーリストには所属メンバーが記載されていない場合がある。
・/etc/gshadow :: shadowファイルのグループver。暗号化されたグループパスワード等が格納されるファイル。
・/etc/default/useradd :: useraddコマンドでオプションを指定せずにユーザを追加した時のデフォルトの値が記述されたファイル。[useradd -D]で確認できる。
・passwd   :: ユーザーのパスワードを変更するコマンド。
・chage    :: パスワードの有効期限の設定に特化したコマンド
・useradd  :: ユーザーアカウントを新規作成するコマンド。
              [ユーザアカウントを新規作成する際に暗号化されたパスワードを設定 :: -p]
              ※Debian系では、「-m」オプション（ホームディレクトリを作成する）を使用しないとホームディレクトリは作成されない。
・userdel  :: ユーザーアカウントを削除するコマンド。
・usermod  :: 既存のユーザーアカウントを変更するコマンド。[-n :: グループ名の変更]
・groupadd :: グループアカウントを新規作成するコマンド。
・groupdel :: グループアカウントを削除するコマンド。
・groupmod :: 既存のグループアカウントの設定を変更
・id       :: ユーザーのUIDやGIDを表示するコマンド。
・groups   :: ユーザーの所属するグループを表示するコマンド。
・gpasswd  :: 「/etc/group」を管理するコマンド。グループのパスワードやメンバーを設定するできる。
・getent   :: 指定したデータベースからユーザーやグループの情報一覧を表示するコマンド。
              ユーザー名やホームディレクトリなどのユーザー情報の一覧を表示する [getent passwd]

※対話的ログインを禁止
ログインシェルを「/bin/false」 or 「/sbin/nologin」に設定。
「chsh -s /sbin/nologin hoge2」 or 「usermod -s /bin/false hoge2」

※アカウントを使用させないようにする
「/etc/passwd」パスワードフィールドの1文字目に「!」または「*」を追加する
「/etc/shadow」パスワードフィールドの1文字目に「!」または「*」を追加する
「passwd -l user3」
「usermod -L user3」

※あるユーザが3つのグループ（A,B,C)に属しているが、Bグループからそのユーザを削除したい。ただしBグループはユーザのプライマリグループではないものとする。
usermod -Gを使う
```

``` txt : ジョブスケジューリング
・cron  :: スケジュールを定義したコマンドを定期的に実行するプログラム。  
・crond :: 定期的に実行するジョブのスケジュールを管理するデーモン。1分ごとに起動され、crontabファイルなどを調べて設定されたジョブを実行する。
・/usr/sbin/crond :: RedHat系crondデーモン  
・/usr/sbin/cron  :: Debian系crondデーモン  
・crontabコマンド :: ユーザ用のcronの設定を行うコマンド。コマンドの定時実行のスケジュール管理コマンド。  
・crontab書式     :: [分] [時] [日] [月] [曜日] [実行ユーザー名(システム用設定ファイルでのみ指定)] [コマンド]
                     [* :: 全てに一致] , [- :: 範囲指定] , [, :: 複数の値を指定] , [/  :: 間隔の指定]
                     1つの設定を識別するのに必要なもの→「改行」
・/var/spool/cron/ユーザ名  :: ユーザ用のcrontabファイル。エディタで編集不可(cat不可)。crontabからのみ可能。
・/var/spool/cron/crontabs/ :: ユーザ用のcrontabファイルが置かれるディレクトリ。  
・/etc/crontab       :: システムに定期的に実行させたいジョブを設定するファイル。主に以下4つのディレクトリに置かれたスクリプトを実行する。
                        エディタで編集可能。実行ユーザー必要。
・/etc/cron.hourly/  :: 毎時定期的に実行するジョブのスクリプトを格納したディレクトリ。  
・/etc/cron.daily/   :: 毎日定期的に実行するジョブのスクリプトを格納したディレクトリ。  
・/etc/cron.monthly/ :: 毎月定期的に実行するジョブのスクリプトを格納したディレクトリ。  
・/etc/cron.weekly/  :: 毎週定期的に実行するジョブのスクリプトを格納したディレクトリ。  
・/etc/cron.d/       :: サービス個別のジョブ実行を定義した設定ファイルを置くディレクトリ。  

※「hogescript」スクリプトを土曜日と日曜日に2時間ごとに実行したい。
0 */2 * * 6,7 hogescript

・at    :: 1回限りの実行スケジュールを扱うコマンド。※日時は基本的にHH:MMの形式で指定
・batch :: システムの負荷の少ないタイミングで指定した時間に1回だけコマンドを自動実行します。  
・atd   :: atデーモン。atコマンドによるスケジューリングを実施するデーモン。
・atrm  :: atのジョブを削除するコマンド。[at -d]と同じ。  
・atq   :: atのジョブのスケジュールを一覧で表示するコマンド。[at -l]と同じ。  

・/etc/cron.allow :: cronの利用を許可するユーザーを記述する。  
・/etc/cron.deny  :: cronの利用を拒否するユーザーを記述する。  
① /etc/cron.allowファイルがあれば、そこに記述されたユーザーのみがcronを利用できる。/etc/cron.denyファイルは無視される。  
② /etc/cron.allowファイルが無ければ、/etc/cron.denyを参照し、/etc/cron.denyに記述されていないすべてのユーザーがcronを利用できる。  
③ /etc/cron.allowファイル、/etc/cron.denyファイルのどちらもない場合、rootユーザーのみが利用可能。  
・/etc/at.allow :: atの利用を許可するユーザーを記述する。  
・/etc/at.deny  :: atの利用を拒否するユーザーを記述する。  
① /etc/at.allowがあれば、そこに記述されたユーザーのみがatを利用できる。/etc/at.denyファイルは無視される。  
② /etc/at.allowが無ければ、/etc/at.denyを参照し、/etc/at.denyに記述されていないすべてのユーザーがatを利用できる。  
③ どちらのファイルも無ければ、rootユーザーだけがatを利用できる。  

・timerユニット :: systemdにおいて、cronのようにジョブスケジューラとして使用できるユニット。
※「/etc/systemd/system」に拡張子.timerの定義ファイルを作成し、[Timer]セクションに実行タイミングと実行するジョブを指定する。  
・モノトニックタイマー  :: cronのように、起動後はジョブを定期的に実行する。  
・リアルタイムタイマー  :: atのように、指定した実行日時にジョブを1度だけ実行する。  
・systemctl list-timers :: systemdにおいて、全ての有効なtimerユニットを表示するコマンド。  
・systemd-runコマンド   :: systemdで、一時的なユニットを作成してジョブを実行するコマンド。
```

``` txt : ローカライゼーションと国際化
・locale :: 現在のロケールの設定を確認するコマンド。「-a」オプションを使用すると現在のシステムで使用できるロケールが表示される。
・/etc/locale.conf :: systemdが動作するシステムでのシステム全体のロケール設定ファイル
・LC_CTYPE     :: 文字の種類やその比較・分類の規定  
・LC_NUMERIC   :: 数値の書式に関する規定  
・LC_TIME      :: 日付や時刻の書式に関する規定  
・LC_MESSAGES  :: メッセージ表示に使用する言語  
・LC_MONETARY  :: 通貨に関する規定  
・LC_NAME      :: 名前の書式
・LC_ADDRESS   :: アドレス、ロケーションの書式
・LC_TELEPHONE :: 電話番号の書式
・LC_COLLATE   :: 文字の照合や整列に関する規定  
・LC_ALL       :: ロケールの環境変数すべて  
                  指定した値が全てのカテゴリを上書きし、カテゴリごとの設定が出来ない。
・LANG         :: 全てのカテゴリで必ずその値が使われるが、個々のカテゴリ毎に個別の設定が可能。
※LC_ALLが設定されていない場合、指定した値がデフォルトとして使用される。
※LC_ALLは全てのカテゴリを上書きするので「/etc/locale.conf」に設定することは推奨されません。
※「LANG=C」を設定すると、ロケールが異なる環境でも英語で共通の出力が得られる
※LC_ALLはlocale.confに記述しない
※環境変数LANGの指定をコマンドの前に置くと、そのコマンドのみ指定された環境で実行される。
例) LANG=ja_JP.eucJP myapp

・iconv :: 文字コードを変換するコマンド  
・ASCII       :: 7ビットで表される基本的な128種類の文字(英数字+α)  
・ISO-8859    :: ASCIIを拡張した8ビットの文字コードで256種類の文字を表現する文字コード  
・UTF-8       :: Unicodeを使った文字コードで、1文字を1バイトから6バイトで表す。Linux標準。
・EUC-JP      :: 日本語EUC。UNIX環境で標準的に利用されていた日本語の文字コード  
・ShiftJIS    :: Windowsで利用される日本語の文字コード  
・ISO-2022-JP :: 電子メールなどで利用される日本語の文字コード(JISコード)  
・Unicode     :: 多言語を扱うために作成された符号化文字集合。符号化方式には、UTF-8,UTF-16,UTF-32等がある。

・UTC(Coordinated Universal Time) :: 協定世界時。各地の時間を決める際の基準となるもの。
・JST(Japan Standard Time)        :: 日本標準時。UTCより9時間進んでいます。
・/etc/localtime :: システムクロックの時刻からローカルタイムへ変換するための時差情報が格納されている。  
・/etc/timezone  :: システムで使用するタイムゾーンを指定するテキストファイル。  
・/usr/share/zoneinfo/ :: タイムゾーンの情報がバイナリファイルとして格納されているディレクトリ。
                          システムで使用したいファイルを「/etc/localtime」へコピーまたはシンボリックリンクを作成することで反映される。
・環境変数TZ :: タイムゾーンの設定に使用される環境変数。
・tzselect :: 一覧から表示される情報をもとにタイムゾーンを設定できるコマンド。  
              環境変数「TZ」や「/etc/timezone」ファイルで指定するタイムゾーンの値を確認できる。
・tzconfig :: タイムゾーンを設定できるコマンド。「/etc/localtime」と「/etc/timezone」の値をまとめて変更する。  

※エポック(epoch)時間 :: UTC 1970年1月1日午前0時0分0秒からの経過秒数。
※タイムゾーンの設定はエポック時間からローカルの時間に変換するときに参照される。
```

---

## ユーザーとグループの管理

### /etc/passwd

ユーザーアカウント情報が格納されているファイル。  
パーミッションは`644(-rw-r--r--)`  
普通のファイルで、基本的に実行権はない。  

現在のシステムでは暗号化されたパスワード（シャドウパスワード）が使用されており、パスワード欄には「x」が入ります。  
この場合、パスワードは「/etc/shadow」ファイルに格納されます。  
「/etc/shadow」ファイルはrootユーザのみしか読み書きができません。  
なお、「/etc/passwd」ファイルのパーミッションは「644」で一般ユーザによる読み出し権限が付与されています。  
シャドウパスワードを利用することでセキュリティレベルが上がります。  

/etc/shadowファイルを使っているか否かに関わらず、/etc/passwdの第2フィールドに`*`あるいは`!`を指定すると、  
PAMの認証モジュールpam_unix.50は/etc/shadowの参照や暗号化パスワードとしての処理をせず、その時点でログインを拒否する。  
ログイン時に表示されるメッセージはパスワードを間違えた時と同じになる。  

``` txt : ファイルの書式と各項目の説明
ユーザ名：パスワード：UID：GID：コメント：ホームディレクトリ：ログインシェル

・ユーザ名           :: 一意のユーザ名
・パスワード         :: ユーザのパスワード。
・UID                :: ユーザのUID（ユーザID）。UIDはユーザを識別するための一意のID
・GID                :: ユーザのプライマリグループのGID（グループID）。GIDはグループを識別するための一意のID
・コメント           :: ユーザに関する任意のコメント（省略可）
・ホームディレクトリ :: ユーザのホームディレクトリ
・ログインシェル     :: ユーザのログインシェル（ログイン時に使用されるデフォルトのシェル）
```

### /etc/shadow

暗号化されているパスワード（シャドウパスワード）や、パスワードの有効期限に関する情報が格納されているファイル。  
パスワードにロックをかけると「/etc/shadow」の該当ユーザのパスワードフィールドの1文字目に「!」が追加されます。  

「/etc/shadow」ファイルのパーミッションには「400（r--------）」、「600（rw-------）」、「000（---------）」などがあり、  
ディストリビューションやバージョンによって異なります。いずれの場合もrootユーザのみが読み書き可能な設定です。  

「日数1」の部分で最終更新日が分かります。
よってユーザーパスワードの最終更新日が記録されているファイルは/etc/shadow  

``` txt : 書式と各項目の説明
ユーザ名：パスワード：日数1：日数2：日数3：日数4：日数5：日数6：フラグ

・ユーザ名   :: 一意のユーザ名（/etc/passwdと同様）
・パスワード :: 暗号化されたパスワード
・日数1      :: 1970/1/1から、パスワードが最後に更新された日までの日数
・日数2      :: パスワードが変更できるようになるまでの日数
・日数3      :: パスワードを変更しなければならなくなる日までの日数
・日数4      :: パスワードの有効期限切れる前に警告をだす日数
・日数5      :: パスワードの有効期限切れからアカウントが使用できなくなるまでの日数
・日数6      :: 1970/1/1から、アカウントが使用できなくなる日までの日数
・フラグ     :: 未使用
```

### 小話 パーミッション000

[パーミッション000](https://oshiete.goo.ne.jp/qa/6781290.html)  
>パーミッション000とは  
>・オーナー権限 読み込み不可・書き込み不可・実行不可  
>・グループ権限 読み込み不可・書き込み不可・実行不可  
>・他者権限 読み込み不可・書き込み不可・実行不可  
>ということです。  
>
>例えるならば、ハシゴを利用して屋根に上ったが、上ってきたハシゴを蹴り飛ばしてしまったような感じです。  
>自分ではどうすることも出来ず、別の人がハシゴをかけ直してくれるのを頼むしかありません。  

### /etc/nologin

一般ユーザのログインを禁止する際に使用するファイル。  

### /etc/group

グループに関する情報が格納されたファイル。  

現在のシステムでは暗号化されたパスワード（シャドウパスワード）が使用されており、パスワード欄には「x」が入ります。  
この場合、パスワードは「/etc/gshadow」ファイルに格納されます。  

「グループのメンバーリスト」には、補助グループ（supplementary groups）として所属しているユーザが設定されます。  
プライマリグループとして登録しているユーザは含まれません。  
したがって、所属メンバーがいても、記載されていない場合があります。  

``` txt : ファイルの書式と各項目の説明
グループ名:グループパスワード:GID:グループのメンバーリスト

・グループ名 :: 一意のグループ名
・グループパスワード :: グループのパスワード
・GID :: グループのGID
・グループのメンバーリスト :: グループに所属するメンバー。複数の場合は「,」で区切る
```

### useraddコマンド

ユーザーアカウントを作成するコマンド  

``` txt
useradd [オプション] ユーザー名

オプション
-c コメント :: コメントフィールドを指定する。
-d パス :: ホームディレクトリを指定する。
-g グループ名 / GID :: プライマリグループを指定する。
-G グループ名 / GID :: プライマリグループ以外に所属するグループを指定する。
-s パス :: デフォルトシェルを指定する。
-D :: デフォルトの設定値を表示もしくは設定する。
-m :: ホームディレクトリを自動的に作成する。
-p 暗号化済みのパスワード :: 暗号化済みのパスワードを設定する。
```

コメント、ホームディレクトリ、デフォルトシェルを指定して、新規ユーザーlinuxuserを作成する。  
`useradd -c "Linux User" -d /home/linux -s /bin/bash linuxuser`  

試験的に重要なオプションは-m。  

オプションを指定せずにユーザーを作成する際、使用されるデフォルトの値が格納されているファイル  
`/etc/default/useradd`  

ファイルの内容は`useradd -D`でも確認できる。  

### /etc/skelディレクトリ

ホームディレクトリのデフォルトファイルを置くディレクトリ  
ユーザーアカウントを作成したときに、自動的にコピーされるひな形を置いておくディレクトリ  
基本的な設定ファイルなど、どのユーザーにも必要と思われるファイルも同時に配布できると便利。  
ホームディレクトリ作成時に配布したいファイルはひな形として/etc/skelディレクトリに置いておく。  

### usermodコマンド

既存のユーザーアカウントを変更するコマンド。  
/etc/passwdファイルの概要フィールドを書き換えた場合と同じ。  

``` txt
usermod [オプション] ユーザー名

オプション
-c コメント             :: コメントフィールドを変更する。
-d パス                 :: ホームディレクトリを変更する。
-g グループ名 / GID     :: プライマリグループを変更する。
-G グループ名 / GID     :: 所属するグループを変更する。プライマリグループは変更しない。
-s パス                 :: デフォルトシェルを変更する。
-L                      :: パスワードをロックして一時的に無効化する。
-U                      :: パスワードのロックを解除する。
-e                      :: アカウントの失効日を設定する。changeコマンドと同じ。
-f                      :: パスワード失効までの猶予日数を設定する。
-p 暗号済みのパスワード :: 暗号化済みのパスワードに変更する。
```

ユーザーlpicがプライマリグループ以外に所属するグループをbprojectに変更する。  
`usermod -G bproject lpic`  

ユーザーlpicのアカウントを無効にする。  
`usermod -L lpic`  

manaのパスワードが有効期限を過ぎてから無効になるまでの期間を30日に設定する。  
`usermod -f 30 mana`  

ユーザtestuserのパスワードを暗号化済みの「xynhyrsnDvkYw」に変更する  
`usermod -p xynhyrsnDvkYw testuser`  

### userdelコマンド

ユーザーアカウントを削除するコマンド。  

``` txt
userdel [オプション] ユーザー名

オプション
-r :: ホームディレクトリも同時に削除する。
-f :: 強制削除(使用中であっても削除)
```

ユーザーlpicjpをホームディレクトリごと削除する。  
`userdel -r lpicjp`  

ユーザuser1を削除する際、ホームディレクトリも一緒に削除したい。この際、アカウントが使用中であっても削除する。  
`userdel -rf user1`  

### passwdコマンド

パスワードを変更するコマンド。  
スーパーユーザー以外は自分のパスワードだけを変更できる。  
passwdを単独で実行すると自分自身のパスワードを変更できる。  
現在のパスワードを入力したのち、新しいパスワードを確認のため2回入力する。  

``` txt
1. passwd
2. passwd [オプション] [ユーザー名]

オプション
-l :: パスワードをロックして一時的に無効化する。
-u :: パスワードのロックを解除する。
-x :: パスワードが変更なしで有効な最長日数を設定する。
-i :: パスワード失効までの猶予日数を設定する。
```

yukoのパスワードの有効期限を60日に設定する。  
`passwd -x 60 yuko`  

期限を過ぎてから無効になるまでにパスワードを変更できる期間を30日に設定する。  
`passwd -i 30 yuko`  

### groupaddコマンド

グループを作成するコマンド。  
グループを指定してユーザーを作成するときは、あらかじめグループを作成しておく必要がある。  

``` txt
groupadd グループ名
```

salesグループを作成する。  
`groupadd salse`  

### groupmodコマンド

既存のグループを変更する。  

``` txt
groupmod [オプション] グループ名

オプション
-g GID :: GIDを変更する。
-n グループ名 :: グループ名を変更する。
```

develグループの名称をdevelopに変更する。  
`groupmod -n develop devel`  
groupmod 変更前 -n 変更後 という構造ではないことに注意。  

既に存在するグループアカウント「ProjectA」のGID（グループID）を600へ変更。  
`groupmod -g 600 ProjectA`  

「TestA」ユーザが3つのグループ（A,B,C)に属しているが、Bグループからそのユーザを削除したい。  
`groupmod -G 'A,C' TestA`  
削除するグループを指定するのではなく、名前を書かない。  

### groupdelコマンド

グループを削除するコマンド。  
削除対象グループをプライマリグループとするユーザーがいる場合は削除出来ない。  

``` txt
groupdel グループ名
```

salesグループを削除する。  
`groupdel salse`  

### idコマンド

ユーザーに関する識別情報を表示するコマンド。  
(UID、ユーザー名、グループID、グループ名等)  
ユーザ名を省略すると、コマンドを実行したユーザの情報が表示されます。  
オプションを省略すると、UIDと所属する全てのグループのGIDを表示します。  

``` txt
id [オプション] [ユーザー名]

-u :: UID(ユーザID)を表示
-g :: ユーザーのプライマリグループのGIDを表示
-G :: 所属する全てのグループのGIDを表示
```

ユーザ「test」のプライマリグループのGIDを確認。  
`id -g test`  

### groupsコマンド

ユーザーが所属しているグループを表示するコマンド。  
UIDやGIDは確認出来ない。  

``` txt
groups [ユーザー名]

グループ名：グループのパスワード：グループID番号：所属するユーザー名のリスト
```

### getentコマンド

ローカルホストやLDAPサーバーなどにあるユーザー情報、グループ情報などを一括して出力することができる。  
ネームサービススイッチ(/etc/nsswitch.conf)の設定に従い、引数で指定したデータベースの内容を表示する。  

「/etc/nsswitch.conf」は、名前解決やサービス名解決の際の問い合わせ順序を指定するファイル。  
ユーザー情報、パスワード情報の取得、ホスト名からIPアドレスを取得する際の情報検索先など設定内容は多岐にわたる。  

getent は、それらの情報の問い合わせを行うコマンド。  

``` txt
getent 対象
getent データベース名 キー名

対象
ユーザー情報→passwd
グループ情報→group
をそれぞれ指定する。
```

getent passwd を実行した場合、システムの全ユーザーのアカウントが表示される。  
ユーザー名やホームディレクトリなどのユーザー情報の一覧  

### シャドウパスワード

暗号化されたパスワードは **/etc/shadowファイル** に記録されている。  
rootユーザーしか読み取り出来ない。  
/etc/passwdファイルの読み取りを禁止した場合、様々な不都合が生じるため、このような構造になっている。  

### gpasswdコマンド

`/etc/group`を管理するコマンド。  
グループのパスワードや所属するメンバーなどを設定できます。  

ユーザtestを補助グループsalesから削除する  
`gpasswd -d test sales`  

### 対話的なログインを禁止する方法

・ログインシェルに/bin/falseを設定する  
・ログインシェルに/sbin/nologinを設定する  

メールサーバやFTPサーバなどでは、ユーザアカウントは必要ですが、ユーザがシステムにログインしシェルを利用する必要が無い場合もあります。  
このような場合に対話的ログインを禁止します。  
対話的ログインを禁止するにはログインシェルを「/bin/false」または「/sbin/nologin」に設定します。  

ログインシェルは「usermod -s」や「useradd -s」（ユーザ作成時）コマンドで設定できます。  
また、シェル変更専用の`chsh`コマンドでも変更が可能です。  
オプションでシェルを指定する場合「chsh -s」を使用します。  
なお、ログインシェルに設定するシェルは「/etc/shells」ファイルに登録されている必要があります。  

chshはChangeShellと思われる。

### アカウントをロックする方法

「/etc/shadow」の該当ユーザのパスワードフィールドの1文字目に「!」または「*」を追加する  
「/etc/passwd」の該当ユーザのパスワードフィールドの1文字目に「!」または「*」を追加する  
「passwd -l user3」コマンドを実行する  
「usermod -L user3」コマンドを実行する  

passwdは小文字。  
usermodは大文字。  

因みに解除  
`usermod -U`  
`passwd -u`  

---

## ジョブスケジューリング

### cron

スケジュールを定義したコマンドを定期的に実行するプログラム。  
DAEMONとも呼ばれる。  

定期的にジョブを実行するcronはスケジュールを管理するデーモンである**crond**と、スケジューリングを編集する**crontabコマンド**から構成される。  
crondデーモンは1分ごとにcrontabファイルを調べて実行すべきスケジュールが存在すればそのジョブを実行する。  

crondデーモン  
RedHat系 :: /usr/sbin/crond  
Debian系 :: /usr/sbin/cron  

システム保守のためのコマンドの定期実行はcronから起動されるanacronによって行われる。  

### crontabコマンド

コマンドの定時実行のスケジュール管理を行うために用いられるコマンド。  
標準入力からコマンド列を読み取り、crontabと呼ばれるファイルにそれを記録する。  

crontabコマンドで設定するのは`var/spool/cron/ユーザー名ファイル`。  
ユーザーのcrontabファイルは`var/spool/cron/`ディレクトリ以下に置かれる。  

studentユーザーの場合  
`/var/spool/cron/student` or `var/spool/cron/crontabs/student`  

crontabファイルは直接編集してはいけない。  
crontabコマンドを使用して編集する。  
起動されるエディタは環境変数EDITORに設定されているエディタ。  

``` txt
crontab [オプション]

オプション
-e(edit)      :: エディタを使ってcrontabファイルを編集する
-l(list)      :: crontabファイルの内容を表示する
-r(remove)    :: crontabファイルを削除する
-i            :: crontabファイル削除時に確認する
-u ユーザー名 :: ユーザーを指定してcrontabファイルを編集する。(rootユーザーのみ可)
```

### crontabファイル

crontabファイルでは1行ごとに、自動的に実行するコマンドおよびその実行日時を指定します。
なので1つの設定の識別に必要なのは**改行**。  

```txt : 構成とフィールド
書式 :: [分] [時] [日] [月] [曜日] [実行ユーザー名(システム用設定ファイルでのみ指定)] [コマンド]

分 :: 0~59までの整数
時 :: 0~23までの整数
日 :: 1~31までの整数
月 :: 1~12までの整数、もしくはjan~decまでの文字列
曜日 :: 0~7までの整数( 1=月、2=火、3=水、4=木、5=金、6=土、7と0 =日) もしくはSun,Monなどの文字列
コマンド :: 実行すべきコマンド

「#」がある行はコメント。
「*」はすべての値にマッチする。
「-」範囲の指定。「時」に「1-3」と指定すると、1時から3時までを意味する。
複数の値を指定する場合は「,」で区切る。「時」に「1,2,3」と指定すると、1時,2時,3時を意味する。
間隔の指定。「時」に「1-7/2」と指定すると、1時から7時の間で2時間おきを意味する。
2分事や2時間毎などの間隔の指定は「*/2」のように記述する。
```

毎日23:15に`usr/local/bin/backup`プログラムを実行する。  

``` txt
# Daily Backup
15 23 * * * /usr/local/bin/backup
```

毎週月曜日の9時と12時に`/usr/local/bin/syscheck`プログラムを実行する。  

```txt
#weekly System Check
0 9,12 * * 1 /usr/local/bin/syscheck
```

2時間ごとに`/usr/local/bin/syscheck`プログラムを実行する。  
`0 */2 * * * /usr/local/bin/syscheck`  

### systemのcrontab

システム用のcrontabファイル(`/etc/crontab`)では、そこから`/etc/cron.*`ディレクトリに置かれたファイルを呼び出すようになっており、  
`/etc/crontab`ファイルには実行するユーザー名を指定するフィールドが加わる。  

・「/etc/crontab」はシステム用の設定ファイルである  
・「/etc/crontab」にはコマンドの実行ユーザも指定する  

変数はvi等のテキストエディタで行う。  
設定ファイルで指定したユーザーの権限で実行(主にrootユーザー)  

``` txt
書式 :: 分 時 日 月 曜日 ユーザー コマンド  

cronで定期的に実行するジョブを格納するディレクトリ  
/etc/cron.hourly/ :: 毎時定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.daily/ :: 毎日定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.monthly/ :: 毎月定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.weekly/ :: 毎週定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.d/ :: 上記以外のジョブのスクリプトを格納したディレクトリ  

/etc/crontab :: システムのcrontabファイル。主にhourly,daily,weekly,monthlyの4つのディレクトリに置かれたスクリプトを実行する。  
/var/spool/cron/ or /var/spool/cron/crontabs/ :: ユーザーのcrontabファイルを収めたディレクトリ  
```

### atコマンド

1回限りの実行スケジュールを扱うコマンド。  
atコマンドによるスケジューリングを実施するには、atデーモン(atd)が動作している必要がある。  

atコマンドは対話式でコマンドを指定する。  
日時を指定すると入力モードになる。  
Ctrl + Dでコマンドの入力を終了する。  
あらかじめテキストファイルにコマンドを記述して起き、そのファイルを指定する方法もある。  

``` txt
1. at オプション
2. at [-f ファイル名] [日時]
※日時は基本的にHH:MMの形式で指定

オプション
-rジョブ番号 :: 指定した予約中のジョブを削除する(atrmコマンドと同じ)
-dジョブ番号 :: -rと同じ
-l :: 予約中のジョブを表示する(atqコマンドと同じ)
-f :: コマンドを記述したファイルを指定する。
```

``` txt : 明日の6:00に/usr/local/bin/backup.shプログラムを実行
at 6:00 tomorrow
at> /usr/local/bin/backup.sh
at> ^D
```

``` txt : testjobファイルにあらかじめコマンドを定義した例  
at -f testjob 15:00
```

``` txt : 書式例  
午後10時 :: 22:00 or 10pm  
正午 :: noon  
真夜中 :: midnight  
16:00 :: teatime  
今日 :: today  
明日 :: tomorrow  
3日後 :: now + 3 days  
2週間後の22:00 :: 10ps + 2 weeks  
```

### atrmコマンド

atのジョブを削除するコマンド。  
at -dと同じ動作をする。  

### atqコマンド

atのジョブのスケジュールを一覧で表示するコマンド。  
at -lと同じ動作をする。  

### cronコマンドのアクセス制御

`/etc/cron.allow` :: cronの利用を許可するユーザーを記述する。  
`/etc/cron.deny` :: cronの利用を拒否するユーザーを記述する。  

① /etc/cron.allowファイルがあれば、そこに記述されたユーザーのみがcronを利用できる。/etc/cron.denyファイルは無視される。  
② /etc/cron.allowファイルが無ければ、/etc/cron.denyを参照し、/etc/cron.denyに記述されていないすべてのユーザーがcronを利用できる。  
③ /etc/cron.allowファイル、/etc/cron.denyファイルのどちらもない場合、すべてのユーザーがcronを利用可能。  
※最新バージョンでは、rootユーザーのみが利用可能。  
ping-tではrootユーザーのみ。白本では全てのユーザーがOKとのこと。  

初期状態では利用制限が行われていないため、すべてのユーザーが実行することができる。  

### atコマンドのアクセス制御

`/etc/at.allow` :: atの利用を許可するユーザーを記述する。  
`/etc/at.deny` :: atの利用を拒否するユーザーを記述する。  

① /etc/at.allowがあれば、そこに記述されたユーザーのみがatを利用できる。/etc/at.denyファイルは無視される。  
② /etc/at.allowが無ければ、/etc/at.denyを参照し、/etc/at.denyに記述されていないすべてのユーザーがatを利用できる。  
③ どちらのファイルも無ければ、rootユーザーだけがatを利用できる。  

初期状態では利用制限が行われていないため、すべてのユーザーが実行することができる。  
デフォルトで空の/etc/at.denyファイルがあり、すべてのユーザーがatコマンドを利用できるようになっている。  

設定例 : 「mike」と「ken」に対してatを利用可能にする設定  

``` bash
#vi /etc/at.allow
mike
ken
```

### で、結局違いは何なの？

どちらのファイルもなかった場合の挙動  
・cronはすべてOK。
・atはrootだけ。  

なのだが、最新ではrootだけって事になっているので、どっちもrootって応えて置けばいいかも。  

atは最初から/etc/at.denyファイルがある。  

### systemdによるスケジューリング

systemdのtimerユニットは、定期的に自動でジョブを実行するジョブスケジューラとしてcronの代わりに使用できます。  

timerユニットによるジョブ実行には以下のユニット定義作成が必要になります。  
・timerユニット :： ジョブの実行タイミング、実行するジョブを指定する。  
・ジョブ本体となるユニット :： timerユニットから呼び出され、処理を行うユニット。  
timerユニット以外のユニットが指定できるが、デフォルトではtimerユニットと同じ名前のserviceユニットが実行される（例：「foo.timer」の場合「foo.service」）  
timerユニットの定義ファイルの拡張子は.timer  
「/etc/systemd/system」に拡張子.timerの定義ファイルを作成し、`[Timer]`セクションに実行タイミングと実行するジョブを指定します。  

timerユニットとジョブ本体のユニットが別になっているので、ログの調査やジョブ本体のデバッグが容易になります。  

timerユニットの実行タイミング指定には2つの方法があります。  
・モノトニックタイマー :： cronのように、起動後はジョブを定期的に実行する  
・リアルタイムタイマー :： atのように、指定した実行日時にジョブを1度だけ実行する  

systemdにおいて、全ての有効なtimerユニットを表示するコマンド。  
`systemctl list-timers`

### systemd-runコマンド

systemdに置ける一時的なユニットを作成してジョブを実行するコマンド。  
timerユニットを設定するにはtimerユニットと対応するジョブ本体のユニットを作成したりと手間がかかりますが、  
systemd-runコマンドを使用することでより簡単にジョブをスケジューリングできます。  

ユニット名runtestで、毎日17時30分に「/tmp/test」プログラムを実行する。  
`systemd-run --unit==runtest --on-calendar="*-*-* 17:30:00" /tmp/test`

### batch

batchコマンドは、システムの負荷の少ないタイミングで指定した時間に1回だけコマンドを自動実行します。  
batchコマンドで設定されたジョブの管理は、atコマンドを使用して行います。  

「batch」コマンドを入力すると、プロンプトが「at>」に変わり、コマンドを入力できるようになるので、実行したいコマンドを入力して、最後にCtrl+Dで終了します。  
これは「at」コマンドの入力と同じです。  
ただし、時間指定ではなく、負荷が下がった時点で実行される点が違います。  

``` txt
batch [オプション]

-l :: 予約中のジョブを表示(atqコマンドと同様)
-d ジョブ番号 :: 指定した予約中のジョブを削除(atrmコマンドと同様)
```

``` sh : 負荷が下がると「IDLE」とコンソールに表示するジョブを設定
$ batch
at> echo "IDLE" > /dev/pts/0 ←実行するコマンドを指定
at> <EOT> ←Ctrl + Dで終了
job 1 at 2016-12-12 23:00
$ at -l ←ジョブの確認
1 2016-12-12 23:00
```

---

## ローカライゼーションと国際化

### ローカライゼーション(localization)

言語や通過単位、日付の書式等を地域や国に合わせる事  

### 国際化(internationalization : i18n)

ローカライゼーションを国ごとに行うのは大変なので、多くのソフトウェアでは最初から多言語・他地域に対応するように作られている。  

### ロケール

利用者の地域情報  

systemdが動作するシステムでのシステム全体のロケール設定ファイルは「/etc/locale.conf」です。  

デフォルトのロケールはC（POSIX）ロケールです。  
Cロケールのエンコーディング（数値と文字の対応・変換の方式）はASCIIで、数値や日付の書式は米国英語です。  
日本とフランスなどロケールが異なる環境でスクリプトを実行しても、英語で共通の出力が得られます。  
またロケールに関する処理が行われない分、処理の高速化が期待できます。  

``` txt : ロケールの主なカテゴリ  
LC_CTYPE     :: 文字の種類やその比較・分類の規定  
LC_NUMERIC   :: 数値の書式に関する規定  
LC_TIME      :: 日付や時刻の書式に関する規定  
LC_MESSAGES  :: メッセージ表示に使用する言語  
LC_MONETARY  :: 通貨に関する規定  
LC_NAME      :: 名前の書式
LC_ADDRESS   :: アドレス、ロケーションの書式
LC_TELEPHONE :: 電話番号の書式
LC_COLLATE   :: 文字の照合や整列に関する規定  
LC_ALL       :: ロケールの環境変数すべて  
                指定した値が全てのカテゴリを上書きし、カテゴリごとの設定が出来ない。
LANG         :: 全てのカテゴリで必ずその値が使われるが、個々のカテゴリ毎に個別の設定が可能。
                (LC_ALL)が設定されていない場合、指定した値がデフォルトとして使用される。

※LC_ALLは全てのカテゴリを上書きするので「/etc/locale.conf」に設定することは推奨されません。
```

### localeコマンド

現在のロケールの設定を確認するコマンド  
引数なしで実行した場合、システムに設定されているロケールが表示される。  

``` txt
構文 :: locale [オプション] ユーザー名

オプション
-a :: 設定できるロケールを全て表示
-m :: 利用できる文字コードを全て表示
```

ロケールの環境変数の全てをja_JP.utf8にする例  
`export LC_ALL=ja_JP.utf8`  

### ロケール名の言語名_国家もしくは地域名.文字コード  

``` txt : 主なロケール名  
C,POSIX :: 英語  
ja_JP.utf8 :: 日本語/Unicode  
ja_JP.eucJP :: 日本語/EUC-JP  
ja_JP.ShiftJIS :: 日本語/シフトJIS  
en_US.utf8 :: 英語(米)/Unicode  
```

### 文字コード

``` txt
ASCII       :: 7ビットで表される基本的な128種類の文字(英数字+α)  
ISO-8859    :: ASCIIを拡張した8ビットの文字コードで256種類の文字を表現  
UTF-8       :: Unicodeを使った文字コードで、1文字を1バイトから6バイトで表す  
EUC-JP      :: 日本語EUC。UNIX環境で標準的に利用されていた日本語の文字コード  
ShiftJIS    :: Windowsで利用される日本語の文字コード  
ISO-2022-JP :: 電子メールなどで利用される日本語の文字コード(JISコード)  
Unicode     :: 多言語を扱うために作成された符号化文字集合(文字コード表)
               Unicodeで定義された文字を表現する符号化方式には、UTF-8,UTF-16,UTF-32等がある。
```

### iconvコマンド

文字コードを変換するコマンド  

``` txt
iconv [オプション] [入力ファイル名]

オプション
-f 入力文字コード :: 返還前の文字コードを指定する
-t 出力文字コード :: 変換して出力したい文字コードを指定する 
-l :: 扱える文字コードを表示する  
```

日本語EUC(EUC-JP)で作成されたファイルreport.euc.txtをUTF-8に変換してreport.utf8.txtとして保存する例。  
`iconv -f eucjp -t utf8 report.euc.txt > report./.utf8.txt`  

### タイムゾーン

地域ごとに区分された標準時間帯をタイムゾーンと言う。  
主にエポック時間からローカルの時間に変換するときに参照する。  
Linuxの内部では、UTC 1970年1月1日午前0時0分0秒からの経過秒数であるエポック（epoch）時間で時間を管理しており、  
設定されたタイムゾーンにしたがってエポック時間から変換して、日付時刻を扱います。  
なお、エポック時間はUNIX時間（Unix Timestamp）とも呼ばれます。  

一般ユーザーでも変更することが出来る。  

### UTC(Coordinated Universal Time) JST(Japan Standard Time)

UTC（Coordinated Universal Time）は協定世界時のことで、各地の時間を決める際の基準となるものです。  
JST（Japan Standard Time）は日本標準時のことで、UTCより9時間進んでいます。  

### /usr/share/zoneinfo/ と /etc/localtime

「/usr/share/zoneinfo/」ディレクトリ以下には、国や地域ごとにタイムゾーンの情報がバイナリファイルとして格納されています。  
システムのタイムゾーンは、それらのバイナリファイル群から、  
システムで使用したいタイムゾーンのものを「/etc/localtime」へコピーまたはシンボリックリンクを作成することで設定します。  

タイムゾーンといいつつ、リンクを張る先はlocaltimeなのに注意。  
zoneinfoファイルは`/usr`ディレクトリであることに注意(1敗)  

タイムゾーンを日本に設定するコマンド  
`cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime`  

シンボリックリンクの場合  
`ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime`  

### /etc/localtime

システムクロックの時刻からローカルタイムへ変換するための時差情報が格納されている。  

Linuxのインストール時に指定したタイムゾーンに対応する/usr/share/zoneinfoの下のファイルがコピーされる。  
ディストリビューションやバージョンによってはシンボリックリンクとして作成される場合がある。  

バイナリファイルらしい。  
「/etc/localtime」には「/usr/share/zoneinfo/」ディレクトリに格納されている、国や地域ごとのタイムゾーン情報を持つバイナリファイルをコピーする事でタイムゾーンを設定します。

### /etc/timezone

システムで使用するタイムゾーンを指定するテキストファイル。  

例）システムのタイムゾーンを日本（Asia/Tokyo）にする場合  
`cat /etc/timezone`  
Asia/Tokyo  

### 環境変数TZ

環境変数`TZ`で設定もできる。  
`export TZ="Asia/Tokyo"`  

環境変数TZを全ユーザーで利用するなら、`/etc/timezone`ファイルに「Asia/Tokyo」と設定する。  

### tzselectコマンド

一覧から表示される情報をもとにタイムゾーンを設定できるコマンド。  
対話式でオプション等はなさそう。  
環境変数「TZ」や「/etc/timezone」ファイルで指定する値は「tzselect」コマンドで確認できる。  

tzselectコマンドで得た値は以下のように使用します。  
・export TZ=Asia/Tokyo  
・vi /etc/timezone  
Asia/Tokyo  

### tzconfigコマンド

このコマンドでもタイムゾーンを設定できる。  
`/etc/localtime`と`/etc/timezone`の値をまとめて変更する。  

Debian系のコマンド  
最近のディストリビューションでは利用できない。  
利用したいなら`dpkg-reconfigure tzdata`をたたく。  

---

## 小豆本問題

---

### 1 ×

ユーザーアカウント[jupiter]を新しく作成したい。  
ホームディレクトリは[/home/plane]、デフォルトシェルは[/bin/zsh]として作成する場合のコマンド

→  
× `useradd -m /home/planet -s /bin/zsh jupiter`  
○ `useradd -d /home/planet -s /bin/zsh jupiter`  

ホームディレクトリの指定は-dでした。  
-mはホームディレクトリを自動的に生成するオプションです。  
でも、全体的にいい線は言っていたのではないでしょうか。  

---

### 2 ×

ユーザーuser07は現在group07とgroup08の2つのグループに所属している。  
更に既存のグループgroup09にも所属させたい場合、実行すべきコマンドは？  

→  
-gか-Gか。  
どちらかはメインを変更せず、追加するだけだった気がする。  
最後にユーザーを指定する構文なので、選択肢的に`usermod -g group09 user07`しかないなぁ。  

→  
まさかの選択肢C`usermod -G group07,group08,group09 user07`だった。  
[-G]はプライマリグループは変更しないで所属するグループを変更するオプションだった。  
複数のグループにいる状態で更に追加したい場合は、今いるグループもすべて記述しないといけないっぽい。  

---

### 3 ○

ユーザーアカウントsaturnを削除すると同時に、そのユーザーが使っていたホームディレクトリも削除したい。  
適切なオプションとコマンドを記述せよ。  

→  
`userdel -r saturn`  

これはあたり。  
削除はremoveっぽいので-rで正解。  
ホームディレクトリの引数は特に必要ない。  

---

### 4 ×

ユーザーを新規に作成する際、新たに作成されるホームディレクトリの中に、デフォルトで必要とされるいくつかのファイルをコピーする必要がある。  
ユーザーの作成と同時に自動的にそれらのファイルがユーザーのホームディレクトリ内にコピーされるようにするには、ひな形となるファイルをどのディレクトリに配置すれば良いか？  
ディレクトリ名を絶対パスで記述せよ。  

→  
`/etc/skld`  

あー。おしい。
sk~~なんだっけ？ってところまではいい線言ってた。  

skelの意味はどうやらskeltonという意味らしい。  
skeltonは骸骨のイメージがあるが、それ以外にも骨組みや必要最小限という意味もあるみたいね。  

---

### 5 ○

crontabコマンドを用いて、毎月10日の午後5時10分に/home/myhome/myscriptが実行されるように死体。  

→  
D. `10 17 10 * * /home/myhome/myscript`  

当たった。  
秒は指定出来ず、分から徐々に大きくなって行くのは覚えていた。  
月まではいいとして、最後は曜日だったか？  
うん、曜日だった。  

---

### 6 ×

atコマンドを利用しようとしている。  
/etc/at.allowファイルは存在せず、/etc/at.denyファイルは存在下が、中には何も記述されていない。  
この時の説明は？すべて選択。  

→  
B. rootユーザーだけが使える。  

それ以外にもA. すべての一般ユーザーはatコマンドを利用できる も正解らしい。  
あれ？そうだったっけ？  
あー。すべてのファイルがない場合の話だ。  
denyがあって何も記述が無かったら、確かに全員使えるわな。  

---

### 7

日付や時刻の表記を規定する変数  

→  
あれー。何だっけ。  
普通に考えて`LC_FORMAT`  

はい。`LC_TIME`だそうです。  
LC_FORMATなるものは存在しません。  

---

### 8 ○  

システムに設定されているロケールを表示するコマンド  

→  
locale  

まぁ、ロケール言ってるんだからこれしかないよね。  
引数なしでlocaleコマンドを実行すると、システムに設定されているロケールが表示されるらしい。  

---

### 9 ○

タイムゾーンを日本に設定しようとしている。下線部に当てはまるコマンド。  
`# ___ -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime`  

→  
忘れた。環境変数はTZと覚えているのだが。  
タイムゾーンだから普通にtimezoneってやりたいけどそんなコマンドあったっけ？  
いや、違う。シンボリックリンクを通すかコピーするかって話だった気がする。
だったらリンクを作るコマンドなので `ln`か？  

いやー、覚えてるもんだね。  
因みにタイムゾーンを設定するコマンドはlocaltimeだそうです。  
全然覚えてない。  
