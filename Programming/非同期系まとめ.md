# 非同期系まとめ

非同期における概念的なモノをまとめる。  

---

## 非同期処理とは？同期処理と何が違う？

諸説あり、確定はしていないので、とりあえずしっくり来た説明だけをまとめておく。  

UIスレッドで処理する事 → 同期処理  
UIスレッド以外 (例えば、スレッドプール)で処理する事 → 非同期処理  

---

## UIスレッド

ユーザーインターフェイススレッド (英: user-interface thread) とは、アプリケーションソフトウェアのグラフィカルユーザーインターフェイス (GUI) におけるメインスレッドのことを指す。  
UIスレッドと表記されることもある。  
ユーザーインターフェイススレッドは、Javaではイベントディスパッチスレッド、Adobe Flashではprimordial workerと呼ばれる。  

画面が動いているスレッドのことを指す。  

---

## スレッドプール

1. 使用可能なスレッドをプール(貯めておく)しておく仕組み → スレッドを管理する仕組み。  
2. スレッドを効率よく処理するための仕組み  
   - スレッドを立てる事は非常に時間が掛かる  
   - スレッドは必要になった時に都度新しく作るより、最初にいくつか作っておいて使いまわす方が効率が良い  
   - スレッドの使いまわし、スレッドのパフォーマンス改善のための仕組みがスレッドプール  

[【C#】Task初心者のTask初心者によるTask初心者の為のTask入門](https://qiita.com/OXamarin/items/eddc9f7f01b691631887)  
[[C#]await利用時の同期コンテキストと実行スレッドの動きについてコードを動かして見ていく](https://qiita.com/Kosei-Yoshida/items/7afe6c2f6158f36f50b1)  

### 他の説明

[未確認飛行C_[雑記] スレッド プールとタスク](https://ufcpp.net/study/csharp/misc_task.html)  

スレッドを直接使うのではなく、 1度作ったスレッドを可能な限り使いまわすような仕組みを使います。  
このようなスレッドの使い回しの仕組みをスレッド プール（thread pool）と呼びます。  

スレッド プールとは、以下のような仕組みです。

- 一定数のスレッドを常に立てておく。 （CPU 数と同じ数だけスレッドが動いている状態が理想。）  
- タスクを待たせておくためのキューを持つ。  
- 現在処理中のタスクが終わり次第、次のタスクをキューから取り出して実行する。  

[第2回　.NETにおけるマルチスレッドの実装方法を総括](https://atmarkit.itmedia.co.jp/ait/articles/0504/20/news111.html)  
.NETマルチスレッド・プログラミングにおいて、最も基本となるのがスレッド（Threadクラス）である。
Threadクラス（System.Threading名前空間）は、指定したメソッドを別スレッドで起動（実行）する仕組みを提供する。  
スレッドの一時停止や中断、優先順位付けなどを細かく制御することもできる。  
ただし、サーバ型のプログラムのように、リクエストを並行して処理するようなプログラムの場合、スレッドの生成・破棄を大量に繰り返す必要が出てくる。  
スレッドの生成にはそれなりのリソースが消費されるため、単純にこれを繰り返していてはパフォーマンスが低下する。  

この問題を解決する仕組みが「スレッドプール」である。  
スレッドプールとは、キューに入れられたリクエスト（処理）をスレッドプールが用意しているスレッドにより次々に実行していく仕組みである。  
スレッドプールでは、一度確保したスレッドのリソースをできる限り再利用するように設計されている。  
そのため、別スレッドで実行したいメソッドを、スレッドプール専用のキューに次々と入れる（登録する）だけで、後は自動的に登録したメソッドが別スレッドで効率よく実行されていく。  

### 番外編 スレッドの上限数を確認する

スレッドの上限数はメモリによるらしい。  

``` C# : スレッドの上限数を取得するコード
ThreadPool.GetMaxThreads(out int workerThreads, out int portThreads);
Console.WriteLine($"Worker threads={workerThreads}, Completion port threads={portThreads}");
//ワーカースレッド上限数 : 32767 (2^15)  
//ポートスレッド上限 : 1000
```

---

## スレッドセーフ

[e-Words](https://e-words.jp/w/%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%BB%E3%83%BC%E3%83%95.html#:~:text=%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%BB%E3%83%BC%E3%83%95%E3%81%A8%E3%81%AF%E3%80%81%E3%83%9E%E3%83%AB%E3%83%81,%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%80%82)  

>スレッドセーフとは、マルチスレッド環境において、あるコンピュータプログラムを複数のスレッドで並行して実行しても、問題が生じない仕様や設計になっていること。  
>一つのプログラムが複数の命令の流れ（スレッド）を並行に実行できることをマルチスレッドというが、ある関数などが複数のスレッドから同時に実行されても矛盾や不具合が生じないようになっていることをスレッドセーフという。  
>例えば、共有メモリ領域の内容を書き換えるような処理を含む場合、あるスレッドから書き換え処理を行っている最中に別のスレッドからも書き換えが行われ、内容が破損したり失われることがある。このような複数スレッド間の競合が起き得る状態はスレッドセーフではない。
>ローカル変数のみを利用する場合はスレッドセーフと言えるが、ファイルやデータベースなどへのアクセスを含む場合、静的変数やグローバル変数、ヒープ領域などを利用する場合、変数などの参照やポインタを使用する場合にはスレッドセーフ性を確保するための工夫が必要となる場合がある。

---

## プロセスとスレッドの違い

[イケてるエンジニアになろうシリーズ 〜メモリとプロセスとスレッド編〜](https://moro-archive.hatenablog.com/entry/2014/09/11/013520)

スレッド（thread）は、CPU の数を超えて複数の処理を同時に実行するための仕組みです。  
同時に実行するといっても、本当に並列に動いているわけではありません。  
一定間隔で OS が処理を奪い、別のスレッドに切り替えることで、見かけ上の同時実行を実現しています。  
