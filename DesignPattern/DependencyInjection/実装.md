# DIの実装

## DIの実装例_DIコンテナを用いた実装

MVPSampleがいい例だったのでそのまま流用した。  

### DIなしで実装した場合

``` C# : DIなしで実装した場合
    public partial class App : Application
    {
        [STAThread]
        public static void Main()
        {
            IRectangleModel model = new RectangleModel();
            IRectangleView view = new MainWindow();
            _ = new RectanglePresenter(view, model);
            view.Show();
            new App().Run();
        }
    }
```

### IUnityContainerで実装した場合

``` C# : IUnityContainerで実装した場合
    public partial class App : Application
    {
        [STAThread]
        public static void Main()
        {
            IUnityContainer container = new UnityContainer();
            container.RegisterType<IRectangleView, MainWindow>();
            container.RegisterType<IRectangleModel, RectangleModel>();
            // DIコンテナを用いた場合、自動的に引数に注入してくれる模様。
            container.Resolve<RectanglePresenter>();
            container.Resolve<IRectangleView>().Show();
            container.Resolve<App>().Run();

            // 依存性を注入する部分はこういう風にもかける。だけど、ほぼ意味はないでしょう。
            //① これでもいける
            //container.RegisterInstance(new RectanglePresenter(view, container.Resolve<IRectangleModel>()));
            //② これでもいける
            //container.RegisterType<RectanglePresenter>(
            //    new InjectionConstructor(
            //        new ResolvedParameter<IRectangleView>(),
            //        new ResolvedParameter<IRectangleModel>()
            //    )
            //);
        }
    }
```

### Microsoft.Extensions.DependencyInjectionでの実装

ASP.NET Core などで何も考えない場合に使うことになる、事実上の標準の DI コンテナです。  
非常にシンプルで DI コンテナとして最低限これくらいは持ってるだろうと思われる機能だけ持ってます。  

[コンストラクタインジェクションはここを参考にした](http://surferonwww.info/BlogEngine/post/2021/01/01/dependency-injection-for-dotnet-core-application.aspx)  

AddTransient で登録するとコンテナから取得するたびに別のインスタンスを返します。  
AddSingleton で登録すると毎回同じインスタンスになります。  
AddScoped で登録すると同じスコープ内だと同じインスタンスになります。  
スコープを作るには ServiceCollection に BuildServiceProvider をした結果の ServiceProvider の CreateScope メソッドを使います。  

``` C# : Microsoft.Extensions.DependencyInjectionでの実装
    public partial class App : Application
    {
        [STAThread]
        public static void Main()
        {
            // Microsoft.Extensions.DependencyInjectionでの実装
            IServiceCollection services = new ServiceCollection();
            services.AddTransient<App>();
            services.AddScoped<IRectangleView, MainWindow>();
            services.AddScoped<IRectangleModel, RectangleModel>();
            services.AddTransient<RectanglePresenter>();
            // インスタンスを提供してくれる人を作る
            using var provider = services.BuildServiceProvider();
            provider.GetService<RectanglePresenter>();
            provider.GetService<IRectangleView>()?.Show();
            provider.GetService<App>()?.Run();
        }
    }
```

[C#でDIコンテナを使用してみる](https://remix-yh.net/1332/)  
[Unity Container: Constructor Injection](https://www.tutorialsteacher.com/ioc/constructor-injection-using-unity-container)  
[.NET 系の DI コンテナ](https://qiita.com/okazuki/items/239ca5ef46e5a085e085)  

---

## DIの実装例_手動のDI

wikiの例を参考。  
コンストラクタを用いた手動のDIを紹介。  
コンストラクターインジェクション  

``` java : DIを用いない状態
public class VerySimpleStockTraderImpl implements IAutomatedStockTrader {
    // 別のクラスを直接Newしている
    private IStockAnalysisService analysisService = new StockAnalysisServiceImpl();
    private IOnlineBrokerageService brokerageService = new NewYorkStockExchangeBrokerageServiceImpl();

    public void executeTrades() {}
}

// エントリーポイント
public class MyApplication {
    public static void main(String[] args) {
        IAutomatedStockTrader stockTrader = new VerySimpleStockTraderImpl();
        stockTrader.executeTrades();
    }
}
```

``` java : 手動でのDI
public class VerySimpleStockTraderImpl implements IAutomatedStockTrader {
    private IStockAnalysisService analysisService;
    private IOnlineBrokerageService brokerageService;
    // コンストラクタからインスタンスを取得
    public VerySimpleStockTraderImpl(IStockAnalysisService analysisService,IOnlineBrokerageService brokerageService) {
        this.analysisService = analysisService;
        this.brokerageService = brokerageService;
    }

    public void executeTrades() {}
}

// エントリーポイント
public class MyApplication {
    public static void main(String[] args) {
        // MyApplication.main()が依存性の注入を行っており、VerySimpleStockTraderImpl自体は特定の実装に依存しなくなっている。
        IStockAnalysisService analysisService = new StockAnalysisServiceImpl();
        IOnlineBrokerageService brokerageService = new NewYorkStockExchangeBrokerageServiceImpl();
        // この実装ではコンストラクタ注入の手法が用いられている。
        IAutomatedStockTrader stockTrader = new VerySimpleStockTraderImpl(analysisService,brokerageService);
        stockTrader.executeTrades();
    }
}
```
