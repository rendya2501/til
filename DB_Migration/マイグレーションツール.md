# マイグレーションツール

## ツール一覧

- EntityFrameworkCore  
- SQL Server Database Project  
- Flyway  
- FluentMigrator  
- sqldef  
- DbUp  
- Evolve  

---

## 不採用候補

- Flyway  
  - Java製データベースバージョン管理ツール。  
  - データベース管理ツールでは一番に出てくる程メジャーな製品。  
  - ツールと同じフォルダにSQLをためて、CLIでマイグレーションを実行するツール。  
  - EvolveなるFlywayをリスペクトしたC#製ツールがあるので、わざわざJava製のツールを使う必要を感じなかった。  
  - Java製のツールなら操作、確認の選択肢は豊富そうだったが、そうでなければ操作や確認はCLIのみでコマンドに慣れが必要。  
  - 個人的主観としてとっつき辛かった。少し動かそうとしたがQLServerは接続の設定から面倒だった。  

- Evolve  
  - プレーンなSQLスクリプトを使用する、Flywayに触発されたC#製データベース移行ツール  
  - ASP.NetCoreプロジェクトとして作成するのでIISのサービス起動と同時にマイグレーションできる模様。  
    →サービスを起動する度に最新状態を保てる。  
  - ドキュメントが皆無。Evolveという単語が強すぎてマイグレーションツールに関して全く引っかからない。  
  - サービスの起動と同時にマイグレーションを実行するのはアンチパターンとして紹介されている記事もあったため。  
  - プレーンなSQLスクリプトを使うツールとしてDbUpなるものがあり、そちらのほうが文献も豊富でとっつき易かった。  

- FluentMigrator  
  - .Netのデータベース管理ライブラリ  
  - Linq Likeな専用命令で移行スクリプトを記述してプロジェクトを実行することでマイグレーションを行う。  
  - EntityFrameworkのマイグレーション機能だけを抜き出したような感じのライブラリ  
  - わざわざプレーンなSQLを作っているのに、それをわざわざ専用命令に書き直す必要性を感じなかった。  
    - 専用命令が冗長で海外でも不評  
  - 2013年頃の記事がほとんどでもう古い。  

- sqldef  
  - 個人開発のGo製のcliツール  
  - 元のスキーマーと目標とするスキーマとの差分から自動的にCREATE TABLE や ALTER TABLE を生成してくる代物。  
  - 検証してみたが、エラーとなって先に進まなかったのでボツ。  
  - 差分からスクリプトを生成する機能はSQLServer Database Projectにもあったのでボツ。  

---

## 採用候補

- Entity Framework Core  
  - .Net製ORマッパーフレームワーク。  
  - コードファーストによる開発を実現するフレームワーク。  

- SQL Server Database Project  

- DbUp  
  - 変更を SQL Server データベースに展開するのに役立つ .NET ライブラリ。nugetからインストール可能。  
  - すでに実行されている SQL スクリプトを追跡し、データベースを最新の状態にするために必要な変更スクリプトを実行します。

---

## DatabaseProject

>データベースプロジェクトとはVisualStudio 2010 の標準プロジェクトテンプレートです。
機能は  
・データベースをバージョン管理できる  
・他の人が変更した内容を、自分のローカル環境に簡単に反映できる  
・配置済のデータベースと、プロジェクトのデータベースの差分をスクリプトとして生成してくれたりする  
・etc...  
などがあります。  
[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  

<!--  -->
>データベースプロジェクトは、Visual Studio.NETプロジェクトの特殊なタイプです。  
その目的は、SQLデータベーススクリプトを作成し、管理することです。  
Visual Studio.NETでデータベーアプリケーションを開発する場合、データ ベースでの作業をより簡単かつ迅速にするためのツールについて知っておくとよいでしょう。  
[Visual Studio.NET Database Projects](https://www.pearsonhighered.com/assets/samplechapter/0/6/7/2/0672323435.pdf)  

- .NetFramework依存。.NetCoreには対応していない。  
- SQLServerしか対応していない。  

### スクリプトを実行した後のバージョン確認

`データ層アプリケーション`として登録して `select * from msdb.dbo.sysdac_instances` することで、データベース プロジェクト プロパティで指定されたものと同じバージョン番号を含むレコードが作成されます。  

``` sql
select * from msdb.dbo.sysdac_instances
```

<https://marcin.gminski.net/blog/database-development-in-visual-studio/>  

---

>■**問題**
>チーム内でのデータベース管理に、データベースプロジェクトを利用しています。  
>
>ですが、よくあるマスタデータの挿入については、手作業で管理をしていました。  
>Insert文を書いたクエリファイルを、共有フォルダに置くなり、メールに添付するなりして、「このファイル実行しておいてねー」とチームで共有していました…。  
>
>これでは実行が面倒ですし、新しくデータベースを作成する際に、手間がかかります。  
>マスタデータなどの重要なスクリプトが、バージョン管理されていないのも問題です。  
>
>■**解決方法**  
>データベースプロジェクトには、最初から配置前・配置後スクリプトが準備されています。(中身は空です。)  
>その配置後スクリプトに、マスタデータ挿入スクリプトを追加します。  
>これで、バージョン管理が可能になり、配置の際にスクリプトを実行してくれます。  
>
>[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  

---

[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  
[Top Features in SQL Server Data Tools for Database Projects](https://www.mssqltips.com/sqlservertip/6749/ssdt-top-features-database-projects/)  
[DATABASE DEVELOPMENT IN VISUAL STUDIO](https://www.mssqltips.com/sqlservertip/6749/ssdt-top-features-database-projects/)  
[Best Practices for multi-environment database development](https://sqlbits.com/Sessions/Event14/Best_Practices_for_multi-environment_database_development_in)  

---

### 実行前スクリプト・実行後スクリプト

>チーム内でのデータベース管理に、データベースプロジェクトを利用しています。  
>
>ですが、よくあるマスタデータの挿入については、手作業で管理をしていました。  
>Insert文を書いたクエリファイルを、共有フォルダに置くなり、メールに添付するなりして、
>「このファイル実行しておいてねー」とチームで共有していました…。  
>
>これでは実行が面倒ですし、新しくデータベースを作成する際に、手間がかかります。  
>マスタデータなどの重要なスクリプトが、バージョン管理されていないのも問題です。  

[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  

---

### what register as a data-tire application

[SQL Server のデータ層アプリケーションの概要](https://www.sqlshack.com/an-introduction-to-data-tier-applications-in-sql-server/)  

---

## DbUp

フォルダにスクリプトまとめて、実行されていないスクリプトを判定して実行してくれる。  
Azure DevOpsからCI/DIの設定が可能。  
C#でコマンドラインツールを作って実行する形になる。  
コードを自分たちで生成できるので、条件判定など入れやすいかも。  

[DbUp_Document](https://dbup.readthedocs.io/en/latest/)  
[Getting Started With DbUp And Setting Up Azure DEVOPS Pipeline | Deploy Changes to SQL Server](https://www.youtube.com/watch?v=Jm4C-WzAdls)  

[Database Migrations with DbUp](https://counihan.co.za/blog/Database-Migrations-with-DbUp/)  
[jonathancounihan/dbup-database-migrations](https://github.com/jonathancounihan/dbup-database-migrations/blob/master/DBMigrate/Program.cs)  

[Database change management](http://www.kamilgrzybek.com/database/database-change-management/)  
[Using Database Project and DbUp for database management](http://www.kamilgrzybek.com/database/using-database-project-and-dbup-for-database-management/)  

[Converting a Visual Studio database project to use DbUp migrations](https://dasith.me/2020/06/08/database-project-conversion-to-migrations/)  

---

## Evolve

>■**概要**
>プレーンな SQL スクリプトを使用する、 Flywayに触発されたクロスプラットフォームのデータベース移行ツール  
>
>目的は、データベースの変更を自動化し、すべての環境と開発チームを通じてそれらの変更を同期させることです。  
>これにより、継続的な統合/配信のための理想的なツールになります。  
>
>全体的に Evolve はシンプルさを取り入れています。  
>プロジェクトを実行するたびに、データベースが最新であることを自動的に確認します。  
>それをインストールして忘れてください！  

<!--  -->
>■
>.NET プロジェクトで、データベース スキーマをすべての環境で最新の状態に保つ最も簡単な方法は、SQL 移行スクリプトをアセンブリと共に配置し、起動時に Evolve を実行することです。
>このようにして、デプロイされたアプリケーションは自動的に移行を適用し、データベース スキーマ バージョンと常に同期します。

[Evolve_github](https://github.com/lecaillon/Evolve)  
[Evolve_document](https://evolve-db.netlify.app/)

## EntityFrameworkCore

>**実環境での Dapper と EF のハイブリッド使用**
>
>完璧なデータ永続化のために、数え切れないほどのシステムが Dapper を使用しています。  
しかし、今回このテーマを取り上げるのは、開発者たちがハイブリッド ソリューションを選択しているためです。  
たとえば、特定の問題領域の調整を目的にその部分に EF を導入しているシステムがあります。  
また、クエリにはすべて Dapper を使用し、保存にはすべて EF を使用することを選択しているチームもあります。  
>@garypochron のチームによれば、**「効果の高い領域には Dapper を使い、SQL のオリジンを管理するためにリソース ファイルを使うようにしている」**とのことです。  
>人気の EF Reverse POCO Generator の製作者 Simon Hughes (@s1monhughes) が、既定では Dapper を使用し、技術的に難しい問題には EF を使用しているという、逆の方向に向かっていると知ったのは驚きでした。  
>彼は、「可能であれば Dapper を使い、複雑な更新には EF を使う」と話しています。  
>
>また、ハイブリッド アプローチは、パフォーマンスの強化よりも、懸案事項の分離がきっかけになっていることに関するさまざまな議論も目にしました。  
>最も多かった意見は、既定では EF の ASP.NET Identity の信頼を利用し、ソリューションの残りの永続性には Dapper を使用するというものでした。  
>
>[データ ポイント - Dapper、Entity Framework、およびハイブリッド アプリ](https://learn.microsoft.com/ja-jp/archive/msdn-magazine/2016/may/data-points-dapper-entity-framework-and-hybrid-apps)

普通にEFCoreでスキーマ管理してるところもあるのかもなぁ。  
「Dapper + EFCore スキーマ管理」  
→  
ありました。  

<!--  -->
>Dapper と Entity Framework Core の両方を使用して最大限に活用できるのに、なぜどちらを選択するのかということです。  
>Dapper は、複数の結合と非常に長いビジネス ロジックを扱う複雑なクエリを処理するのに非常に優れています。  
>Entity Framework Core は、クラスの生成、オブジェクトの追跡、複数の入れ子になったクラスへのマッピングなどに最適です。  
>したがって、これら 2 つの ORM について話すときは、通常、パフォーマンスと機能です。  
>
>[ASP.NET Core での Entity Framework Core と Dapper の使用](https://morioh.com/p/09c8bea3cedb)  

---

## SQL Server Database Project

database migration sqlserver

[How To Put Your SQL Server Database in Version Control (Git)](https://www.youtube.com/watch?v=FWAx0pdMLfQ)  
[データベースの変更追跡 (Visual Studio と Git を使用)](https://www.youtube.com/watch?v=skPhTDlaPEA)  
[Introduction to SQL Server Change Tracking](https://www.youtube.com/watch?v=ZNUN9qejCfc)  

Visual Studio database project best practices
visual studio database project deploy

[DATABASE DEVELOPMENT IN VISUAL STUDIO](https://marcin.gminski.net/blog/database-development-in-visual-studio/)
[Top Features in SQL Server Data Tools for Database Projects](https://www.mssqltips.com/sqlservertip/6749/ssdt-top-features-database-projects/)
[Best Practices for multi-environment database development](https://sqlbits.com/Sessions/Event14/Best_Practices_for_multi-environment_database_development_in)
[Visual Studio で SQL Server データベース プロジェクトを作成する方法](https://www.c-sharpcorner.com/article/how-to-create-sql-server-database-project-with-visual-studio/)  

---

## SQLServer

DDLTriggerなるものを使えば、テーブルに対して行ったスキーマー変更の履歴を残すことができる。  
あくまで残すだけなので、そこからどうするってのは考えないといけない。  

でも、開発テーブルにこの仕組みを作っておいて、何を適応してきたのか履歴を作るのは何かのきっかけで調査する必要があった時に役に立つ時が来るのでは？と思ったり。
開発環境でマイグレーション管理をしないなら、せめて履歴管理くらいはしてもいいと思ったり。  

[データベースのスキーマ変更を検出してみる(SQLServer)](https://recruit.cct-inc.co.jp/tecblog/database/ddl_trigger/)  

SQL Source Control

製品なのでダメ。

[Using SQL Server Management Studio to Push Changes to a Git Remote Repository | Redgate](https://www.youtube.com/watch?v=Pv13GpjGVmY)

database version control
[CI/CD for SQL Databases (both SSDT and EF)- A TimCo Retail Manager Video](https://www.youtube.com/watch?v=TuHf0Ty80jA)  

[SSMS でのソース管理](https://www.youtube.com/watch?v=1iJMuUDB5MU)

---

## DBeaver

無料の複数種類のDBに対応したデータベースの操作ができるツール。  
HeidiSQLと同じやつ。  

このクライアントからDBに接続して色々できる。  
ER図とか書き起こしてくれる模様。  
でもマイグレーション管理的な文献が見当たらなかった。  

---

## SQL Server Data Tools

>SQL Server Data Toolsは、SQL Serverを使用するアプリケーション開発者のための開発支援ツールです。  
開発者がSQL Server Management Studioで実施していたテーブルの作成や変更などのデータベース関連タスクを、Visual Studioで完結することを目的としています。  
<https://codezine.jp/article/detail/6531>  

古いのとバージョン管理的な文言が見当たらなかった。  
というか、この機能は2017年あたりからVisualStudioに統合されたっぽい？  
DatabaseProjectにおける差分比較機能はDataToolsの機能で実装されているような感じがした。  

とりあえず、あまり考えなくてよさそう。

[方法:スキーマ比較を使用して各種のデータベース定義を比較する](https://learn.microsoft.com/ja-jp/sql/ssdt/how-to-use-schema-compare-to-compare-different-database-definitions?view=sql-server-ver16)  

---

## FluentMigrator

- DotNetのデータベース管理ライブラリ  
- EFCoreほど大規模でガッツリしたものではない。Dapper的な立ち位置。つまりお手軽。  

>dotnet系プロジェクトでのデータベースマイグレーションというと、真っ先に思いつくのがEntity Framework Core(EFCore)によるものだろう。
実際多くの場合で、EFCoreを使えば問題は無い。
だが、筆者の場合、クエリはほぼDapper経由で出しているため、クエリビルダ等は必要なく、欲しいものはマイグレーションのみとなる。
マイグレーションのみの用途となると、EFCoreは大がかりに見えて、個人的にはちょっと扱いにくいなと思った。
そこで、よりマイグレーションのみに特化したライブラリは無いものかと探して、FluentMigratorを見つけた。
自分にとっては丁度良い規模感だったため、今回の記事で紹介する。

[FluentMigratorでデータベースマイグレーションを行う(dotnet)](https://qiita.com/skitoy4321/items/ba294a3ae35b617d207f)  
[FluentMigration の基本機能メモ](https://kendik.hatenablog.com/entry/2015/07/02/231529)  
[C#のORM（オブジェクト関係マッピング）における理想形を考えてみる](https://qiita.com/ikuosaito1989/items/f332863dfbe5f30fdf4a)  

---

## Flyway

- データベースのスキーマに対してバージョン管理するツール  
- Java製  
  - Java実行環境(JavaVirtualMachine) が必要だが問題はない  
- データベース管理ツールで調べると一番に出てくる程メジャーな製品  

[Flywayの使い方](https://garafu.blogspot.com/2020/06/how-to-use-flyway.html)  

---

## sqldef

- 

>目標とするスキーマを書くと, DBに接続して現在のスキーマと比較し, DBのスキーマが現在のスキーマに一致するように CREATE TABLE や ALTER TABLE などを実行してくれるGo製のcliツール。  
>[sqldefをマイグレーションコード生成ツールとして使う](https://kgtkr.net/blog/2022/02/10/sqldef-for-generate-migration)  

[sqldefへのSQL Server対応のコントリビュート 〜OSS活動を通して紐解くDBマイグレーションツールの実装〜](https://techblog.zozo.com/entry/database-migration-with-sqldef)  
[DBスキーマ変更管理ツール sqldef を試してみた](https://qiita.com/abe_masanori/items/7fd2a470e7eba2f255a4)  
[マイグレーションツールをsqldefに移行した話](https://zenn.dev/ko30005/articles/5712a1d4731627)  

---

## SQL Developer Data Modeler

Oracle製のデータベースクライアント  
差分を検出してクエリを作ってくれるらしいが、クライアントのダウンロードにはオラクルへのログインが必要で、SQLServerを使えるようにするためには、プラグインを組み込まないといけない。  
そのプラグインが2008以降存在するのか確認していない。  
