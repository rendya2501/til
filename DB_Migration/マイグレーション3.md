# マイグレーション3

---

## アジェンダ

- 管理されないことの問題  
- 必要な解決法  
- 候補一覧  
- 不採用候補  
- 採用候補  
- 採用候補について掘り下げ  

---

## 管理されていないと何が問題か？

- DBはアプリケーションの核。構成の不一致で簡単にエラーが発生する。  
- 履歴管理していないため、変更した理由がわからない。  
- 各データベースにどこまでスクリプトを当てたのかわからない。  

- 周知漏れなどで、自分のところでは動くけど、他の環境では動かないなどが発生する。  
- 変更した人が、チャットやメールなどで他のエンジニアに周知する必要が出てくる。  
- 周知されたエンジニアは後回しにする可能性があり、結局、エラーになったときに確認してDBを更新することになる。  
  - エンジニアの負担大。作業効率の低下。  

---

## 必要な解決法

- 第一歩はDDL文の監査。  
  - 少なくとも、いつ誰が何を変更したかはわかるようにしておく。  

- マイグレーションツールと仕組みの導入。  
  - 他の企業のベストプラクティスを自社に適応する。  

---

## ツール一覧

- EntityFrameworkCore  
- SQL Server Database Project  
- Flyway  
- FluentMigrator  
- sqldef  
- DbUp  
- Evolve  

---

## 不採用候補

- Flyway  
  - Java製データベースバージョン管理ツール。  
  - データベース管理ツールでは一番に出てくる程メジャーな製品。  
  - ツールと同じフォルダにSQLをためて、CLIでマイグレーションを実行するツール。  
  - EvolveなるFlywayをリスペクトしたC#製ツールがあるので、わざわざJava製のツールを使う必要を感じなかった。  
  - Java製のツールなら操作、確認の選択肢は豊富そうだったが、そうでなければ操作や確認はCLIのみでコマンドに慣れが必要。  
  - 個人的主観としてとっつき辛かった。少し動かそうとしたがQLServerは接続の設定から面倒だった。  

- Evolve  
  - プレーンなSQLスクリプトを使用する、Flywayに触発されたC#製データベース移行ツール。nugetからインストール可能。  
  - ASP.NetCoreプロジェクトとして作成するのでIISのサービス起動と同時にマイグレーションできる模様。  
    →つまり、サービスを起動する度に最新状態を保てる。  
  - ドキュメントが皆無。Evolveという単語が強すぎてマイグレーションツールに関して全く引っかからない。  
  - サービスの起動と同時にマイグレーションを実行するのはアンチパターンとして紹介されている記事もあった。  
  - プレーンなSQLスクリプトを使うツールとしてDbUpなるものがあり、そちらのほうが文献も豊富でとっつき易かった。  

- FluentMigrator  
  - .Netのデータベース管理ライブラリ。nugetからインストール可能。  
  - Linq Likeな専用命令で移行スクリプトを記述してプロジェクトを実行することでマイグレーションを行う。  
  - わざわざプレーンなSQLを作っているのに、それをわざわざ専用命令に書き直す必要性を感じなかった。  
  - 2013年頃の記事がほとんど。古い。専用命令が冗長。海外でも不評。  
  - EntityFrameworkのマイグレーション機能だけを実現するシンプルな構成なのはよかったがそれだけ。  

- sqldef  
  - 個人開発のGo製のcliツール  
  - 元のスキーマーと目標とするスキーマとの差分から自動的にCREATE TABLE や ALTER TABLE を生成してくる代物。  
  - 検証してみたが、エラーとなって先に進まなかったのでボツ。  
  - 差分からスクリプトを生成する機能はSQLServer Database Projectにもあったのでボツ。  

小さく紹介

## 採用候補

- Entity Framework Core  
  - .Net製ORマッパーフレームワーク。  
  - コードファーストによる開発を実現するフレームワーク。  

- SQL Server Database Project  

- DbUp  
  - 変更を SQL Server データベースに展開するのに役立つ .NET ライブラリ。nugetからインストール可能。  
  - すでに実行されている SQL スクリプトを追跡し、データベースを最新の状態にするために必要な変更スクリプトを実行します。

中くらいで紹介

---

## 各詳しく

大きく紹介
想定される運用方法を定時

## なぜDbUpか？

>DbUpを使った方が、DB内のトランザクションログが非常に軽く、Entity Frameworkではできない効率的な方法で、自分好みのオブジェクトを作成できるので、楽です。  
>DBにオブジェクトを作ることしかできないソースコードを使うより、Native SQLを使ってDatabaseの移行をスムーズかつ簡単に行う方がいい。  
[[Docs] Difference to EF migrations](https://github.com/DbUp/DbUp/issues/590)  

<!--  -->
>個人的には、データベースの移行を実行したいという理由だけでテクノロジを強制されるのは好きではありません。
[Database Migrations Using DbUp in an ASP.NET Core Web API Application](https://medium.com/cheranga/database-migrations-using-dbup-in-an-asp-net-core-web-api-application-c24ccfe0cb43)
