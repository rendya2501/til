# データベースマイグレーション

## データベースマイグレーションとは？

>**データベースマイグレーション**
>
>アプリケーションの変更に伴い、データベースのスキーマ情報の変更を必要とする場合があります。  
>例えば以下のケースです。  
>
>- 新機能の実装に必要となるカラムを追加したい  
>- ビジネスロジックの変更に伴いカラムの制約を変更したい  
>- パフォーマンスチューニングのためにインデックスを追加したい  
>
>データベースに保存されているデータを保持したままスキーマ情報を変更することをデータベースマイグレーションと呼びます。  
>そのデータベースマイグレーションにより、仕様変更や機能追加でスキーマ情報の変更が発生しても柔軟に適応できます。  
>しかし、環境ごとのスキーマ管理や更新のためのDDL文を実行する手間など、新たな課題が浮上します。  
>
>**データベースマイグレーションツール**
>
>上記の課題を解決する手段の1つとして、データベースマイグレーションツールがあります。  
>データベースマイグレーションツールは、スキーマ情報の変更に伴うDDL文の実行を管理するためのツールです。  
>
>多くのデータベースマイグレーションツールは、現時点と最新のスキーマ情報の差分から実行が必要なDDL文だけを実行してくれます。  
>そのため、開発環境や本番環境ごとにスキーマ情報を管理し、更新に必要なDDL文を1つ1つ手動で実行するという手間を省くことができます。  
>
>[sqldefへのSQL Server対応のコントリビュート 〜OSS活動を通して紐解くDBマイグレーションツールの実装〜](https://techblog.zozo.com/entry/database-migration-with-sqldef)  

---

## スキーマ管理・バージョン管理が必要な理由

### 管理されていないと何が問題か？

- DBはアプリケーションの核であり、構成の不一致で簡単にエラーが発生する。  
- 履歴管理していないため、変更した理由がわからない。  
- 各データベースにどこまでスクリプトを当てたのかわからない。  
- DDL、DMLを手動で管理することによる事故の危険性がある。  

- 周知漏れなどで、自分のところでは動くけど、他の環境では動かないなどが発生する。  
- 変更した人が、チャットやメールなどで他のエンジニアに周知する必要が出てくる。  
- 周知されたエンジニアは後回しにする可能性があり、結局、エラーになったときに確認してDBを更新することになる。  
  - エンジニアの負担大。作業効率の低下。  

>おそらく多くのプロジェクトでは  
>
>- 初期化パラメーター：Excelシートで管理  
>- スキーマ情報：DDL生成機能を独自追加したExcelシートで管理  
>
>くらいが平均的なところでしょう。
>
>システム開発の現場では、本番環境や検証環境、開発環境など同一システムが複数あるのが一般的です。  
>さらに開発環境は、同一システムに数十個存在することもあります。  
>このような複雑な環境下で、手動管理するのには限界があります。  
>そのため、以下のようなトラブルが発生しています。  
>
>- 本番環境と検証環境の初期化パラメーターが乖離して、設計書と違うものになっている。そして履歴管理していないため、変更した理由がわからない  
>- 開発環境のスキーマ変更情報を検証環境に反映し忘れて、アプリケーションエラーになる  
>- ストアド・プロシージャとテーブル定義がミスマッチでエラーになる  
>- 環境によってパフォーマンスが違うので調べてみたら、インデックスの有無が違っていた  
>
>そして本文では説明しませんでしたが、第一歩はDDL文の監査です。  
>少なくとも、いつ誰が何を変更したかは、わかるようにしてください。  
>
>[第9回 バージョン管理していますか？](https://www.intellilink.co.jp/column/oracle/2016/080800.aspx)  

<!--  -->
>DBは開発工程前に予め設計するのですが、やはり変更はつきものです。  
>しかもDBはアプリケーションの核になっているので、構成が変わるとエラーが発生したり、随時更新していかないと環境によって構成が異なったりします。  
>
>私も周知漏れなどで、自分のところでは動くけど、他の環境では動かないなどは日常茶飯事でした。  
>ちゃんと管理しろって話ですが、エンジニアの人数も少なかったので、管理コストに比べたら、トライアルアンドエラーの方が良かったりします（汗 ただし、エラーログに「〜の列が見つかりません。」のような、エラーのトレースができることが前提ですね。  
>
>ここで問題なのが、他の環境でも適用が必要だということです。  
>変更した人が、チャットやメールなどで他のエンジニアに周知する必要が出てきます。  
>しかも、周知されたエンジニアは後回しにする可能性があり、結局、エラーになったときにExcelを確認し、DBを更新することになります。  
>
>多くの場合、アプリのバージョンとDBのバージョンはリンクしており、DBのみ最新にしてもエラーになることがあります。  
>なので、DBの履歴管理上でアプリのどのバージョンに対応などに記載が必要な場合もあります。  
>ちゃんとやろうとすると、管理コストがかかってしまうのです。  
>
>[DBのバージョン管理で苦労しないために](https://blog.frevo-works.co.jp/entry/2019/01/23/125756)  

<!--  -->
>- 私のプロジェクトでは、スキーマ更新がバージョン管理システムで管理されていません。  
>   - 私のプロジェクトでは、各テーブルのスキーマ更新(ALETER クエリ), ビューやトリガー、プロシージャの作成クエリがバージョン管理システムで管理されていません。  
>    これらの更新情報は、テーブル定義書やプロジェクトwikiを参照する必要があります。  
>- 私のプロジェクトでは、スキーマ更新がモジュールごとに分散しています。  
>   - 私のプロジェクトでは、スキーマ更新はバージョン管理されています。  
>     しかし、それぞれの更新クエリは各モジュールに分散しています。  
>     サーバに適用するたびに、私は各モジュールに更新クエリが追加されていないか探しまわらなければなりません。  
>- 私のプロジェクトでは、どの環境にどのスキーマ更新を適用したか記録がありません。  
>   - 私のプロジェクトでは、本番環境、ステージング環境、開発環境がありますが、どのスキーマ更新をどの環境にどこまで適用したか記録がありません。  
>
>[データベーススキーマ変更の失敗しにくい管理方法](https://qiita.com/suin/items/fd996de8c5d58d95047d)  

---

## どのようにバージョン管理すればよいか？

- 第一歩はDDL文の監査  
  - 少なくとも、いつ誰が何を変更したかはわかるようにしておく  

- マイグレーションツールと仕組みの導入  
  - 他の企業のベストプラクティスを自社に適応する  

>原始的な方法として思いつくのは、テキスト化できる操作やパラメーターをSubversionやGitで管理する方法です。  
>少人数開発で小規模アプリケーションならば、なんとかなりそうです。  
>しかし、規模が大きくなるほど大変になり、記録漏れも発生しそうです。  
>
>そのため実際には  
>
>- 設計書→開発環境→検証環境→本番環境  
>
>のような一方向の伝搬だけでなく、現状の環境をキャプチャーし、  
>
>- 「検証環境と本番環境」「設計書と開発環境」のギャップ分析  
>
>のようなリバースエンジニアリング&比較機能もあるのが理想的です。  
>
>実際のところ、この分野の議論をインターネットで検索しても意見はさまざまです。  
>それぞれのソリューションで、コンセプトや機能に違いがあり、同一基準では判断できないからです。  
>また何が適しているのかは、使用する組織の文化やプロジェクト次第でしょう。  
>
>[第9回 バージョン管理していますか？](https://www.intellilink.co.jp/column/oracle/2016/080800.aspx)  

---

## Googleのデータベースマネージメントに関する記事

>継続的デリバリーで成果を上げているチームは、データベースの変更をバージョン管理のスクリプトとして保存することで、本番環境のアプリケーションの変更と同じ方法で管理しています。  
>さらに、アプリケーションの変更でデータベースの変更が必要な場合は、本番環境のデータベースを担当しているグループと協議し、エンジニアリング チームが保留中のデータベースの変更の進行状況について把握できるようにしています。  
>
>[DevOps 技術: データベースのチェンジ マネジメント](https://cloud.google.com/architecture/devops/devops-tech-database-change-management?hl=ja)  

---

## マイグレーションについての良記事

[Database Migrations In .NET Core](https://dotnetcoretutorials.com/2017/02/25/database-migrations-net-core/)  

[Database versioning best practices](https://enterprisecraftsmanship.com/posts/database-versioning-best-practices/)  
[State vs migration-driven database delivery](https://enterprisecraftsmanship.com/posts/state-vs-migration-driven-database-delivery/)
[Database versioning tools](https://enterprisecraftsmanship.com/posts/database-versioning-tools/)  

>1. データが失われないことを確認してください  
>2. スクリプトを変更または削除しないでください  
>3. バージョン管理にタイムスタンプを使用する  
>4. 適切な DSL を使用する  
>5. 移行ツール以外でデータベースの変更を行わないでください  
>6. 選択した移行ツールを使用して、データベースをどこにでも展開します  
>7. 移行を書き留めて時間を無駄にしない  
>8. アプリケーションの起動時に移行するのは悪い考えです  
>9. 移行を Docker 化する  
>10. ビジネス担当者と移行について話すことを恐れないでください  
>
>[Database migrations tips(データベース移行のヒント)](https://mcode.it/blog/2020-03-15-database_migrations_tips/)  

---

[データベースのスキーマ変更を検出してみる(SQLServer)](https://recruit.cct-inc.co.jp/tecblog/database/ddl_trigger/)  

[その他の変更の追跡の機能](https://learn.microsoft.com/ja-jp/ef/core/change-tracking/miscellaneous)  
[SQL Server Data Tools](https://learn.microsoft.com/ja-jp/sql/ssdt/sql-server-data-tools?view=sql-server-ver16)  

[データ ポイント - Dapper、Entity Framework、およびハイブリッド アプリ](https://learn.microsoft.com/ja-jp/archive/msdn-magazine/2016/may/data-points-dapper-entity-framework-and-hybrid-apps)  
[DB マイグレーションツールの Fluentmigrator がいい感じかも](https://kendik.hatenablog.com/entry/2015/06/30/203134)  

[C#のORM（オブジェクト関係マッピング）における理想形を考えてみる](https://qiita.com/ikuosaito1989/items/f332863dfbe5f30fdf4a)  

[sqldefへのSQL Server対応のコントリビュート 〜OSS活動を通して紐解くDBマイグレーションツールの実装〜](https://techblog.zozo.com/entry/database-migration-with-sqldef)  

[DBのバージョン管理で苦労しないために](https://blog.frevo-works.co.jp/entry/2019/01/23/125756)  
[.NET Core で DBマイグレーションを試したら色々ハマった話](https://blog.ecbeing.tech/entry/2019/06/12/125411)  
[データベーススキーマ変更の失敗しにくい管理方法](https://qiita.com/suin/items/fd996de8c5d58d95047d)  
[Entity Framework のマイグレーションを基礎から理解する](https://qiita.com/yutotakakura/items/31ab539321502deacd88)  

[Entity Frameworkのベストプラクティス-EFCoreをデータアクセスとして選択する必要がありますか？](https://www.youtube.com/watch?v=qkJ9keBmQWo)  
[CRUD with a .NET 6 Web API & Entity Framework Core 🚀 Full Course](https://www.youtube.com/watch?v=Fbf_ua2t6v4)  
[ASP.Net Core Web API - Entity Framework Core Transaction | Commit | Rollback](https://www.youtube.com/watch?v=VBFlI0-mbh4)  

マイグレーションツール一覧
[2023年度最新版スタンドアロンDBマイグレーションツールの比較](https://qiita.com/cocoa-maemae/items/d55c7b53f95425efdce8)  
