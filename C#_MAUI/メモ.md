# MAUIメモ

## System.ArgumentException: 'Ambiguous routes matched for...'

3階層あるようなページ構成において、3ページ目で`Shell.Current.GoToAsync('..')`したら発生した。  

AppShell.xamlでxaml上とコードビハインドでそれぞれRoutingを定義していると発生する模様。  
XAML側の定義を削除したら解決した。  

>これは、XAML（appshellファイル）でルートを登録し、C#のコードビハインドでルートを登録しようとしたときに発生します。  
>XAMLまたはC#のどちらかを使用して、一度だけルートを登録するようにしてください（両方は使用しないでください）。  
>[forms - Xamarin Shell Raise Ambiguous Routes matched Exception - Stack Overflow](https://stackoverflow.com/questions/58352925/xamarin-shell-raise-ambiguous-routes-matched-exception)  

---

## Page

親ページを作って使いまわす時に参考になりそうな動画。  
[Master Content Page ( Master Page, Partial View ) In .NET MAUI / Xamarin - YouTube](https://www.youtube.com/watch?v=ufMlk8k4Wq4)  

---

## Publisher/Subscriber Pattern ・ Prism EventAggregator

MauiはデフォルトでPublisher/Subscriberパターンを実装している模様。  

``` cs
protected override void OnNavigating(ShellNavigatingEventArgs args)
{
    base.OnNavigating(args);

    if (args.Target.Location.OriginalString.Contains("VariantPage1"))
    {

        MessagingCenter.Send<AppShell, string>(this, "Hi", "Test1");
    }

    if (args.Target.Location.OriginalString.Contains("VariantPage2"))
    {
        MessagingCenter.Send<AppShell, string>(this, "Hi", "Test2");
    }
}
```

``` cs
[ObservableProperty]
private string side = "Left";

public VariantViewModel(ConfigurationService service)
{
    this.configService = service;
    LoadWidgets();
    MessagingCenter.Subscribe<AppShell, string>(this, "Hi", (sender, arg) =>
    {
        Side = arg;
    });
}
```

[c# - C# - クエリプロパティを使用した.NET MAUIシェルナビゲーションが常にページをロードするとは限りません](https://stackoverflow-com.translate.goog/questions/76095594/net-maui-shell-navigation-with-query-property-not-always-loading-pages?_x_tr_sl=en&_x_tr_tl=ja&_x_tr_hl=ja&_x_tr_pto=sc)  

---

## Preferrence

MAUIのグローバルストレージ的なモノらしい。  

[.NET MAUI で設定を保存する(Preferences) | 開発者のごみ箱](https://developers-trash.com/archives/1249)  

---

## MAUIでappsettings.jsonを使う

``` cs : MauiProgram.cs
public static class MauiProgram
{
    public static MauiApp CreateMauiApp()
    {
        var builder = MauiApp.CreateBuilder();
        builder
            .UseMauiApp<App>()
            .ConfigureFonts(fonts =>
            {
                fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
            });

        builder.Services.AddTransient<MainPage>();

        using var stream = Assembly.GetExecutingAssembly().GetManifestResourceStream("projectname.appsettings.json");
        var config = new ConfigurationBuilder()
            .AddJsonStream(stream)
            .Build();
        builder.Configuration.AddConfiguration(config);
        return builder.Build();
    }
}

public class Settings
{
    public int KeyOne { get; set; }
    public bool KeyTwo { get; set; }
    public NestedSettings KeyThree { get; set; } = null!;
}

public class NestedSettings
{
    public string Message { get; set; } = null!;
}
```

``` cs
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;

public partial class MainPage : ContentPage
{
    int count = 0;
    IConfiguration configuration;
    public MainPage(IConfiguration config, ILogger<MainPage> logger)
    {
        InitializeComponent();

        configuration = config;
        logger.LogInformation("Test");
        //configuration = MauiProgram.Services.GetService<IConfiguration>();
    }

    private async void OnCounterClicked(object sender, EventArgs e)
    {
        count++;
        CounterLabel.Text = $"Current count: {count}";

        SemanticScreenReader.Announce(CounterLabel.Text);

        var settings = configuration.GetRequiredSection("Settings").Get<Settings>();
        await DisplayAlert("Config", $"{nameof(settings.KeyOne)}: {settings.KeyOne}" +
            $"{nameof(settings.KeyTwo)}: {settings.KeyTwo}" +
            $"{nameof(settings.KeyThree.Message)}: {settings.KeyThree.Message}", "OK");
    }
}
```

[App Configuration Settings in .NET MAUI (appsettings.json) - James Montemagno](https://montemagno.com/dotnet-maui-appsettings-json-configuration/)  
[GitHub - jamesmontemagno/dotnet-maui-configuration: How to use appsettings.json in .NET MAUI](https://github.com/jamesmontemagno/dotnet-maui-configuration)  

---

## VersionTracking

VersionTracking.CurrentVersionは、アプリケーションの現在のバージョン番号を返すメソッド。  
アプリケーションが最後に起動したときのバージョンを参照する。  
Platformsフォルダの各プラットフォームのそれぞれのファイルに記述されている。  

- Android  
  - AndroidManifest.xml内のandroid:versionName属性  
- iOS  
  - Info.plistファイルのCFBundleShortVersionStringキー  
- Windows  
  - Package.appxmanifestファイルのIdentity Version属性  

[Xamarin.Essentials VersionTracking を使用して、アプリの新機能をユーザーにアピールする - YouTube](https://www.youtube.com/watch?v=-2JlbepO_Mc)  

---

## Login Flow

ローディングページ方式 その1  
[Login Flow .Net MAUI by Abhay Prince - YouTube](https://www.youtube.com/watch?v=97G-XkuENYE)  

ローディングページ方式 その2  
[Creating a login flow with Xamarin Forms Shell - Mark's Blog](https://mallibone.com/post/xamarin-forms-shell-login)  

ローディングページ方式 その3  
[Building a login flow with .NET MAUI](https://www.c-sharpcorner.com/blogs/building-a-login-flow-with-net-maui)  

>App.xaml.csで`MainPage = new AppShell();`を見つけることをお勧めします。  
>そこで、認証されないときは、`MainPage = new LoginPage();`とします。  
>ログインに成功したら、適当なLoginPageメソッドで、`Application.Current.MainPage = new AppShell();`として、AppShellを起動する。  
>これで、ログイン処理とappshellが分離されます。  
>Xamarinと似ているので、xamarin shell login pageでググると例が見つかると思います。  
[app shell - Maui AppShell - Navigate on Open - Stack Overflow](https://stackoverflow.com/questions/73488406/maui-appshell-navigate-on-open)  

<!--  -->
>LoginPageをAppShellに取り込む。  
>
>1. AppのMainPageとしてAppShellを設定する。  
>2. AppShellに2つのTabbarを配置し、LoginPageをHomePageよりも先に配置し、2つのTabbarに異なるRouteを設定する。  
>
>AppShellにLoginPageを含めない。  
>
>1. まず、LoginPage を App の MainPage として設定します。  
>2. ログイン時はMainPage = new AppShell()、ログアウト時はMainPage = new LoginPage()を呼び出します。  
[c# - Xamarin forms shell getting confused with Login screen not navigating to home content - Stack Overflow](https://stackoverflow.com/questions/69653569/xamarin-forms-shell-getting-confused-with-login-screen-not-navigating-to-home-co)  

非同期の初期化を可能にし、初期化が完了するまでLoading Pageを使用する方式  
[app shell - Navigate to page on start in .NET Maui app - Stack Overflow](https://stackoverflow.com/questions/73840141/navigate-to-page-on-start-in-net-maui-app)  

ログイン処理のフローチャート  
[Login Flow in Xamarin.Forms Shell | Damir's Corner](https://www.damirscorner.com/blog/posts/20201030-LoginFlowInXamarinFormsShell.html)  

---

## Popup

ロード中のポップアップサンプル  
[Creating a Spinner Popup for .NET MAUI - Andreas Nesheim](https://www.andreasnesheim.no/creating-a-spinner-popup-for-net-maui/)
[GitHub - andreas-nesheim/SpinnerPopup: Sample code for how to create a spinner popup in .NET MAUI using the .NET MAUI Community Toolkit.](https://github.com/andreas-nesheim/SpinnerPopup)  

[【.NET MAUI】ポップアップをカスタマイズする方法を紹介（MVVM）](https://marunaka-blog.com/net-maui-customization-popup-mvvm/7493/)  

---

## AndroidでHTTP通信を許可する

`AndroidManifest.xml`に`android:usesCleartextTraffic="true"`を追加する。  
お手軽だが、あまりよろしくない模様。  

``` xml
<?xml version="1.0" encoding="utf-8"?>
<manifest ... >
    <application android:usesCleartextTraffic="true"
                    ... >
        ...
    </application>
</manifest>
```

[Android 9でHTTP通信を有効にする方法 | backport](https://backport.net/blog/2018/12/27/how_to_allow_http_on_android_9/)  

---

## Gesture Recognise

LabelでもTapした時にCommandを受け取ることができる。  

パターン1

``` xml
<Label GestureRecognizers="{TapGestureRecognizer Command={Binding HogeCommand}}"/>
```

パターン2

``` xml
<Label>
    <Label.GestureRecognizers>
        <TapGestureRecognizer Command="{Binding HogeCommand}"/>
    </Label.GestureRecognizers>
</Label>
```

[c# - Gesture Recognisers using MVVM in .NET MAUI/Xamarin.Forms - Stack Overflow](https://stackoverflow.com/questions/72359980/gesture-recognisers-using-mvvm-in-net-maui-xamarin-forms)  

---

## 画像のバインド

文字列で行ける。

``` xml
<Image Source="{Binding CreditLogo}"/>
```

``` cs
[ObservableProperty]
public ImageSource _creditLogo = "credit.png";
```

[Setting image source in view model in .NET MAUI app - Stack Overflow](https://stackoverflow.com/questions/75692776/setting-image-source-in-view-model-in-net-maui-app)  

---

## MAUIのデータストア

[.NET MAUI (データストア) - Qiita](https://qiita.com/kashin777/items/03bcfa6c0f17178911e2)  

---

## Builderへの個別登録例

ダラダラ書くよりメリハリがついていいかも。

``` cs
public static MauiAppBuilder RegisterViews(this MauiAppBuilder builder) 
{
    builder.Services.AddSingleton<AppShell>();
    builder.Services.AddSingleton<MainPage>();
    builder.Services.AddSingleton<PdfViewPage>();

    return builder;
}

public static MauiAppBuilder RegisterViewModels(this MauiAppBuilder builder)
{
    builder.Services.AddSingleton<AppShellViewModel>();
    builder.Services.AddSingleton<MainPageViewModel>();
    builder.Services.AddSingleton<PdfViewPageViewModel>();

    return builder;
}
```

[.NET MAUI - Basic Navigation](https://davek.dev/net-maui-basic-navigation)  

---

## QRコードの生成

QRCoderというライブラリで実現出来た。  

```xml
    <Image Source="{Binding QrImage}" />
```

``` cs
    [ObservableProperty]
    public ImageSource _qrImage;

    [RelayCommand]
    public async Task Loaded()
    {
        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(value, QRCodeGenerator.ECCLevel.L);
        PngByteQRCode qRCode = new PngByteQRCode(qrCodeData);
        byte[] qrCodeBytes = qRCode.GetGraphic(20);
        QrImage = ImageSource.FromStream(() => new MemoryStream(qrCodeBytes));
    }
```

[.Net MAUI - QR Code Generator](https://www.c-sharpcorner.com/article/net-maui-qr-code-generator/)  
