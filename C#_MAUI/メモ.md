# MAUIメモ

---

## Publisher/Subscriber Pattern ・ Prism EventAggregator

MauiはデフォルトでPublisher/Subscriberパターンを実装している模様。  

``` cs
protected override void OnNavigating(ShellNavigatingEventArgs args)
{
    base.OnNavigating(args);

    if (args.Target.Location.OriginalString.Contains("VariantPage1"))
    {

        MessagingCenter.Send<AppShell, string>(this, "Hi", "Test1");
    }

    if (args.Target.Location.OriginalString.Contains("VariantPage2"))
    {
        MessagingCenter.Send<AppShell, string>(this, "Hi", "Test2");
    }
}
```

``` cs
[ObservableProperty]
private string side = "Left";

public VariantViewModel(ConfigurationService service)
{
    this.configService = service;
    LoadWidgets();
    MessagingCenter.Subscribe<AppShell, string>(this, "Hi", (sender, arg) =>
    {
        Side = arg;
    });
}
```

[c# - C# - クエリプロパティを使用した.NET MAUIシェルナビゲーションが常にページをロードするとは限りません](https://stackoverflow-com.translate.goog/questions/76095594/net-maui-shell-navigation-with-query-property-not-always-loading-pages?_x_tr_sl=en&_x_tr_tl=ja&_x_tr_hl=ja&_x_tr_pto=sc)  

---

## VersionTracking

VersionTracking.CurrentVersionは、アプリケーションの現在のバージョン番号を返すメソッド。  
アプリケーションが最後に起動したときのバージョンを参照する。  
Platformsフォルダの各プラットフォームのそれぞれのファイルに記述されている。  

- Android  
  - AndroidManifest.xml内のandroid:versionName属性  
- iOS  
  - Info.plistファイルのCFBundleShortVersionStringキー  
- Windows  
  - Package.appxmanifestファイルのIdentity Version属性  

[Xamarin.Essentials VersionTracking を使用して、アプリの新機能をユーザーにアピールする - YouTube](https://www.youtube.com/watch?v=-2JlbepO_Mc)  

---

## Login Flow

ローディングページ方式 その1  
[Login Flow .Net MAUI by Abhay Prince - YouTube](https://www.youtube.com/watch?v=97G-XkuENYE)  

ローディングページ方式 その2  
[Creating a login flow with Xamarin Forms Shell - Mark's Blog](https://mallibone.com/post/xamarin-forms-shell-login)  

ローディングページ方式 その3  
[Building a login flow with .NET MAUI](https://www.c-sharpcorner.com/blogs/building-a-login-flow-with-net-maui)  

>App.xaml.csで`MainPage = new AppShell();`を見つけることをお勧めします。  
>そこで、認証されないときは、`MainPage = new LoginPage();`とします。  
>ログインに成功したら、適当なLoginPageメソッドで、`Application.Current.MainPage = new AppShell();`として、AppShellを起動する。  
>これで、ログイン処理とappshellが分離されます。  
>Xamarinと似ているので、xamarin shell login pageでググると例が見つかると思います。  
[app shell - Maui AppShell - Navigate on Open - Stack Overflow](https://stackoverflow.com/questions/73488406/maui-appshell-navigate-on-open)  

<!--  -->
>LoginPageをAppShellに取り込む。  
>
>1. AppのMainPageとしてAppShellを設定する。  
>2. AppShellに2つのTabbarを配置し、LoginPageをHomePageよりも先に配置し、2つのTabbarに異なるRouteを設定する。  
>
>AppShellにLoginPageを含めない。  
>
>1. まず、LoginPage を App の MainPage として設定します。  
>2. ログイン時はMainPage = new AppShell()、ログアウト時はMainPage = new LoginPage()を呼び出します。  
[c# - Xamarin forms shell getting confused with Login screen not navigating to home content - Stack Overflow](https://stackoverflow.com/questions/69653569/xamarin-forms-shell-getting-confused-with-login-screen-not-navigating-to-home-co)  

非同期の初期化を可能にし、初期化が完了するまでLoading Pageを使用する方式  
[app shell - Navigate to page on start in .NET Maui app - Stack Overflow](https://stackoverflow.com/questions/73840141/navigate-to-page-on-start-in-net-maui-app)  

ログイン処理のフローチャート  
[Login Flow in Xamarin.Forms Shell | Damir's Corner](https://www.damirscorner.com/blog/posts/20201030-LoginFlowInXamarinFormsShell.html)  

---

## Popup

ロード中のポップアップサンプル  
[Creating a Spinner Popup for .NET MAUI - Andreas Nesheim](https://www.andreasnesheim.no/creating-a-spinner-popup-for-net-maui/)
[GitHub - andreas-nesheim/SpinnerPopup: Sample code for how to create a spinner popup in .NET MAUI using the .NET MAUI Community Toolkit.](https://github.com/andreas-nesheim/SpinnerPopup)  

[【.NET MAUI】ポップアップをカスタマイズする方法を紹介（MVVM）](https://marunaka-blog.com/net-maui-customization-popup-mvvm/7493/)  

---

## Gesture Recognise

LabelでもTapした時にCommandを受け取ることができる。  

パターン1

``` xml
<Label GestureRecognizers="{TapGestureRecognizer Command={Binding HogeCommand}}"/>
```

パターン2

``` xml
<Label>
    <Label.GestureRecognizers>
        <TapGestureRecognizer Command="{Binding HogeCommand}"/>
    </Label.GestureRecognizers>
</Label>
```

[c# - Gesture Recognisers using MVVM in .NET MAUI/Xamarin.Forms - Stack Overflow](https://stackoverflow.com/questions/72359980/gesture-recognisers-using-mvvm-in-net-maui-xamarin-forms)  

---

## Builderへの個別登録例

ダラダラ書くよりメリハリがついていいかも。

``` cs
public static MauiAppBuilder RegisterViews(this MauiAppBuilder builder) 
{
    builder.Services.AddSingleton<AppShell>();
    builder.Services.AddSingleton<MainPage>();
    builder.Services.AddSingleton<PdfViewPage>();

    return builder;
}

public static MauiAppBuilder RegisterViewModels(this MauiAppBuilder builder)
{
    builder.Services.AddSingleton<AppShellViewModel>();
    builder.Services.AddSingleton<MainPageViewModel>();
    builder.Services.AddSingleton<PdfViewPageViewModel>();

    return builder;
}
```

[.NET MAUI - Basic Navigation](https://davek.dev/net-maui-basic-navigation)  

---

## QRコードの生成

QRCoderというライブラリで実現出来た。  

```xml
    <Image Source="{Binding QrImage}" />
```

``` cs
    [ObservableProperty]
    public ImageSource _qrImage;

    [RelayCommand]
    public async Task Loaded()
    {
        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(value, QRCodeGenerator.ECCLevel.L);
        PngByteQRCode qRCode = new PngByteQRCode(qrCodeData);
        byte[] qrCodeBytes = qRCode.GetGraphic(20);
        QrImage = ImageSource.FromStream(() => new MemoryStream(qrCodeBytes));
    }
```

[.Net MAUI - QR Code Generator](https://www.c-sharpcorner.com/article/net-maui-qr-code-generator/)  
