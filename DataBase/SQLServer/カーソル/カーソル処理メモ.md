# カーソル処理メモ

---

## カーソルは既に存在します

カーソル宣言部分に`LOCAL`キーワードを追加することで解決できる。  

`DECLARE [CUR_NAME] CURSOR LOCAL FOR`  

原因としてはカーソルのスコ―プ範囲が上手く設定できていないためらしい。  
同一名のカーソルが宣言されたままになっている状態っぽいので、スコープ範囲をローカルに明記することで対応する。  

[【SQL Server】カーソルは既に存在しますの対応](http://lifesiz.com/adsense/?p=215)  

---

## カーソル処理のIF EXISTS

[テーブルなどのデータベースオブジェクトの存在確認](https://johobase.com/exists-database-object-sqlserver/#IF_EXISTS_ELSE)  
[Using cursor to update if exists and insert if not](https://dba.stackexchange.com/questions/218994/using-cursor-to-update-if-exists-and-insert-if-not)  

カーソル処理の `IF EXISTS ELSE` には閉じる構文がない。  
ELSE以降のNEXT FETCHがELSEでしか実行されないことを心配したが大丈夫であることを確認できた。  
とりあえずBEGIN ENDで処理を囲めばよいらしい。  

``` sql : 実際にうまくいった例
    -- カーソル定義
    DECLARE myCursor CURSOR FOR 
    SELECT ~~ FROM ~~ WHERE ~~

    -- カーソルオープン
    OPEN myCursor

    -- カーソルから変数に値をいれて、次のカーソルを参照
    FETCH NEXT FROM myCursor INTO @~~

    BEGIN
        -- 存在したらUPDATE
        IF EXISTS(SELECT ~~ FROM ~~ WHERE ~~)
            -- IFの処理
            BEGIN
                UPDATE ~~
                SET ~~
            END
        -- 存在しなければINSERT
        ELSE
            -- ELSEの処理
            BEGIN
                INSERT INTO ~~
            END

        -- if文外で実行したい場合はここにBEGIN ENDで囲って書くと実行される。
        BEGIN
            INSERT INTO ~~
        END
    END
    
    -- カーソルを次に進める。
    FETCH NEXT FROM myCursor4 INTO @~~
```

---

## WHILEループ

``` SQL : WHILEの書き方
WHILE *ループ継続条件*
BEGIN
    *繰り返し実行したいコード*
END
-- ループ内でBREAKEが実行されるとループを抜けます。
-- ループ内でCONTINUEが実行されるとループの先頭に戻ります。
```

``` SQL : WHILE 10回ループ
--変数宣言&初期化
DECLARE @index INTEGER = 0

WHILE @index < 10
BEGIN
    --ループ用変数をインクリメント
    SET @index = @index + 1
    PRINT @index
END
```

``` SQL : 10回ループ(BREAKでループを抜ける)(まぁつかわんやろ)
--変数宣言&初期化
DECLARE @index INTEGER = 0

WHILE 1=1
BEGIN
    --ループ用変数をインクリメント
    SET @index = @index + 1
    IF @index > 10
        BEGIN
            --ループ終了
            BREAK
        END
    PRINT @index
END
```

[SQL Server - WHILEによるループ(T-SQL)](https://www.curict.com/item/bb/bb80194.html)  
