# トランザクションメモ

## TransactionはTryの前で行うべきか後に行うべきか

昔、Tryの前にTransactionを実行してエラーとなり、トランザクションが開いたままになった記憶がある。  
教科書やほとんどの例ではTry Catchの内部でBegin Tranしている。  
では、Tryの前にBegin Tranする事は何がいけないのか調べた。  
全然そんな文献に当たらない。  

でもって実際に実行してみたが、特にトランザクションが開きっぱなしになるような事もない。  
どちらでもいいのだろうか。  

``` sql
BEGIN TRANSACTION

BEGIN TRY
    SELECT 1/0
    COMMIT TRANSACTION
END TRY

BEGIN CATCH
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage

    ROLLBACK TRANSACTION
    PRINT 'Error detected, all changes reversed.'
END CATCH
```

[開発備忘録＆ふと思ったこと](https://memo.itsysgroup.com/?p=1359)  
こちらのサイトでも同じようなことをしているが、やはり問題なくロールバックされる模様。  
この書き方で駄目だったのは別の要因であって、書き方の順番ではなかった？  
普通に考えれば、先にトランザクションを開始してからエラーキャッチを行うか、エラーキャッチを行った後にトランザクションを開始するかの違いでしかなく、これくらい小さなバッチではトランザクションを開始した時点でバッチ全てがトランザクションの対象になるから、順番なんてあまり関係ないのだろうか。  
多分そうだと思う。  

[TSQL Try / Catch within Transaction or vice versa?](https://stackoverflow.com/questions/23056973/tsql-try-catch-within-transaction-or-vice-versa)  
