# SQLServer 任意の位置に列を追加する構文

---

## 概要

SQLServerManagementStudio でならデザイナで任意の場所に列を追加することが可能。  

T-SQL(Transact-SQL)でやる場合、そのようなコマンドは存在しないので以下のような手順を踏んでフィールドを追加する必要あり。  
そもそも、MySQL以外のデータベースではカラム追加時の位置指定が軒並み不可能な模様。  

[浦下.com](https://urashita.com/archives/13652)  

---

## パターン1クエリ

1. テーブルをバックアップ  
2. テーブルを削除  
3. テーブルを再作成  
4. 再作成したテーブルにバックアップからリストア  

``` SQL : パターン1
BEGIN TRAN
BEGIN TRY
    -- ①対象テーブルのデータをテンポラリテーブルにバックアップ
    SELECT * INTO #Temp FROM TBL_USER

    -- ②対象テーブルを削除
    DROP TABLE TBL_USER

    -- ③カラムを追加して対象テーブルを再作成
    CREATE TABLE TBL_USER
    (
        UserNo int NOT NULL DEFAULT (0),
        Name nvarchar(255) NOT NULL DEFAULT (),
        Age int NOT NULL DEFAULT (0),
        Addr nvarchar(255) NOT NULL DEFAULT (),
        Tel nvarchar(255) NOT NULL DEFAULT (),
        CONSTRAINT TBL_USER_PK PRIMARY KEY CLUSTERED (UserNo)
    )
    -- コメントも必要に応じて入れる
    EXECUTE sp_addextendedproperty N'MS_Description', N'コード', N'SCHEMA', N'dbo', N'TABLE', N'Src_Table', N'COLUMN', N'Code'

    -- ④テンポラリテーブルからバックアップデータを復元
    INSERT INTO TBL_USER
    SELECT
        UserNo,
        [Name],
        0,
        Addr,
        Tel
    FROM #Temp

    -- ⑤テンポラリテーブルを削除
    DROP TABLE #Temp

    COMMIT TRAN
END TRY
BEGIN CATCH
    ROLLBACK TRAN
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage
END CATCH
```

---

## パターン2クエリ

1. 新テーブルの作成  
2. 新テーブルへデータ投入  
3. 元テーブルの削除  
4. 新テーブルをリネームして元テーブル名に変更  
5. 主キーの作成  
6. コメントの作成等  

この構文の場合、テーブルを作った地点で主キーを設定した場合何か弊害があるのだろうか？
できるなら作ってしまったほうが手間が省けてよさそうに見えるが？  
後、コメントもテーブル作ったタイミングでできないか？  
テーブル名を変更した時、コメントも影響受けるのだろうか？  
そこもしっかり把握していくか。  

テーブルを生成した地点で主キーを設定しても問題ない。  
テーブル名を変更しても問題なく主キーが有効であった。  
コメントはテーブル名を指定しないといけないので、元のテーブルが新しくなった後にやらないと駄目なので、テーブル生成と同じタイミングでやるならテーブル名を全部書き換えないといけない。  
それをやっていいなら生成と同時にできるけど、そうじゃないなら最後にやるべし。  

``` sql : パターン2
BEGIN TRAN
BEGIN TRY
    -- ①新テーブルの作成
    CREATE TABLE [Dst_Table] (
        filed,
        ~~~~,
        CONSTRAINT Dst_Table_PKC PRIMARY KEY CLUSTERED (Code)
    )

    -- ②新テーブルへデータ投入
    INSERT INTO [Dst_Table]([filed1],[filed2]...)
    SELECT [filed] FROM [Src_Table]

    -- ③元テーブルの削除
    DROP TABLE [Src_Table]

    -- ④新テーブルをリネームして元テーブル名に変更
    EXEC sp_rename 'Dst_Table', 'Src_Table';

    -- ⑤コメントの作成等
    EXECUTE sp_addextendedproperty N'MS_Description', N'コード', N'SCHEMA', N'dbo', N'TABLE', N'Src_Table', N'COLUMN', N'Code'

    COMMIT TRAN
END TRY
BEGIN CATCH
    ROLLBACK TRAN
    SELECT
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage
END CATCH
```

---

## 一番最後に列を追加する

一番最後に列を追加するのは当たり前なので割愛するが、コマンドはこんな感じ。

``` sql : TBK_USERに年齢カラムを追加するクエリ
ALTER TABLE TBL_USER ADD Age int DEFAULT 0
```
