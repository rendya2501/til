# マイグレーション2

散らばってきたので新規作成

---

## DatabaseProject

### 概要

>データベースプロジェクトとはVisualStudio 2010 の標準プロジェクトテンプレートです。
機能は  
・データベースをバージョン管理できる  
・他の人が変更した内容を、自分のローカル環境に簡単に反映できる  
・配置済のデータベースと、プロジェクトのデータベースの差分をスクリプトとして生成してくれたりする  
・etc...  
などがあります。  
[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  

<!--  -->
>データベースプロジェクトは、Visual Studio.NETプロジェクトの特殊なタイプです。  
その目的は、SQLデータベーススクリプトを作成し、管理することです。  
Visual Studio.NETでデータベーアプリケーションを開発する場合、データ ベースでの作業をより簡単かつ迅速にするためのツールについて知っておくとよいでしょう。  
[Visual Studio.NET Database Projects](https://www.pearsonhighered.com/assets/samplechapter/0/6/7/2/0672323435.pdf)  

---

### スクリプトを実行した後のバージョン確認

`データ層アプリケーション`として登録して `select * from msdb.dbo.sysdac_instances` することで、データベース プロジェクト プロパティで指定されたものと同じバージョン番号を含むレコードが作成されます。  

``` sql
select * from msdb.dbo.sysdac_instances
```

<https://marcin.gminski.net/blog/database-development-in-visual-studio/>  

---

>■**問題**
>チーム内でのデータベース管理に、データベースプロジェクトを利用しています。  
>
>ですが、よくあるマスタデータの挿入については、手作業で管理をしていました。  
>Insert文を書いたクエリファイルを、共有フォルダに置くなり、メールに添付するなりして、「このファイル実行しておいてねー」とチームで共有していました…。  
>
>これでは実行が面倒ですし、新しくデータベースを作成する際に、手間がかかります。  
>マスタデータなどの重要なスクリプトが、バージョン管理されていないのも問題です。  
>
>■**解決方法**  
>データベースプロジェクトには、最初から配置前・配置後スクリプトが準備されています。(中身は空です。)  
>その配置後スクリプトに、マスタデータ挿入スクリプトを追加します。  
>これで、バージョン管理が可能になり、配置の際にスクリプトを実行してくれます。  
>
>[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  

---

[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  
[Top Features in SQL Server Data Tools for Database Projects](https://www.mssqltips.com/sqlservertip/6749/ssdt-top-features-database-projects/)  
[DATABASE DEVELOPMENT IN VISUAL STUDIO](https://www.mssqltips.com/sqlservertip/6749/ssdt-top-features-database-projects/)  
[Best Practices for multi-environment database development](https://sqlbits.com/Sessions/Event14/Best_Practices_for_multi-environment_database_development_in)  

---

### 実行前スクリプト・実行後スクリプト

>チーム内でのデータベース管理に、データベースプロジェクトを利用しています。  
>
>ですが、よくあるマスタデータの挿入については、手作業で管理をしていました。  
>Insert文を書いたクエリファイルを、共有フォルダに置くなり、メールに添付するなりして、
>「このファイル実行しておいてねー」とチームで共有していました…。  
>
>これでは実行が面倒ですし、新しくデータベースを作成する際に、手間がかかります。  
>マスタデータなどの重要なスクリプトが、バージョン管理されていないのも問題です。  

[データベースプロジェクトにて、非スキーマスクリプトを管理する方法](https://miso-soup3.hateblo.jp/entry/20120423/1335171924)  

---

### what register as a data-tire application

[SQL Server のデータ層アプリケーションの概要](https://www.sqlshack.com/an-introduction-to-data-tier-applications-in-sql-server/)  

---

## DbUp

フォルダにスクリプトまとめて、実行されていないスクリプトを判定して実行してくれる。  
Azure DevOpsからCI/DIの設定が可能。  
C#でコマンドラインツールを作って実行する形になる。  
コードを自分たちで生成できるので、条件判定など入れやすいかも。  

[DbUp_Document](https://dbup.readthedocs.io/en/latest/)  
[Getting Started With DbUp And Setting Up Azure DEVOPS Pipeline | Deploy Changes to SQL Server](https://www.youtube.com/watch?v=Jm4C-WzAdls)  

[Database Migrations with DbUp](https://counihan.co.za/blog/Database-Migrations-with-DbUp/)  
[jonathancounihan/dbup-database-migrations](https://github.com/jonathancounihan/dbup-database-migrations/blob/master/DBMigrate/Program.cs)  

[Database change management](http://www.kamilgrzybek.com/database/database-change-management/)  
[Using Database Project and DbUp for database management](http://www.kamilgrzybek.com/database/using-database-project-and-dbup-for-database-management/)  

[Converting a Visual Studio database project to use DbUp migrations](https://dasith.me/2020/06/08/database-project-conversion-to-migrations/)  

---

## Evolve

>■**概要**
>プレーンな SQL スクリプトを使用する、 Flywayに触発されたクロスプラットフォームのデータベース移行ツール  
>
>目的は、データベースの変更を自動化し、すべての環境と開発チームを通じてそれらの変更を同期させることです。  
>これにより、継続的な統合/配信のための理想的なツールになります。  
>
>全体的に Evolve はシンプルさを取り入れています。  
>プロジェクトを実行するたびに、データベースが最新であることを自動的に確認します。  
>それをインストールして忘れてください！  

<!--  -->
>■
>.NET プロジェクトで、データベース スキーマをすべての環境で最新の状態に保つ最も簡単な方法は、SQL 移行スクリプトをアセンブリと共に配置し、起動時に Evolve を実行することです。
>このようにして、デプロイされたアプリケーションは自動的に移行を適用し、データベース スキーマ バージョンと常に同期します。

[Evolve_github](https://github.com/lecaillon/Evolve)  
[Evolve_document](https://evolve-db.netlify.app/)

---

## マイグレーションについての良記事

[Database Migrations In .NET Core](https://dotnetcoretutorials.com/2017/02/25/database-migrations-net-core/)  

[Database versioning best practices](https://enterprisecraftsmanship.com/posts/database-versioning-best-practices/)  
[State vs migration-driven database delivery](https://enterprisecraftsmanship.com/posts/state-vs-migration-driven-database-delivery/)
[Database versioning tools](https://enterprisecraftsmanship.com/posts/database-versioning-tools/)  

>1.データが失われないことを確認してください
>2.スクリプトを変更または削除しないでください
>3. バージョン管理にタイムスタンプを使用する
>4. 適切な DSL を使用する
>5. 移行ツール以外でデータベースの変更を行わないでください
>6. 選択した移行ツールを使用して、データベースをどこにでも展開します
>7. 移行を書き留めて時間を無駄にしない
>8.アプリケーションの起動時に移行するのは悪い考えです
>9. 移行を Docker 化する
>10. ビジネス担当者と移行について話すことを恐れないでください
>
>[Database migrations tips(データベース移行のヒント)](https://mcode.it/blog/2020-03-15-database_migrations_tips/)  
