# ジョブスケジューリング

---

## cron

スケジュールを定義したコマンドを定期的に実行するプログラム。  
DAEMONとも呼ばれる。  

定期的にジョブを実行するcronはスケジュールを管理するデーモンである**crond**と、スケジューリングを編集する**crontabコマンド**から構成される。  
crondデーモンは1分ごとにcrontabファイルを調べて実行すべきスケジュールが存在すればそのジョブを実行する。  

crondデーモン  
RedHat系 :: /usr/sbin/crond  
Debian系 :: /usr/sbin/cron  

システム保守のためのコマンドの定期実行はcronから起動されるanacronによって行われる。  

---

## crontabコマンド

コマンドの定時実行のスケジュール管理を行うために用いられるコマンド。  
標準入力からコマンド列を読み取り、crontabと呼ばれるファイルにそれを記録する。  

crontabコマンドで設定するのは`var/spool/cron/ユーザー名ファイル`。  
ユーザーのcrontabファイルは`var/spool/cron/`ディレクトリ以下に置かれる。  

studentユーザーの場合  
`/var/spool/cron/student` or `var/spool/cron/crontabs/student`  

crontabファイルは直接編集してはいけない。  
crontabコマンドを使用して編集する。  
起動されるエディタは環境変数EDITORに設定されているエディタ。  

``` txt
crontab [オプション]

オプション
-e(edit)      :: エディタを使ってcrontabファイルを編集する
-l(list)      :: crontabファイルの内容を表示する
-r(remove)    :: crontabファイルを削除する
-i            :: crontabファイル削除時に確認する
-u ユーザー名 :: ユーザーを指定してcrontabファイルを編集する。(rootユーザーのみ可)
```

---

## crontabファイル

crontabファイルでは1行ごとに、自動的に実行するコマンドおよびその実行日時を指定します。
なので1つの設定の識別に必要なのは**改行**。  

```txt : 構成とフィールド
書式 :: [分] [時] [日] [月] [曜日] [実行ユーザー名(システム用設定ファイルでのみ指定)] [コマンド]

分 :: 0~59までの整数
時 :: 0~23までの整数
日 :: 1~31までの整数
月 :: 1~12までの整数、もしくはjan~decまでの文字列
曜日 :: 0~7までの整数( 1=月、2=火、3=水、4=木、5=金、6=土、7と0 =日) もしくはSun,Monなどの文字列
コマンド :: 実行すべきコマンド

「#」がある行はコメント。
「*」はすべての値にマッチする。
「-」範囲の指定。「時」に「1-3」と指定すると、1時から3時までを意味する。
複数の値を指定する場合は「,」で区切る。「時」に「1,2,3」と指定すると、1時,2時,3時を意味する。
間隔の指定。「時」に「1-7/2」と指定すると、1時から7時の間で2時間おきを意味する。
2分事や2時間毎などの間隔の指定は「*/2」のように記述する。
```

毎日23:15に`usr/local/bin/backup`プログラムを実行する。  

``` txt
# Daily Backup
15 23 * * * /usr/local/bin/backup
```

毎週月曜日の9時と12時に`/usr/local/bin/syscheck`プログラムを実行する。  

```txt
#weekly System Check
0 9,12 * * 1 /usr/local/bin/syscheck
```

2時間ごとに`/usr/local/bin/syscheck`プログラムを実行する。  
`0 */2 * * * /usr/local/bin/syscheck`  

---

## systemのcrontab

システム用のcrontabファイル(`/etc/crontab`)では、そこから`/etc/cron.*`ディレクトリに置かれたファイルを呼び出すようになっており、  
`/etc/crontab`ファイルには実行するユーザー名を指定するフィールドが加わる。  

・「/etc/crontab」はシステム用の設定ファイルである  
・「/etc/crontab」にはコマンドの実行ユーザも指定する  

変数はvi等のテキストエディタで行う。  
設定ファイルで指定したユーザーの権限で実行(主にrootユーザー)  

``` txt
書式 :: 分 時 日 月 曜日 ユーザー コマンド  

cronで定期的に実行するジョブを格納するディレクトリ  
/etc/cron.hourly/ :: 毎時定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.daily/ :: 毎日定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.monthly/ :: 毎月定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.weekly/ :: 毎週定期的に実行するジョブのスクリプトを格納したディレクトリ  
/etc/cron.d/ :: 上記以外のジョブのスクリプトを格納したディレクトリ  

/etc/crontab :: システムのcrontabファイル。主にhourly,daily,weekly,monthlyの4つのディレクトリに置かれたスクリプトを実行する。  
/var/spool/cron/ or /var/spool/cron/crontabs/ :: ユーザーのcrontabファイルを収めたディレクトリ  
```

---

## atコマンド

1回限りの実行スケジュールを扱うコマンド。  
atコマンドによるスケジューリングを実施するには、atデーモン(atd)が動作している必要がある。  

atコマンドは対話式でコマンドを指定する。  
日時を指定すると入力モードになる。  
Ctrl + Dでコマンドの入力を終了する。  
あらかじめテキストファイルにコマンドを記述して起き、そのファイルを指定する方法もある。  

``` txt
1. at オプション
2. at [-f ファイル名] [日時]
※日時は基本的にHH:MMの形式で指定

オプション
-rジョブ番号 :: 指定した予約中のジョブを削除する(atrmコマンドと同じ)
-dジョブ番号 :: -rと同じ
-l :: 予約中のジョブを表示する(atqコマンドと同じ)
-f :: コマンドを記述したファイルを指定する。
```

``` txt : 明日の6:00に/usr/local/bin/backup.shプログラムを実行
at 6:00 tomorrow
at> /usr/local/bin/backup.sh
at> ^D
```

``` txt : testjobファイルにあらかじめコマンドを定義した例  
at -f testjob 15:00
```

``` txt : 書式例  
午後10時 :: 22:00 or 10pm  
正午 :: noon  
真夜中 :: midnight  
16:00 :: teatime  
今日 :: today  
明日 :: tomorrow  
3日後 :: now + 3 days  
2週間後の22:00 :: 10ps + 2 weeks  
```

---

## atrmコマンド

atのジョブを削除するコマンド。  
at -dと同じ動作をする。  

---

## atqコマンド

atのジョブのスケジュールを一覧で表示するコマンド。  
at -lと同じ動作をする。  

---

## cronコマンドのアクセス制御

`/etc/cron.allow` :: cronの利用を許可するユーザーを記述する。  
`/etc/cron.deny` :: cronの利用を拒否するユーザーを記述する。  

① /etc/cron.allowファイルがあれば、そこに記述されたユーザーのみがcronを利用できる。/etc/cron.denyファイルは無視される。  
② /etc/cron.allowファイルが無ければ、/etc/cron.denyを参照し、/etc/cron.denyに記述されていないすべてのユーザーがcronを利用できる。  
③ /etc/cron.allowファイル、/etc/cron.denyファイルのどちらもない場合、すべてのユーザーがcronを利用可能。  
※最新バージョンでは、rootユーザーのみが利用可能。  
ping-tではrootユーザーのみ。白本では全てのユーザーがOKとのこと。  

初期状態では利用制限が行われていないため、すべてのユーザーが実行することができる。  

---

## atコマンドのアクセス制御

`/etc/at.allow` :: atの利用を許可するユーザーを記述する。  
`/etc/at.deny` :: atの利用を拒否するユーザーを記述する。  

① /etc/at.allowがあれば、そこに記述されたユーザーのみがatを利用できる。/etc/at.denyファイルは無視される。  
② /etc/at.allowが無ければ、/etc/at.denyを参照し、/etc/at.denyに記述されていないすべてのユーザーがatを利用できる。  
③ どちらのファイルも無ければ、rootユーザーだけがatを利用できる。  

初期状態では利用制限が行われていないため、すべてのユーザーが実行することができる。  
デフォルトで空の/etc/at.denyファイルがあり、すべてのユーザーがatコマンドを利用できるようになっている。  

設定例 : 「mike」と「ken」に対してatを利用可能にする設定  

``` bash
#vi /etc/at.allow
mike
ken
```

---

## で、結局違いは何なの？

どちらのファイルもなかった場合の挙動  
・cronはすべてOK。
・atはrootだけ。  

なのだが、最新ではrootだけって事になっているので、どっちもrootって応えて置けばいいかも。  

atは最初から/etc/at.denyファイルがある。  

---

## systemdによるスケジューリング

systemdのtimerユニットは、定期的に自動でジョブを実行するジョブスケジューラとしてcronの代わりに使用できます。  

timerユニットによるジョブ実行には以下のユニット定義作成が必要になります。  
・timerユニット :： ジョブの実行タイミング、実行するジョブを指定する。  
・ジョブ本体となるユニット :： timerユニットから呼び出され、処理を行うユニット。  
timerユニット以外のユニットが指定できるが、デフォルトではtimerユニットと同じ名前のserviceユニットが実行される（例：「foo.timer」の場合「foo.service」）  
timerユニットの定義ファイルの拡張子は.timer  
「/etc/systemd/system」に拡張子.timerの定義ファイルを作成し、`[Timer]`セクションに実行タイミングと実行するジョブを指定します。  

timerユニットとジョブ本体のユニットが別になっているので、ログの調査やジョブ本体のデバッグが容易になります。  

timerユニットの実行タイミング指定には2つの方法があります。  
・モノトニックタイマー :： cronのように、起動後はジョブを定期的に実行する  
・リアルタイムタイマー :： atのように、指定した実行日時にジョブを1度だけ実行する  

systemdにおいて、全ての有効なtimerユニットを表示するコマンド。  
`systemctl list-timers`

---

## systemd-runコマンド

systemdに置ける一時的なユニットを作成してジョブを実行するコマンド。  
timerユニットを設定するにはtimerユニットと対応するジョブ本体のユニットを作成したりと手間がかかりますが、  
systemd-runコマンドを使用することでより簡単にジョブをスケジューリングできます。  

ユニット名runtestで、毎日17時30分に「/tmp/test」プログラムを実行する。  
`systemd-run --unit==runtest --on-calendar="*-*-* 17:30:00" /tmp/test`

---

## batch

batchコマンドは、システムの負荷の少ないタイミングで指定した時間に1回だけコマンドを自動実行します。  
batchコマンドで設定されたジョブの管理は、atコマンドを使用して行います。  

「batch」コマンドを入力すると、プロンプトが「at>」に変わり、コマンドを入力できるようになるので、実行したいコマンドを入力して、最後にCtrl+Dで終了します。  
これは「at」コマンドの入力と同じです。  
ただし、時間指定ではなく、負荷が下がった時点で実行される点が違います。  

``` txt
batch [オプション]

-l :: 予約中のジョブを表示(atqコマンドと同様)
-d ジョブ番号 :: 指定した予約中のジョブを削除(atrmコマンドと同様)
```

``` sh : 負荷が下がると「IDLE」とコンソールに表示するジョブを設定
$ batch
at> echo "IDLE" > /dev/pts/0 ←実行するコマンドを指定
at> <EOT> ←Ctrl + Dで終了
job 1 at 2016-12-12 23:00
$ at -l ←ジョブの確認
1 2016-12-12 23:00
```
