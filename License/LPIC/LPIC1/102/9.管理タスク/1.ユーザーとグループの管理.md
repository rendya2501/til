# ユーザーとグループの管理

---

## /etc/passwd

ユーザーアカウント情報が格納されているファイル。  
パーミッションは`644(-rw-r--r--)`  
普通のファイルで、基本的に実行権はない。  

現在のシステムでは暗号化されたパスワード（シャドウパスワード）が使用されており、パスワード欄には「x」が入ります。  
この場合、パスワードは「/etc/shadow」ファイルに格納されます。  
「/etc/shadow」ファイルはrootユーザのみしか読み書きができません。  
なお、「/etc/passwd」ファイルのパーミッションは「644」で一般ユーザによる読み出し権限が付与されています。  
シャドウパスワードを利用することでセキュリティレベルが上がります。  

/etc/shadowファイルを使っているか否かに関わらず、/etc/passwdの第2フィールドに`*`あるいは`!`を指定すると、  
PAMの認証モジュールpam_unix.50は/etc/shadowの参照や暗号化パスワードとしての処理をせず、その時点でログインを拒否する。  
ログイン時に表示されるメッセージはパスワードを間違えた時と同じになる。  

``` txt : ファイルの書式と各項目の説明
ユーザ名：パスワード：UID：GID：コメント：ホームディレクトリ：ログインシェル

・ユーザ名           :: 一意のユーザ名
・パスワード         :: ユーザのパスワード。
・UID                :: ユーザのUID（ユーザID）。UIDはユーザを識別するための一意のID
・GID                :: ユーザのプライマリグループのGID（グループID）。GIDはグループを識別するための一意のID
・コメント           :: ユーザに関する任意のコメント（省略可）
・ホームディレクトリ :: ユーザのホームディレクトリ
・ログインシェル     :: ユーザのログインシェル（ログイン時に使用されるデフォルトのシェル）
```

---

## /etc/shadow

暗号化されているパスワード（シャドウパスワード）や、パスワードの有効期限に関する情報が格納されているファイル。  
パスワードにロックをかけると「/etc/shadow」の該当ユーザのパスワードフィールドの1文字目に「!」が追加されます。  

「/etc/shadow」ファイルのパーミッションには「400（r--------）」、「600（rw-------）」、「000（---------）」などがあり、  
ディストリビューションやバージョンによって異なります。いずれの場合もrootユーザのみが読み書き可能な設定です。  

「日数1」の部分で最終更新日が分かります。
よってユーザーパスワードの最終更新日が記録されているファイルは/etc/shadow  

``` txt : 書式と各項目の説明
ユーザ名：パスワード：日数1：日数2：日数3：日数4：日数5：日数6：フラグ

・ユーザ名   :: 一意のユーザ名（/etc/passwdと同様）
・パスワード :: 暗号化されたパスワード
・日数1      :: 1970/1/1から、パスワードが最後に更新された日までの日数
・日数2      :: パスワードが変更できるようになるまでの日数
・日数3      :: パスワードを変更しなければならなくなる日までの日数
・日数4      :: パスワードの有効期限切れる前に警告をだす日数
・日数5      :: パスワードの有効期限切れからアカウントが使用できなくなるまでの日数
・日数6      :: 1970/1/1から、アカウントが使用できなくなる日までの日数
・フラグ     :: 未使用
```

---

## 小話 パーミッション000

[パーミッション000](https://oshiete.goo.ne.jp/qa/6781290.html)  
>パーミッション000とは  
>・オーナー権限 読み込み不可・書き込み不可・実行不可  
>・グループ権限 読み込み不可・書き込み不可・実行不可  
>・他者権限 読み込み不可・書き込み不可・実行不可  
>ということです。  
>
>例えるならば、ハシゴを利用して屋根に上ったが、上ってきたハシゴを蹴り飛ばしてしまったような感じです。  
>自分ではどうすることも出来ず、別の人がハシゴをかけ直してくれるのを頼むしかありません。  

---

## /etc/nologin

一般ユーザのログインを禁止する際に使用するファイル。  

---

## /etc/group

グループに関する情報が格納されたファイル。  

現在のシステムでは暗号化されたパスワード（シャドウパスワード）が使用されており、パスワード欄には「x」が入ります。  
この場合、パスワードは「/etc/gshadow」ファイルに格納されます。  

「グループのメンバーリスト」には、補助グループ（supplementary groups）として所属しているユーザが設定されます。  
プライマリグループとして登録しているユーザは含まれません。  
したがって、所属メンバーがいても、記載されていない場合があります。  

``` txt : ファイルの書式と各項目の説明
グループ名:グループパスワード:GID:グループのメンバーリスト

・グループ名 :: 一意のグループ名
・グループパスワード :: グループのパスワード
・GID :: グループのGID
・グループのメンバーリスト :: グループに所属するメンバー。複数の場合は「,」で区切る
```

---

## useraddコマンド

ユーザーアカウントを作成するコマンド  

``` txt
useradd [オプション] ユーザー名

オプション
-c コメント :: コメントフィールドを指定する。
-d パス :: ホームディレクトリを指定する。
-g グループ名 / GID :: プライマリグループを指定する。
-G グループ名 / GID :: プライマリグループ以外に所属するグループを指定する。
-s パス :: デフォルトシェルを指定する。
-D :: デフォルトの設定値を表示もしくは設定する。
-m :: ホームディレクトリを自動的に作成する。
-p 暗号化済みのパスワード :: 暗号化済みのパスワードを設定する。
```

コメント、ホームディレクトリ、デフォルトシェルを指定して、新規ユーザーlinuxuserを作成する。  
`useradd -c "Linux User" -d /home/linux -s /bin/bash linuxuser`  

試験的に重要なオプションは-m。  

オプションを指定せずにユーザーを作成する際、使用されるデフォルトの値が格納されているファイル  
`/etc/default/useradd`  

ファイルの内容は`useradd -D`でも確認できる。  

---

## /etc/skelディレクトリ

ホームディレクトリのデフォルトファイルを置くディレクトリ  
ユーザーアカウントを作成したときに、自動的にコピーされるひな形を置いておくディレクトリ  
基本的な設定ファイルなど、どのユーザーにも必要と思われるファイルも同時に配布できると便利。  
ホームディレクトリ作成時に配布したいファイルはひな形として/etc/skelディレクトリに置いておく。  

---

## usermodコマンド

既存のユーザーアカウントを変更するコマンド。  
/etc/passwdファイルの概要フィールドを書き換えた場合と同じ。  

``` txt
usermod [オプション] ユーザー名

オプション
-c コメント             :: コメントフィールドを変更する。
-d パス                 :: ホームディレクトリを変更する。
-g グループ名 / GID     :: プライマリグループを変更する。
-G グループ名 / GID     :: 所属するグループを変更する。プライマリグループは変更しない。
-s パス                 :: デフォルトシェルを変更する。
-L                      :: パスワードをロックして一時的に無効化する。
-U                      :: パスワードのロックを解除する。
-e                      :: アカウントの失効日を設定する。changeコマンドと同じ。
-f                      :: パスワード失効までの猶予日数を設定する。
-p 暗号済みのパスワード :: 暗号化済みのパスワードに変更する。
```

ユーザーlpicがプライマリグループ以外に所属するグループをbprojectに変更する。  
`usermod -G bproject lpic`  

ユーザーlpicのアカウントを無効にする。  
`usermod -L lpic`  

manaのパスワードが有効期限を過ぎてから無効になるまでの期間を30日に設定する。  
`usermod -f 30 mana`  

ユーザtestuserのパスワードを暗号化済みの「xynhyrsnDvkYw」に変更する  
`usermod -p xynhyrsnDvkYw testuser`  

---

## userdelコマンド

ユーザーアカウントを削除するコマンド。  

``` txt
userdel [オプション] ユーザー名

オプション
-r :: ホームディレクトリも同時に削除する。
-f :: 強制削除(使用中であっても削除)
```

ユーザーlpicjpをホームディレクトリごと削除する。  
`userdel -r lpicjp`  

ユーザuser1を削除する際、ホームディレクトリも一緒に削除したい。この際、アカウントが使用中であっても削除する。  
`userdel -rf user1`  

---

## passwdコマンド

パスワードを変更するコマンド。  
スーパーユーザー以外は自分のパスワードだけを変更できる。  
passwdを単独で実行すると自分自身のパスワードを変更できる。  
現在のパスワードを入力したのち、新しいパスワードを確認のため2回入力する。  

``` txt
1. passwd
2. passwd [オプション] [ユーザー名]

オプション
-l :: パスワードをロックして一時的に無効化する。
-u :: パスワードのロックを解除する。
-x :: パスワードが変更なしで有効な最長日数を設定する。
-i :: パスワード失効までの猶予日数を設定する。
```

yukoのパスワードの有効期限を60日に設定する。  
`passwd -x 60 yuko`  

期限を過ぎてから無効になるまでにパスワードを変更できる期間を30日に設定する。  
`passwd -i 30 yuko`  

---

## groupaddコマンド

グループを作成するコマンド。  
グループを指定してユーザーを作成するときは、あらかじめグループを作成しておく必要がある。  

``` txt
groupadd グループ名
```

salesグループを作成する。  
`groupadd salse`  

---

## groupmodコマンド

既存のグループを変更する。  

``` txt
groupmod [オプション] グループ名

オプション
-g GID :: GIDを変更する。
-n グループ名 :: グループ名を変更する。
```

develグループの名称をdevelopに変更する。  
`groupmod -n develop devel`  
groupmod 変更前 -n 変更後 という構造ではないことに注意。  

既に存在するグループアカウント「ProjectA」のGID（グループID）を600へ変更。  
`groupmod -g 600 ProjectA`  

「TestA」ユーザが3つのグループ（A,B,C)に属しているが、Bグループからそのユーザを削除したい。  
`groupmod -G 'A,C' TestA`  
削除するグループを指定するのではなく、名前を書かない。  

---

## groupdelコマンド

グループを削除するコマンド。  
削除対象グループをプライマリグループとするユーザーがいる場合は削除出来ない。  

``` txt
groupdel グループ名
```

salesグループを削除する。  
`groupdel salse`  

---

## idコマンド

ユーザーに関する識別情報を表示するコマンド。  
(UID、ユーザー名、グループID、グループ名等)  
ユーザ名を省略すると、コマンドを実行したユーザの情報が表示されます。  
オプションを省略すると、UIDと所属する全てのグループのGIDを表示します。  

``` txt
id [オプション] [ユーザー名]

-u :: UID(ユーザID)を表示
-g :: ユーザーのプライマリグループのGIDを表示
-G :: 所属する全てのグループのGIDを表示
```

ユーザ「test」のプライマリグループのGIDを確認。  
`id -g test`  

---

## groupsコマンド

ユーザーが所属しているグループを表示するコマンド。  
UIDやGIDは確認出来ない。  

``` txt
groups [ユーザー名]

グループ名：グループのパスワード：グループID番号：所属するユーザー名のリスト
```

---

## getentコマンド

ローカルホストやLDAPサーバーなどにあるユーザー情報、グループ情報などを一括して出力することができる。  
ネームサービススイッチ(/etc/nsswitch.conf)の設定に従い、引数で指定したデータベースの内容を表示する。  

「/etc/nsswitch.conf」は、名前解決やサービス名解決の際の問い合わせ順序を指定するファイル。  
ユーザー情報、パスワード情報の取得、ホスト名からIPアドレスを取得する際の情報検索先など設定内容は多岐にわたる。  

getent は、それらの情報の問い合わせを行うコマンド。  

``` txt
getent 対象
getent データベース名 キー名

対象
ユーザー情報→passwd
グループ情報→group
をそれぞれ指定する。
```

getent passwd を実行した場合、システムの全ユーザーのアカウントが表示される。  
ユーザー名やホームディレクトリなどのユーザー情報の一覧  

---

## シャドウパスワード

暗号化されたパスワードは **/etc/shadowファイル** に記録されている。  
rootユーザーしか読み取り出来ない。  
/etc/passwdファイルの読み取りを禁止した場合、様々な不都合が生じるため、このような構造になっている。  

---

## gpasswdコマンド

`/etc/group`を管理するコマンド。  
グループのパスワードや所属するメンバーなどを設定できます。  

ユーザtestを補助グループsalesから削除する  
`gpasswd -d test sales`  

---

## 対話的なログインを禁止する方法

・ログインシェルに/bin/falseを設定する  
・ログインシェルに/sbin/nologinを設定する  

メールサーバやFTPサーバなどでは、ユーザアカウントは必要ですが、ユーザがシステムにログインしシェルを利用する必要が無い場合もあります。  
このような場合に対話的ログインを禁止します。  
対話的ログインを禁止するにはログインシェルを「/bin/false」または「/sbin/nologin」に設定します。  

ログインシェルは「usermod -s」や「useradd -s」（ユーザ作成時）コマンドで設定できます。  
また、シェル変更専用の`chsh`コマンドでも変更が可能です。  
オプションでシェルを指定する場合「chsh -s」を使用します。  
なお、ログインシェルに設定するシェルは「/etc/shells」ファイルに登録されている必要があります。  

chshはChangeShellと思われる。

---

## アカウントをロックする方法

「/etc/shadow」の該当ユーザのパスワードフィールドの1文字目に「!」または「*」を追加する  
「/etc/passwd」の該当ユーザのパスワードフィールドの1文字目に「!」または「*」を追加する  
「passwd -l user3」コマンドを実行する  
「usermod -L user3」コマンドを実行する  

passwdは小文字。  
usermodは大文字。  

因みに解除  
`usermod -U`  
`passwd -u`  
