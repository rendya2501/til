# X11のインストールと設定

---

## X Window System(X,X11)

LinuxでGUIを実現するための技術。  
X.Org.Foundationが開発。  
クライアント/サーバー方式を採用。  

XFree86  
一昔前のX Window Systemの実装。  

X.Org  
現在のX Window Systemの実装。  
「UnixLikeSystem上でのGUI基礎環境の提供」をしてくれるプログラム。  

GUIログイン時のX Window Systemのエラーは、`~/.xsession-errors`ファイルに出力される。  
X Window Systemの設定ファイル :: `/etc/X11/xorg.conf`  
→  
「xorg.conf」は、Linuxで標準的に使用されているX Window SystemであるX.Orgの設定ファイルです。  
「xorg.conf」ファイルは「/etc/X11」ディレクトリに格納されています。  

---

## クライアント・サーバーモデル

X Window Systemはクライアント・サーバ方式を使用しているため、XサーバとXクライアントは異なるマシンで動作していても使用できます。  
例えば、Xサーバがあるマシン上の画面に、Xクライアントがあるマシン上で実行したプログラムを表示させられます。  
普通のクラサバはクライアントを直接操作して離れた場所にあるサーバーを利用するが、Xでは逆となる。  
サーバーに対して命令し、クライアントが実行する。  

``` txt
Xクライアント
↑②    ↓③
Xサーバー
↑①    ↓④
ｷｰﾎﾞｰﾄﾞ ﾓﾆﾀｰ

ネットワーク越しの利用の場合、②と③がネットワークになる。
```

①キーボードでデータを入力する。  
②Xサーバーは入力データを受け付けてXクライアント(アプリ)にデータを送る。  
③Xクライアントは受け取ったデータを処理して処理結果をXサーバーへ送る。  
④XサーバーはXクライアントから受け取った処理結果をディスプレイに出力する。  

X Window Systemはネットワーク側のウィンドウシステム。  
XクライアントはTCP/IP上でXプロトコルによりXサーバーのサービスを受ける事ができる。  

■Xクライアント側の設定:  
環境変数DISPLAYで送り先のXサーバーを指定する。  
環境変数DISPLAYの書式は以下の通り。  
`[ホスト名] : ディスプレイ番号`  

デフォルトのディスプレイを使用する場合はディスプレイ番号に0を指定します。  
複数のXサーバが起動している場合は、ディスプレイ番号0から1, 2, 3...の順で番号を指定します。  

■Xサーバー側の設定:  
xhostコマンドを実行してクライアントホストからのリクエストを許可する。  

---

## /etc/X11/xorg.conf

X.Prgの設定ファイル  
設定ファイルの他にディレクトリ以下に.confファイルを配置する場合もある。  

xorg.confファイルは複数のセクションから構成されている。  
各セクションは「Section "セクション名"」から始まり、「EndSection」で終わる。  

デフォルトの設定ファイルは/usr/share/X11/xorg.conf.dに配置されている。  
手動で設定が必要な場合は、設定を変更するファイルを/etc/X11/xorg.conf.dディレクトリ以下にコピーして編集する。

``` txt : xorg.confの主なセクション
Files        :: フォントやカラーデータベースファイルのパス名
Module       :: ダイナミックモジュールの設定。
                組み込むモジュールの指定。
                モジュールとは、Xサーバ本体には無い機能を新たに追加するためのファイルのこと。
InputDevice  :: キーボードやマウス等の入力装置の設定
InputClass   :: 入力装置の「クラス」に適用される設定
Device       :: ビデオカードの設定
Monitor      :: モニターの設定
Modes        :: ビデオモードの設定
Screen       :: ディスプレイの色深度(表示色数)や画面サイズの設定
ServerLayout :: 入出力デバイスとスクリーンの指定
```

ServerLayoutだけ入出力デバイスとスクリーンという、一見すると関係ない組み合わせなので注意。  
あと、ビデオカードはなぜかDeviceなのでそれにも注意。  

``` conf : Deviceセクションの設定例
Section "Device"
        Identifir "Videocard0"
        Driver "vmware"
EndSection
```

---

## なんか各種コマンド

xdpyinfo or xwininfo ::  Xサーバーの色深度を表示するコマンド  
Xorg - configure :: xorg.confファイルを自動生成するためのコマンド  
上記コマンドで`/root/xorg.conf.new`ファイルが生成される。  

X -config /root/xorg.conf.new :: `/root/xorg.conf.new`ファイルを使ってテストを実行するコマンド  
上記ファイルをコピーする。  
`cp /root/xorg.conf.net /etc/X11/xorg.conf`  

`/var/log/Xorg.0.log` or `~/.xsession-errors` :: Xのログファイル  

Xサーバーの起動コマンド :: `startx`

/etc/X11/xorg.conf.dディレクトリにも、X.Orgの設定として拡張子.confファイルを保存できる。  
キーボードレイアウトやモデルなどキーボード関連の設定をする「00-keyboard.conf」  

``` conf : /etc/X11/xorg.conf.d/00-keyboard.conf
Section "InputClass"
        Indetifire "system-keyboard"
        MatchIsKeyboard "on"
        Option "XkbLayout" "jp"
EndSection
```

---

## xhostコマンド

ホスト単位でXサーバへのアクセス許可・不許可をコントロールするコマンド。  
引数なしで実行すると、現在の状態を表示する。  

``` txt
xhost [+ or -] [ホスト名]

オプション
+ ホスト名 :: 指定したホストからのXサーバーへの接続を許可(+は省略可能)
- ホスト名 :: 指定したホストからのXサ―バーへの接続を拒否
+ :: アクセス制御の無効化(全てのホストからの接続を許可)
- :: アクセス制御の有効か(アクセス許可されていないホストからの接続は拒否)
```

remotepcのXクライアントが、localpcのXサーバーを利用できるように許可する設定  
`xhost +remotepc`

Xクライアントの処理結果を表示するために、remotepcの環境変数DISPLAYでXサーバーを指定して環境変数のDISPLAYをエクスポートを設定する。  
`構文 : ホスト名 : ディスプレイ番号`  

remotepcのXクライアントが、localpcのXサーバーを利用できるよう許可する設定  

``` txt
DISPLAY=localpc:0
export DISPLAY
```

---

## xauthコマンド

Xサーバへの接続に使用される資格情報を表示したり、クライアント認証ファイルを編集するコマンド。  
xhostコマンドはホスト単位でアクセスを許可するため、セキュリティ上好ましくない。  
xauthコマンドはユーザ単位でXサーバへのアクセスを制限する。  

■Xサーバ側  
xauth listコマンドでXサーバごとの接続に使用される資格情報が表示されます。  

■Xクライアント側  
xauthのaddコマンドで、接続ユーザの`~/.Xauthority`ファイル（クライアント認証ファイル）にXサーバと同じ資格情報を保存します。  
Xサーバと資格情報が一致したユーザのみがアクセスできるようになります。  

---

## X Window System X-サーバーが起動するまでの流れ

コンソールから`startx`コマンドを実行  
↓  
xinitコマンドを実行  
↓  
①`~/.xinitrc`を実行  
②ない場合は`/etc/X11/xinit/xinitrc`を実行  
↓  
/etc/X11/xinit/xinitrc.d以下のスクリプト
①`~/.xsession`を実行。  
②`~/.xsession`がない場合、`~/.Xclients`を実行。  
③`~/.Xclients`がない場合、`/etc/X11/xinit/Xclients`を実行。  
↓  
GNOME等のウィンドウマネージャーを起動  

startxコマンドをCUI環境（ランレベル3）で実行すると、X Window System（GUI環境）が起動します。  

---

## 「/etc/X11/xdm」にある関連ファイル

``` txt
ファイル名 : 説明

xdm-config :: XDMの設定ファイル。
Xresources :: XDMログイン画面のデザイン設定。
Xaccess    :: ホストからXDMへアクセス許可の設定。
Xsetup_0   :: XDMログイン画面表示前に実行されるスクリプト。
              XDMのカラー設定や背景（壁紙）の指定を行う。
              ファイル名の末尾にある「_0」はディスプレイを識別するための番号（ディスプレイ番号）。
Xsession   :: XDMのログイン後に実行されるスクリプト。
```

---

## Wayland

X11に変わる新しいディスプレイサーバー。  
クライアントとサーバ―はWaylandプロトコルで通信する。  
Waylandディスプレイサーバーは個々のクライアントアプリケーションのウィンドウを合成してスクリーンイメージを生成する機能を持つ。  
これがWaylandの主要機能であるコンポジタ(compositor)。  
Xに比べて再描画がが早い。  
ウィンドウのリサイズやオーバーラップ時のちらつき(flicker)がなく、処理が効率的で高速と言った特徴を持つ。  
Xクライアントアプリケーションにも対応するため、WaylandサーバーはXorgサーバーにパッチを当てた形で提供される。  

RHEL8,CentOS8でデフォルト実装されている。  
Fedora28やUbuntu18.04では設定により使用可能。  

Waylandでは、コンポジタと呼ばれるウィンドウマネージャがディスプレイサーバとして各アプリケーションのバッファの画像を合成し、直接カーネルに描画を要求します。  
コンポジタとクライアントの間にXサーバを介さないため、処理がシンプルで効率的です。  
