# 2.ユーザーに対するセキュリティ管理

---

## chageコマンド

「chage」はパスワードの有効期限の設定に特化したコマンド（CHange password AGEの略）で、詳細な設定やその表示が可能です。  
なお、パスワードの有効期限に関する情報は「/etc/shadow」ファイルに保存されます。  

ユーザーのパスワードの有効期限を表示・変更するコマンド。  
引数を設定しないで実行した場合、対話モードになる。  
9.管理タスクのパスワードに置ける問題でも頻出。  

cha'n'geではなく、chageであることに注意。  
CHange password AGEの略 らしい。  

``` txt
chage [オプション] [ユーザー名]

-l :: アカウントとパスワードの失効日の情報を表示。(ls)
      一般ユーザーでも使用可能。
-d :: パスワードの最終更新日を設定。YYYY-MM-DDの形式もしくは1970年1月1日からの日数で指定する。
-m :: パスワード変更間隔の最短日数を設定。(minimum)
      (パスワードを変更できるようになる日数)
-M :: パスワードを変更なしで使用できる最長日数を設定。(Max)
      (何日毎に必ずパスワードを変更させるか)
-W :: パスワードの変更期限の何日前から警告を出すかを指定。(Warning)
      (有効期限の何日前から警告を行うか)
-I :: パスワードの変更期限を過ぎてからアカウントが使用できなくなるまでの失効日数。(Inactive)
      パスワードの有効期限切れ後にアカウントがロックされるまでの日数を指定。
      有効期限が切れてからパスワードが実際にロックされるまでの猶予期間を指定できます。
      「0」を指定すれば、期限切れと同時にパスワードがロックされます。
-E :: アカウントの失効日を設定。(YYYY-MM-DD形式)(Expire:期限切れ)

※-lオプション以外はrootユーザしか実行できません。
```

ユーザーryoのパスワードの有効期限を60日に設定する。  
`chage -M 60 ryo`  

期限を過ぎてから無効になるまでにパスワードを変更できる期間を30日に設定する。  
`chage -I 30 ryo`  

ユーザ「user1」のパスワードをいつでも変更できるようにしたい。  
`chage -m 0 user1`  
→  
-mはパスワードを変更できるようになる日数の設定なので、0にする事で即変更できるようになる。  

短期のアルバイト社員「user1」のユーザーアカウントを、2010年4月20日までの期限付きにしたい  
`chage -E 2010-04-20 user1`  

アカウント「user1」のパスワードを設定してから、最長でも90日ごとには強制的にパスワードを変更させたい  
`chage -M 90 user1`  

---

## パスワードの有効期限に関する設定が可能なコマンド

・chage  
・passwd  
・usermod  

中でも「chage」はパスワードの有効期限の設定に特化したコマンド（CHange password AGEの略）で、詳細な設定やその表示が可能です。  
なお、パスワードの有効期限に関する情報は「/etc/shadow」ファイルに保存されます。  

passwdはユーザーのパスワードを変更するのがメインのコマンド。  
パスワードのロックや最長日数、失効までの猶予期間の設定はできるが、問題文にある有効期限の確認や設定は出来ない。  

chageはパスワードの変更は出来ないが、有効期限の確認や設定等の細かな設定ができるコマンド。  
問題文中に有効期限というフレーズがあれば間違いなくこちら。  

「passwd」コマンドでパスワードの最長有効日数を10日にする場合は「passwd -x 10 user1」とします。  
「usermod」コマンドにはこれを実現するオプションは存在しませんが、  
アカウントの有効期限やパスワードの使用期限が切れてからアカウントを永久に使用不能になるまでの日数を設定できますので、正解の1つとなります。  

---

## /etc/nologinファイル

「/etc/nologin」ファイルが存在すると、rootユーザのみログインが許可されます。  
rootユーザ以外の、一般ユーザによるログインを禁止するときに作成します。  
一般ユーザアカウントは必要だけれど、ログインはさせたくない場合などに使用します。  

「touch」は空ファイルを作成するコマンドです（書式：touch [ファイル名]）。  

ユーザーのログインを禁止するファイル  
これが存在するだけでルートユーザー以外のログインは出来なくなる。  
中身は空でもよい。
記述した場合は、その内容が一般ユーザーがログインしようとしたときに表示される。  

---

## suコマンド

su（Switch User）コマンドを使うと、ログイン中に別のユーザーに切り替わる事ができます。  

suコマンドには以下の特徴があります。  
・引数に「-」をつけると、切り替わる先のユーザの環境変数を使用する  
・ユーザー名を指定しない場合、rootユーザへ切り替わる  
・ユーザを切り替える時に求められるパスワードは、切り替わる先のユーザのパスワード  
・但し、rootユーザから別のユーザに切り替わる時はパスワードは要求されない  

一時的に別のユーザーになるコマンド  
別の実行ユーザーIDと実行グループIDを持つ新たなシェルを起動するコマンド  

``` txt
su [オプション] [-] ユーザー名

-あり :: 直接ログインしたときと同様の動作を行う。
カレントディレクトリは新しいユーザーのホームディレクトリとなる。
環境変数が全て初期化される。

-なし :: 現在の環境をそのままにしてユーザーだけを切り替える。  
```

---

## sudoコマンド

[superuser do] or [substitute user do]  
substitute : 代わりの  

別のユーザーの権限でプログラムを実行するためのコマンド。  
大抵はrootユーザーとして実行する場合に使われる。  
実質、一般ユーザが管理者権限でコマンドを実行する為のコマンド  
一般ユーザでも、管理者から実行権限を委譲されたコマンドであれば実行できます。  

・自身に委譲されているコマンドは「sudo -l」で確認できます。  
・sudoコマンドを実行するとパスワードの入力を求められますが、rootのパスワードではなく、ユーザー自身のパスワードを入力します。  
・権限委譲の設定は「visudo」コマンドで「/etc/sudoers」ファイルを編集することで行います。  

``` txt
sudo [オプション] [-u ユーザー名] コマンド

オプション
-l :: 自身に許可されているコマンドを表示する
-i :: 変更先ユーザーでシェルを起動する(ログイン時の処理を行う)
-s :: 変更先ユーザーでシェルを起動する

-u ユーザー :: rootではなく指定したユーザーでコマンドを実行する
ユーザー名を省略するとrootユーザーで実行する。
```

---

## visudoコマンド

sudoコマンドの利用設定をするコマンド。  
「/etc/sudoers」ファイルを編集する。  
rootユーザーのみ実行可能。  

---

## /etc/sudoersファイル

sudoコマンドを実行できるユーザーの設定を行うファイル。  
sudoコマンド実行時、sudoコマンドはこのファイルを参照してユーザーが実行権限を持っているかどうか判定を行う。  
visudoコマンドで編集する。  
エディターで直接、このファイルを開いてはいけないらしい。  

``` txt
書式
権限を委譲するユーザ名 ホスト名=(実行ユーザー名) [NOPASSWD:]委譲するコマンド

ユーザー名     :: コマンドの実行を許可するユーザー名かグループ名、もしくはALL
ホスト名       :: 実行を許可するホスト名か、IPアドレス、もしくはALL
実行ユーザー名 :: コマンド実行時のユーザー名(省略時はroot)、もしくはALL
コマンド       :: 実行を許可するコマンドのパス、もしくはALL
NOPASSWD:      :: 指定すると、コマンド実行時にパスワードを問われない

移譲するコマンドを複数していする場合は「,(カンマ)」で区切る。
```

studentユーザーのみshutdownコマンドが実行できるように設定する  
`student ALL=(ALL) /sbin/shutdown`  

studentユーザーに対し、全てのroot権限が必要なコマンドの実行を許可する。  
`student ALL=(ALL) ALL`  

wheelグループに対し、全てのroot権限が必要なコマンドをパスワードなしで実行できるようにする。  
`%wheel ALL=(ALL) NOPASSWD:ALL`

---

## ulimitコマンド

ユーザやシェルが利用できるリソースの制限を設定したり表示するコマンド  
アプリケーションのエラー発生時に生成されるcoreファイルの最大サイズやシェルが使用できる最大メモリ量など、使用するリソースを制限できる。  

``` txt
ulimit [オプション] [制限値]

-a         :: 現在の全ての設定を表示(all)
-c サイズ  :: コアダンプで生成されるcoreファイルの最大サイズ(単位はブロック)を制限(core)
-f サイズ  :: シェルが生成できるファイルの最大サイズをブロック単位で指定する(file)
-n 数      :: オープンできるファイル(ファイル記述子)の最大個数を制限
-u ﾌﾟﾛｾｽ数 :: 1人のユーザーが利用できる最大プロセス数を指定する(user process)
-v サイズ  :: シェルが利用できる仮想メモリの最大サイズ(単位はキロバイト)を制限(virtual memory)

※コアファイル
プログラムが異常終了した時にプログラムが使用していたメモリ情報をファイルに書きだしたものです。
主にデバッグのために使用しますが、一般ユーザーが通常使用するものではなく、
またプログラムによっては多くのメモリを使用するためコアファイルが巨大になることがあります。
そのため、ファイルシステムの容量を食いつぶさないようにコアファイルのサイズを制限することが一般的です。
```
