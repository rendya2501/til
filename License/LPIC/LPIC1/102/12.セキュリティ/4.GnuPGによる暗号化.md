# 4.GnuPGによる暗号化

---

## GnuPG(GNU Privacy Guard)

GnuPG（GNU Privacy Guard）は暗号化プログラム。  
共通鍵暗号方式や公開鍵暗号方式に対応しています。  
ファイルの暗号化や復号を行うにはgpgコマンドを使用します。  

公開鍵暗号方式を使って、ファイルの暗号化や復号をしたり、電子署名をしたりすることができるオープンソースソフトウェア。  
公開鍵暗号PGP(Pretty Good Privacy)の標準仕様であるOpenPGPのGNUによる実装であり、暗号化と署名を行うツール。  

---

## gpg-agent

gpg-agentは、GnuPG（GPG）という暗号化プログラムにおいて秘密鍵を管理し、パスフレーズによる認証状態を一定期間キャッシュするデーモンプログラムです。  
SSHにおけるssh-agentと同様です。  

---

## gpgコマンド

GnuPGを使ってファイルの暗号化や復号を行うコマンド。  

``` txt
gpg [オプション]

オプション
--gen--key        :: 公開鍵暗号方式の鍵ペアを生成する。「~/.gnupg/」ディレクトリの下に、作成される。
--export          :: 公開鍵をエクスポートする。
--import          :: 公開鍵をインポートする。
--list-keys       :: 公開鍵を一覧表示する。
--sign            :: ファイルに署名する。
--verify          :: ファイルの署名を検証する。verify:確認
-e ファイル名     :: 暗号化データを受け取る側の公開鍵を使用してファイルを暗号化する。
-o ファイル名     :: 出力ファイル名を指定する。
-r メールアドレス :: 暗号化に使用する公開鍵の持ち主のメールアドレスを指定する。

※復号する場合はそのままファイル名を指定する。オプションはいらない。
```

公開鍵と秘密鍵の鍵ペアを生成するコマンド  
`gpg --full-generate-key` or `gpg --gen-key`  
鍵は`~/.gnupg`ディレクトリに作成される。  

失効証明書の作成  
`gpg -o 執行証明書ファイル名 --gen-revoke メールアドレス`  
失効証明書はパスフレーズが漏れてしまったり、忘れてしまった際に鍵を無効化するために必要。  

失効証明書を使い鍵を無効化するコマンド  
`gpg --import revoke.asc`  

共通鍵を使ったファイルの暗号化  
`gpg -c ファイル名`  
例 : secret.txtファイルを暗号化  
`gpg -c secret.txt`  

公開鍵を使ったファイルの暗号化  
`gpg -c ファイル名`  

公開鍵のエクスポート  
`gpg -o 出力ファイル名 -a --export 自分のメールアドレス`  

公開鍵のインポート  
`gpg --import pubkey`  
→
公開鍵暗号方式では、公開鍵を使って暗号化したものをペアの秘密鍵で復号します。  
このため暗号化ファイルを送りたい相手から事前に公開鍵をファイル形式で受け取り、インポート（--importオプション）しておきます。  

鍵に署名を行うコマンド  
`gpg --sign-key メールアドレス`
公開鍵が信頼できる場合に行う。署名を行わないと毎回警告が表示される。  

ファイルの暗号化  
`gpg -e -a -r 送り先のメールアドレス 暗号化するファイル名`  
例 : 受信者ID yuko@mylpic.com,送信データファイルsecret-document.txt  
`gpg --encrypt --recipient yuko@mylpic.com secret-document.txt`  
受信は○○です。暗号化するファイルはこれです。この組み合わせで暗号化します。  

送られてきた暗号化ファイル「hogehoge.txt.gpg」を自分の秘密鍵を使用して復号したい。
`gpg hogehoge.txt.asc`  
→  
復号する場合はそのままファイル名を指定する。オプションはいらない。

ファイルの署名  
`gpg -o sample.sig --sign gpg.log`  

鍵の管理に関するタスクを対話モードで実行する場合のコマンド  
`gpg --edit-key`  

メールアドレス「user1@ping-t.com」のユーザから受け取った公開鍵を使ってファイル「hogehoge.txt」を暗号化します。  
`gpg -e -r user1@ping-t.com hogehoge.txt`  

---

## ~/.gnupg/ ディレクトリ

GnuPGに関連するファイルの置かれるディレクトリ。  

「--gen-key」オプションを使用すると、「~/.gnupg/」ディレクトリの下に、  
公開鍵暗号方式の公開鍵のキーリング（pubring.gpg）秘密鍵のキーリング（secring.gpg）が作成されます。  
キーリングとは公開鍵や秘密鍵を保管しておく鍵用のファイルのことです。  

公開鍵キーリング :: ~/.gnupg/pubring.gpg  
秘密鍵キーリング :: ~/.gnupg/secring.gpg  

---

## GnuPGを使った公開鍵暗号化方式を用いたファイルのやり取り

■公開鍵暗号方式の鍵ペアを作成  
暗号化データを受け取る側で、公開鍵と秘密鍵の鍵ペアを作成します。  
他者に公開できる公開鍵で暗号化されたファイルは、その公開鍵のペアとなる秘密鍵でしか復号できません。  
そのため、秘密鍵は作成したユーザのみが管理し他者にもれないようにします。  

例）server1のuser1が鍵ペアを作成する  
`gpg --gen-key`  

「gpg --gen-key」コマンド実行時に下図のようなパスフレーズを入力するダイアログを表示させるために、  
pinentry-curses（パスフレーズ入力ダイアログのコレクション）をインストールしておく必要があります。  

・gpg-agent  
gpg-agentというデーモンプログラムが、秘密鍵を管理し、パスフレーズによる認証状態を一定期間キャッシュします。  

■公開鍵のエクスポート  
暗号化に使用する公開鍵を通信相手に渡すため、公開鍵をファイルに出力します。  

例）user1がメールアドレス「user1@ping-t.com」を用いる公開鍵を「pubkey」というファイル名でエクスポートする  
`gpg -o pubkey --export user1@ping-t.com`  

エクスポートされた「pubkey」ファイルは通信相手（暗号化データを送る側）に送っておきます。  
`scp pubkey user2@server2:~/pubkey`  

■公開鍵のインポート  
暗号化データを送る側で、エクスポートされた公開鍵をインポートします。  

例）server2のuser2が、server1のuser1から受け取った公開鍵「pubkey」ファイルをインポートする  
`gpg --import pubkey`

■ファイルの暗号化  
暗号化データを送る側で、受け取った公開鍵を使ってファイルを暗号化します。  

例）user1から受け取った公開鍵を使ってファイル「hogehoge.txt」を暗号化する  
`gpg -e -r user1@ping-t.com hogehoge.txt`

暗号化したファイル「hogehoge.txt.gpg」はserver1のuser1に送っておきます。  

■ファイルの復号  
暗号化データを受け取る側で、送られてきた暗号化ファイルを自分の秘密鍵を使用して復号します。  

例）server2のuser2から送られてきた暗号化ファイル「hogehoge.txt.gpg」を復号する  
`gpg hogehoge.txt.gpg`

■ファイルの署名  
秘密鍵を使用してファイルに署名することで、ファイルの作成者が本人かどうかやファイルが改ざんされていないかどうかを確認できます。  

例）「hogehoge2.txt」ファイルに署名する  
`gpg --sign hogehoge2.txt`

「hogehoge2.txt.gpg」というバイナリファイルが作成されます。  

例）「hogehoge2.txt.gpg」ファイルの署名を検証する  
`gpg --verify hogehoge2.txt.gpg`  
