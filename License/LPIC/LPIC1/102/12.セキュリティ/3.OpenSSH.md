# 3.OpenSSH

オープンソースのSSH実装ソフトウェア。  
SSHプロトコルを利用するためのソフトウェア。  
SSHサーバーおよびSSHクライアントを含む。  
SSHを利用するために、現在世界で最も使われているSSH実装。  

[インフラエンジニアじゃなくても押さえておきたいSSHの基礎知識](https://qiita.com/tag1216/items/5d06bad7468f731f590e)  

---

## SSH(Secure Shell)

暗号や認証の技術を利用して、安全にリモートコンピュータと通信するためのプロトコル。  
公開鍵認証や通信の暗号化といった点でTELNET(ポート23)よりセキュリティが強固です。  
※外部サーバを管理する場合、通信の内容が平文である（暗号化されていない）TELNET(ポート23)はできる限り使うべきではない。  

``` txt
ポート番号 :: 22
SSHサーバーの機能を提供するデーモン :: sshd

SSHに関する主なファイル
             | SSHクライアント     | SSHサーバー(sshd)
設定ファイル | /etc/ssh/ssh_config | /etc/ssh/sshd_config
秘密鍵       | ~/.ssh/id_rsa       | /etc/ssh/ssh_host_rsa_key
公開鍵       | ~/.ssh/id_rsa.pub   | /etc/ssh/ssh_host_rsa_key.pub
認証鍵リスト | ~/.ssh/known_hosts  | ~/.ssh/authorized_keys

①ホスト認証時に登録
サーバー公開鍵 : /etc/ssh/ssh_host_rsa_key.pub → クライアント認証鍵リスト : ~/.ssh/known_hosts
②ユーザー認証時に登録
クライアント公開鍵 : ~/.ssh/id_rsa.pub → サーバー認証鍵リスト : ~/.ssh/authorized_keys

※ユーザー側のファイル名「id_<鍵の種類>」「id_<鍵の種類>.pub」
※サーバー側のファイル名「ssh_host_<鍵の種類>_key」「ssh_host_<鍵の種類>_key.pub」

※クライアント側の設定ファイル「/etc/ssh/ssh_config」に設定した内容はシステム全体（全ユーザ）に適用されます。
※ユーザが個別に設定したい場合は「~/.ssh/config」を使用します。
```

---

## /etc/ssh/sshd_config  

sshdの設定ファイル  
[OpenSSH (sshd) のデフォルト値](https://qiita.com/bezeklik/items/b728ea2de4924f89a787)  
めっちゃたくさんある。  

``` txt : sshdの主なディレクティブ  
Port                   :: 待機ポート番号
Protocol               :: プロトコルバージョン
PermitRootLogin        :: rootログインを許可するかどうか(デフォルトはyes:許可。no:不許可が推奨)
                          セキュリティ上の理由から、rootユーザでのSSHログインは禁止する事が一般的に推奨されます。
PubkeyAuthentication   :: 公開鍵認証(プロトコルバージョン2)
AuthorizedKeysFile     :: ユーザー認証の公開鍵格納ファイル名
PasswordAuthentication :: パスワード認証
X11Forwarding          :: X11ポートフォワーディングを許可するかどうか

例)
Port 22
Protocol 2
PermitRootLogin yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PasswordAuthentication yes
```

---

## /etc/ssh/ssh_known_hostsファイル

ローカルシステムの全ユーザーが利用するsshサーバーの公開鍵を格納するファイル。  
そのsshサーバーはローカルシステムの全ユーザーにとって正当と認めるサーバーになる。  

---

## sshコマンド

SSHを使ってリモートホストにログインするためのコマンド  

``` txt
ssh [オプション] [[ログインユーザー@]ホスト名]

-p ポート番号 :: ポート番号を指定する。「-o Port = ポート番号」 or 「-o "Port ポート番号"」 でも指定可能。
-l ユーザー名 :: 接続するユーザーを指定する。(本オプションと[ユーザー名@]のどちらも省略された場合は現在のユーザー名を使用)
-i ファイル名 :: 秘密鍵ファイルを指定する。「-o IdentityFile=秘密鍵ファイル」でも指定可能。
-o            :: ssh_configで設定できるオプションの指定。「-o ディレクティブ=値」の方式で指定する。
-f            :: コマンドを実行する際にsshをバックグラウンドにする(Xアプリケーションを実行する際に使用)
-N            :: リモートコマンドを無効にする。転送のみを指示する。
-2            :: SSHのバージョン2を使用する。
-L            :: 指定されたローカル (クライアント) ホスト上のポートが、指定されたリモート側のホストおよびポートに転送されることを指定します。
                 -Lは「Local port forwarding」のためのオプションです。詳しくはポートフォワーディングを参照。
-X            :: DISPLAY環境変数が自動で設定される。詳しくはX11ポートフォワーディングを参照。
```

sv1.lpic.jpにSSHで接続する。  
`ssh sv1.lpic.jp`  

studentユーザーとしてsv1.lpic.jpにSSHで接続する。  
`ssh student@sv1.lpic.jp`  

ポート番号22番、アイデンティティファイル~/.ssh/id_dsa、プロトコルバージョン2、ログインユーザーyukoでsshサーバーにログインする。  
`ssh -p 22 -i ~/.ssh/id_dsa -2 -l yuko examserver`  

接続時にユーザー名を指定する方法  
・「ユーザ名@ホスト名」の形式で接続先ホストを指定する  
・「-l ユーザ名」オプションを指定する  
・「-o User=ユーザ名」オプションを指定する  
→  
sshでの接続ユーザを指定するには、ホスト名の前にユーザ名を@でつなげる、「-l ユーザ名」オプションで指定する、  
ssh_configで接続先ホストのエントリで「User ユーザ名」を設定する方法があります。  
ssh_configの設定値はsshコマンドに直接「-o オプション名」を指定しても有効になります。  

sshコマンドのオプションで、公開鍵方式のユーザ認証に使用する秘密鍵のファイルを指定する方法  
・「-i 秘密鍵ファイル」オプションを指定する。  
・「-o IdentityFile=秘密鍵ファイル」オプションを指定する。  
→  
sshコマンドで接続時に秘密鍵ファイルを指定しないと「~/.ssh」配下の秘密鍵がユーザ認証で使用されます。  
「~/.ssh」以外の場所にある秘密鍵を認証で使用したい場合は、「-i 秘密鍵ファイル」で指定するか、  
ssh_configで接続先ホストのエントリで「IdentityFile 秘密鍵ファイル」を設定します。  
ssh_configの設定値はsshコマンドに直接「-o オプション名」を指定しても有効になります。  

---

## SSH認証

クライアントがSSHでサーバへログインする際、ホスト認証（接続先のSSHサーバが正しいホストかどうかを確認する）とユーザ認証（SSHクライアントで接続してくるユーザが正当なユーザかどうかを確認する）が行われます。  

ホスト認証の後、ユーザー認証を行う。  
接続先がなりすましだった場合、警告が出る。  
ユーザーが接続先の正当性を確認するための認証がホスト認証というわけ。  

---

## ホスト認証（認証方式：公開鍵方式）

ホスト認証は、SSHクライアントが接続先のリモートホスト（SSHサーバ）が正しいホストかどうかを確認する（なりすましを防ぐ）ために行います。  
クライアントからの接続時に、リモートホストは自身の公開鍵をSSHクライアントに送信します。  
SSHクライアントは受け取った公開鍵と、SSHクライアントの「~/.ssh/known_hosts」ファイルに格納されているSSHサーバの公開鍵を比べることで正しいホストかどうかを確認します。  

初めて接続する際はSSHクライアントの「~/.ssh/known_hosts」ファイルにSSHサーバの公開鍵が格納されていないため、サーバの公開鍵を登録するかどうか問われます。  
「yes」と入力すると「~/.ssh/known_hosts」に登録されます。2回目以降は問われません。  

※クライアントがサーバーの正当性を確認するための認証。  
※サーバの公開鍵をクライアントの「~/.ssh/known_hosts」に登録しておく。  
※クライアントは登録した公開鍵とサーバの公開鍵が一致したらログインする。  
※接続したサーバの公開鍵が異なる場合、メッセージが表示されてログインできない。  

``` txt
ホスト認証流れ  
①クライアントからサーバにSSH接続する  
②サーバは自身の公開鍵をSSHクライアントに送信する  
③クライアントは、受け取った公開鍵とSSHクライアントの「~/.ssh/known_hosts」ファイルに格納されているSSHサーバの公開鍵が一致したらログインする。  
  一致しなければログインしない。  

SSHクライアント                    SSHサーバー
①SSH接続 →→→→→→→→→→→→
                                ← ②サーバーの公開鍵(認証鍵)を送付
③登録されている公開鍵と
サーバーの公開鍵は一致するか？
↓OK
正しいホストと判定し、ログインする。
ユーザー認証へ
```

---

## ユーザ認証（ID/パスワード方式、もしくは公開鍵方式）  

ユーザ認証は、SSHクライアントで接続してくるユーザが正当なユーザかどうかを確認するために行います。  
ユーザ認証には、ローカルでのログインと同様のID/パスワード方式と公開鍵方式の2種類があります。  
公開鍵方式を使用する場合は一対の公開鍵と秘密鍵を作成する必要があります。  
作成したユーザ公開鍵をサーバに登録しておき、サーバがSSH接続を受け付けた際、サーバは登録されている公開鍵とユーザの秘密鍵のペアが一致するかどうかを確認します。  
一致しなければログインさせません。これによりID/パスワード方式よりもセキュリティ上強固なユーザ認証を実現します。  

ユーザ認証で公開鍵方式を使う場合、「ssh-keygen」コマンドで公開鍵/秘密鍵のペアを作成し、  
そのうち公開鍵「~/.ssh/id_rsa.pub」（デフォルト）をサーバの認証鍵リスト「~/.ssh/authorized_keys」に登録しておきます。  

※サーバーが接続してくるクライアントに対して行う認証。  
※ユーザの公開鍵をサーバの「~/.ssh/authorized_keys」に登録しておく  
※サーバは登録した公開鍵とユーザの秘密鍵のペアが一致したらログインさせる  

事前の準備  
①公開鍵と秘密鍵のペアを作成  
SSH接続するユーザごとに「ssh-keygen」コマンドを使用して公開鍵と秘密鍵のペアを作成する。  
鍵の作成時には任意のパスフレーズを入力する。  
※秘密鍵が流出した場合でも、パスフレーズを入力しないとその秘密鍵を使用することはできません。  
②ユーザの公開鍵をサーバの「~/.ssh/authorized_keys」ファイルに登録しておく  

``` txt
ユーザー認証の流れ  
①ユーザーの公開鍵を利用できるか問い合わせる。  
②サーバーが利用できると返す。  
③ユーザーの秘密鍵で署名を作る。  
④データと署名をサーバーに送る。  
⑤ユーザーの公開鍵で署名を検証。  
⑥署名が合っていればログインを許可。  

SSHクライアント                                     SSHサーバー
①ユーザーの公開鍵を利用できるか問い合わせる。  →  
                                                ←  ②サーバーが利用できると返す。
③ユーザーの秘密鍵で署名を作る。
④データと署名をサーバーに送る。→→→→→→→→→
                                                    ⑤ユーザーの公開鍵で署名を検証。
                                                    ⑥署名が合っていればログインを許可。
```

---

## 共通鍵暗号方式(共通鍵認証)

暗号化と復号に共通の鍵を用います。  
処理が早く簡単ですが、複数の相手に同じ共通鍵を使用すると他の人のデータも復号できてしまうので、データを送信する相手ごとに鍵を作成した方がよいでしょう。  

``` txt
受信者                             送信者A,B,C
①共通鍵のペアの作成 * 送信者分
②共通鍵を渡す                  →
                                ← ③受け取った共通鍵で暗号化し送信
④共通鍵で復号
```

---

## 公開鍵暗号方式(公開鍵認証)

共通鍵暗号方式では送信者と受信者で共通の鍵を使用するため、安全な鍵の受け渡しが重要でした。  
これに対して公開鍵暗号方式は、自分だけの鍵（秘密鍵）と、誰でも参照可能な鍵（公開鍵）を使用することで共通鍵暗号方式の問題点を回避しています。  
公開鍵暗号方式では、公開鍵を使って暗号化したものをペアとなる秘密鍵で復号します。  
送信者は暗号化ファイルを送りたい相手の公開鍵でファイルを暗号化して相手に送ります。  
暗号化ファイルを受け取った受信者は、自身の秘密鍵で復号を行います。  
正しい鍵ペアの場合のみ復号できますので、送信者も受信者も安全にデータの受け渡しができます。  
また、送信者が自身の「秘密鍵」を使ってデータに「署名」を行うこともできます。  
署名されたデータを受信した相手は送信者の公開鍵を使って署名の「検証」を行い、正当な相手からの改ざんされていないデータであることを確認できます。  

``` txt
受信者                                送信者A,B,C
①暗号化用の「公開鍵」、
  復号用の「秘密鍵」のペアを生成。
②公開鍵を渡す                     →
                                   ← ③受け取った公開鍵で暗号化し送信
④秘密鍵で復号
```

- 公開鍵暗号方式は非対称暗号方式とも呼ばれる。  
- 暗号化と復号の鍵が異なる方式。  
- 秘密鍵を乱数で生成し、秘密鍵から大きな2つの素数の積や離散対数により公開鍵を生成する。  
- 秘密鍵と公開鍵は1対1対応。  
- 秘密鍵から公開鍵が計算されるが、その逆の演算は実質不可能(宇宙が出来上がるまでの時間を掛ければ出来なくはないが、計算時間に対して割に合わな過ぎる)  
- データ送信側は受信側から事前に取得してある公開鍵でデータを暗号化して受信側に送り、受信側は自分の秘密鍵でデータを復号する。  
- 公開鍵認証では、被認証側が自分の秘密鍵で認証データを作成して認証側に送り、認証側では被認証側の公開鍵で認証データを検証する。  

---

## ssh-keygenコマンド

公開鍵と秘密鍵の鍵ペアを作成するコマンド  

鍵を作成する際、パスフレーズの入力が求められますが、これを忘れてしまった場合、**パスフレーズを表示、削除するコマンドやオプションは存在しません**。  
再度「ssh-keygen」コマンドでキーを作成し、その際にパスフレーズを入力し直します。  
その場合は、新たに作成された秘密鍵とペアの公開鍵をサーバに登録する作業もやり直す必要があります。  

※パスフレーズ  
秘密鍵を利用する際の認証用文字列。  
秘密鍵を暗号化してファイルに格納するために秘密鍵の作成時に設定する文字列。  
秘密鍵をファイルから取り出すときに同じパスフレーズを入力して復号する。  

``` txt
ssh-keygen [オプション]

-t キータイプ :: 
-p            :: 
-f ファイル名 ::
-R ホスト名   :: 
-b ビット長   ::

-tオプションで生成できる暗号方式と鍵のデフォルトのファイル名
                   SSHｸﾗｲｱﾝﾄ        SSHサーバー
                   ~/.ssh/配下      /etc/ssh/配下
rsa     | 秘密鍵 | id_rsa         | ssh_host_rsa_key
        | 公開鍵 | id_rsa.pub     | ssh_host_rsa_key.pub
dsa     | 秘密鍵 | id_dsa         | ssh_host_dsa_key
        | 公開鍵 | id_dsa.pub     | ssh_host_dsa_key.pub
ecdsa   | 秘密鍵 | id_ecdsa       | ssh_host_ecdsa_key
        | 公開鍵 | id_ecdsa.pub   | ssh_host_ecdsa_key.pub
ed25519 | 秘密鍵 | id_ed25519     | ssh_host_ed25519_key
        | 公開鍵 | id_ed25519.pub | ssh_host_ed25519_key.pub

※rsaがデフォルト
```

DSAで鍵ペアを作成
`ssh-keygen -t dsa`

---

## ~/.ssh/内のファイル

``` txt
・~/.ssh/authorized_keys :: 接続を許可する公開鍵を登録しておくサーバー側のファイル。
・~/.ssh/config          :: SSH接続情報を格納したファイル。
・~/.ssh/id_rsa          :: ssh-keygenコマンドで生成された秘密鍵ファイル。
・~/.ssh/id_rsa.pub      :: ssh-keygenコマンドで生成された公開鍵ファイル。
・~/.ssh/known_hosts     :: 過去に接続したことがあるサーバーの情報。クライアント側のファイル。
```

---

## ~/.ssh/authorized_keys  

接続を許可する公開鍵を登録しておくサーバー側のファイル。  
①接続先リモートホストのホームディレクトリ内に「.ssh」ディレクトリを作成。  
②その中にauthorized_keysファイルを作成して、そこに公開鍵をコピーして登録する。  

---

## ~/.ssh/config

SSH接続情報を格納したファイル。  
sshコマンドを使うとき、ここに記述した設定が反映されるので、毎回面倒な接続情報書かなくて済むようになったりする。  
接続時に使うので、クライアント側に配置するファイルだと思われる。  

<https://blog-and-destroy.com/20409>  
<https://qiita.com/0084ken/items/2e4e9ae44ec5e01328f1>  
SSH系の記事が豊富過ぎてまとめるのが大変だ。  

``` txt : 主な設定項目
Host         :: sshコマンド等で指定するホスト名。
HostName     :: 実際の接続ホストのアドレス。IPアドレスや/etc/hostsに指定したホスト名等を指定する。  
                これがあるとホスト名を省略できる。  
User         :: ユーザー名。これがあるとユーザー名を省略できる。  
Port         :: ポート番号。これがあると 「-p ポート番号」 って書かなくてよくなる。  
IdentityFile :: 秘密鍵ファイル。これがあると 「ssh -i 秘密鍵ファイルのパス」 って書かなくてよくなる。  

例)
Host 接続コマンド名（任意の名前）
    HostName ホスト名
    User ユーザー名
    IdentityFile ~/.ssh/秘密鍵のファイル名
    Port ポート番号

ssh 接続コマンド名
を利用した接続が可能になる。  
```

---

## ~/.ssh/id_rsa

ssh-keygenで生成した秘密鍵。  

---

## ~/.ssh/id_rsa.pub

ssh-keygenで生成した公開鍵。  

---

## ~/.ssh/known_hosts

過去に接続したことがあるサーバーの情報。  
クライアント側に保存される。  
内容は**ホスト名、IPアドレス、公開鍵**  

---

## scpコマンド

SSHの仕組みを使い、ホスト間で安全にファイルをコピーするコマンド  

``` txt
ローカルホストにあるファイルをリモートホストにコピーする場合の書式
scp コピー元ファイル名 [ユーザー名@]コピー先ホスト:[コピー先ファイル名]

リモートホストにあるファイルをローカルホストにコピーする場合
scp [ユーザー名@]コピー元ホスト:コピー元ファイル コピー先ファイル名

オプション
-p            :: パーミッションなどを保持したままコピーする
-r            :: ディレクトリ内を再帰的にコピーする
-P ポート番号 :: ポート番号を指定する
```

ローカルホストの/etc/hostsをリモートホストsv3.example.jpの/tmp以下にコピーする。  
`scp /etc/hosts sv3.example.jp:/tmp`  

リモートホストsv3.example.jpの/etc/hostsをカレントディレクトリにコピーする。  
`scp sv3.example.jp:/etc/hosts .`

リモートホストsv3.example.jpのfredユーザーのホームディレクトリに、ローカルホストのdata.txtファイルをコピーする。  
`scp data.txt fred@sv3.example.jp:`  

---

## ssh-agent

「ssh-agent」はメモリ上に秘密鍵を保管しておく認証エージェントです。  

ざっくりまとめ  
・バッググラウンドで動作する。  
・クライアント側で稼働するデーモン。  
・ssh-agentによって起動されたシェル内で認証エージェントとして機能する。  
・起動する度に「ssh-add」コマンドで秘密鍵とパスフレーズを登録しないといけない。  
・秘密鍵とパスフレーズはメモリ上にキャッシュされる。  
・一度起動すると「ssh-agent -k」でssh-agentをkillするまでバックグラウンドで動作し続ける。  
・SSH接続を終了しても停止しない。  
・環境変数SSH_AUTH_SOCKとSSH_AGENT_PIDを利用する。  
・SSHサーバーとは通信しない。ローカルプロセスであるssh及びssh-addと通信する。  

「ssh-keygen」コマンドでキーペアを作成する際にパスフレーズを設定している場合、その秘密鍵を使用する際には毎回パスフレーズの入力が求められます。  
パスフレーズ付きの秘密鍵を使ってSSH接続する際に毎回パスフレーズを入力しないで済むようにするには、「ssh-agent」を使用します。  

ssh-agent起動直後は鍵情報が登録されていませんので、「ssh-add」コマンドで秘密鍵とペアになるパスフレーズを入力して鍵情報を登録します。  
これ以降は登録した秘密鍵を使用したSSH接続時にパスフレーズの入力が求められなくなります。  

「ssh-agent bash」コマンドでssh-agentはbashを起動し、バックグラウンドで動作します。  
ssh-agentによって起動されたシェル内で子プロセスとしてssh-addやsshコマンドを実行すると、これらの認証エージェントとしてssh-agentが機能します。  

指定した文字列を評価後に連結して実行させるevalコマンドでssh-agentを起動することも可能です。  
この場合、現在のシェルでssh-agentが動作します。  

``` txt
#eval `ssh-agent`
Agent pid 23977 ←現在のシェルでssh-agentが動作する。
```

[ssh-agentを使って公開鍵認証方式のsshパスワード入力を省略する方法](https://www.server-memo.net/server-setting/ssh/ssh-agent.html)  
>公開鍵認証方式による認証を行っているSSHサーバーへ接続する際、秘密鍵に設定されているパスフレーズの入力を代わりにやってくれるプログラム。  

パスフレーズの入力回数を減らしてくれるという便利なプログラムだが、ちょっと使いづらい仕様もあったりする。  

- ssh-agentを起動したシェル内のみ有効  
  ログアウトしたりシェルを変更すると使えなくなりssh-agentの再実行が必要  
- ssh-addで秘密鍵とパスフレーズの登録が必要  
  ssh-agentを起動するたびに登録が必要  
- ssh-agentが自動終了しない  
  ログアウトしたりシェルを変更してもssh-agentは自動終了しないため、新しいシェルでssh-agentを起動すると多重起動が発生してしまう  

ssh-agent利用のためには、子プロセスとしてbashシェルを起動する必要がある。  
`ssh-agent bash`  

秘密鍵を登録する。  
`ssh-add`  

秘密鍵の登録確認。  
`ssh-add -l`  

---

## ssh-addコマンド

認証エージェントであるssh-agentに秘密鍵を登録するコマンド。  

「ssh-keygen」コマンドで鍵を作成する際、パスフレーズの入力が求められます。  
SSHサーバへ公開鍵認証方式で接続する際には秘密鍵へのアクセスが必要となるため、毎回パスフレーズの入力が必要になります。  
SSH接続時にパスフレーズを聞かれないようにする為には「ssh-agent」コマンドを使用します。これはメモリ上に秘密鍵を保管しておく認証エージェントです。  
ただ、最初は認証エージェントに認証鍵が登録されていませんので、「ssh-add」コマンドを実行し、1度だけパスフレーズを入力して秘密鍵を登録します。  
これ以降、SSH接続時にパスフレーズの入力が求められなくなります。  

---

## ポートフォワーディング

SSHクライアント to SSHサーバー  

SSHポート転送(ポートフォワーディング)とは、あるポートに送られてきたTCPパケットをSSHを使った安全な通信路を経由して、リモートホストの任意のポートに転送すること。  
POP3やFTPなど、暗号化されていないプロトコルを使った通信の安全性を高めることが出来る。  

SSHには、他の通信を自身の作成する暗号化コネクション内に流す機能があります。  
この機能はポートフォワーディングによって実現されています。  
ポートフォワーディングとは、あるポートで受け取った通信を別のポートに転送する処理のことです。  

-Lは「Local port forwarding」のためのオプションです。  

``` txt
ping-tバージョン
ssh -L 転送対象ポート番号:SSHサーバーから見た接続先アドレス:SSHサーバーからの接続先ポート番号 [SSH接続ユーザー名@]SSHサーバーアドレス

例)ローカルのポート8000への接続は、SSHサーバー自身(localhost)のポート80(Webサーバー)へ転送する。
ssh -L 8000:localhost:80 user@ssh-server


白本か小豆本バージョン
ssh -L [ローカルポート]:[リモートホスト]:[リモートポート] [リモートホストのユーザー名]@[リモートホスト]

例)ローカルホストの10110版ポートに接続すると、リモートホストpop.example.netの110番ポートに接続する。  
ssh -f -N -L 10110:pop.example.net:110 student@pop.example.net
```

``` txt : SSHポートフォワーディング例

 外部Webサーバー               SSHサーバー                   SSHクライアント
(www.example.com)①
        ↑                                   SSH暗号化接続                                     Webブラウザ
        ↑←←←←←←←←←← SSHサーバー ←←←←←←←←  SSHクライアント ポート 8080 ← ① ポートフォワードlocalhost:8080にアクセスした場合
                                   ↓                                        ポート10080 ← ② ポートフォワードlocalhost:10080にアクセスした場合
                               Webサーバー②
                                                                            Webサーバー  ← ③ポートフォワードしない場合のlocalhost:8080アクセス

Webブラウザで「http://localhost」に接続すると、自身の内部で動作するWebサーバにアクセスしに行きます③。
ここで、SSHサーバへの接続に以下の2つのポートフォワーディング設定を行います。
・ローカルのポート8080への接続を、外部Webサーバ（www.example.com）のポート80へ転送する①
ssh -L 8080:www.example.com:80 user@ssh-server

・ローカルのポート10080への接続は、SSHサーバ自身（localhost）のポート80（Webサーバ）へ転送する②
ssh -L 10080:localhost:80 user@ssh-server

次にWebブラウザでの接続先を変更すると、アクセス先が変更されます。
・接続先「http://localhost:8080」 → 外部Webサーバへ接続
・接続先「http://localhost:10080」→ SSHサーバ内のWebサーバへ接続

このように、SSHがポートを用意して通信を中継することをSSHポートフォワーディングといいます。
また、SSHの暗号化接続内を通ることで、SSHサーバ・クライアント間でのHTTP通信は外部から内容を盗み見ることができなくなります。
こういった特性から、SSHポートフォワーディングのことを「SSHトンネリング」と呼ぶこともあります。
そのため、SSHポートフォワーディング設定を行うことを俗に「トンネルを掘る」ということもあります。
```

---

## リモートポートフォワーディング

SSHサーバー to SSHクライアント  

逆向きの「Remote port forwarding」もあります。  
この場合はSSHサーバが転送用ポートを用意し、SSHクライアントの指定されたポートに転送します。  

``` txt : イメージ
以下の例では、「SSHサーバのポート8080へのアクセスは、SSHクライアントのポート80（Webサーバ）へ転送」されます。

外部サーバー    SSHサーバー                  SSHクライアント
    →→→→→  ポート8080
                    ↓      SSH暗号化接続
                SSHサーバ →→→→→→→→→ SSHクライアント
                                                 ↓
                                             Webサーバー
```

リモートポートフォワーディングはSSHクライアント上でsshコマンドを以下の書式で実行します。  
-Rは「Remote port forwarding」のためのオプションです。  

``` txt
ssh -R 転送対象ポート番号:SSHクライアントから見た接続先アドレス:SSHクライアントからの接続先ポート番号 [SSH接続ユーザー名@]SSHサーバアドレス

例)SSHサーバのポート8080へのアクセスは、SSHクライアントのポート80（Webサーバ）へ転送する
ssh -R 8080:localhost:80 user@ssh-server
```

---

## X11ポートフォワーディング

SSHサーバー to SSHクライアント with X11  

ポートフォワーディングをネットワークを介したXサーバ・クライアントの通信に特化し、通信の暗号化、設定作業を簡略化できるX11フォワーディングがあります。  
Xサーバ・クライアント間の通信は暗号化されていないため、入力したキー情報など盗み見られる恐れがあります。  
X11フォワーディングを使うことで、ローカルのXサーバとリモートのXクライアントで安全に通信を行うことができます。  

X11ポート転送を有効にするためにはSSHサーバの設定ファイル`/etc/ssh/sshd_config`で「X11Forwarding yes」となっている必要がある。  

``` txt : イメージ
SSHサーバー                    SSHクライアント

               SSH暗号化接続
SSHサーバー  →→→→→→→→  SSHクライアント
     ↑                           ↓
Xクライアント                  Xサーバー  → 画面表示
```

X11フォワーディングはSSHクライアント上でsshコマンドを以下の書式で実行します。  

``` txt
書式
ssh -X [SSH接続ユーザー名@]SSHサーバアドレス [Xクライアントコマンド]
```

このコマンドにより、SSHサーバ上のXクライアントが、SSHクライアントのXサーバ画面上に表示されます。  
なお、-Xオプションを付けてssh接続すると、Xクライアントの表示用にDISPLAY環境変数が自動で設定されます。  
そのため、-Xオプション付きで接続したsshセッションでは、起動したXクライアントはすべてSSHクライアント（ローカル）側のXサーバに表示されます。  
