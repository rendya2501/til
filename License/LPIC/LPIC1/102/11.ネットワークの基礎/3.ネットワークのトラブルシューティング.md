# ネットワークのトラブルシューティング

---

## pingコマンド  

pingコマンドは、エラーメッセージや制御メッセージを通知する「ICMP」というプロトコルを使って、ネットワークの疎通確認を行います。  
送信元デバイスでpingコマンドを実行すると、ICMPエコー要求パケットが宛先へと送信されます。  
宛先デバイスでエコー要求パケットを正常に受信すると、正常に受信したことを知らせるためのICMPエコー応答パケットが送り返されてきます。  
通信に問題がある場合は、エラーの原因として時間超過や宛先到達不能などのメッセージが返されます。  

指定されたホスト(ホスト名もしくはIPアドレス)にICMPパケットを送り、その反応を表示するコマンド  
何もオプションを指定しない場合、Ctrl + Cを押すまで送信し続ける。  

ipv6の場合はping6コマンドを使う。内容は全く同じ。  
IPv6アドレスが割り当てられていない宛先へはIPv6アドレスの解決ができないため、ping6コマンドはエラーになります。  
同様に、IPv6ルーティングが無効で、宛先までの経路が存在しない場合もエラーになります。  

``` txt
ping [オプション] ホスト名orIPアドレス

-c 回数 :: 指定した回数だけICMPパケットを送信する。(count)
-i 間隔 :: 指定した間隔(秒)ごとにICPMパケットを送信する(デフォは1秒)(interval)
-n      :: 結果表示時の形式をホスト名ではなくアドレスで表示(numeric)

※IPv6のリンクローカルアドレス（fe80::/10）宛にping6を実行する場合は、-I（大文字i）で出力インターフェースを指定する必要がある。
※Windowsのpingコマンドでは-nが送信するパケットの回数を指定するオプションです。

・応答がない場合
サーバーがダウンしている場合に発生するエラー。
停止しているサーバに対してpingを実行した場合、Ctrl+Cで強制終了するまで応答がない。

・ネットワークに届かないというエラーが返ってくる
コマンドを実行するマシンのインタフェースがdownしている時のエラーです。

・ホストに届かないというエラーが返ってくる
存在しないIPアドレスに対して実行した場合のエラーです。
```

---

## tracerouteコマンド  

tracerouteコマンドは、リモートホストまでの通信経路を表示します。  
宛先ホストに対して、デフォルトではUDPパケットのTTLを1から1つずつ増やして送信を繰り返します。  
※Time to Live: パケットの生存期間を表し、ルータを経過する度に1つ減る  
TTLが0になった時点の機器はICMP Time Exceeded（時間切れ通知）を送信元に返すので、この情報を元にパケットが通過した経路が組み立てられ、  
経路上のどこに問題があるのかを確認することもできます。  

指定されたホスト(ホスト名もしくはIPアドレス)までパケットが伝わる経路を表示するコマンド  
宛先までのルータやホストが順に表示される。  
ネットワーク経路上に障害があった場合は、その位置を特定できる可能性がある。  
ipv6はtraceroute6コマンドを使う。内容は全く同じ。  

- パケット送信に使用するデフォルトのプロトコルはUDP。  
- UDPポートのデフォルトは33434番で、送信するたびにインクリメントする。  
- routepathはtracerouteよりも機能が少なく、特権を必要とするRAWパケットを生成するオプションもない。  

``` txt
traceroute [オプション] ホスト名orIPアドレス  

オプション
-l            :: ICMP ECHOパケットを送信。デフォルトはUDPパケット。
-f TTL 初期値 :: TTL(Time To Live)の初期値を設定。デフォルトは1。
-n            :: 結果表示の形式をホスト名ではなくアドレスで表示(numeric)
```

---

## tracepathコマンド  

宛先アドレスまでの経路と経路上の最大転送単位(PathMTU)表示するコマンド。  
ip6はtracepath6コマンドを使う。内容は全く同じ。  

``` txt
tracepath [オプション] ホスト名orIPアドレス[/ポート番号]  

-n :: 結果表示の形式をホスト名ではなくアドレスで表示(numeric)
```

---

## 疎通コマンド早見表

``` txt
ping       :: 宛先アドレスに到達可能かを確認。
traceroute :: 宛先アドレスまでの経路を確認。
tracepath  :: 宛先アドレスまでの経路と経路上の最大転送単位(PathMTU)を確認。

※IPv4対応コマンドでも、最近は「-6」オプションを使用する事でIPv6対応できる。

※MTU(Maximum Transmission Unit)  
通信用に細切れにしたデータの大きさ制限で『これくらいの大きさの細切れデータなら通れるよ（送れるよ）』な最大値  
```

---

## hostnameコマンド

ホスト名を一時的に変更するコマンド。  
ホスト名の表示も可能。  
マシンの再起動で設定は元に戻る。  
恒久的な変更には「/etc」以下のファイルに設定します。  
ホスト名を変更できるのはrootユーザーのみ。  

ホスト名変更色々まとめ。  
[CentOS 7 の Hostname を変更する](https://qiita.com/notakaos/items/d18ab37bce2b25b2d5b0)  

``` txt
hostname [ホスト名]  

ホスト名を指定しない場合 :: 現在のホスト名を表示する。  
ホスト名を指定した場合   :: ホスト名を変更する。  
```

---

## netstatコマンド  

ネットワーク機能に関する様々な情報を表示するコマンド  
開いているポートの検索によく利用する模様。  
「netstat」コマンドはネットワーク情報の表示は出来ますが、設定は一切出来ません。  

``` txt
netstat [オプション]  

-a :: すべてのソケット情報を表示する。全てのプロトコル(TCP,UDP,UNIXソケット)を表示  
-l :: 接続待ち(LISTEN)のソケットを表示。  
-c :: 状況を1秒ごとにリアルタイムで表示する。  
-i :: ネットワークインターフェースの状態を表示する。  
-n :: アドレスやポートを数値で表示する。(つまり名前解決しない)  
-p :: pidとプロセス名も表示する。  
-s :: 統計情報を表示
-r :: ルーティングテーブルを表示する。  
-t :: TCPポートのみ表示する。  
-u :: UDPポートのみ表示する。  
-x :: UNIXソケットを表示  
      ※ソケット :: プログラムがデータを交換する窓口  

オプション無し :: 有効なネットワーク接続や開いているソケットの情報等を表示。

■表示される項目
Active Internet connections
Proto , Recv-Q , Send-Q , LocalAddress , ForeignAddress , State , 
Active UNIX domain sockets
Proto , RefCnt , Flags , Type , State , I-Node , Path
```

netstatコマンドを打ったが、結果がなかなか表示されない。  
原因と考えられるものは何か。  
→  
DNSによる名前解決ができない。  
→  
-nオプションを指定する。  
→  
「netstat」コマンドはオプション無しで実行すると、有効なネットワーク接続や開いているソケットの情報等を表示します。  
その際にはアドレスやポート番号の名前解決を自動で行って表示します。  
この時にDNSサーバに障害などがあると、名前解決が出来ずに、結果が表示がされない場合があります。  

---

## ssコマンド

ssコマンドはnetstatの後継となるコマンドで、ネットワークのソケットの情報を表示します。  
ifconfig、route、arp、netstatコマンドなど旧来のネットワーク関連ユーティリティであるnet-toolsの代替として開発されたiproute2ユーティリティに含まれています。  

``` txt
ss [オプション]

オプション
-a :: 全てのソケットを表示
-n :: サービス名の名前解決をしない
-t :: TCPソケットを表示
-u :: UDPソケットを表示

※ソケット :: プログラムがデータを交換する窓口  

■表示項目
Netid,State,Recv-Q,Send-Q,LocalAddress:Port,Peer Address:Port
```

---

## ncコマンド  

netcatコマンド。  
catコマンドのネットワーク版。  
テキストストリームにおけるcatコマンドと同様の働きをネットワーク上で行うコマンド。  

NetcatはTCP/UDPを使った通信を手軽に行うことのできる便利なツールです。  
・標準入出力を使用してのデータ授受  
・TCP/UDPでのデータ送受信  
・簡易的なサーバになれる  

※catコマンド  
conCATenate(繋ぐ、連結する)。  
ファイルを連結するためのコマンド  

``` txt
nc [オプション] [接続先アドレス or ホスト] [宛先ポート番号]  

オプション
-l          :: 指定したアドレス、ポート番号で接続の待ち受けをする。(listen)
               指定したポートをリッスンする。  
               ※簡易サーバ構築に用いられる模様。
-p ポート   :: ポート番号を指定する。  
-u          :: UDPを利用する。(デフォはTCP)  
-o ファイル :: 指定したファイルに出力する。  

※宛先ポート番号が未指定の場合、デフォルトで31337番ポートが指定されたものとして動作する。
```

12345番ポートで待ち受け氏、受け取ったデータをlisten.logファイルに出力する。  
`nc -l -p 12345 -o listen.log`  

上記例を実行したホストの12345番ポートに対し、data.txtファイルの内容を出力する。  
`nc centos7.example.com 12345 < data.txt`  

ファイアウォール機能のテスト用に、Netcatを使って簡易サーバを用意したい。  
serverの8000/tcpで待ち受けし、clientから接続されるとresponse.txtを返す実行例。  
`nc -l 8000 < response.txt`  

ファイアウォール機能のテストのため、Netcatで送信元ポート番号を50000に指定して接続したい。  
`np -p 50000 test-sv`  

ローカルホスト（127.0.0.1）のSSHサーバ（ポート番号：22）にclientのポート番号50000から接続した例  
`nc -p 50000 127.0.0.1 22 &`  

---

## routeコマンド  

ルーティングテーブルの表示や操作を行うコマンド  
routeコマンドを引数なしで実行すると、ルーティングテーブルが表示される。  
`route` = `netstat -r` = `ip route show`

``` txt
■ルーティングテーブルの表示を行う書式
route [オプション]

オプション
-F :: カーネルのルーティングテーブルを表示(オプション指定無しと同じ)
-C :: カーネルのルーティングキャッシュを表示
-n :: 名前解決をせずルーティングテーブルを表示

■ルーティングテーブルの主な項目
Destination :: 宛先ネットワークアドレス(defaultはデフォルトルート)
Gateway     :: 宛先ネットワークへのゲートウェイ。(*は未設定)
Genmask     :: 宛先ネットワークのサブネットマスク(デフォルトルートは0.0.0.0)
Flags       :: 状態フラグ
Iface       :: 宛先ネットワークへの送信に使用するインターフェース

■状態フラグの項目
U :: 経路が有効
H :: 対象をホストとして設定
G :: ゲートウェイを使用


■ルーティングテーブルに新しい経路を追加する書式
route add [オプション]

-p :: add時に指定すると、次回以降のOS起動後も有効になる。

■ルーティングテーブルから経路情報を削除する書式
route del [オプション]

追加・削除オプション
-host      :: 対象をホストのアドレスとみなす
-net       :: 対象をネットワークアドレスとみなす
netmask    :: サブネットマスクを指定
gw         :: ゲートウェイを指定
default gw :: デフォルトゲートウェイを指定
```

192.168.0.0/24のネットワークあてのパケットは、ゲートウェイ172.30.0.254に送られるようにする設定を追加するコマンド例  
`route add -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイを172.30.0.1に設定する  
`route add default gw 172.30.0.1`  

設定した経路情報を削除する。  
`route del -net 192.168.0.0 netmask 255.255.255.0 gw 172.30.0.254`  

デフォルトゲートウェイ172.17.255.254を削除する。
`route del default gw 172.17.255.254`  
`route del default`  
→  
デフォルトゲートウェイを削除するには、デフォルトゲートウェイのIPアドレスを指定して削除する方法としないで削除する方法があります。  
IPアドレスを指定する場合は、「route del」の後に「default gw」というオプションの後でIPアドレスを指定します。  
例えば「route del default gw 192.168.1.254」のようになります。  
IPアドレスを指定しない場合は、「route del default」のみでデフォルトゲートウェイの削除は可能です。  
その場合「gw」は付けてはいけません。  

---

## ipコマンド  

ネットワークインターフェースやルーティングテーブル、ARPテーブル等を管理するコマンド。  
ipコマンドはifconfigコマンドに変わる新しいコマンド。  

ifconfig、route、arp、netstatなどの旧来のネットワーク関連コマンドを置き換えるために、iproute2 ネットワークユーティリティが開発されました。  
iproute2を使うことで、※ポリシーベースルーティングやトラフィック制御といった高度なネットワーク設定が可能になります。  
iproute2ユーティリティでは、ipコマンドでアドレス設定、ルーティング設定などを行います。  
Red Hat Enterprise Linux 7からは旧来のネットワーク関連コマンドは非推奨となっており、今後はiproute2の使用が推奨されます。  
なお、現在でも旧来のネットワーク関連コマンドは提供されており、iproute2と併用することが可能です。  

※ポリシーベースルーティング（PBR）：  
通常のルーティングは宛先アドレスを元にパケットの送信先を決定しますが、  
PBRはそれ以外の情報（送信元アドレス、UDP/TCPのプロトコル、ポート番号など）を組み合わせてより詳細にパケットの送信先を決定するルーティング方式です。  

ipコマンドは、オブジェクト（機能）に対して、コマンド（処理）を指定する形式で実行します。  
オブジェクトやコマンドは短縮して指定することも可能です。  
なお、各オブジェクトごとに指定可能なコマンドは異なります。  

``` txt
ip [オプション] オブジェクト [サブコマンド] [デバイス]

オプション
-s :: 統計情報を表示する

オブジェクト
link      :: データリンク層、ネットワークデバイス、インターフェース
addr      :: IPv4,IPv6アドレス(短縮版は「a」)
route     :: ルーティングテーブル
neighbour :: IPv4のARPキャッシュ、IPv6のNDキャッシュ(アメリカ英語である「neighbor」でも動作する。「neighbour」はイギリス英語)

サブコマンド
show :: 現在の状態の表示(省略したときのデフォルト)(短縮版は「sh」)
add  :: 値の追加
del  :: 値の削除

※IPv6ではARPの代わりにND（Neighbor Discovery）を使って宛先MACアドレスを入手します。
入手したMACアドレスはNDキャッシュに格納されます。
NDキャッシュのみを確認する場合はIPv6を指定する「-6」または「-f inet6」オプションを指定します。

●routeオブジェクトに対する操作では、値としてデフォルトルートを意味する「default」を指定することもできます。

●経路情報を追加するには、routeオブジェクトにaddコマンドを発行します。その際、値を以下の書式で指定します。
ip route add 宛先ネットワークアドレス/サブネットマスク長 via ゲートウェイアドレス [ dev 出力インタフェース ]

例)
宛先ネットワークアドレス：192.168.3.0
サブネットマスク：255.255.255.0
ゲートウェイ：192.168.1.1

ip route add 192.168.3.0/24 via 192.168.1.1


●経路情報を削除するには、routeオブジェクトにdelコマンドを発行します。その際、値を以下の書式で指定します。
ip route del 宛先ネットワークアドレス/サブネットマスク長 [via ゲートウェイアドレス [ dev 出力インタフェース ]]

※デフォルトルートを対象とする場合は「宛先ネットワークアドレス/サブネットマスク長」を「default」と指定します。

例)
ip route del 192.168.3.0/26 via 192.168.2.101 dev eth1

例)コマンドで、デフォルトルートを削除する  
ip route del default
ip route del default via 192.168.122.1


●インタフェースにアドレスを追加するには、addrオブジェクトにaddコマンドを発行します。その際、値を以下の書式で指定します。
ip addr add 宛先ネットワークアドレス/サブネットマスク長 dev インタフェース

例)ip コマンドを使って、lo インタフェースに以下のアドレスを追加したい。
アドレス：127.0.0.100
サブネットマスク：255.255.0.0

ip addr add 127.0.0.100/16 dev lo


●インタフェースを有効化・無効化するには、linkオブジェクトにsetコマンドを発行します。
ip link set { up | down } dev インタフェース
ip link set インタフェース up|down

up   :: インターフェースの有効化
down :: インターフェースの無効化


●IPアドレスの設定状況を確認したい。(短縮バージョン)
ip addr showの短縮バージョン
ip a sh
```

ネットワークインターフェースのデータリンク層の情報を表示する  
`ip link show`  

ネットワークインターフェースeth0の詳細情報を表示する  
`ip -s link show dev eth0`  

ルーティングテーブルの表示  
`ip route show`  

eth0インターフェースの状態やIPアドレスの表示  
`ip addr show eth0`  

eth0のipアドレスを192.168.11.12/24に設定する  
`ip addr add 192.168.11.12/23 dev eth0`  

デフォルトゲートウェイを192.168.11.1に設定  
`ip addr add default via 192.168.11.1`  

---

## 経路表示コマンド早見表

・ip route show  
・route  
・netstat -r  

ipコマンドでルーティングテーブルを表示した場合、viaやdevという表示がある。  

routeとnetstat -rの表示は全く同じ。viaという文言はない。  
Destination,Gateway,Genmask,Flags,Metric,Ref,Use,Iface  

---

## ifconfigコマンド  

ネットワークインターフェースの情報の表示や設定を行うコマンド。  
ipアドレスの確認によく利用する模様。  
ifconfigは古いので非推奨。ifconfigに代わって利用が推奨されるipコマンドを使うべし。  

``` txt
ifconfig [インターフェース名] [オプション]

オプション
IPアドレス        :: ipアドレスを設定する
netmask ｻﾌﾞﾈｯﾄﾏｽｸ :: サブネットマスクを設定する
up                :: ネットワークインターフェースを有効化する
down              :: ネットワークインターフェースを無効化する


インターフェース名やオプションを指定せずに「ifconfig」コマンドのみを実行すると、有効化されている全てのインターフェースの情報が表示されます。
オプションを指定せずインターフェース名を指定すれば、そのインターフェースの情報のみが表示されます。

表示内容
・インターフェースのMACアドレスやIPアドレス
・ブロードキャストアドレス
・サブネットマスク
・送受信バイト数
・MTU（最大転送単位）
等

※ネットワークインターフェース名はデバイスに基づいた命名規則によって生成されるのが一般的らしい  


ifconfigコマンド使用時の影響範囲について述べた記述で、正しいものを二つ選べ。  
→  
・インターフェースのアップ・ダウン状態が変更される  
・ifconfigコマンドを実行しても、何も影響がない場合もある  

・ルーティングテーブルが変わることはない  
インターフェースを停止すると、接続するネットワークの情報がルーティングテーブルから削除されるため、通信できなくなります。  

・ IPアドレスやサブネットマスクは起動スクリプトで設定されるため、ifconfigでは変更できない  
インターフェース名の後にオプションを指定することで、IPアドレスやサブネットマスクの設定が可能です。  

・ルーティングテーブルに影響なくIPアドレスやサブネットマスクを変えられる  
サブネットマスクを変更すると所属するネットワークが変わるため、ルーティングに影響が出ることに注意してください。  


インターフェースを停止すると、接続するネットワークと通信できなくなります。また、接続するネットワークの情報がルーティングテーブルからも削除されます。
サブネットマスクを変更すると所属するネットワークが変わるため、ルーティングに影響が出ることに注意してください。
この場合、インターフェイスはアップ・ダウンしていませんが、ルーティングテーブルは変更されています。
```

ネットワークインターフェースの情報を表示する  
`ifconfig`  

ネットワークインターフェースeth0にipアドレス192.168.0.50、サブネットマスク255.255.255.0を設定する。  
`ifconfig eth0 192.168.0.50 netmask 255.255.255.0`  

ネットワークインターフェースeth0のサブネットマスクを255.255.255.0に設定する。  
`ifconfig eth0 netmask 255.255.255.0`  

---

## ifup

ifupは指定したインタフェースを有効にするコマンドです。  
ディストリビューションによって書式が異なります。  

``` txt
Red Hat系の書式：
ifup インタフェース名

Debian系の書式：
ifup [オプション] インタフェース名

-a :: 「/etc/network/interfaces」でautoフラグが設定されたNICを対象とする
```

---

## ifdown

ifdownは指定したインタフェースを無効にするコマンドです。  
ディストリビューションによって書式が異なります。  

``` txt
Red Hat系の書式：
ifdown インタフェース名

Debian系の書式：
ifdown [オプション] インタフェース名

-a :: 「/etc/network/interfaces」でautoフラグが設定されたNICを対象とする
```

---

## デフォルトルート

・他に宛先がない場合に参照されるルートである  
・Linuxのルーティングテーブルでは「default」と表示される  

宛先ネットワークがルーティングテーブルの「Destination」に存在しない場合は、デフォルトルートの存在を確認し、  
存在する場合はデフォルトルートの「Gateway」（デフォルトゲートウェイ）へ送信します。  
デフォルトルートとは、ルーティングテーブルの「Destination」が「default」と表示されている情報です。  
「route -n」コマンドで名前解決をせずにルーティングテーブルを表示した場合は「0.0.0.0」と表示されます。  
