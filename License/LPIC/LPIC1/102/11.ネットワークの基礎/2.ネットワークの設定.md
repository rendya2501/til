# ネットワークの設定

---

## /etc/services  

ポート番号とサービスの対応が記述されたファイル  
複数形であることに注意。  

``` txt : 表示例
#cat /etc/services
telnet 23/tcp
```

---

## /etc/hostname

ホスト名のみが記述されているファイル。  
ホスト名を記述するファイルはディストリビューションによって異なります。  
・Debian系では従来から「/etc/hostname」を使用しています。  
・Red Hat系ディストリビューションでは「/etc/sysconfig/network」にホスト名や、ネットワーク機能の有効/無効、デフォルトゲートウェイの設定などを記述していましたが、  
Red Hat Enterprise Linux（RHEL）7からは、ホスト名の設定はDebian系同様「/etc/hostname」を使用するようになりました。  

なお、「hostname」コマンドでもホスト名の変更は可能ですが、マシンの再起動で元に戻ってしまいますので、恒久的な変更には「/etc」以下のファイルに設定します。  
ホスト名はwww.hoge.comのwwwの部分。hoge.comに属するwwwというPC名(ホスト名)。  

``` txt : 表示例
# car /etc/hostname
Debian
```

``` conf : 例
centos7.example.com
```

---

## /etc/sysconfig/network

ホスト名を設定(Red Hat系)  
ネットワーク機能の有効/無効やデフォルトゲートウェイ等も設定可能。  
Red Hat Enterprise Linux（RHEL）7からは、ホスト名の設定はDebian系同様「/etc/hostname」を使用するようになりました。  
GATEWAYの設定項目があるのは/etc/sysconfig/networkファイルだけ。  

``` txt : 表示例
# cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=CentOS
GATEWAY=192.168.1.1
```

---

## /etc/hosts

IPアドレスとホスト名の対応付け

名前解決に用いられるシンプルなテキストファイルで、1行に1つのIPアドレスがあり、そのIPアドレスと続くホスト名とを関連づけています。  
IPアドレスはIPv4、IPv6どちらでも指定できます。  
現在では名前解決にDNSが広く用いられている為、「/etc/hosts」ファイルは補助的な役割を果たしています。  

ホスト名とIPアドレスの対応を記述するファイル。  
小規模ならこれで十分。これ以上になればDNSが必要。  
変更の反映は全てのホストに配布する必要がある。  

``` txt : 書式
IPアドレス ホスト名 ホストの別名

スペースで区切って記述する。  
1対1なので、改行する。

例)
127.0.0.1 localhost.localdomain localhost
192.168.0.1 windsor.example.com windsor
fc00:192:168:1::100 FileServer

例2)
# cat /etc/hosts
112.78.124.10 pint-t.com
192.168.1.100 FileServer
```

---

## /etc/network/interfaces  

Debian系でネットワークインターフェースの設定を記述するファイル。  
Debian系はUbuntuとかか。  

設定項目は多数あるので、問題で出たら都度まとめる。  
IPアドレスとかネットマスクとかDNSのIPアドレスとかデフォルトゲートウェイとか、そういう基本的な設定をするのがこのファイルってわけ。  

---

## /etc/sysconfig/network-scriptsディレクトリ  

RedHat系でネットワークインターフェースの設定を記述するディレクトリ。  
ネットワークインターフェース名が「eth0」の場合、設定ファイル名は「ifcfg-eth0」となる。  
IPアドレスを固定で割り当てたい場合などにこのファイルを編集する。  

---

## NetworkManager  

NetworkManagerはRed Hat Enterprise LinuxやCentOSで導入されている、動的にネットワークを管理する仕組みです。  
様々なディストリビューションで採用されており、Red Hat Enterprise Linux 6では、  
従来のinitスクリプトによるネットワーク設定に代わり標準のネットワーク設定として導入されています。  
システムで検出されたネットワークデバイスは自動でNetworkManagerによって管理され、DHCPサーバが有効な環境であればDHCPによって動的なIPアドレスが割り当てられます。  
また、特定のインタフェースをNetworkManagerで管理しないように設定することもできます。  
ノートPCなど移動式のデバイスでは、ネットワーク環境を切り替えるのに便利な機能です。  
ただし、サーバのように設定を固定した方がよい環境では動的に設定が変更されて問題が発生するのを防ぐため、NetworkManagerを無効化することもあります。  
NetworkManagerでは、設定内容をまとめた「接続（connection）」とネットワークデバイスを示す「デバイス（インタフェース）」を別々に定義し、それらを関連付けて管理します。  
既存の接続に新しいデバイスを関連付けることによって、構成変更にも動的に対応できます。  

※特定のインタフェースをNetworkManagerで管理しないように設定できる  
※検出されたネットワークデバイスは自動でNetworkManagerによって管理される  

Ethernet,Wi-Fi,ブリッジといったネットワークデバイスと、デバイスによるネットワーク接続およびデフォルトルート、DNS名前解決を自動的に管理します。  
I/F設定ファイルに特別な記述がない限り、DHCPを利用するので、ネットワークI/Fとデフォルトルートは自動設定される。  
もちろん手動設定も可能。(らしい)  

``` txt
systemdの場合
systemctl status NetworkManager  :: 利用確認
systemctl start NetworkManager   :: 起動
systemctl stop NetworkManager    :: 停止
systemctl enable NetworkManager  :: 有効
systemctl disable NetworkManager :: 無効

SysVinitの場合
/etc/init.d/NetworkManager start :: 起動
/etc/init.d/NetworkMagager stop  :: 停止
chkconfig NetworkManager on      :: 有効
chkconfig NetworkManager off     :: 無効
```

・デフォルトでは固定のIPアドレスが設定される  
DHCPサーバが有効な環境であればDHCPによって動的なIPアドレスが設定されますが、固定IPアドレスは設定されません。よって誤りです。  

・NetworkManagerが管理していないインタフェースも動的に設定する  
NetworkManagerが管理していないインタフェースは管理下にないため、NetworkManagerによる動的な設定は行われませんので、誤りです。  

・無効にするとネットワークに接続できなくなる  
NetworkManagerは無効化できますが、接続設定は維持されネットワークに接続できなくなることはありません。  
従来のinitスクリプトによるネットワーク設定も行えます。よって誤りです。  

``` txt : NetworkManagerで管理できるネットワークデバイスのタイプ  
・ethernet  
・wifi  
・bridge  

ethernetは有線、wifiは無線、bridgeは異なるネットワーク間の接続を示します。  
「nmcli connection show」で確認可能。  
```

---

## nmtuiコマンド

NetworkManagerによるネットワーク管理を行える、cursesベースのインタフェースを起動するコマンド。  
nmtuiはcurses（カーシス: UNIX向け端末制御ライブラリ）ベースのテキストユーザインタフェース（TUI）です。  
コマンドラインからnmtuiコマンドで起動します。  

---

## nmcliコマンド  

NetworkManagerにおいて、ネットワークの設定、接続の管理、状態の確認を行うコマンド。  
Network Manager Command Line Interfaceの略見たい。  

``` txt
nmcli オブジェクト [コマンド]

オブジェクト  コマンド
general     :: status                          :: NetworkManagerの状態を表示
            :: hostname[ホスト名]              :: ホスト名を表示・指定したホスト名に変更
networking  :: {on|off}                        :: ネットワークの有効化|無効化
            :: connectivity                    :: ネットワークの接続状態を表示
radio       :: wifi                            :: Wi-Fiの状態を表示
            :: wifi {on|off}                   :: Wi-Fi接続の有効化|無効化
connection  :: show                            :: 接続状況を表示
            :: modify ID パラメータ            :: 指定した接続IDの設定ファイル(/etc/sysconfig/network-scripts/ifcfg-<接続名>)の指定したﾊﾟﾗﾒｰﾀを書き換える。
                                                  ﾊﾟﾗﾒｰﾀの反映には接続のconnection up操作が必要。
            :: {up|down} ID                    :: 接続の有効化|無効化
device      :: status                          :: デバイスの状態を表示
            :: show ｲﾝﾀｰﾌｪｰｽ名                 :: 指定したデバイスの詳細情報を表示
            :: {connect|disconnect} ｲﾝﾀｰﾌｪｰｽ名 :: 指定したデバイスを接続|切断
            :: modify ｲﾝﾀｰﾌｪｰｽ名               :: 指定したｲﾝﾀｰﾌｪｰｽのﾊﾟﾗﾒｰﾀを即時変更する。設定ファイルの書き換えは行われない。
            :: monitor ｲﾝﾀｰﾌｪｰｽ名              :: 指定したデバイスの監視
            :: delete ｲﾝﾀｰﾌｪｰｽ名               :: ｿﾌﾄｳｪｱﾃﾞﾊﾞｲｽ(ﾌﾞﾘｯｼﾞなど)の削除。※ﾌﾞﾘｯｼﾞとは異なるﾈｯﾄﾜｰｸ同士を接続して同一のｾｸﾞﾒﾝﾄとしてまとめる手法
            :: wifi list                       :: Wi-Fiアクセスポイントの表示
            :: wifi connect SSID               :: Wi-Fiに接続するデバイスを作成、有効化。※接続できなければエラーを返す。
            :: wifi rescan                     :: wi-fiアクセスポイントの再検索
agent
monitor
help
```

NetworkManagerで管理できるネットワークデバイスのタイプ  
wifi,ethernet,bridge  
`nmcli connection show`(接続状況を表示)で確認できる。  

``` txt : nmcli networking connectivityで表示されるネットワークの接続状態
full    :: インターネットにアクセス可能なネットワークに接続している。
portal  :: インターネットにアクセスする前のcaptive portalの状態である。
           ※captive portal(キャプティブポータル)
           Wi-Fiホットスポットやホテルなどでインターネット利用前に強制的に認証や課金のWebページを参照させる技術。
           ログインが完了しないとインターネットにアクセスできない。
limited :: ネットワークに接続しているが、インターネットにアクセスできない。
none    :: どのネットワークにも接続していない。
unknown :: 接続状態が見つからない。
```

ホスト名をcentos.localdomainに設定  
`nmcli general hostname centos.localdomain`  

ホスト名の表示  
`nmcli general hostname`  

デバイスの状態を表示する  
`nmcli device status`  

ネットワークの状態を表示する  
`nmcli networking connectivity`  

My-WiFiに接続する
`nmcli device wifi connect My-Wifi`

---

## hostnamectlコマンド  

ホスト名を設定するコマンド  
systemdが動作するシステムでは、hostnamectlコマンドでもホスト名や関連する情報の表示、ホスト名の設定を行えます。

``` txt
hostnamectl [サブコマンド]

サブコマンド
status                :: ホスト名と関連情報を表示する(でふぉ)
set-hostname ホスト名 :: ホスト名を設定する  
```

 ホスト名をvm2に変更  
`hostnamectl set-hostname vm2`  

/etc/hostnameファイルでもホスト名を変更できるなら、hostnamectlコマンドでホスト名を変更した情報はどこに保存されるのか？  
hostnamectlコマンドで/etc/hostnameファイルが変更される？  
[hostnameコマンドより便利なhostnamectlコマンド](https://linuc.spa-miz.com/2020/12/23/hostnamectl-command-more-useful-than-the-hostname-command/)  
→
hostnamectlコマンドで/etc/hostnameファイルが変更されるらしい。  
結局、保存先であるファイルが全て何だな。  

---

## systemd-networkd

systemdの動作するシステムでネットワーク設定を管理するデーモンです。  
systemd-networkdの設定は「/etc/systemd/network」配下の拡張子.networkのファイルで行います。  
