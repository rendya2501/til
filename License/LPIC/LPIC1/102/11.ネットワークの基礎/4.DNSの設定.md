# DNSの設定

---

## DNS（Domain Name System）

DNS（Domain Name System）はドメイン名/ホスト名などの名前とIPアドレスを対応させるシステムです。  
DNSサーバが名前とIPアドレスの対応情報（リソースレコード）を管理し、DNSクライアントからの問い合わせに対して名前解決のための情報を提供します。  

DNSサーバにはDNSキャッシュサーバと権威DNSサーバがあり、インターネット上の多数のDNSサーバでドメイン情報を分散して管理しています。  
・DNSキャッシュサーバ  
権威DNSサーバに問い合わせを行い、得た情報をキャッシュに保持します。  
保持している情報に該当する問い合わせがきた場合は権威DNSサーバに問い合わせずに応答することで、DNSクライアントへの応答速度を上げるとともに、  
権威DNSサーバの負荷も減らします。  

・権威DNSサーバ（ネームサーバ）  
特定のドメインの情報を管理する正当な権限を持つDNSサーバです。  
「xxx.com」を管理する権威DNSサーバや、「xxx.jp」を管理する権威DNSサーバのように、ドメインごとに分散管理しています。名前に関する情報（コンテンツ）を保持するため、  
コンテンツサーバともよばれます。  

DNSサーバが管理している情報をリソースレコードと呼び、主に以下のリソースタイプ（種類）があります。

``` txt
a   :: IPアドレス
mx  :: メールサーバーの情報
ns  :: ネームサーバーの情報
soa :: ゾーン(ドメインの範囲)の情報
txt :: テキスト情報
```

ホスト名とIPアドレスの相互変換→名前解決  
ホスト名からIPアドレスを求める→正引き  
IPアドレスカラホスト名を求める→逆引き  

www.example.com
www : ホスト名  
example.com : ドメイン名  

ネットワークの区画(ドメイン)に所属しているPC名(ホスト名)  

---

## /etc/resolv.conf

名前解決に使用するDNSサーバや、DNSの名前解決問い合わせに関するオプションを設定するファイル。  
ファイル名はresolveではなく**resolv**なので注意。  

今思ったらdns domain,nameserver,serachでdnsの頭文字になってる。  
これならそれっぽく覚えられるな。  

``` txt : 主な設定項目
■domain
このホストが所属するドメイン名を記述する。  
ドメイン名を含まないホスト名を検索する場合、このドメイン内を検索する。  
複数のドメイン名を指定することはできない。  
自ドメインを指定する際はdomainにドメイン名を記述する。  
例)自ドメインが(pint-t.com)だった場合  
「domain pint-t.com」

■nameserver
名前解決に使用するDNSサーバーのIPアドレスを記述。(1サーバー1行)
nameserverの指定は3台まで。  
応答が無ければ次の行を参照する。  
※「問い合わせて解決できなければ」ではなく、「応答がなければ」であることに注意。  

■serach
ドメイン名の省略時に補完するドメイン名を記述。  
複数指定可能。スペースで区切る。左から右へ検索していく。  
searchの指定を行った場合、ドットがないホスト名についてはsearchで指定したドメインを検索する。

・nameserverは標準では3つまでしか設定できません。上限を変更する場合はライブラリの再コンパイルが必要になります。
・domainは自身の所属するドメイン名を記述します。ホスト名のみの問い合わせの場合は同じドメインに所属するホストとみなされ、自動的にドメイン名が追加されます
・searchは省略されうるドメイン名を列挙します。最大6つまでしか設定できず、上限を変更する場合はライブラリの再コンパイルが必要になります。
・domainとsearchはいずれか一つしか設定できず、最後に記述されたものが有効になります。
```

``` txt : 記述例
例1)
domain infraeye.com
search infraeye.com infraeye.net infraeye.edu
nameserver 192.168.231.2

例2)
# cat /etc/resolv.conf
search test1.domain test2.domain test3.domain
nameserver 192.168.1.1
nameserver 192.168.1.2
nameserver 192.168.1.3
```

domain、searchの設定の違いについて、
・DNSサーバではないサーバ（192.168.1.1）
・名前解決の問い合わせに「NXDomain（存在しないドメイン）」を返すDNSサーバ（192.168.1.2）
・名前解決の問い合わせ元（192.168.1.101）でのパケットキャプチャ

``` txt
#cat /etc/resolv.conf
domain local.domain
nameserver 192.168.1.1
nameserver 192.168.1.2
nameserver 192.168.1.3
```

設問の設定では、以下のように名前解決しようとします。  
■問い合わせ順序  
・DNSサーバ 192.168.1.1に最初に問い合わせる  
・192.168.1.1から応答がなければ、192.168.1.2に問い合わせる  
・192.168.1.2から応答がなければ、192.168.1.3に問い合わせる  

■名前解決の対象がホスト名のみ（＝ドットを含まない）の場合  
・リストの1番目（test1.domain）をホスト名につけて名前解決  
・リストの1番目のドメインを追加して名前解決に失敗した場合、リストの2番目（test2.domain）を追加して名前解決  
・リストの2番目のドメインを追加して名前解決に失敗した場合、リストの3番目（test3.domain）を追加して名前解決  
・search行のドメイン名リストすべてで失敗した場合、ホスト名のみで名前解決  
・ホスト名のみでも失敗した場合、名前解決に失敗とする  

■名前解決の対象がドメイン名付き（と思われる＝ドットを含む）の場合  
・そのままで名前解決  
・失敗した場合、リストの1番目（test1.domain）を追加して名前解決  
・リストの1番目のドメインを追加して名前解決に失敗した場合、リストの2番目（test2.domain）を追加して名前解決  
・リストの2番目のドメインを追加して名前解決に失敗した場合、リストの3番目（test3.domain）を追加して名前解決  
・search行のメイン名リストすべてで失敗した場合、名前解決に失敗とする  

したがって正解は  
・192.168.1.1から応答が無ければ、192.168.1.2に問い合わせる  
・ホスト名にtest1.domain、test2.domain、test3.domainの順にドメインを追加して名前解決を試みる  

---

## ドメイン

<https://t-tel.net/domain/092/>  

`https://www.example.com`  
ホスト名 : www  
ドメイン名 : example.com  
FQDN : www.example.com  

ホスト名 + ドメイン名 = FQDN  
Fully Qualified Domain Name  

---

## /etc/nsswitch.conf  

「nsswitch.conf」は、GNU Cライブラリが名前解決やサービス名解決の際の問い合わせ順序を指定するファイルです。  
ユーザー情報、パスワード情報の取得、ホスト名からIPアドレスを取得する際の情報検索先など設定内容は多岐にわたります。  

名前解決の仕方にも色々あるので、どういう順番でどういう手段を使うのかを設定するファイル  

主な名前解決の方法  
・etc/hostsファイルでの問い合わせ→files  
・LDAPサーバーへの問い合わせ→ladp  
・DNSサーバーへの問い合わせ→dns  

以下の記述例の場合、ホスト名の名前解決のために最初に/etc/hostsファイルを参照し、次にLDAPサーバーに問い合わせ、最後にDNSサーバーに問い合わせるように定義している。  

``` txt : /etc/nsswitch.confファイルの設定例
hosts: files ldap dns
```

「passwd」の行でパスワードの情報源の順番を指定します。  
「files」が「/etc/passwd」ファイルを表します。  
「hosts」の行で名前解決の順番を指定します。  
「files」が「/etc/hosts」ファイルを、「dns」がDNSサーバを表します。  
「/etc/hosts」を先に参照し、そこで名前解決が出来なければDNSサーバに問い合わせを行うように指定しています。  

「/etc/nsswitch.conf」ファイルでは、「hosts」の行で名前解決の順番を指定します。  
「files」が「/etc/hosts」ファイルを、「dns」がDNSサーバを表します。  
表示例では「/etc/hosts」を先に参照し、そこで名前解決が出来なければDNSサーバに問い合わせを行うように指定しています。  

「hosts:」に続けて優先順位の高い方から名前解決方法を記述します。  
最初の「files」で「/etc/hosts」ファイルを参照して名前解決をするように指定し、それができなければ続く「dns」でDNSサーバに問い合わせを行うように指定しています。  

``` txt
cat /etc/nsswitch.conf
passwd: files
hosts: files dns
```

---

## etc/systemd/resolved.conf

systemdを採用したディストリビューションでは、名前解決にsystemd-resolvedサービスが使われる。  
その設定ファイル。  

``` txt : /etc/systemd/resolved.conf
[Resolve]
DNS=192.168.11.1 8.8.8.8
Domains=example.com
```

systemd-resolvedサービスを有効にするコマンド  
`systemctl restart systemd-resolved.service`  

---

## systemd-resolved

systemd-resolvedは、systemdの動作するシステムで名前解決を管理するデーモンです。  
systemd-resolvedの設定は「/etc/systemd/resolved.conf」ファイルや「/etc/systemd/resolved.conf.d/」配下の拡張子.confのファイルで行います。  

``` txt : resolved.confからの抜粋
[Resolve]
DNS=192.168.0.1
```

---

## hostコマンド  

DNSサーバーを使ってホストやドメインに関する情報を表示する。  

``` txt
host [オプション] ホスト名orIPアドレス [DNSサーバー]

オプション
-t :: 問い合わせる情報の指定(type)
      digと同じく、a,mx,ns,any等が指定できる。
-v :: 詳細な情報表示(verbose)
```

www.lpi.jpのIPアドレスを問い合わせる→正引き  
`host www.lpi.jp`  

192.168.0.6のホスト名を問い合わせる→逆引き  
`host 192.168.0.6`  

---

## digコマンド  

DNSサーバへ直接問い合わせて、指定した名前に関するDNSサーバからの応答を表示します。  
また、表示する情報のタイプ（リソースタイプ）を指定する事もでき、詳細な情報を確認できるため、DNSに関するデバッギングツールとしても使用できます。  

・指定したホスト名に対するDNSサーバーへの登録情報を表示する。  
・DNSサーバーからデバッグのための詳細な情報を取得できる。  
・nslookupコマンドはDNSサーバーからの応用を加工して表示するが、digでは応答を加工せずに表示する。  

``` txt
dig [オプション] [@DNSサーバー名] ホスト名orドメイン名 [検索タイプ]

オプション
-x :: IPアドレスからホスト名を検索する(逆引き)
-t :: 検索タイプを指定する

「@DNSサーバ」には問い合わせるDNSサーバを指定します。  
省略した場合は、そのホストに設定されているDNSサーバに問い合わせます。  

検索タイプ
a      :: ipアドレス(Address)(デフォルト)
aaaa   :: ipv6アドレス
any    :: 全ての情報
mx     :: メールサーバーの情報(Mail Exchanger)
ns     :: ネームサーバーの情報(Name Server)
soa    :: ゾーン(ドメインの範囲)の情報
txt    :: テキスト情報
+short :: 詳細情報を省く
```

TXTレコードは任意の文字列を記すためのものですが、メールの送信元を記載することで正しい送信元を確認するためのSPFレコードとして利用したり、  
Google指定の情報を記載することでGoogleのサービス利用時に所有者であることを証明したりすることができます。  

lpi.jpのメールサーバー情報を問い合わせる  
`dig lpi.jp mx`  

69.90.69.237のホスト名を問い合わせる(詳細情報を省く)  
`dig -x 69.90.69.237 +short`

digコマンドで外部のDNSサーバ8.8.8.8に「yahoo.co.jp」のIPアドレスを問い合わせたい。  
`dig @8.8.8.8 yahoo.co.jp`  

DNSサーバに登録されている、「yahoo.co.jp」ドメインのゾーンに関する情報を確認したい。  
`dig -t soa yahoo.co.jp` or `dig yahoo.co.jp soa`  

白本模試より、検索結果のQUESTION SECTIONなるセクションに例えば[IN NS]と表示されていた場合、  
`dig -t ns ホスト名`のコマンドを実行したと逆算できるらしい。  

※ホスト名の指定はwwwを含んでも含まなくても良い。  

---

## whoisコマンド  

whoisサーバのデータベースに問い合わせを行い、ドメインの登録者や管理者、所属団体等の情報を得ることができます。  

ドメインの管理者や所有者情報を表示。  
調べたいドメイン名を指定して、whoisデータベースに問い合わせるコマンド。  

---

## getentコマンド

名前解決の順序を設定する「/etc/nsswitch.conf」に従って検索を行うコマンド。

ホスト名の名前解決順序は「hosts」項目で設定します。  
設問の図のように「files dns」の設定であれば、/etc/hostsから検索し、見つからなければ次にDNSサーバに問い合わせを行います。  
データベース名に nsswitch.conf で指定できるサービス名、検索したい情報をキーに指定することで、名前解決順序設定に従って検索した結果を得られます。  

``` txt
getent データベース名 [ キー ... ]

データベース名
hosts :: nsswitch.conf で指定できるサービス名を指定する。(passwd,hosts)
```

testsvの名前解決  
`getent hosts testsv`  
