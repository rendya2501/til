# TCP/IPの基礎

---

## IPv4

IPv4ヘッダの説明  
・「ヘッダ長」や「オプション」フィールドなど、いくつかのフィールドはIPv6ヘッダには存在しない  
・TTLはルータを1つ通過するごとに1ずつ減算される  
※TTL（Time to Live - パケットの生存期間）はルータを1つ通過するごとに1ずつ減算され、0になるとパケットが破棄されてルーティングのループを防ぎます  

---

## IPアドレスのクラス

``` txt : IPアドレスのクラス
クラス         範囲                   サブネットマスク
A   ::   0.0.0.0 - 127.255.255.255 :: 255.0.0.0
B   :: 128.0.0.0 - 191.255.255.255 :: 255.255.0.0
C   :: 192.0.0.0 - 223.255.255.255 :: 255.255.255.0
D   :: 224.0.0.0 - 239.255.255.255
E   :: 240.0.0.0 - 255.255.255.255
```

クラスDはマルチキャスト（特定の複数宛ての送信に使用される）用のアドレスです。  

``` txt : プライベートアドレスの範囲
A :: 10.0.0.0 – 10.255.255.255
0000 1010 . 0000 0000 . 0000 0000 . 0000 0000
0000 1010 . 1111 1111 . 1111 1111 . 1111 1111

B :: 172.16.0.0 - 172.31.255.255
1010 1100 . 0001 0000 . 0000 0000 . 0000 0000
1010 1100 . 0001 1111 . 1111 1111 . 1111 1111

C :: 192.168.0.0 – 192.168.255.255
1100 0000 . 1010 1000 . 0000 0000 . 0000 0000
1100 0000 . 1010 1000 . 1111 1111 . 1111 1111
```

IPアドレスのうち、ローカルネットワークでのみ使用が許可されているアドレスを「プライベートアドレス」と言い、クラスごとに範囲が定められています。  
プライベートアドレスはIANA（アイアナ：Internet Assigned Numbers Authority）によって予約されています。  

---

## IPv6

IPv6(Internet Protocol version 6)は、現在主流のIPv4に変わる次世代版のインターネットプロトコル(IP:Internet Protocol)です。  
近年、インターネットの急速な普及や、接続機器の増加に伴い、IPアドレスの枯渇が問題となりました。  
そこで、IPv4では32ビットの長さで表していたIPアドレスをIPv6では128ビットで表すことで、使用できるIPアドレスが約340澗（かん）個（事実上無限）にまで増大しました。  

※正確には340澗（かん）2823溝（こう）6692穣（じょう）938秄（じょ）4634垓（がい）6337京（けい）4607兆4317億6821万1456個。  
2の32乗（32ビット）で表すことのできる約43億という数の、さらに4乗（2の32乗×2の32乗×2の32乗×2の32乗）という膨大な数です。  

- アドレス長が128bit  
- 16進数表記(0-9,A-F)  
- ユニキャスト、エニーキャスト、マルチキャストをサポート。  
- ブロードキャストが廃止され、一斉送信は全てマルチキャスト（特定グループ宛通信）で行われる  
- アドレス表記法  
  ①各ブロックの先頭の「0」は省略できる  
  ②連続した「0000」のブロックは1回に限り「::」に省略可能  
  ③「0000」は「0」に省略可能  
  例）  
  0001:5000:0001:0000:0000:0002:000A:0001 → 1:5000:1::2:A:1  
  2001:5000:0001:0000:0000:DA02:0000:1001 → 2001:5000:1::DA02:0:1001  
  2001:5000:0001:0000:0000:0000:0000:0000 → 2001:5000:1::  
- プロトコル番号,ポート機能はIPv4と同じ。  
- IPsec（暗号化通信）を標準で実装  
- IPアドレスの自動割り当て機能を標準で実装している。(IPv4はDHCPで実装)  
- IPv4との互換性は無い（但し、機器にIPv4とIPv6の両方のアドレスを割り当てるデュアルスタックなどの仕組みで相互運用は可能）  
- IPv4アドレスと直接通信出来ない。変換が必要。  
  IPv4とIPv6ではパケットフォーマットが異なる為、直接通信をする事はできません（互換性はありません）が、  
  デュアルスタックなどの相互運用の仕組みを利用してIPv4とIPv6が混在したネットワークを構築することが可能です。  
- IPv6アドレスは非常に広大なアドレス空間のため、IPv4での「クラス」の概念はなくなりました。  
  その代わりに、ユニキャスト（1対1通信）のアドレス割当時にはサブネットを表す前半64ビットと、ホストを表す後半64ビットでアドレス割り当てすることが推奨されています。  
  前半64ビットを「サブネットプレフィックス」、後半64ビットを「インタフェース識別子（Interface-ID）」とよびます。  
- IPv4のネットワーク部に相当する部分が**サブネットプレフィックス**、ホスト部に相当する部分が**インタフェース識別子（Interface-ID）**  
- ホップリミットはIPv4のTTLと同じ役割を持つ  
- プレフィックス、インターフェースIDともに64ビット  
- IPv6のポート番号の表記法 → `[IPアドレス]:ポート番号`  
  例:[fe80:20c:29ff:fe55:94ef]:80  

※プロトコル番号  
上位層のプロトコルを識別するための番号。
IPヘッダに8ビット情報で存在する。  
各プロトコルにはポート番号だけではなく、各々に番号がある模様。  

``` txt
 1 :: ICPM
 4 :: IP
 6 :: TCP
17 :: UDP
etc...
```

・ユニキャスト : 1つのネットワークインターフェースを識別するアドレス  
・エニーキャスト : 複数のホストの集合に割り当てられるアドレス  
・マルチキャスト : IPv4のブロードキャストに相当するもの  

ローカルループバックアドレス , ::1/128  
グローバルユニキャストアドレス , 2000::/3  
リンクローカルユニキャストアドレス , fe80::/10  
マルチキャストアドレス , ff00::/8  

IPv6パケット内の制御情報であるIPv6ヘッダは、IPv6ヘッダ（固定長）＋オプションの拡張ヘッダ（可変長）で構成されます。  

``` txt : IPv6ヘッダー
バージョン（4ビット）        :: IPのバージョン番号。IPv6では"6"が入る  
トラフィッククラス（8ビット）:: パケットの優先度をつける  
フローラベル（20ビット）     :: アプリケーションフローの識別  
ペイロード長（16ビット）     :: IPv6ヘッダを除くパケットのデータ部の長さ  
ネクストヘッダ（8ビット）    :: IPv6ヘッダの次にくるヘッダのタイプを示す  
ホップリミット（8ビット）    :: 通過できるルータの数（IPv4のTTLと同じ）  
送信元アドレス（128ビット）  :: 送信元のIPv6アドレス  
宛先アドレス（128ビット）    :: 宛先のIPv6アドレス  
```

IPv4ヘッダの基本サイズは20バイト、IPv6ヘッダは40バイトなので 2倍のサイズになっていますが、  
IPv6ではチェックサムフィールドなどいくつかのフィールドを削除して構造を簡単にしています。  
さらにIPv6ヘッダでは、可変長となるフィールドをオプションにして、転送に必要になる基本ヘッダを固定長にすることで処理効率を上げています。  

---

## CIDR(Classless Inter Domain Routing)  

IPアドレスのクラスの概念を使わずに、任意の長さのサブネットマスクを利用する事。

アドレスクラスの概念を気にしないで、IPアドレスの割り当てや経路選択などの自由度を上げる仕組み。  
サブネットマスクを調整することで任意の大きさのネットワークを作るあれのこと。  
192.168.0.***/24の「/24」の部分がCIDR表記。  

クラスの概念に基づいてネットワークを設定すると、使わないIPアドレスが発生してしまう。  
なので、クラスの概念をとっぱらって、サブネットマスクでもって、設定できるようにしたほうが無駄が少なくてよくね？って考え方がこれ。  

読み方はサイダー  

---

## ウェルノウンポート  

ポート番号は0～65535番まであります。  
その中でも、主要なサービスのポート番号はウェルノウンポート(0～1023番）として予約されています。  
ポートは0から始まる事に注意。  

``` txt : ポート
Well Known Ports :: 0~1023      :: システムやroot権限を持つプロセスに割り当てられたポート
System Ports                       (WebサーバーやWindowsファイル共有サービスなど)

Registered Ports :: 1024~49151  :: よく使われるプログラムに割り当てられたポート番号
User Ports                         (OracleやMicrosoft SQL Serverなど)
                                   一般ユーザーが使えるのは1024番から。

Dynamic Ports    :: 49152~65535 :: 自由に使用可能なポート
Ephemeral Ports(エフェメラル)
Private Ports
```

``` txt : ウェルノウンポート
 20 :: FTP    :: ファイル転送(データ用)
 21 :: FTP    :: ファイル転送(制御用)
 22 :: SSH    :: リモートホストの遠隔操作(暗号化あり)
 23 :: Telnet :: リモートホストの遠隔操作(暗号化なし)
 25 :: SMTP   :: 電子メール  
 53 :: DNS    :: TCP/UDP,名前解決
 80 :: HTTP  
110 :: POP3   :: 電子メール受信(受信メールをサーバーからダウンロードしてサーバーから消す方式)(Post Office Protocol version 3)
143 :: IMAP   :: 電子メール受信(受信メールをサーバ上で管理し、メールソフトに表示させる受信方式)(Internet Message Access Protocol)  
161 :: SNMP   :: ネットワークの監視  
162 :: SNMP Trap :: ネットワークの監視(警告通知等)  
443 :: HTTPS  
465 :: SMTPS  
636 :: LDAP over SSL/TLS  
993 :: IMAPS  
995 :: POP3S  

どうでもいいプロトコル
 63 :: whois++プロトコル
123 :: NTP  
361 :: Semantixサービス
389 :: LDAP :: ディレクトリサービス  
529 :: IRC(Internet Relay Chat)
514 :: Syslog :: ロギングサービス  
631 :: CUPSの設定ポート  
```

---

## IP(Internet Protocol)

「IP（Internet Protocol）」はネットワークに接続された機器（サーバ、ルータ、クライアントPCなど）へのアドレス付与によって機器やネットワークを識別したり、  
パケットの分割や統合を行い目的地までパケットを届ける、インターネット通信の中核をなすプロトコルです。  

---

## TCP(Transmission Control Protocol)

OSI参照モデルの第4層に属し、TCP/IPの中核となるTCP（Transmission Control Protocol）は、信頼性の高いコネクション型のプロトコルです。  
コネクション型とは、通信する相手と事前にコネクション（接続）を確立し、取り決めた通信手順に従ってデータを送受信する通信方式です。  

TCPはコネクション型の通信プロトコルですので、データを送受信する時の制御機能を持ち、パケットを順番通りに並べたり、到達したかどうか確認したり、  
途中で消失したパケットを再送したりすることができます。  

---

## UDP（User Datagram Protocol）

UDP（User Datagram Protocol）はコネクションレス型のプロトコルです。  
コネクションレス型とは、相手とのコネクション（接続）を事前に行わず、送りたいデータを一方的に送りつける通信方式です。  
到達確認や再送などの複雑な制御機能を持たない代わりに、いつでもデータを送信でき、処理も簡単なので高速に動作します。  
この特性から、主に動画や音声などのマルチメディア通信に使われます。  

---

## ARP(Address Resolution Protocol)

IPアドレスからMAC（Media Access Control）アドレスを求めるプロトコル。  

MACアドレスは、ネットワークに接続するNIC（Network Interface Card）などの物理的な接続に割り当てられたアドレスで、基本的に変更することができません。  
ネットワークに接続された機器は、自分のMACアドレス宛のデータのみを受信するようになっています。  
IP（Internet Protocol）アドレスはOSなどのソフトウェアが管理するアドレスであり、割り当てられた範囲内で自由に設定できます。  
そのため、故障による機器交換などでIPアドレスとMACアドレスの組み合わせは簡単に変わってしまいます。  

宛先IPアドレスを持つ機器のMACアドレスが変わっていると、送信したデータの宛先MACアドレスが一致しないため、宛先IPアドレスを設定した機器にもかかわらず、受信せずに破棄されてしまいます。
これを解決するため、「このIPアドレスを持つ機器は、MACアドレスを回答してほしい」という要求を全機器宛てに送信し、  
その応答を元に正しい宛先MACアドレスを設定して送信します。これがARPの仕組みです。  

ARPによって入手したIPアドレスとMACアドレスの対応表は、MACアドレステーブル、ARPキャッシュと呼ばれ、各アドレスごとに一定時間保持されます。  
一定時間経過後には、再度ARPによって最新のIPアドレスとMACアドレスの対応が作成されます。  

---

## ICMP(Internet Control Message Protocol)

IPを使った通信では、宛先までパケットが到達しなかった場合でも、IP自身にはそれを知らせる術がありません。  
IPで発生した、宛先到達不能などの通信エラー情報や、経路変更要求（リダイレクト）などの制御メッセージの通知にはICMP（Internet Control Message Protocol）が使われます。  
pingやtracerouteコマンドはICMPを利用してネットワークを診断します。  

---

## その他色々

IPアドレスのホスト部に相当するbitをすべて0にしたものは、ネットワークそのものを表すネットワークアドレスです。  
また、ネットワーク上にあるすべての端末に対して、データを送り出すことをブロードキャストといいます。  
ブロードキャストアドレスは、IPアドレスのホスト部に相当するbitをすべて1にしたものです。  

IPアドレス「192.168.18.1」とサブネットマスク「255.255.255.0」を2進数で表記すると以下のようになります。  

11000000 10101000 00010010 00000001　　 :: IPアドレス  
11111111 11111111 11111111 00000000　　 :: サブネットマスク  

これは後半の8ビット(サブネットマスクが0の部分）がホスト部である事をあらわしています。  
そこを全て0にするとネットワークアドレス、全て1にするとブロードキャストアドレスとなります。  

11000000 10101000 00010010 00000000　　 :: ネットワークアドレス  
11000000 10101000 00010010 11111111　　 :: ブロードキャストアドレス  

これを10進数に直すと、ネットワークアドレスが「192.168.18.0」、ブロードキャストアドレスが「192.168.18.255」となります。  
