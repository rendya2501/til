# プリンタ管理

---

## CPUS(Common Unix Printing System)

UNIXの印刷サービス。印刷サブシステムらしい。  
以前はLPD（Line Printer Daemon）が使われていましたが、現在ではCUPS（Common Unix Printing System）が使われます。  
CUPSはレガシーな印刷システムであるLPDとの互換性があります。  

``` txt : LPDと互換性のある印刷コマンド
lpr  :: 印刷ジョブを生成し、プリントキューに登録
lprm :: プリントキューにある印刷ジョブを削除
lpq  :: プリントキューにある印刷ジョブを表示
```

``` txt : CUPSで標準的な印刷コマンド
lp     :: 印刷ジョブを生成し、プリントキューに登録
cancel :: プリントキューにある印刷ジョブを削除
lpstat :: プリントキューにある印刷ジョブを表示
```

- IPP(Internet Printer Protocol)の採用  
  ネットワーク上のプリンタをサポートする印刷プロトコルIPPを採用。  
- PPD(PostScript Printer Description)ファイルのサポート  
  AdobeのPPD形式のファイル(テキストファイル)でデバイスドライバの設定ができる。  
- Webベースで設定可能  
  Webブラウザから設定できるツールが組み込まれている。  
- プリンタクラスのサポート  
  複数のプリンタを1台のプリンタに見せかける機能をサポートしている。  
- `/etc/cups/ppd`  
  PPDファイルを格納するためのディレクトリ  
- `/var/spool/cups`  
  印刷ジョブを溜めておくためのスプールディレクトリ。  
- CUPSのデーモンはcupsd。  
  cupsdは`/etc/cups/cupsd.conf`設定ファイルを参照して動作します。  
- `/etc/cups/cupsd.conf`
  CUPSの設定ファイル  
  印刷要求をネットワーク経由で受け付ける場合のポート番号(631)や、接続するクライアントのアクセス許可の設定等。  
- `/etc/cups/printers.conf`
  プリンタに関する情報などの設定(プリンタの場所や共有設定など)  
  プリンタのDeviceURIを指定する。
- 設定ポート :: 631  
  localhost:631でアクセス。  

CUPSの設定ファイルが置かれるディレクトリは「/etc/cups/」です。  
ここに、CUPSのデーモン「cupsd」の設定ファイル「/etc/cups/cupsd.conf」や、プリンタに関する設定を記述する「/etc/cups/printers.conf」があります。  

設定の仕方  
①設定ファイルを直接編集。  
②WebブラウザでCUPSの設定ページにアクセスして編集する。  

---

## CUPSの印刷処理の流れ

1. アプリケーションや印刷コマンドから印刷データを受け取る。  
   プリンタの設定オプションはPPDファイルから提供される。  
2. スプーラーが印刷データを受付、スケジューリングを行う。  
3. プリンタが直接受け付けられないデータを一旦中間形式としてPDFまたはPostScriptにフィルタで変換する。  
4. PPDに定義されたフィルタにより、最終の印刷データに変換する。  
5. 処理した印刷データをCUPSのバックエンドに送る。  
6. バックエンドは印刷データをローカル接続(USBなど)またはネットワークを経由(IPPやLPRなど)してプリンタに渡す。  

ping-t解説  

1. データを印刷プログラムによって印刷ジョブとしてスプーラ（スケジューラ）に登録する  
2. スプーラは、スプールに溜まった印刷データを順に取り出してフィルタシステムに送る  
3. フィルタはデータをPostScript形式に変換し、PostScript形式のデータをPPDファイルの定義に従って、印刷するプリンタ専用のラスタデータ形式に変換する。  
   ラスタデータはバックエンドに送られる  
4. バックエンドは、渡されたラスタデータを指定されたプリンタに送信する  

---

## CUPSサービスの起動

SysVinitの場合  
`/etc/init.d/cups start`  

systemdの場合  
`systemctl start cups.service`  

IPPサービス(ポート631/tcp)が開いていれば、CUPSは動作している。  
`netstat -at | grep ipp`  

---

## PostScript

アドビシステムズが開発したページ記述言語で、どういったデータをどのように描画するかという命令が記述されます。  

---

## PPD(Postscript Printer Description)

アドビシステムズが策定したファイル形式で、プリンタがPostScriptで記述されたデータをどのように扱うかを定義するファイルです。  
(フォント、用紙サイズ、解像度など、PostScriptプリンタの機能を記述し制御するためのファイル)  

ラスタデータとは、点の集合で作成された画像形式です（例：JPEG、BMPファイル）。  
対称的な形式としてベクタデータ（数値や座標計算によって描画される画像形式）があります。  

現在のプリンタの多くは各メーカー独自の形式で印刷データを扱います。  
各プリンタ用のPPDファイルを用意することで、いったんPostScript形式に印刷データを変換することで、各メーカー独自の形式に変換することが容易になります。  
そのため、CUPSではLPDよりも多くのプリンタに対応できるようになりました。  

---

## lprコマンド

印刷コマンド。  
指定されたファイルや標準入力をプリントキューに送る。  
オプションでプリンタを指定しなければ、デフォルトのプリンタで印刷します。  

``` txt
lpr [オプション] [ファイル名]

-#部数      :: 印刷部数を指定する。
-Pプリンタ名 :: 印刷を行うプリンタを指定する。-Pとプリンタ名の間に空白はないことに注意。
```

テキストファイル testdata.txtを6部印刷する。  
`lpr -# 6 testdata.txt`  

/etc/passwdファイルを5部印刷する。  
`lpr -# 5 /etc/passwd`  

dmesgコマンドの出力を印刷する。  
`dmesg | lpr`  

「/etc/group」ファイルを「PrinterA」で印刷。  
`lpr -PPrinterA /etc/group`  

---

## lpqコマンド

BSD系におけるプリントキューの内容を表示するコマンド。  
オプションを指定せずにコマンドを実行した場合、デフォルトに設定されているプリンタのキューを表示する。  

``` txt
lpq [オプション] [ユーザー名] [ジョブ番号]

-a           :: すべてのプリンタの情報を表示。
-Pプリンタ名 :: 指定したプリンタの情報を表示。
```

---

## lpcコマンド

BSD系に属するプリンタのキューの状態を表示するコマンドの内の1つ。  
CUPSのlpcは実質的にプリントキューの状態を表示するstatusコマンドしかなく、`lpc status キュー名`以外の機能はない。  
コマンドの指定なしで実行すると対話的にコマンドを実行できる。  

``` txt
lpc [コマンド]
```

キューが受付可能かどうか、プリンタへ出力可能かどうか調べる。  
`lpc status all`

---

## lprmコマンド

プリンタキューにある印刷ジョブを削除するコマンド。  
一般ユーザーは自分の発行した印刷要求のみ、スーパーユーザーはすべての印刷要求を削除できる。  

``` txt
lprm [オプション] [ジョブ番号]

-Pプリンタ名 :: 指定したプリンタの印刷ジョブを削除。
-            :: 自分の印刷ジョブをすべて削除。
                rootユーザーで実行した場合は、全ユーザーの印刷ジョブを削除する。
```

自分の印刷ジョブを全て削除(一般)  
`$ lprm -`  

PrinterBで問題を起こしている印刷ジョブ番号500の印刷ジョブをいったん取り消したい。  
`lprm -PPrinterB 500`  

---

## lpadminコマンド

プリンタの登録や削除等を行うCUPSの設定コマンド。

``` txt
lpadmin -p プリンタ名 [オプション] 

-p :: 作成するプリンタ名を指定する。
-E :: プリンタジョブを受付、プリンタへの出力を開始状態にする。
-v :: デバイスURIを指定する。
-m :: modelディレクトリ/usr/share/cups/modelの下のPPDファイル名を指定する。
-p :: PPDファイル名を指定する。
```

新規にプリンタを登録する構文  
`lpadmin -p プリンタ名 オプション`  

デフォルトプリンタを設定する構文  
`lpadmin -d プリンタ名`  

デフォルトプリンタを削除する構文  
`lpadmin -x プリンタ名`  

---

## lpコマンド

CUPSの標準的な印刷コマンド。  
印刷ジョブを生成し、プリントキューに登録する。  

SystemV系のlprコマンド。  
lprはBSD系らしい。  
オプションの機能は同じなのに引数が違うというクソ仕様。  

``` txt
lp [オプション] ファイル名

-d      :: 指定したプリンタに出力する。指定しない場合はデフォルトプリンタが使われる。 lprにおける-P。
-n 部数 :: numで指定した部数を出力する。lprにおける-#。
-o raw  :: フィルタを通さずにプリンタに出力する。これはlprと同じ。
-l      :: フィルタを通さずに直接印刷する。-oと動作的に同じらしい。
```

sampleファイルを2部印刷する。  
パイプラインでファイル名を渡しても大丈夫らしい。  
`cat sample | lp -n2`  
`cat sample | lpr -#2`

---

## lpstatコマンド

CUPS標準の印刷ジョブを表示するコマンド。  
SystemV系におけるプリンターのキューを表示するコマンド。  
BSD系はlpqとlpc。  

``` txt
lpstat [オプション]

-a :: プリントキューが受付可能(accept)になっているか否かを表示。
-p :: プリントキューが出力可能(enable)になっているか否かを表示。
-t :: プリンタの状態をキューの状態を含めてすべて表示。  
```

---

## cancelコマンド

CUPS標準の印刷ジョブを削除するコマンド。  

PrinterBの全ての印刷ジョブを削除する。  
`cancel -a PrinterB`  

---

## cupsdisableコマンド

指定したプリンターを停止状態にするコマンド。  
引数に-r(reason)を付けて実行すると、現在のプリンタの状態のコメントを設定することができる。  
コメントはキューの状態を調べるコマンドを実行したときに表示される。  

``` txt
cupsdisable [オプション] プリンタ名

-c :: プリントキューの全てのジョブをキャンセル
-r :: 停止の理由を示すメッセージを指定。キューの状態の中にメッセージが表示される。
```

---

## cupsableコマンド

停止したプリンタを開始するコマンド。  

---

## cupsrejectコマンド

指定したプリンタへのプリントジョブを受け付けないようにするコマンド。  

``` txt

-c :: プリントキューの全てのジョブをキャンセル
-r :: 停止の理由を示すメッセージを指定(cupsrejectのみ)。キューの状態の中にメッセージが表示される。
```

---

## cupsacceptコマンド

プリントジョブを受け付けるようにするコマンド。  

---

## プリントキュー管理のまとめ  

``` txt
lp,lprコマンド → プリントキュー入口 → プリントジョブ → プリントキュー出口 → プリンタ
                         ↑                    ↑                  ↑
    受付/拒否を制御するコマンド  キューの状態を表示するコマンド   開始/停止を制御するコマンド
                    cupsaccept             lpstat -a              cupseanble
                    cupsreject             lpstat -p              cupsdisable
                                           lpstat -t
                                           lpq
                                           lpc status

```
