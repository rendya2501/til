# メール管理(メールシステム)

---

## MTA(Mail Transfer Agent)

メールの転送を行うプログラム。  
ネットワーク経由、またはサーバ内部（ローカル）のメール転送依頼に基づき、指定された宛先へメールを転送する。  
メールシステムの中心的役割を担う。  
DNSサーバーを使用してメールの送信先となるMTAのホスト名を調べる。  
SMTPプロトコルでメッセージをやり取りするため、SMTPサーバーとも呼ばれる。  

代表的なMTAプログラム  
Exim,Postfix,Sendmailなど  

Sendmailは標準的なMTAとして長く使われてきたが、最近は使われていない。(さすがに古いし、後継もある)  
主流はEximとPostfix。  
SMTPサーバーとして使われる。  
EximとPostfixは以下のコマンドとファイルでの設定が有効であるためSendmailに互換性がある。  
・sendmailコマンド  
・newaliasesコマンド  
・mailqコマンド  
・~/.forwardファイル  

---

## MDA (Mail Delivery Agent)

ローカルのメールスプールへ配送するプログラム。  
MTAによってローカルの宛先へのメールであると判断されたメールを受け取り、宛先ユーザのメールボックス（メールスプール）へメールを配送する。  
MTAが受け取ったメールをローカルドメインのユーザーに配信する(メールスプールに格納する)プログラム。  

MTAに対するMDAプログラム  

- Sendmail : procmail(デフォルト)  
- PostFix : localデーモン  
- Exim : Exim自身が行う  

---

## MUA (Mail User Agenet)

ユーザーがメールの送受信に使用するプログラム。  
ユーザーがメールを扱うプログラム。  
自身のメールボックスへアクセスして受信したメールを閲覧したり、メールを送信したりする。  
MUAの例としては、LinuxのmailコマンドやThunderbird、WindowsやMac OS X付属のメールソフトがある。

CUIベース : malix,mutt  
GUIベース : Thunderbird,Evolution  

---

## メール配送の仕組み

``` txt
クライアント  メールサーバー  ネットワーク  メールサーバー  クライアント
    MUA    →     MTA①          →             MTA②
                                                 ↓
                                                 MDA
                                                 ↓
                                            メールボックス
                                                 ↓
                                              POPサーバー  →    MUA
```

①メールクライアントソフトウェア(MUA)で作成されたメールは、送信用MTA①へ送られる。  
②MTA①は、メールアドレスから配送先メールサーバーを調べ、メールをMTA②に配送する。  
③MTA②がメールを受け取ると、ローカル配送プログラムであるMDAが、メールのさて先となっているユーザーのメールボックスにメールを格納する。  
④受取人側はPOPサーバーやIMAPサーバーを経由して自分のメールボックスからメールを取り出す。  

---

## Sendmail

Sendmail : 1981  
古くから使われるMTAで、様々なメール転送方式に対応している。  
1つのプログラムで全ての処理を実行できる反面、設定は難解で専用のツールを使う必要がある。  
また、セキュリティ面での問題がたびたび発生したり、処理速度が遅いなどの問題もある。

``` txt : sendmailのメールスプールとキュー
スプール :: /var/spool/mail/   :: mail
キュー   :: /var/spool/mqueue/ :: mailq
```

---

## Exim

Exim : 1995  
Debian系の標準MTA。  
設定は平易だが、日本語の情報は比較的少ない。  
設定ファイルの内容はバージョンによって異なる。  

``` txt : Eximのメールスプールとキュー
スプール :: /var/mail/             :: mail
キュー   :: /var/spool/exim/input/ :: mailq
```

---

## Postfix

Postfix : 1998  
sendmailとの高い互換性を保ちながら、処理を高速化している。  
設定が平易でsendmailよりもセキュリティが向上しているため、最近の一部のLinuxディストリビューションで標準のMTAになっている。  

``` txt : Postfixのメールスプールとキュー
スプール :: /var/mail/                   :: mail
キュー   :: /var/spool/postfix/deferred/ :: mailq
```

---

## /etc/aliasesファイル

メールアドレスの別名を設定するファイル。  
例えば、root宛に届いたメールをユーザーadminとlpicでも受け取れるようにするには以下のように設定する。  
adminとlpicはどちらもrootあてのメールを受け取れるようになるが、rootにはメールが届かなくなる。  
設定の反映は`newaliases`コマンドで行う。  

・書式は「別名:転送先（メールアドレスやアカウント）」  
・転送先が複数ある場合はカンマで区切って指定  

``` txt : /etc/aliasesの記述例1
root: admin,lpic
```

``` bash: 記述例2
#vi /etc/aliases
support: root,postmaster, xxxx@yahoo.co.jp
# newaliases ←設定を反映させるために必要
```

---

## mailコマンド

コマンドラインでメールを受信したり、受信メールを確認したりするコマンド。  
mailコマンドでユーザー名のみを指定するとローカルシステムのユーザー宛に送信される。  

``` txt : ※sendmailのメールスプールとキュー
名称        ディレクトリ          保存物            表示コマンド
スプール :: /var/spool/mail/   :: 受信メール     :: mail
キュー   :: /var/spool/mqueue/ :: 返信待ちメール :: mailq
```

``` txt
■mail
引数なしでコマンドを実行すると、メールスプール「/var/spool/mail」に格納されている受信メールを表示する。
番号でその番号のメールを選択。qで終了。

■mail [-s 題名] [宛先メールアドレス or ユーザー名]
-sはタイトル(Subject)を指定するオプション。  
```

ローカルシステム内のユーザーである「admin」にメールを送信する。  

``` txt
mail -s TESTMAIL admin
this is a test e-mail
.
```

---

## sendmailコマンド

メールを送信するコマンド。  
CUIのMUAであるmalix,muttで利用する。  

古くからあるMTAのsendmailでは、メール送信やMTAの制御のためにsendmailコマンドが用意されていました。  
sendmailコマンドは引数無しで単独で実行すると、標準入力からメールのデータを受け取り、.（ピリオド）のみの行を受け取った時点でメールの送信を行います。  

MUAの中にはsendmailコマンドを使ってメールの送信を行うものもあることから、sendmail以外のMTAでも互換性のためにsendmailコマンドが用意されています。  
Postfixやeximでも、sendmailコマンドが用意されています。  

``` txt : 実行例
sendmail yuki@mylpic.com < 送信する本文を格納したファイル
```

---

## newaliasesコマンド

メールアドレスの別名を設定するファイルとして、エイリアスファイル(/etc/aliases)とエイリアスデータベースファイル(/etc/aliases.db)がある。  
このうちの、**エイリアスデータベースファイルを更新するコマンド**。  
エイリアスデータベースファイルは更新してもすぐには反映されないので、newaliasesコマンドを叩いて変更を反映させる必要がある。  
因みにエイリアスファイルはSendmail,Postfixの起動時にのみ、読みこまれる。  

エイリアスデータベースファイルがあれば、そちらを参照し、無ければエイリアスファイルが参照される。  
Eximはエイリアスデータベースファイルを参照しない。  
newaliasesコマンドは使えるが、それはSendmailとの互換性のためだけ。  

Sendmail,Postfix : エイリアスファイル、エイリアスデータベースファイル  
Exim : エイリアスファイル  

``` txt
別名 : 転送アドレス1,転送アドレス2,転送アドレス3
```

---

## mailqコマンド

MTAが転送できなかったメールのキューを見るためのコマンド。  
送信待ちのメールはメールキュー(/var/spool/mqueue)に蓄えられる。  
全MDA(Sendmail,Postfix,Exim)で使用可能。  

---

## ~/.forwardファイル

ユーザー受信メールのリダイレクトを行いたい時に設定するファイル。  
自分のホームディレクトリの下に`.forward`ファイルを作成して、転送先メールアドレスを記述する。  
一時的にメールを転送したい場合等に便利。  
ユーザーが各自で設定できるため、管理者が設定する必要はない。  

``` txt : 記述例
mana@example.com
mana@mylpic.com
```

自分宛のメールをmana@example.comとmana@mylpic.comに転送する。  

因みにファイル名やディレクトリが「.(ドット)」から始まるのは隠しファイルや隠しフォルダ。  
`~/`はホームディレクトリを表す。  

---

## オープンリレー

外部からのメールを制限することなく他のドメインに中継する事。  
そのままではスパムの踏み台にされるので、以下の制限を設定する。  
①外部からのメールはローカルドメイン宛のメールだけを受け取り、他のドメインへ中継しない。  
②内部ネットワークからのメールだけを他のドメインに中継する。  

因みに「外部からの名前解決リクエストに対して制限することなく答えを返すこと」をオーブンリゾルバという。  

MTA(Mail Transfer Agent)は、通常SMTP（電子メール送信用のプロトコル）を利用して電子メールを送信します。  
MTA間でメールの転送を行うことをリレー（中継）といい、リレー対象を制限せず、誰からのメール送信、  
転送依頼でも受け付ける設定になっているMTA（SMTPサーバ）の事を「オープンリレー」といいます。  
オープンリレーは誰でも利用できるため、悪質な迷惑メール（スパム）送信に使用されてしまいます。  
そのためインターネットに公開された**SMTPサーバ**にはオープンリレー設定をするべきではありません。  

---

## メール転送早見表

``` txt
設定ファイル    影響範囲        内容                  設定の反映方法
/etc/aliases :: システム全体 :: 別名と転送先を記載 :: [newaliases]コマンドを実行
~/.forward   :: ユーザー個別 :: 転送先を記載       :: 即時反映
```
