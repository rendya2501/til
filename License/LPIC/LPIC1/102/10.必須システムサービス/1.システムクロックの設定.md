# システムクロックの設定

---

## ハードウェアクロック

PCにハードウェアとして内臓された時計。  
電源がオフの状態でも動作する。(PC内に取り付けられた電池で動作する)  

---

## システムクロック

Linuxカーネル内に存在する時計。  
Linux起動時にハードウェアクロックを参照して設定されるが、その後は別々に動く。  
そのため、起動してから時間が経過するにつれ、ハードウェアクロックと差が生じる。  

---

## dateコマンド

システムクロックを表示するコマンド。  
rootユーザーはdateコマンドを使ってシステムクロックを設定できる。  

``` txt
現在の日付を表示する。
date [オプション] [+書式]

オプション
-u,--universal,--utc :: 協定標準時を表示する。  

引数を「+」で始めると、指定した書式で表示する。
%Y :: 年
%m :: 月(01~12)
%d :: 日(01~31)
%H :: 時(00~23)
%M :: 分(00~59)
%a :: 曜日
%b :: 月名

システムクロックを変更する。
date [MMDDhhmm[[CC]YY][.ss]]

MM :: 月
DD :: 日
hh :: 時
mm :: 分
CC :: 西暦の上2桁
YY :: 西暦の下2桁
ss :: 秒
```

システムクロックを2018年12月10日20時に設定する。  
`sudo date 121020002018`  

「年/月/日(曜日)」の書式で表示する。  
`date "+%Y/%m/%d (%a)"`  
2018/12/10 (月)  

※バックアップをする時に``tar czf `date +"+%Y%m%d"`.tar.gz/data``というコマンドが自動的に実行されるようにしておけば、  
「20181210.tar.gz」のように、バックアップを実行した日付入りのアーカイブファイルを作成する事ができる。  

cfz → create file zip  

---

## hwclockコマンド

ハードウェアクロックの参照や設定を行うコマンド  

``` txt
hwclock オプション

-r(read)      :: ハードウェアクロックを表示する。デフォルト動作なので省略可能。
-w(--systohc) :: システムクロックの時刻をハードウェアクロックに設定する。
-s(--hctosys) :: ハードウェアクロックの時刻をシステムクロックに設定する。
-u            :: utcを指定する。
```

---

## NTP(Network Time Protocol)

ハードウェアクロックもシステムクロックも残念ながらあまり正確ではない。  
正確な時刻を設定するためには、ネットワーク経由でクロックを同期するプロトコルであるNTPを使い、インターネット上にあるNTPサーバー(タイムサーバー)から正確な時刻を取得する。  

NTPネットワークは階層構造になっている。  
最上位は原子時計やGPSなど、きわめて正確な時刻情報の提供元がある。  
原子時計やGPSなどの正確な時計をstratum（ストレイタム：階層）0とし、その直下にあるNTPサーバーをStratum1。その次をStratum2。  
最下層は stratum 16となる。  
stratum 16のサーバからは時刻を取得することは出来ません。  

NTPサーバーは上位の複数のNTPサーバーから正確な時刻を取得する。  
NTPクライアントによるNTPサーバーとの時刻同期にはroot権限が必要。  

ntpdの各種設定は`/etc/ntp.conf`で行う。  

---

## /etc/ntp.conf

ntpdの設定ファイル。  

正確な時刻を有するNTPサーバから時刻を取得し、システムクロックと自動で同期させるには「ntpd」デーモンを起動しておきます。  
「ntpd」デーモンは、その設定ファイルである「/etc/ntp.conf」を読み込んで起動します。  

公開NTPサーバを利用する場合は、複数のNTPサーバ群で構成される「pool.ntp.org」プロジェクトに登録されている外部サーバ等を指定します。  
「pool.ntp.org」を利用すると、複数のNTPサーバから、負荷分散の技術の一つである「DNSラウンドロビン」を利用して時刻を取得します。  
例えば日本であれば「0.jp.pool.ntp.org」から「3.jp.pool.ntp.org」といったserverを指定することで、遅延の少ない、正確な時刻を入手できるようになります。  

NTPサーバは「/etc/ntp.conf」の設定項目「server」で指定します。  
内外部にある信頼できるNTPサーバを設定項目「server」で指定して正確な時刻を得ながら、  
自身のマシンも管理下のネットワークに対してNTPサーバ（他のNTPサーバが時刻を取得するサーバ）として動作させる、といった運用も可能です。  

``` txt : 主な設定項目
restrict  :: ntpdへのアクセス制御を行う。
server    :: 時刻を取得するサーバーを指定する項目。
             ネットワーク内部に設置したNTPサーバや、世界中にある公開NTPサーバ、プロバイダが提供するNTPサーバを指定します。 
driftfile :: 自身の時刻のズレ具合を記録するファイルを指定。
```

---

## ntpdateコマンド

指定したNTPサーバーから現在時刻を取得するコマンド。  
手動でNTPサーバから正確な時刻を取得し、即座にシステムクロックに反映させる。  
ntpdate コマンドはNTPクライアントとしてのツール。  

``` txt
ntpdate [オプション] NTPサーバー名

-q :: NTPサーバーとシステムクロックの差分(offset)を確認する。
```

NTPサーバーtime.sercer.lpic.jpから現在時刻を取得する。  
`ntpdate time.server.lpic.jp`  

NTPサーバー(ntp.nict.jp)を使ってシステム時計との差分を確認する。  
`ntpdate -q ntp.nict.jp`  

---

## NTPサーバー

NTPサーバーは自前で運用することができる。  
組織内にNTPクライアントが多い場合は用意したほうが都合がよい。  

ntpdはNTPバージョン3互換のデーモン。  
stratum上位の外部NTPサーバーの時刻を参照してシステムクロックの時刻同期を行い、  
このシステムクロックにより外部ホストに対して時刻同期のサービスを提供するNTPサーバーとなる。  

自身をNTPサーバとすることで、指定したNTPサーバに定期的に時刻情報を問い合わせて自身の時刻を修正し、正確なシステムクロックを維持できます。  
よく使用されるNTPサーバ（デーモン）はntpdです。  

SysVinitを採用したシステムでのNTPサーバーの起動方法  
`/etc/init.d/ntpd start`  

systemdを採用したシステムでのNTPサーバーの起動方法  
`systemctl start ntpd.service`  

NTPサーバーの設定は`/etc/ntp.conf`で行う。(NTPデーモンが参照する設定ファイル)  
補正情報(クロックの誤差を予測した数値)は、`/etc/ntp.drift`に保存される。  
ディストリビューションによっては`/var/lib/ntp/drift`や`/var/lib/ntp/ntp.drift`になっていることもある。  

``` txt : /etc/ntp.confファイルの例
server 0.jp.pool.ntp.org ← 1番目のNTPサーバー
server 1.jp.pool.ntp.org ← 2番目のNTPサーバー
server 2.jp.pool.ntp.org ← 3番目のNTPサーバー
server 3.jp.pool.ntp.org ← 4番目のNTPサーバー
driftfile /etc/ntp.drift ← 補正情報ファイルの指定
logfile /var/log/ntp.log ← ログファイルの設定
```

この設定例では、複数のNTPサーバーをまとめて仮想的なNTPサーバーとして運用している。  
0.jp.pool.ntp.orgにDNSで問い合わせすると、いくつかのNTPサーバーの中から1つのIPアドレスがランダムに帰ってくる。  
このようにして特定のNTPサーバーに負荷が集中しないようにしている。  

左の項目はコンフィグレーションコマンドと言うらしい。  
serverはNTPデーモンを外部NTPサーバーのスレーブにするための項目ともいえるらしい。  

iburstオプション  
NTPサーバーとの初期の同期にかかる時間を短縮するオプション。
serverコマンドのオプションとして指定可能。  

---

## ntpqコマンド

NTPサーバーの状態を照会するコマンド。  

``` txt
ntpq [オプション] 接続先サーバー

-p :: /etc/nptd.confのserverに指定したサーバーとの同期状態を一覧表示する。対話モードのpeersコマンドと同様。
-i :: 対話モードで起動する(デフォルト)
```

localhostで稼働しているNTPサーバーから問い合わせされているNTPサーバーのリストを表示する。  
`ntpq -p localhost`  

``` txt : 表示項目の説明
remote :: serverに指定したNTPサーバーのホスト。
          先頭に「*」がついているものが時刻同期先。
          「+」は時刻同期可能なサーバー。
          「-」は参照しないことが決定したサーバーを意味する。
refid  :: remoteのサーバーの時刻参照先アドレス。
          同期開始時は「.INIT.」を表示し、stratum1のサーバーでは「.GPS.」などを表示する。
st     :: remoteのサーバーのstratum。
t      :: ntpパケットの交換方法。uはユニキャストを表す。
when   :: 前回ntpパケットを交換してからの経過時間(秒)
poll   :: 時刻問い合わせの間隔(秒)。同期が安定すると間隔が自動で長くなっていく。
reach  :: 過去8回の時刻問い合わせ結果を8進数で表示。
          8回全て成功で377(2進数で11 111 111)。
          過去7回成功して直前が失敗すると376(11 111 110)。
          過去7回失敗で直前が成功すると1(00 00 001)。
delay  :: ntpパケットの往復に要した遅延時間(ミリ秒)
offset :: remoteのサーバーとの時刻のズレ(ミリ秒)
jitter :: 同期した時刻とのずれ具合(ミリ秒)
```

時刻同期が安定してくると、poll間隔が自動で長くなっていく。  
最大1024秒(約17分)ごとに時刻問い合わせを行うようになり、システムへの負荷が少なくなるようになって行く。  
refidが`.INIT.`の時は初期化中なので、同期できない。その場合はremoteが空白になる。(+でも-でも*でもない)  

上表から設問の出力結果を確認すると
・60.56.214.78と時刻同期している
・60.56.214.78とは直近8回連続で時刻同期に成功している
・106.185.48.114とは時刻同期が可能
・157.7.236.66を時刻同期先としない
・49.212.186.27とは開始処理中のため、時刻同期処理は行われていない
事がわかります。

よって正解は
・60.56.214.78と時刻同期している
・49.212.186.27とは時刻同期できない
・60.56.214.78とは安定して時刻同期している
です。

その他の選択肢については以下のとおりです。
・106.185.48.114と時刻同期している
・157.7.236.66と時刻同期している
先頭に「*」がついていないので時刻同期先になっていないことがわかります。

・103.1.106.69とは時刻同期できない
「103.1.106.69」は「157.7.236.66」のNTPサーバが参照している時刻同期先サーバのアドレスです。この表示から時刻同期できないとは言えません。

・106.185.48.114とは安定して時刻同期している
reach項目を8進数→2進数に変換すると、直近８回の時刻問い合わせ結果が以下のとおり成功（1）が連続していないことがわかります。
12: 00 001 010
問い合わせが連続して成功していないので、安定して時刻同期しているとは言えません。

・145.174.168.164とは安定して時刻同期している
「145.174.168.164」は「106.185.48.114」のNTPサーバが参照している時刻同期先サーバのアドレスです。この表示から安定して時刻同期しているとは言えません。

---

## Chrony(クローニー)

ntpd/ntpdate の代替となるNTPサーバー/クライアントソフトウェア。  
デーモンプロセス:`chronyd` と クライアントコマンド:`chronyc` から構成される。  
設定ファイル : `/etc/chrony.conf`  

---

## /etc/chrony.conf

Chrony（クローニー: ntpdに代わるNTPサーバ/クライアント）の設定ファイル。  

``` txt : 主な設定項目
server    :: 時刻を取得するNTPサーバーを指定。サーバー/クライアントの関係。
peer      :: 時刻を取得するNTPサーバーを指定。同じstratum(階層)同士。
pool      :: 時刻を取得するNTPサーバーのプール(複数アドレスを集約した名前)を指定。
driftfile :: 自身の時刻のズレ具合を記録するファイルを指定。
rtcsync   :: システムクロックをハードウェアクロック(RTC)にコピーする。デフォルトで11分おきに反映される。
makestep  :: 参照クロックとの時間差の閾値と、ステップ方式による時刻補正の回数を指定するパラメータ。

※makestepは白本の模試に出てきたパラメーター。
※serverはあるが、clientはないので注意。sourceもない。
```

``` conf : /etc/chrony.confの設定例
# NTPサーバーを指定
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst

# 補正情報ファイルを指定
driftfile /var/lib/chrony/drift

# ハードウェアクロックと同期させる
rtcsync

# ログファイルを指定
logdir /var/log/chrony
```

---

## chronydデーモン

NTPにより時刻の同期を取るクライアントかつサーバーデーモン。  
ntpdと同様に上位のNTPサーバーから時刻の同期を受けるクライアント機能と、NTPクライアントに時刻を配信するサーバー機能を持っている。  

設定ファイル  
・`/etc/chrony.conf`(RedHad系)  
・`/etc/chrony/chrony.conf`(Debian系)  

---

## 主なディレクティブ

- `server ホスト名`  
  時刻元として使用するNTPサーバーを指定する。  
  オプション「iburst」を指定した場合は起動後の最初の4回の問い合わせは2秒間隔で行う。  
  起動後の同期を早くするために有効。  
  例1: server 0.centos.pool.ntp.org iburst  
  例2: server ntp.nict.jp iburst  
- `pool プール名`  
  時刻元として使用する複数のNTPサーバーのプールを指定する。  
  オプション「maxsources」を指定した場合は、使用するサーバーの最大台数は指定した値となる。  
  例1: pool ntp.ubuntu.com iburst maxsources 4  
  例2: pool ntp.nict.jp burst  
- `makestep 閾値 回数`  
  時刻のずれが閾値(単位:秒)より大きかった場合は指定した問い合わせ回数まではステップで同期する。  
  例: makestep 1.0 3  
- `rtcsync`  
  定期的にハードウェアクロックの同期を取る。
- `rtcfile`  
  ドリフトファイルにより時刻を補正する。  
- `driftfile ファイル`  
  システムクロックとハードウェアクロックのズレを記録するドリフトファイルを指定する。  
  例: driftfile /var/lib/chrony/drift  

---

## chronycコマンド

chronydの管理を行うコマンド  
chronycコマンド単体で実行した場合、対話モードでの操作となる。  

``` txt
chronyc

対話モード
quit :: 対話状態を終了する。


chronyc [オプション] [サブコマンド]

主なサブコマンド
activity           :: NTPサーバーのオンライン/オフライン数を表示する。
sources            :: 時刻ソースの情報を表示する。
sourcestats        :: 時刻ソースの統計情報を表示する。
tracking           :: トラッキングを確認する。システムクロックのパフォーマンス情報を表示する。
makestep 閾値 回数 :: 時刻のずれが閾値(単位:秒)より大きかった場合は指定した問い合わせ回数まではステップで同期する。
                      引数を指定せずに実行した場合は時刻を合わせる。
```

時刻ソースとなるNTPサーバー毎の情報を表示する。  
`chronyc sources`  

``` txt : chronyc sources コマンド実行結果の各項目の説明
M               :: ソースのモード（「^」はserver、「=」はpeer ）
S               :: ソースの状態（「*」は同期している、「+」は同期可能、「?」は全てのテストをパスしていないか切断されたソース）
Name/IP address :: ソースの名前/IPアドレス
Stratum         :: ソースのストレイタム（階層）。
                   原子時計やGPSなどの正確な時計をstratum 0とし、そこから直接時刻を取得するサーバがstratum 1、stratum 1のサーバから時刻を取得するサーバはstratum 2、
                   最下層は stratum 16（stratum 16のサーバからは時刻を取得することはできない）
Poll            :: ソースに問い合わせるポーリング間隔。デフォルト値は6（26=64秒）
Reach           :: 過去8回分の問い合わせ結果を8進数で表示。全て成功で377（2進数で11 111 111）
LastRx          :: ソースから最後のサンプルを受信した時期（デフォルトは秒数）
Last sample     :: 同期した時刻とのズレ具合
                   例）「-843us[-1329us] +/- 103ms」表示の場合、843usは前回測定時のズレ、1329usは前回測定後にslewで調整した値、103msは誤差の範囲
```

---

## systemdのタイマー

cronのsystemd版。  
systemdにもタイマーを設定して実行してくれる機能があるらしい。  

atコマンド、crontabコマンドは一般ユーザーでも利用できるが、systemdのタイマーはroot権限を持つユーザーしか設定出来ない。  
cronと同じく、一定間隔あるいは指定した時刻でサービスを実行することが出来る。  
タイマーの設定はサフィックスを.timeとしてunit設定ファイルを作成する。  
2種類のタイマーがある。  

●monotinic timer  
指定した間隔で1回、あるいは複数回、サービスを実行する。  
●realtime timer  
指定した時刻にサービスを実行する。  

monotonic timerの設定
タイマーユニット設定ファイルの[timer]セクションにスターティングポイントから時間間隔を指定して実行する。  
スターティングポイント  
OnActiveSec=(タイマーをアクティベートしてからの時間を指定)  
OnBootSec=(マシンが立ち上がった後の時間間隔を指定)  
等  
OnUnitActiveSec(繰り返して実行する場合の時間間隔)  

``` txt : monotonic timerの設定例
[Timer]
OnActiveSec=1hour
OnUnitActiveSec=1hour
Unit=tiemr-test.service
```

タイマーユニット設定ファイルの[Timer]セクションに実行時刻を「OnCalendar=」で指定する。  
時刻の書式は「曜日 年-月-日 時刻」。(曜日、年-月-日、時刻は省略可能。全て省略したら00:00:00となる。)  

``` txt : realtime timerの設定例
[Timer]
OnCalendar=*-*-* 4:00:00
Unit=timer-test.service
```

まぁ、つまり、systemdでタイマー使いたかったら[.time]ってファイル作って[Timer]ってセクションに何か書けばいいって事だろう。  

---

## timedatectlコマンド

systemdの動作するシステムにおいてシステム時刻の表示や設定を行うコマンド。  
dateコマンドのようにシステムクロック（Linuxカーネルが持つ時刻）を操作するだけではなく、  
システムクロックとハードウェアクロック（コンピュータに内蔵された時刻）を同時に設定できます。  
コマンドのみを実行した場合、現在の日時、タイムゾーン、NTPを利用しているかどうかを表示する。  

``` txt
timedatectl [サブコマンド]

status                    :: 現在の状態を表示する(デフォルト)
set-time 時刻             :: 時刻を設定する(HH:MM:SS)
set-time 日付             :: 日付を設定する(YYYY-MM-DD)
set-time 日付 時刻        :: 日付と時刻を設定する(YYYY-MM-DD HH:MM:SS)
set-timezone タイムゾーン :: タイムゾーンを設定する
list-timezones            :: タイムゾーン一覧を表示する。zone's'であることに注意。
set-ntp yes|no            :: NTPを使うかどうか
```

日時を2019年3月12日12時24分に設定する。  
`timedatectl set-time 2019-03-12 12:24:00`  

タイムゾーンを「Asia/Tokyo」に設定する。  
`timedatectl set-timezone Asia/Tokyo`  

---

## pool.ntp.org

複数のNTPサーバで構成させる仮想的なNTPサーバを、DNSラウンドロビン方式で提供するプロジェクト。  
複数のNTPサーバをまとめて仮想的なNTPサーバとして運用し負荷分散の技術の一つである「DNSラウンドロビン」方式で時刻を提供します。  
